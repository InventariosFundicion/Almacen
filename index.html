<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Almac√©n - Fundici√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            border-bottom: 4px solid #e74c3c;
            color: #e74c3c;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
        }

        #qr-input {
            background: #f8f9fa;
            border: 3px solid #28a745;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            line-height: 1.4;
        }

        #qr-input:focus {
            outline: none;
            border-color: #20c997;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 8px 5px;
            text-transform: uppercase;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 6px solid #3498db;
            margin: 20px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .stats-card {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .stats-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .alert {
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .warehouse-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .warehouse-btn {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .warehouse-btn.selected {
            border-color: #e74c3c;
            background: #e74c3c;
            color: white;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .inventory-table th, .inventory-table td {
            padding: 18px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        .inventory-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: bold;
        }

        .code-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            margin: 2px;
            display: inline-block;
        }

        .pallet-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .pallet-code {
            font-size: 12px;
            padding: 2px 5px;
            margin: 1px;
            background: #e9ecef;
            border-radius: 3px;
            display: inline-block;
        }

        .pallet-info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .pallet-id {
            font-size: 1.2em;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .scanner-hint {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }

        .auto-detect {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .existing-code {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .existing-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .existing-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .duplicate-warning {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #721c24;
        }

        .model-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
        }

        .model-header {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .state-subsection {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
        }

        .state-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .movement-list {
            font-size: 0.9em;
            color: #6c757d;
            margin: 5px 0;
        }

        .theoretical-result {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }

        .verification-section {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
        }

        .verification-match {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .verification-mismatch {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Sistema de Almac√©n</h1>
            <p>Control de Inventario - Fundici√≥n y Acabados</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('scanner')">üì± Esc√°ner QR</button>
            <button class="nav-tab" onclick="showTab('inventory')">üìã Inventario</button>
            <button class="nav-tab" onclick="showTab('pallets')">üì¶ Tarimas</button>
            <button class="nav-tab" onclick="showTab('production')">üè≠ Producci√≥n</button>
            <button class="nav-tab" onclick="showTab('theoretical')">üìä Te√≥rico vs F√≠sico</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>üìä Dashboard de Almac√©n</h2>
            
            <div class="grid">
                <div class="card stats-card">
                    <div class="stats-number" id="total-fundidos">0</div>
                    <h3>üî• FUNDIDOS</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-acabados">0</div>
                    <h3>‚úÖ ACABADOS</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-upr">0</div>
                    <h3>üî∫ UPR</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-lwr">0</div>
                    <h3>üîª LWR</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-pallets">0</div>
                    <h3>üì¶ TARIMAS</h3>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="exportData()">üìä Exportar Datos</button>
            </div>
        </div>

        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content">
            <h2>üì± Procesamiento de C√≥digos QR</h2>
            
            <div class="card">
                <h3>Procesar C√≥digo QR</h3>
                
                <div class="scanner-hint">
                    üí° <strong>Para Scanner F√≠sico:</strong> Posiciona el scanner sobre este campo de texto y escanea. 
                    El c√≥digo se capturar√° autom√°ticamente.
                </div>
                
                <div class="form-group">
                    <label>C√≥digo QR (Tarima o Individual):</label>
                    <textarea id="qr-input" rows="4" placeholder="Pega aqu√≠ el c√≥digo QR completo o usa el scanner f√≠sico..." autofocus></textarea>
                    <div id="qr-analysis"></div>
                </div>
                
                <div class="form-group">
                    <label>Tipo de Inventario:</label>
                    <select id="inventory-type">
                        <option value="movimiento">üì¶ Movimiento Normal</option>
                        <option value="inicial">üéØ Inventario Inicial</option>
                        <option value="turno">‚è∞ Inventario por Turno</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Turno:</label>
                    <select id="shift">
                        <option value="1">Primer Turno (07:00 am - 07:00 pm)</option>
                        <option value="2">Segundo Turno (07:00 pm - 07:00 am)</option>
                    </select>
                </div>
                
                <div class="form-group" id="individual-state-section" style="display: none;">
                    <label>Estado del Material (Pieza Individual):</label>
                    <select id="individual-state">
                        <option value="fundidos">üî• Fundido</option>
                        <option value="acabados">‚úÖ Acabado</option>
                    </select>
                </div>
                
                <div class="form-group" id="movement-destination-section" style="display: none;">
                    <label>Destino del Movimiento:</label>
                    <div class="warehouse-selector" id="movement-selector">
                        <div class="warehouse-btn" data-movement="envios">üì¶ ENV√çOS</div>
                        <div class="warehouse-btn" data-movement="retenciones">‚è∏Ô∏è RETENCIONES</div>
                        <div class="warehouse-btn" data-movement="scrap">‚ôªÔ∏è SCRAP</div>
                        <div class="warehouse-btn" data-movement="pruebas">üß™ PRUEBAS</div>
                    </div>
                </div>
                
                <div class="form-group" id="warehouse-override-section" style="display: none;">
                    <label>Forzar Almac√©n (Tarima sin estado detectado):</label>
                    <div class="warehouse-selector" id="warehouse-selector">
                        <div class="warehouse-btn" data-warehouse="fundidos">üî• FUNDIDOS</div>
                        <div class="warehouse-btn" data-warehouse="acabados">‚úÖ ACABADOS</div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="processQRCode()">‚úÖ Procesar C√≥digo QR</button>
                <button class="btn btn-info" onclick="clearForm()">üîÑ Limpiar</button>
            </div>

            <div id="process-result"></div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>üìã Inventario Detallado</h2>
            
            <div class="card">
                <h3>üìä Inventario por Modelo y Estado</h3>
                <div id="detailed-inventory"></div>
            </div>
            
            <div class="card">
                <h3>üìä Resumen por N√∫mero de Parte</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>N√∫mero de Parte</th>
                            <th>Fundidos</th>
                            <th>Acabados</th>
                            <th>Env√≠os</th>
                            <th>Retenciones</th>
                            <th>Scrap</th>
                            <th>Pruebas</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="grouped-inventory-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Pallets Tab -->
        <div id="pallets" class="tab-content">
            <h2>üì¶ Gesti√≥n de Tarimas</h2>
            
            <div class="card">
                <h3>üìã Registro de Tarimas</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>ID Tarima</th>
                            <th>ID Original</th>
                            <th>Estado</th>
                            <th>Tipo</th>
                            <th>Piezas</th>
                            <th>Almac√©n</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="pallets-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Production Tab -->
        <div id="production" class="tab-content">
            <h2>üè≠ Control de Producci√≥n</h2>
            
            <!-- Secci√≥n 1: Reporte de Fundici√≥n -->
            <div class="card">
                <h3>üî• Reporte de Fundici√≥n</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>M√°quina:</label>
                        <select id="foundry-machine">
                            <option value="30">#30</option>
                            <option value="31">#31</option>
                            <option value="32">#32</option>
                            <option value="33">#33</option>
                            <option value="34">#34</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>N√∫mero de Parte:</label>
                        <select id="foundry-part-number">
                            <option value="PX13-10-301">PX13-10-301</option>
                            <option value="PX13-10-382">PX13-10-382</option>
                            <option value="PEDD-10-301-A">PEDD-10-301-A</option>
                            <option value="PEDD-10-382-A">PEDD-10-382-A</option>
                            <option value="PX13-10-401">P54G-10-301</option>
                            <option value="PX13-10-482">P54G-10-382</option>
                            <option value="PEDD-10-401-A">S51L-10-301</option>
                            <option value="PEDD-10-482-A">S51L-10-382</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Turno:</label>
                        <select id="foundry-shift">
                            <option value="1">Primer Turno (07:00 am - 07:00 pm)</option>
                            <option value="2">Segundo Turno (07:00 pm - 07:00 am)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Cantidad Total Fundida:</label>
                        <input type="number" id="foundry-total-produced" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Cantidad NG Fundici√≥n:</label>
                        <input type="number" id="foundry-ng-quantity" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha:</label>
                        <input type="date" id="foundry-date">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveFoundryReport()">üî• Guardar Reporte Fundici√≥n</button>
            </div>

            <!-- Secci√≥n 2: Reporte de Acabado -->
            <div class="card">
                <h3>‚úÖ Reporte de Acabado</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>L√≠nea de Acabado:</label>
                        <select id="finishing-line">
                            <option value="L1">#30</option>
                            <option value="L2">#31</option>
                            <option value="L3">#32</option>
                            <option value="L4">#33</option>
                            <option value="L5">#34</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>N√∫mero de Parte:</label>
                        <select id="finishing-part-number">
                            <option value="PX13-10-301">PX13-10-301</option>
                            <option value="PX13-10-382">PX13-10-382</option>
                            <option value="PEDD-10-301-A">PEDD-10-301-A</option>
                            <option value="PEDD-10-382-A">PEDD-10-382-A</option>
                            <option value="PX13-10-401">P54G-10-301</option>
                            <option value="PX13-10-482">P54G-10-382</option>
                            <option value="PEDD-10-401-A">S51L-10-301</option>
                            <option value="PEDD-10-482-A">S51L-10-382</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Turno:</label>
                        <select id="finishing-shift">
                            <option value="1">Primer Turno (07:00 am - 07:00 pm)</option>
                            <option value="2">Segundo Turno (07:00 pm - 07:00 am)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Cantidad Total Procesada:</label>
                        <input type="number" id="finishing-total-processed" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Cantidad NG Acabado:</label>
                        <input type="number" id="finishing-ng-quantity" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Fecha:</label>
                        <input type="date" id="finishing-date">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveFinishingReport()">‚úÖ Guardar Reporte Acabado</button>
            </div>

            <!-- Secci√≥n 3: Comprobaci√≥n -->
            <div class="card">
                <h3>üîç Comprobaci√≥n Fundici√≥n vs Acabado</h3>
                <div class="form-group">
                    <label>Seleccionar Fecha para Comprobaci√≥n:</label>
                    <input type="date" id="verification-date">
                    <button class="btn btn-info" onclick="generateVerificationReport()" style="margin-top: 10px;">üîç Generar Comprobaci√≥n</button>
                </div>
                <div id="verification-results"></div>
            </div>
        </div>

        <!-- Theoretical vs Physical Tab -->
        <div id="theoretical" class="tab-content">
            <h2>üìä Inventario Te√≥rico vs F√≠sico</h2>
            
            <div class="card">
                <h3>‚öôÔ∏è Configuraci√≥n Base</h3>
                <p>Configura el inventario inicial y producci√≥n para calcular el te√≥rico.</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div>
                        <h4>üì¶ Inventario Inicial</h4>
                        <div id="initial-setup"></div>
                    </div>
                    
                    <div>
                        <h4>üè≠ Producci√≥n</h4>
                        <div id="production-setup"></div>
                    </div>
                </div>
                
                <button class="btn btn-info" onclick="calculateTheoretical()">üßÆ Calcular Te√≥rico</button>
            </div>
        </div>
    </div>

<script>
// Variables globales
let inventory = [];
let movements = [];
let productionReports = [];
let foundryReports = [];
let finishingReports = [];
let pallets = [];
let selectedWarehouse = '';
let selectedMovement = '';
let palletCounter = 1;

const PART_NUMBERS = ['PX13-10-301', 'PX13-10-382', 'PEDD-10-301-A', 'PEDD-10-382-A', 'P54G-10-301', 'P54G-10-382', 'S51L-10-301', 'S51L-10-382'];

const STATE_MAPPING = {
    'FUNDIDO': 'fundidos',
    'FUNDIDOS': 'fundidos',
    'ACABADO': 'acabados',
    'ACABADOS': 'acabados',
    'FINISHED': 'acabados',
    'CAST': 'fundidos',
    'MOLTEN': 'fundidos'
};

// Funci√≥n para cambiar pesta√±as
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    
    document.getElementById(tabName).classList.add('active');
    const activeButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }
}

function generatePalletId() {
    return `PAL-${String(palletCounter++).padStart(4, '0')}`;
}

function checkExistingCodes(codes) {
    const existingCodes = [];
    const newCodes = [];
    
    codes.forEach(code => {
        const existing = inventory.find(item => item.code === code && item.quantity > 0);
        if (existing) {
            existingCodes.push({ code: code, data: existing });
        } else {
            newCodes.push(code);
        }
    });
    
    return { existingCodes, newCodes };
}

function formatLastMovement(date) {
    const now = new Date();
    const diff = now - date;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(hours / 24);
    
    if (days > 0) {
        return `hace ${days} d√≠a${days > 1 ? 's' : ''}`;
    } else if (hours > 0) {
        return `hace ${hours} hora${hours > 1 ? 's' : ''}`;
    } else {
        return 'hace poco';
    }
}

function updateFormSections() {
    const inventoryType = document.getElementById('inventory-type').value;
    const movementSection = document.getElementById('movement-destination-section');
    
    if (inventoryType === 'movimiento') {
        movementSection.style.display = 'block';
    } else {
        movementSection.style.display = 'none';
        document.querySelectorAll('#movement-selector .warehouse-btn').forEach(btn => 
            btn.classList.remove('selected'));
        selectedMovement = '';
    }
}

function analyzeQRCode() {
    const input = document.getElementById('qr-input').value.trim();
    const analysisDiv = document.getElementById('qr-analysis');
    
    document.getElementById('warehouse-override-section').style.display = 'none';
    document.getElementById('individual-state-section').style.display = 'none';
    
    if (!input) {
        analysisDiv.innerHTML = '';
        return;
    }
    
    const analysis = parseQRCode(input);
    
    if (analysis.isPallet) {
        const codeCheck = checkExistingCodes(analysis.codes);
        
        let existingWarning = '';
        if (codeCheck.existingCodes.length > 0) {
            const existingInfo = codeCheck.existingCodes.slice(0, 3).map(item => 
                `<div class="existing-info">
                    <span class="existing-badge" style="background: ${item.data.state === 'FUNDIDOS' ? '#e74c3c' : '#27ae60'};">
                        ${item.data.state}
                    </span>
                    <span class="existing-badge" style="background: #6c757d;">
                        ${getWarehouseName(item.data.warehouse)}
                    </span>
                    <small>${item.code} - ${formatLastMovement(item.data.lastMovement)}</small>
                </div>`
            ).join('');
            
            existingWarning = `
                <div class="duplicate-warning">
                    ‚ö†Ô∏è <strong>C√ìDIGOS DUPLICADOS DETECTADOS</strong><br>
                    ${codeCheck.existingCodes.length} de ${analysis.codes.length} c√≥digos ya existen en el sistema:<br>
                    ${existingInfo}
                    ${codeCheck.existingCodes.length > 3 ? `<small>... y ${codeCheck.existingCodes.length - 3} m√°s</small>` : ''}
                    <br><strong>Solo se procesar√°n ${codeCheck.newCodes.length} c√≥digos nuevos</strong>
                </div>
            `;
        }
        
        const autoDetectedState = analysis.detectedState ? 
            `<div class="auto-detect">üîç <strong>Estado Auto-detectado:</strong> ${analysis.detectedState.toUpperCase()}</div>` : '';
        
        if (!analysis.detectedState) {
            document.getElementById('warehouse-override-section').style.display = 'block';
        }
        
        analysisDiv.innerHTML = `
            <div class="alert alert-info">
                <strong>üéØ TARIMA DETECTADA</strong><br>
                <span class="code-badge" style="background: #17a2b8;">ID Original: ${analysis.palletId}</span>
                <span class="code-badge" style="background: #28a745;">${analysis.type}</span>
                <span class="code-badge" style="background: #6c757d;">${analysis.codes.length} piezas</span>
                <span class="code-badge" style="background: #17a2b8;">${codeCheck.newCodes.length} nuevas</span>
                ${autoDetectedState}
                ${existingWarning}
                
                <div class="pallet-info">
                    <div class="pallet-id">üÜî Se asignar√° ID: ${generatePalletId()}</div>
                    <small>Este ID √∫nico permitir√° movimientos futuros de la tarima completa</small>
                </div>
                
                <div class="pallet-preview">
                    <strong>C√≥digos ${codeCheck.newCodes.length > 0 ? 'NUEVOS' : 'EXISTENTES'} en la tarima:</strong><br>
                    ${(codeCheck.newCodes.length > 0 ? codeCheck.newCodes : analysis.codes).slice(0, 10).map(code => 
                        `<span class="pallet-code">${code}</span>`
                    ).join('')}
                    ${analysis.codes.length > 10 ? `<br><em>... y ${analysis.codes.length - 10} m√°s</em>` : ''}
                </div>
            </div>
        `;
        palletCounter--;
        
    } else if (analysis.isValid) {
        const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
        
        if (existingItem) {
            analysisDiv.innerHTML = `
                <div class="existing-code">
                    <strong>‚ö†Ô∏è C√ìDIGO EXISTENTE</strong><br>
                    <span class="code-badge" style="background: #28a745;">${analysis.type}</span>
                    <span class="code-badge" style="background: #6c757d;">${analysis.code}</span>
                    
                    <div class="existing-info">
                        <strong>Informaci√≥n actual:</strong><br>
                        <span class="existing-badge" style="background: ${existingItem.state === 'FUNDIDOS' ? '#e74c3c' : '#27ae60'};">
                            ${existingItem.state}
                        </span>
                        <span class="existing-badge" style="background: #6c757d;">
                            ${getWarehouseName(existingItem.warehouse)}
                        </span>
                        <span class="existing-badge" style="background: #17a2b8;">
                            Cant: ${existingItem.quantity}
                        </span>
                        <br><small>√öltimo movimiento: ${formatLastMovement(existingItem.lastMovement)}</small>
                    </div>
                </div>
                
                <div class="alert alert-success">
                    <strong>üîÑ ACTUALIZACI√ìN DISPONIBLE</strong><br>
                    El c√≥digo se procesar√° como movimiento adicional con la nueva informaci√≥n.
                </div>
            `;
            
            document.getElementById('individual-state').value = existingItem.warehouse;
        } else {
            analysisDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ C√ìDIGO NUEVO</strong><br>
                    <span class="code-badge" style="background: #28a745;">${analysis.type}</span>
                    <span class="code-badge" style="background: #6c757d;">${analysis.code}</span>
                    <div class="auto-detect">üí° <strong>Selecciona el estado del material abajo</strong></div>
                </div>
            `;
        }
        
        document.getElementById('individual-state-section').style.display = 'block';
        
    } else {
        analysisDiv.innerHTML = `
            <div class="alert" style="background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
                ‚ùå <strong>C√≥digo no v√°lido</strong><br>
                Verifica que el c√≥digo QR est√© completo y en el formato correcto.
            </div>
        `;
    }
    
    updateFormSections();
}

function parseQRCode(input) {
    if (input.includes('|')) {
        const parts = input.split('|');
        if (parts.length >= 3) {
            const palletId = parts[0];
            const state = parts[1];
            const codes = parts.slice(2).filter(code => code.trim().length > 0);
            
            let type = 'UNKNOWN';
            if (codes.length > 0) {
                const firstCode = codes[0];
                type = firstCode.length === 13 ? 'UPR' : 'LWR';
            }
            
            let detectedState = null;
            const stateUpper = state.toUpperCase();
            for (const [key, value] of Object.entries(STATE_MAPPING)) {
                if (stateUpper.includes(key)) {
                    detectedState = value;
                    break;
                }
            }
            
            return {
                isPallet: true,
                isValid: true,
                palletId: palletId,
                type: type,
                state: state,
                detectedState: detectedState,
                codes: codes
            };
        }
    } else {
        const cleanCode = input.trim();
        if (cleanCode.length === 13 || cleanCode.length === 17) {
            return {
                isPallet: false,
                isValid: true,
                code: cleanCode,
                type: cleanCode.length === 13 ? 'UPR' : 'LWR'
            };
        }
    }
    
    return { isPallet: false, isValid: false };
}

function processQRCode() {
    const input = document.getElementById('qr-input').value.trim();
    const inventoryType = document.getElementById('inventory-type').value;
    const shift = document.getElementById('shift').value;
    const resultDiv = document.getElementById('process-result');
    
    if (!input) {
        alert('Por favor escanea o pega un c√≥digo QR');
        return;
    }
    
    const analysis = parseQRCode(input);
    if (!analysis.isValid) {
        alert('C√≥digo QR no v√°lido');
        return;
    }
    
    let processedCount = 0;
    let targetWarehouse = '';
    
    if (analysis.isPallet) {
        const codeCheck = checkExistingCodes(analysis.codes);
        
        if (inventoryType === 'movimiento') {
            if (!selectedMovement) {
                alert('Por favor selecciona el destino del movimiento (Env√≠os, Retenciones, Scrap, o Pruebas)');
                return;
            }
            targetWarehouse = selectedMovement;
        } else {
            if (analysis.detectedState) {
                targetWarehouse = analysis.detectedState;
            } else {
                if (!selectedWarehouse) {
                    alert('Esta tarima no tiene estado detectable. Por favor selecciona Fundidos o Acabados manualmente.');
                    return;
                }
                targetWarehouse = selectedWarehouse;
            }
        }
        
        if (codeCheck.newCodes.length === 0) {
            alert('‚ö†Ô∏è Todos los c√≥digos de esta tarima ya existen en el sistema. No se procesar√° nada.');
            return;
        }
        
        const palletSystemId = generatePalletId();
        
        const palletRecord = {
            systemId: palletSystemId,
            originalId: analysis.palletId,
            state: targetWarehouse === 'fundidos' ? 'fundidos' : 
                   (targetWarehouse === 'acabados' ? 'acabados' : targetWarehouse),
            type: analysis.type,
            codesCount: codeCheck.newCodes.length,
            warehouse: targetWarehouse,
            codes: codeCheck.newCodes,
            createdDate: new Date(),
            inventoryType: inventoryType,
            shift: shift,
            duplicatesFound: codeCheck.existingCodes.length
        };
        
        pallets.push(palletRecord);
        
        codeCheck.newCodes.forEach(code => {
            processIndividualCode(code, analysis.type, inventoryType, shift, targetWarehouse, palletSystemId);
            processedCount++;
        });
        
        const duplicateInfo = codeCheck.existingCodes.length > 0 ? 
            `<br>‚ö†Ô∏è ${codeCheck.existingCodes.length} c√≥digos duplicados omitidos` : '';
        
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                ‚úÖ <strong>Tarima procesada exitosamente</strong><br>
                üÜî ID Sistema: <strong>${palletSystemId}</strong><br>
                üì¶ ID Original: ${analysis.palletId}<br>
                üìä ${processedCount} piezas NUEVAS ${analysis.type}<br>
                üè™ Destino: ${getWarehouseName(targetWarehouse)}<br>
                üîÑ Tipo: ${inventoryType} - Turno ${shift}${duplicateInfo}
            </div>
        `;
        
    } else {
        // L√ìGICA PARA PIEZAS INDIVIDUALES - CON VERIFICACI√ìN ESTRICTA
        const individualState = document.getElementById('individual-state').value;
        const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
        
        if (inventoryType === 'movimiento') {
            // Para movimientos, permitir solo si el c√≥digo ya existe
            if (!existingItem) {
                alert('‚ùå ERROR: No puedes hacer un movimiento de un c√≥digo que no existe en el inventario.\n\nPrimero registra el c√≥digo con "Inventario Inicial" o "Inventario por Turno".');
                return;
            }
            
            if (!selectedMovement) {
                alert('Por favor selecciona el destino del movimiento (Env√≠os, Retenciones, Scrap, o Pruebas)');
                return;
            }
            targetWarehouse = selectedMovement;
            
            // Procesar movimiento (cambiar ubicaci√≥n sin duplicar)
            existingItem.warehouse = targetWarehouse;
            existingItem.state = targetWarehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
            existingItem.lastMovement = new Date();
            
            movements.push({
                id: Date.now() + Math.random(),
                code: analysis.code,
                partNumber: existingItem.partNumber,
                type: inventoryType,
                warehouse: targetWarehouse,
                quantity: 1,
                date: new Date(),
                shift: shift,
                palletId: null
            });
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>Movimiento procesado</strong><br>
                    üì¶ ${analysis.code}<br>
                    üè™ Movido a: ${getWarehouseName(targetWarehouse)}<br>
                    üîÑ Tipo: ${inventoryType} - Turno ${shift}<br>
                    üìä Cantidad total: ${existingItem.quantity}
                </div>
            `;
            
        } else {
            // Para inventarios iniciales o por turno
            if (existingItem) {
                // Verificar si es el mismo almac√©n/estado
                if (existingItem.warehouse === individualState) {
                    alert(`‚ö†Ô∏è C√ìDIGO YA REGISTRADO\n\nEl c√≥digo ${analysis.code} ya est√° registrado en ${getWarehouseName(individualState)}.\n\nCantidad actual: ${existingItem.quantity}\n√öltimo registro: ${formatLastMovement(existingItem.lastMovement)}\n\n¬øQuieres hacer un MOVIMIENTO en lugar de inventario?`);
                    return;
                } else {
                    // Confirmaci√≥n para cambiar de estado
                    const confirmChange = confirm(`üîÑ CAMBIO DE ESTADO DETECTADO\n\nEl c√≥digo ${analysis.code} est√° actualmente en:\n${getWarehouseName(existingItem.warehouse)}\n\n¬øQuieres moverlo a ${getWarehouseName(individualState)}?\n\n‚úÖ Aceptar = Mover\n‚ùå Cancelar = No hacer nada`);
                    
                    if (!confirmChange) {
                        clearForm();
                        return;
                    }
                }
            }
            
            targetWarehouse = individualState;
            processIndividualCode(analysis.code, analysis.type, inventoryType, shift, targetWarehouse);
            
            const statusMessage = existingItem ? 
                `<br>üîÑ C√≥digo movido desde ${getWarehouseName(existingItem.warehouse)}` : 
                '<br>‚ú® C√≥digo nuevo registrado';
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>C√≥digo individual procesado</strong><br>
                    üì¶ ${analysis.code}<br>
                    üè™ Registrado en: ${getWarehouseName(targetWarehouse)}<br>
                    üìä Estado: ${getWarehouseName(individualState)}<br>
                    üîÑ Tipo: ${inventoryType} - Turno ${shift}${statusMessage}
                </div>
            `;
        }
    }
    
    clearForm();
    updateAllDisplays();
    
    setTimeout(() => resultDiv.innerHTML = '', 6000);
}

function getWarehouseName(warehouse) {
    const names = {
        'fundidos': 'üî• FUNDIDOS',
        'acabados': '‚úÖ ACABADOS',
        'scrap': '‚ôªÔ∏è SCRAP',
        'retenciones': '‚è∏Ô∏è RETENCIONES',
        'envios': 'üì¶ ENV√çOS',
        'pruebas': 'üß™ PRUEBAS'
    };
    return names[warehouse] || warehouse.toUpperCase();
}

function clearForm() {
    document.getElementById('qr-input').value = '';
    document.getElementById('qr-analysis').innerHTML = '';
    
    document.getElementById('warehouse-override-section').style.display = 'none';
    document.getElementById('individual-state-section').style.display = 'none';
    document.getElementById('movement-destination-section').style.display = 'none';
    
    document.querySelectorAll('.warehouse-btn').forEach(btn => 
        btn.classList.remove('selected'));
    selectedWarehouse = '';
    selectedMovement = '';
    
    document.getElementById('qr-input').focus();
}

function processIndividualCode(code, type, movementType, shift, warehouse, palletId = null) {
    const partNumber = type === 'UPR' ? 'PX13-10-301' : 'PX13-10-382';
    
    let item = inventory.find(i => i.code === code);
    
    if (!item) {
        item = {
            code: code,
            partNumber: partNumber,
            type: type,
            state: warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS',
            warehouse: warehouse,
            quantity: 0,
            lastMovement: new Date(),
            shift: shift,
            palletId: palletId
        };
        inventory.push(item);
    }
    
    // Para movimientos, no aumentar cantidad, solo cambiar ubicaci√≥n
    if (movementType === 'movimiento') {
        item.warehouse = warehouse;
        item.state = warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
        item.lastMovement = new Date();
        item.palletId = palletId;
    } else {
        // Para inventarios iniciales o por turno, aumentar cantidad
        item.quantity += 1;
        item.warehouse = warehouse;
        item.state = warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
        item.lastMovement = new Date();
        item.palletId = palletId;
    }
    
    movements.push({
        id: Date.now() + Math.random(),
        code: code,
        partNumber: partNumber,
        type: movementType,
        warehouse: warehouse,
        quantity: 1,
        date: new Date(),
        shift: shift,
        palletId: palletId
    });
}

function movePallet(palletId) {
    const pallet = pallets.find(p => p.systemId === palletId);
    if (!pallet) {
        alert('Tarima no encontrada');
        return;
    }

    const newWarehouse = prompt(`Mover tarima ${palletId} a:\n\n1. fundidos\n2. acabados\n3. scrap\n4. retenciones\n5. envios\n6. pruebas\n\nEscribe el nombre del almac√©n:`);
    
    if (newWarehouse && ['fundidos', 'acabados', 'scrap', 'retenciones', 'envios', 'pruebas'].includes(newWarehouse.toLowerCase())) {
        const warehouse = newWarehouse.toLowerCase();
        
        pallet.warehouse = warehouse;
        pallet.state = warehouse === 'fundidos' ? 'fundidos' : 'acabados';
        
        inventory.forEach(item => {
            if (item.palletId === palletId) {
                item.warehouse = warehouse;
                item.state = warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
                item.lastMovement = new Date();
            }
        });
        
        movements.push({
            id: Date.now() + Math.random(),
            palletId: palletId,
            type: 'movimiento_tarima',
            warehouse: warehouse,
            quantity: pallet.codesCount,
            date: new Date(),
            shift: document.getElementById('shift').value
        });
        
        alert(`‚úÖ Tarima ${palletId} movida a ${getWarehouseName(warehouse)}`);
        updateAllDisplays();
    } else if (newWarehouse !== null) {
        alert('Almac√©n no v√°lido');
    }
}

function viewPalletDetails(palletId) {
    const pallet = pallets.find(p => p.systemId === palletId);
    if (!pallet) {
        alert('Tarima no encontrada');
        return;
    }

    const codes = pallet.codes.length > 10 ? 
        pallet.codes.slice(0, 10).join('\n') + `\n... y ${pallet.codes.length - 10} m√°s` :
        pallet.codes.join('\n');

    alert(`üì¶ DETALLES DE TARIMA\n\n` +
          `üÜî ID Sistema: ${pallet.systemId}\n` +
          `üìã ID Original: ${pallet.originalId}\n` +
          `üìä Estado: ${pallet.state.toUpperCase()}\n` +
          `üîß Tipo: ${pallet.type}\n` +
          `üì¶ Piezas: ${pallet.codesCount}\n` +
          `üè™ Almac√©n: ${getWarehouseName(pallet.warehouse)}\n` +
          `üìÖ Creada: ${pallet.createdDate.toLocaleString()}\n\n` +
          `üìã C√ìDIGOS:\n${codes}`);
}

function saveFoundryReport() {
    const machine = document.getElementById('foundry-machine').value;
    const partNumber = document.getElementById('foundry-part-number').value;
    const shift = document.getElementById('foundry-shift').value;
    const totalProduced = parseInt(document.getElementById('foundry-total-produced').value) || 0;
    const ngQuantity = parseInt(document.getElementById('foundry-ng-quantity').value) || 0;
    const date = document.getElementById('foundry-date').value;
    
    if (!date || totalProduced === 0) {
        alert('Por favor completa los campos obligatorios');
        return;
    }
    
    const report = {
        id: Date.now(),
        machine: machine,
        partNumber: partNumber,
        shift: shift,
        totalProduced: totalProduced,
        ngQuantity: ngQuantity,
        okQuantity: totalProduced - ngQuantity,
        date: date,
        type: 'fundicion'
    };
    
    foundryReports.push(report);
    alert('‚úÖ Reporte de Fundici√≥n guardado');
    
    document.getElementById('foundry-total-produced').value = '';
    document.getElementById('foundry-ng-quantity').value = '';
}

function saveFinishingReport() {
    const line = document.getElementById('finishing-line').value;
    const partNumber = document.getElementById('finishing-part-number').value;
    const shift = document.getElementById('finishing-shift').value;
    const totalProcessed = parseInt(document.getElementById('finishing-total-processed').value) || 0;
    const ngQuantity = parseInt(document.getElementById('finishing-ng-quantity').value) || 0;
    const date = document.getElementById('finishing-date').value;
    
    if (!date || totalProcessed === 0) {
        alert('Por favor completa los campos obligatorios');
        return;
    }
    
    const report = {
        id: Date.now(),
        line: line,
        partNumber: partNumber,
        shift: shift,
        totalProcessed: totalProcessed,
        ngQuantity: ngQuantity,
        okQuantity: totalProcessed - ngQuantity,
        date: date,
        type: 'acabado'
    };
    
    finishingReports.push(report);
    alert('‚úÖ Reporte de Acabado guardado');
    
    document.getElementById('finishing-total-processed').value = '';
    document.getElementById('finishing-ng-quantity').value = '';
}

function generateVerificationReport() {
    const date = document.getElementById('verification-date').value;
    const resultsDiv = document.getElementById('verification-results');
    
    if (!date) {
        alert('Por favor selecciona una fecha');
        return;
    }
    
    const foundryData = foundryReports.filter(r => r.date === date);
    const finishingData = finishingReports.filter(r => r.date === date);
    
    if (foundryData.length === 0 && finishingData.length === 0) {
        resultsDiv.innerHTML = `
            <div class="alert" style="background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;">
                üìÖ No hay reportes para la fecha ${date}
            </div>
        `;
        return;
    }
    
    let verificationHTML = `<h4>üîç Comprobaci√≥n para ${date}</h4>`;
    
    // Agrupar por parte y turno
    const allParts = [...new Set([...foundryData.map(r => r.partNumber), ...finishingData.map(r => r.partNumber)])];
    const allShifts = ['1', '2'];
    
    allParts.forEach(partNumber => {
        verificationHTML += `<h5>üì¶ ${partNumber}</h5>`;
        
        allShifts.forEach(shift => {
            const foundryReport = foundryData.find(r => r.partNumber === partNumber && r.shift === shift);
            const finishingReport = finishingData.find(r => r.partNumber === partNumber && r.shift === shift);
            
            if (foundryReport || finishingReport) {
                const foundryOK = foundryReport ? foundryReport.okQuantity : 0;
                const finishingOK = finishingReport ? finishingReport.okQuantity : 0;
                const difference = foundryOK - finishingOK;
                
                const isMatch = Math.abs(difference) <= 2; // Tolerancia de 2 piezas
                const sectionClass = isMatch ? 'verification-match' : 'verification-mismatch';
                const icon = isMatch ? '‚úÖ' : '‚ùå';
                
                verificationHTML += `
                    <div class="verification-section ${sectionClass}">
                        <strong>${icon} Turno ${shift}</strong><br>
                        üî• Fundici√≥n: ${foundryOK} piezas buenas<br>
                        ‚úÖ Acabado: ${finishingOK} piezas buenas<br>
                        üìä Diferencia: ${difference} piezas<br>
                        ${!isMatch ? '<strong>‚ö†Ô∏è DISCREPANCIA DETECTADA</strong>' : 'üéØ BALANCE CORRECTO'}
                    </div>
                `;
            }
        });
    });
    
    resultsDiv.innerHTML = verificationHTML;
}

function calculateTheoretical() {
    alert('üßÆ Funci√≥n de c√°lculo te√≥rico en desarrollo.\n\nSe implementar√° la l√≥gica completa basada en:\n- Inventario inicial\n- Producci√≥n del turno\n- Movimientos registrados');
}

function exportData() {
    const data = {
        inventory: inventory,
        movements: movements,
        productionReports: productionReports,
        foundryReports: foundryReports,
        finishingReports: finishingReports,
        pallets: pallets,
        exportDate: new Date()
    };
    
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'almacen-completo-' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function loadSampleData() {
    const samples = [
        { code: 'P69A3037OFPX5', type: 'UPR', partNumber: 'PX13-10-301' },
        { code: '25F093109026100PX', type: 'LWR', partNumber: 'PX13-10-382' }
    ];
    
    samples.forEach(sample => {
        inventory.push({
            code: sample.code,
            partNumber: sample.partNumber,
            type: sample.type,
            state: 'ACABADOS',
            warehouse: 'acabados',
            quantity: Math.floor(Math.random() * 20) + 1,
            lastMovement: new Date(),
            shift: '1',
            palletId: null
        });
    });

    const samplePallet = {
        systemId: generatePalletId(),
        originalId: 'TARM001',
        state: 'acabados',
        type: 'UPR',
        codesCount: 15,
        warehouse: 'acabados',
        codes: ['P69A3037OFPX1', 'P69A3037OFPX2', 'P69A3037OFPX3'],
        createdDate: new Date(),
        inventoryType: 'inicial',
        shift: '1'
    };
    pallets.push(samplePallet);
    palletCounter++;
}

function updateAllDisplays() {
    updateDashboard();
    updateGroupedInventory();
    updateDetailedInventory();
    updatePalletsTable();
}

function updateDashboard() {
    const fundidos = inventory.filter(i => i.state === 'FUNDIDOS' && i.quantity > 0).length;
    const acabados = inventory.filter(i => i.state === 'ACABADOS' && i.quantity > 0).length;
    const upr = inventory.filter(i => i.type === 'UPR' && i.quantity > 0).length;
    const lwr = inventory.filter(i => i.type === 'LWR' && i.quantity > 0).length;
    const totalPallets = pallets.length;
    
    document.getElementById('total-fundidos').textContent = fundidos;
    document.getElementById('total-acabados').textContent = acabados;
    document.getElementById('total-upr').textContent = upr;
    document.getElementById('total-lwr').textContent = lwr;
    document.getElementById('total-pallets').textContent = totalPallets;
}

function updateGroupedInventory() {
    const tbody = document.getElementById('grouped-inventory-tbody');
    tbody.innerHTML = '';
    
    const grouped = {};
    
    inventory.forEach(item => {
        if (item.quantity > 0) {
            if (!grouped[item.partNumber]) {
                grouped[item.partNumber] = { 
                    fundidos: 0, acabados: 0, envios: 0, 
                    retenciones: 0, scrap: 0, pruebas: 0 
                };
            }
            
            if (item.warehouse === 'fundidos') {
                grouped[item.partNumber].fundidos += item.quantity;
            } else if (item.warehouse === 'acabados') {
                grouped[item.partNumber].acabados += item.quantity;
            } else if (item.warehouse === 'envios') {
                grouped[item.partNumber].envios += item.quantity;
            } else if (item.warehouse === 'retenciones') {
                grouped[item.partNumber].retenciones += item.quantity;
            } else if (item.warehouse === 'scrap') {
                grouped[item.partNumber].scrap += item.quantity;
            } else if (item.warehouse === 'pruebas') {
                grouped[item.partNumber].pruebas += item.quantity;
            }
        }
    });
    
    Object.keys(grouped).forEach(partNumber => {
        const data = grouped[partNumber];
        const total = data.fundidos + data.acabados + data.envios + data.retenciones + data.scrap + data.pruebas;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${partNumber}</strong></td>
            <td style="text-align: center;">üî• ${data.fundidos}</td>
            <td style="text-align: center;">‚úÖ ${data.acabados}</td>
            <td style="text-align: center;">üì¶ ${data.envios}</td>
            <td style="text-align: center;">‚è∏Ô∏è ${data.retenciones}</td>
            <td style="text-align: center;">‚ôªÔ∏è ${data.scrap}</td>
            <td style="text-align: center;">üß™ ${data.pruebas}</td>
            <td style="text-align: center; font-weight: bold;">${total}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateDetailedInventory() {
    const detailedDiv = document.getElementById('detailed-inventory');
    
    // Agrupar por tipo (UPR/LWR)
    const uprParts = PART_NUMBERS.filter(p => p.includes('301') || p.includes('401'));
    const lwrParts = PART_NUMBERS.filter(p => p.includes('382') || p.includes('482'));
    
    let html = '';
    
    // Secci√≥n UPR
    html += '<div class="model-section">';
    html += '<div class="model-header">üî∫ UPR (Upper)</div>';
    
    uprParts.forEach(partNumber => {
        html += generatePartSection(partNumber);
    });
    
    html += '</div>';
    
    // Secci√≥n LWR
    html += '<div class="model-section">';
    html += '<div class="model-header">üîª LWR (Lower)</div>';
    
    lwrParts.forEach(partNumber => {
        html += generatePartSection(partNumber);
    });
    
    html += '</div>';
    
    detailedDiv.innerHTML = html;
}

function generatePartSection(partNumber) {
    let html = `<h4>üì¶ ${partNumber}</h4>`;
    
    const warehouses = ['fundidos', 'acabados', 'envios', 'retenciones', 'scrap', 'pruebas'];
    const warehouseNames = {
        'fundidos': 'üî• FUNDIDOS',
        'acabados': '‚úÖ ACABADOS',
        'envios': 'üì¶ ENV√çOS',
        'retenciones': '‚è∏Ô∏è RETENCIONES',
        'scrap': '‚ôªÔ∏è SCRAP',
        'pruebas': 'üß™ PRUEBAS'
    };
    
    warehouses.forEach(warehouse => {
        const warehouseName = warehouseNames[warehouse];
        
        html += '<div class="state-subsection">';
        html += `<div class="state-header">${warehouseName}</div>`;
        
        // Inventario inicial
        const initialInventory = movements.filter(m => 
            m.partNumber === partNumber && 
            m.warehouse === warehouse && 
            (m.type === 'inicial' || m.type === 'turno')
        ).length;
        
        // Producci√≥n (solo para fundidos)
        const production = warehouse === 'fundidos' ? 
            foundryReports.filter(r => r.partNumber === partNumber)
                .reduce((sum, r) => sum + r.okQuantity, 0) : 0;
        
        // Movimientos recibidos
        const received = movements.filter(m => 
            m.partNumber === partNumber && 
            m.warehouse === warehouse && 
            m.type === 'movimiento'
        ).length;
        
        // Movimientos enviados (desde este almac√©n a otros)
        const sent = movements.filter(m => {
            const item = inventory.find(i => i.code === m.code);
            return item && item.partNumber === partNumber && 
                   m.type === 'movimiento' && 
                   item.warehouse !== warehouse;
        }).length;
        
        // Inventario actual
        const currentInventory = inventory.filter(i => 
            i.partNumber === partNumber && 
            i.warehouse === warehouse && 
            i.quantity > 0
        ).reduce((sum, i) => sum + i.quantity, 0);
        
        // C√°lculo te√≥rico
        const theoretical = initialInventory + production + received - sent;
        
        html += `<div class="movement-list">üìã Inventario Inicial: ${initialInventory}</div>`;
        if (production > 0) {
            html += `<div class="movement-list">üè≠ Producci√≥n: +${production}</div>`;
        }
        if (received > 0) {
            html += `<div class="movement-list">üì• Recibidos: +${received}</div>`;
        }
        if (sent > 0) {
            html += `<div class="movement-list">üì§ Enviados: -${sent}</div>`;
        }
        
        html += `<div class="theoretical-result">üìä Te√≥rico: ${theoretical} | F√≠sico: ${currentInventory}</div>`;
        
        // Alerta si hay discrepancia
        if (theoretical !== currentInventory) {
            const difference = currentInventory - theoretical;
            html += `<div style="background: #f8d7da; color: #721c24; padding: 5px; border-radius: 3px; margin-top: 5px; font-size: 0.9em;">
                ‚ö†Ô∏è Discrepancia: ${difference > 0 ? '+' : ''}${difference}
            </div>`;
        }
        
        html += '</div>';
    });
    
    return html;
}

function updatePalletsTable() {
    const tbody = document.getElementById('pallets-tbody');
    tbody.innerHTML = '';
    
    pallets.forEach(pallet => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${pallet.systemId}</strong></td>
            <td>${pallet.originalId}</td>
            <td><span class="code-badge" style="background: ${pallet.state === 'fundidos' ? '#e74c3c' : '#27ae60'};">${pallet.state.toUpperCase()}</span></td>
            <td><span class="code-badge" style="background: #17a2b8;">${pallet.type}</span></td>
            <td style="text-align: center;">${pallet.codesCount}</td>
            <td>${getWarehouseName(pallet.warehouse)}</td>
            <td>${pallet.createdDate.toLocaleDateString()}</td>
            <td>
                <button class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;" onclick="movePallet('${pallet.systemId}')">üì¶ Mover</button>
                <button class="btn btn-info" style="padding: 5px 10px; font-size: 12px;" onclick="viewPalletDetails('${pallet.systemId}')">üëÅÔ∏è Ver</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Configurar event listeners cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners
    document.getElementById('qr-input').addEventListener('input', analyzeQRCode);
    document.getElementById('inventory-type').addEventListener('change', updateFormSections);
    
    document.getElementById('qr-input').addEventListener('paste', function(e) {
        setTimeout(() => {
            const content = e.target.value.trim();
            if (content && (content.includes('|') || content.length >= 13)) {
                analyzeQRCode();
            }
        }, 100);
    });
    
    document.getElementById('warehouse-selector').addEventListener('click', function(e) {
        if (e.target.classList.contains('warehouse-btn')) {
            this.querySelectorAll('.warehouse-btn').forEach(btn => 
                btn.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedWarehouse = e.target.dataset.warehouse;
        }
    });
    
    document.getElementById('movement-selector').addEventListener('click', function(e) {
        if (e.target.classList.contains('warehouse-btn')) {
            this.querySelectorAll('.warehouse-btn').forEach(btn => 
                btn.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedMovement = e.target.dataset.movement;
        }
    });
    
    // Inicializar datos y displays
    loadSampleData();
    updateAllDisplays();
    
    // Configurar fechas por defecto
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('foundry-date').value = today;
    document.getElementById('finishing-date').value = today;
    document.getElementById('verification-date').value = today;
});

</script>
</body>
</html>
