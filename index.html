<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Almac√©n - Fundici√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            border-bottom: 4px solid #e74c3c;
            color: #e74c3c;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
        }

        #qr-input {
            background: #f8f9fa;
            border: 3px solid #28a745;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            line-height: 1.4;
        }

        #qr-input:focus {
            outline: none;
            border-color: #20c997;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 8px 5px;
            text-transform: uppercase;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 6px solid #3498db;
            margin: 20px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .stats-card {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .stats-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .alert {
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .warehouse-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .warehouse-btn {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .warehouse-btn.selected {
            border-color: #e74c3c;
            background: #e74c3c;
            color: white;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .inventory-table th, .inventory-table td {
            padding: 18px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        .inventory-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: bold;
        }

        .code-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            margin: 2px;
            display: inline-block;
        }

        .pallet-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .pallet-code {
            font-size: 12px;
            padding: 2px 5px;
            margin: 1px;
            background: #e9ecef;
            border-radius: 3px;
            display: inline-block;
        }

        .pallet-info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .pallet-id {
            font-size: 1.2em;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .scanner-hint {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }

        .auto-detect {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .existing-code {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .existing-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .existing-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .duplicate-warning {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #721c24;
        }

        .model-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
        }

        .model-header {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
        }

        .state-subsection {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
        }

        .state-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .movement-list {
            font-size: 0.9em;
            color: #6c757d;
            margin: 5px 0;
        }

        .collapsible-content {
            display: block;
        }
        .file-management-container {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    background: #f8f9fa;
}

.file-upload-area {
    cursor: pointer;
    text-align: center;
    padding: 20px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.file-upload-area:hover {
    background: #e9ecef;
}

.file-status {
    font-size: 14px;
}

.file-placeholder {
    color: #6c757d;
}

.file-info {
    color: #495057;
    font-weight: bold;
}

.file-success {
    color: #28a745;
    font-weight: bold;
}

.file-actions {
    margin-top: 15px;
    text-align: center;
}

.file-actions .btn {
    margin: 0 5px;
    font-size: 12px;
    padding: 5px 10px;
}

.btn-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

.file-history-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.file-history-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 600px;
    max-height: 70vh;
    overflow-y: auto;
    position: relative;
}

.file-history-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Control de Almacen</h1>
            <p>Fundici√≥n 1.3</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="nav-tab" data-tab="scanner">üì± Esc√°ner QR</button>
            <button class="nav-tab" data-tab="inventory">üìã Inventario</button>
            <button class="nav-tab" data-tab="pallets">üì¶ Tarimas</button>
            <button class="nav-tab" data-tab="production">üè≠ Producci√≥n</button>
            <button class="nav-tab" data-tab="theoretical">üìä Te√≥rico vs F√≠sico</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>üìä Dashboard de Almac√©n</h2>
            
            <div class="grid">
                <div class="card stats-card">
                    <div class="stats-number" id="total-fundidos">0</div>
                    <h3>üî• FUNDIDOS</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-acabados">0</div>
                    <h3>‚úÖ ACABADOS</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-upr">0</div>
                    <h3>üî∫ UPR</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-lwr">0</div>
                    <h3>üîª LWR</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-pallets">0</div>
                    <h3>üì¶ TARIMAS</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="verification-count">0</div>
                    <h3>üîç VERIFICADAS</h3>
                </div>                
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="exportData()">üìä Exportar Datos</button>
            </div>
        </div>

        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content">
            <h2>üì± Procesamiento de C√≥digos QR</h2>
            
            <div class="card">
                <h3>Procesar C√≥digo QR</h3>
                
                <div class="scanner-hint">
                    üí° <strong>Para Scanner F√≠sico:</strong> Posiciona el scanner sobre este campo de texto y escanea. 
                    El c√≥digo se capturar√° autom√°ticamente.
                </div>
                
                <div class="form-group">
                    <label>C√≥digo QR (Tarima o Individual):</label>
                    <textarea id="qr-input" rows="4" placeholder="Pega aqu√≠ el c√≥digo QR completo o usa el scanner f√≠sico..." autofocus></textarea>
                    <div id="qr-analysis"></div>
                </div>
                
                <div class="form-group">
                    <label>Tipo de Inventario:</label>
                    <select id="inventory-type">
                        <option value="movimiento">üì¶ Movimiento Normal</option>
                        <option value="inicial">üéØ Inventario Inicial</option>
                        <option value="turno">‚è∞ Inventario por Turno</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Turno:</label>
                    <select id="shift">
                        <option value="1">Primer Turno (07:00 am - 07:00 pm)</option>
                        <option value="2">Segundo Turno (07:00 pm - 07:00 am)</option>
                    </select>
                </div>
                
                <div class="form-group" id="individual-state-section" style="display: none;">
                    <label>Estado del Material (Pieza Individual):</label>
                    <select id="individual-state">
                        <option value="fundidos">üî• Fundido</option>
                        <option value="acabados">‚úÖ Acabado</option>
                    </select>
                </div>
                
                <div class="form-group" id="movement-destination-section" style="display: none;">
                    <label>Destino del Movimiento:</label>
                    <div class="warehouse-selector" id="movement-selector">
                        <div class="warehouse-btn" data-movement="envios">üì¶ ENV√çOS</div>
                        <div class="warehouse-btn" data-movement="retenciones">‚è∏Ô∏è RETENCIONES</div>
                        <div class="warehouse-btn" data-movement="scrap">‚ôªÔ∏è SCRAP</div>
                        <div class="warehouse-btn" data-movement="pruebas">üß™ PRUEBAS</div>
                    </div>
                </div>
                
                <div class="form-group" id="warehouse-override-section" style="display: none;">
                    <label>Forzar Almac√©n (Tarima sin estado detectado):</label>
                    <div class="warehouse-selector" id="warehouse-selector">
                        <div class="warehouse-btn" data-warehouse="fundidos">üî• FUNDIDOS</div>
                        <div class="warehouse-btn" data-warehouse="acabados">‚úÖ ACABADOS</div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="processQRCode()">‚úÖ Procesar C√≥digo QR</button>
                <button class="btn btn-info" onclick="clearForm()">üîÑ Limpiar</button>
                <button class="btn btn-warning" onclick="startNewShiftVerification()">üÜï Nuevo Turno</button>
            </div>

            <div id="process-result"></div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>üìã Inventario Detallado</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Limpiar Todos los Datos</button>
</div>
            <div class="card">
                <h3>üìä Inventario por Modelo y Estado</h3>
                <div id="detailed-inventory"></div>
            </div>
            
            <div class="card">
                <h3>üìä Resumen por N√∫mero de Parte</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>N√∫mero de Parte</th>
                            <th>Fundidos</th>
                            <th>Acabados</th>
                            <th>Env√≠os</th>
                            <th>Retenciones</th>
                            <th>Scrap</th>
                            <th>Pruebas</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="grouped-inventory-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Pallets Tab -->
        <div id="pallets" class="tab-content">
            <h2>üì¶ Gesti√≥n de Tarimas</h2>
            
            <div class="card">
                <h3>üìã Registro de Tarimas</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>ID Tarima</th>
                            <th>ID Original</th>
                            <th>Estado</th>
                            <th>Tipo</th>
                            <th>Piezas</th>
                            <th>Almac√©n</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="pallets-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Production Tab -->
<div id="production" class="tab-content">
    <h2>üè≠ Control de Producci√≥n</h2>
    
    <!-- Selector de Proceso -->
    <div class="card">
        <h3>üìã Seleccionar Proceso</h3>
        <div class="form-group">
            <label>Tipo de Reporte:</label>
            <select id="production-type" onchange="showProductionForm()">
                <option value="">Selecciona un proceso...</option>
                <option value="fundicion">üî• Reporte de Fundici√≥n</option>
                <option value="acabado">‚úÖ Reporte de Acabado</option>
                <option value="movimientos">üì¶ Movimientos de Material</option>
            </select>
        </div>
    </div>

    <!-- Formulario de Fundici√≥n -->
    <div id="fundicion-form" class="card" style="display: none;">
        <h3>üî• Reporte de Fundici√≥n</h3>
        <form id="production-fundicion-form">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>Fecha de Producci√≥n:</label>
                    <input type="date" id="fund-fecha" required>
                </div>
                <div class="form-group">
                    <label>Turno:</label>
                    <select id="fund-turno" required>
                        <option value="1">Primer Turno (07:00-19:00)</option>
                        <option value="2">Segundo Turno (19:00-07:00)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>M√°quina:</label>
                    <select id="fund-maquina" onchange="updateModelOptions('fund')" required>
                        <option value="">Seleccionar...</option>
                        <option value="30">M√°quina #30 (LWR)</option>
                        <option value="31">M√°quina #31 (LWR)</option>
                        <option value="32">M√°quina #32 (UPR)</option>
                        <option value="33">M√°quina #33 (UPR)</option>
                        <option value="34">M√°quina #34 (UPR)</option>
                    </select>
                </div>
            </div>
            
            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Modelo:</label>
                    <select id="fund-modelo" onchange="updateMoldeOptions('fund')" required>
                        <option value="">Primero selecciona m√°quina...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Molde:</label>
                    <select id="fund-molde" required>
                        <option value="">Primero selecciona modelo...</option>
                    </select>
                </div>
            </div>
            
            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>Cantidad Total Producida:</label>
                    <input type="number" id="fund-total" min="0" oninput="calculateGoodParts('fund')" required>
                </div>
                <div class="form-group">
                    <label>Cantidad NG (No Good):</label>
                    <input type="number" id="fund-ng" min="0" oninput="calculateGoodParts('fund')" required>
                </div>
                <div class="form-group">
                    <label>Piezas Buenas (Autom√°tico):</label>
                    <input type="number" id="fund-buenas" readonly style="background: #e9ecef;">
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
    <label>üìÑ Evidencia (PDF del reporte escaneado):</label>
    <div class="file-management-container">
        <input type="file" id="fund-evidencia" accept=".pdf" onchange="handleFileSelection('fund-evidencia')" style="display: none;">
        <div class="file-upload-area" onclick="document.getElementById('fund-evidencia').click()">
            <div id="fund-evidencia-status" class="file-status">
                <span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>
            </div>
        </div>
        <div id="fund-evidencia-actions" class="file-actions" style="display: none;">
            <button type="button" class="btn btn-sm btn-warning" onclick="replaceFile('fund-evidencia')">üîÑ Reemplazar</button>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeFile('fund-evidencia')">üóëÔ∏è Eliminar</button>
            <button type="button" class="btn btn-sm btn-info" onclick="viewFileHistory('fund-evidencia')">üìã Historial</button>
        </div>
    </div>
</div>
<button type="button" class="btn btn-success" onclick="saveProductionReport('fundicion')">üî• Guardar Reporte de Fundici√≥n</button>
        </form>
    </div>

    <!-- Formulario de Acabado -->
    <div id="acabado-form" class="card" style="display: none;">
        <h3>‚úÖ Reporte de Acabado</h3>
        <form id="production-acabado-form">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>Fecha de Producci√≥n:</label>
                    <input type="date" id="acab-fecha" required>
                </div>
                <div class="form-group">
                    <label>Turno:</label>
                    <select id="acab-turno" required>
                        <option value="1">Primer Turno (07:00-19:00)</option>
                        <option value="2">Segundo Turno (19:00-07:00)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>M√°quina de Acabado:</label>
                    <select id="acab-maquina" required>
                         <option value="">Seleccionar...</option>
                         <option value="30">Acabado AC-30</option>
                         <option value="31">Acabado AC-31</option>
                         <option value="32">Acabado AC-32</option>
                         <option value="33">Acabado AC-33</option>
                         <option value="34">Acabado AC-34</option>
                    </select>
                </div>      
                <div class="form-group">
                    <label>N√∫mero de parte:</label>
                    <select id="acab-modelo" required>
                        <option value="">Seleccionar...</option>
                        <option value="PX13-10-382">PX13-10-382 (LWR)</option>
                        <option value="PEDD-10-382-A">PEDD-10-382-A (LWR)</option>
                        <option value="P54G-10-382">P54G-10-382 (LWR)</option>
                        <option value="PX13-10-301">PX13-10-301 (UPR)</option>
                        <option value="PEDD-10-301-A">PEDD-10-301-A (UPR)</option>
                        <option value="P54G-10-301-A">P54G-10-301-A (UPR)</option>
                    </select>
                </div>
            </div>
            
            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>Cantidad Total Procesada:</label>
                    <input type="number" id="acab-total" min="0" oninput="calculateGoodParts('acab')" required>
                </div>
                <div class="form-group">
                    <label>Cantidad NG (No Good):</label>
                    <input type="number" id="acab-ng" min="0" oninput="calculateGoodParts('acab')" required>
                </div>
                <div class="form-group">
                    <label>Piezas Buenas (Autom√°tico):</label>
                    <input type="number" id="acab-buenas" readonly style="background: #e9ecef;">
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
    <label>üìÑ Evidencia (PDF del reporte escaneado):</label>
    <div class="file-management-container">
        <input type="file" id="acab-evidencia" accept=".pdf" onchange="handleFileSelection('acab-evidencia')" style="display: none;">
        <div class="file-upload-area" onclick="document.getElementById('acab-evidencia').click()">
            <div id="acab-evidencia-status" class="file-status">
                <span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>
            </div>
        </div>
        <div id="acab-evidencia-actions" class="file-actions" style="display: none;">
            <button type="button" class="btn btn-sm btn-warning" onclick="replaceFile('acab-evidencia')">üîÑ Reemplazar</button>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeFile('acab-evidencia')">üóëÔ∏è Eliminar</button>
            <button type="button" class="btn btn-sm btn-info" onclick="viewFileHistory('acab-evidencia')">üìã Historial</button>
        </div>
    </div>
</div>
<button type="button" class="btn btn-success" onclick="saveProductionReport('acabado')">‚úÖ Guardar Reporte de Acabado</button>
        </form>
    </div>

    <!-- Formulario de Movimientos -->
    <div id="movimientos-form" class="card" style="display: none;">
        <h3>üì¶ Movimientos de Material</h3>
        <form id="production-movimientos-form">
            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Tipo de Movimiento:</label>
                    <select id="mov-tipo" required>
                        <option value="">Seleccionar...</option>
                        <option value="scrap">‚ôªÔ∏è Scrap Adicional</option>
                        <option value="envios">üì¶ Env√≠os</option>
                        <option value="retenciones">‚è∏Ô∏è Retenciones</option>
                        <option value="pruebas">üß™ Pruebas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="mov-fecha" required>
                </div>
            </div>
            
            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
    <label>M√°quina/√Årea:</label>
    <select id="mov-maquina" required>
        <option value="">Seleccionar...</option>
        <option value="30">M√°quina #30 (LWR)</option>
        <option value="31">M√°quina #31 (LWR)</option>
        <option value="32">M√°quina #32 (UPR)</option>
        <option value="33">M√°quina #33 (UPR)</option>
        <option value="34">M√°quina #34 (UPR)</option>
        <option value="30">Acabado AC-30</option>
        <option value="31">Acabado AC-31</option>
        <option value="32">Acabado AC-32</option>
        <option value="33">Acabado AC-33</option>
        <option value="34">Acabado AC-34</option>
        <option value="ALMACEN">Almac√©n General</option>
        <option value="ENVIOS">√Årea de Env√≠os</option>
    </select>
</div>
<div class="form-group">
    <label>Modelo/N√∫mero de Parte:</label>
    <select id="mov-modelo" required>
                        <option value="">Seleccionar...</option>
                        <option value="PX13-10-382">PX13-10-382 (LWR)</option>
                        <option value="PEDD-10-382-A">PEDD-10-382-A (LWR)</option>
                        <option value="P54G-10-382">P54G-10-382 (LWR)</option>
                        <option value="PX13-10-301">PX13-10-301 (UPR)</option>
                        <option value="PEDD-10-301-A">PEDD-10-301-A (UPR)</option>
                        <option value="P54G-10-301-A">P54G-10-301-A (UPR)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cantidad:</label>
                    <input type="number" id="mov-cantidad" min="1" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Comentarios/Raz√≥n:</label>
                <textarea id="mov-comentarios" rows="3" placeholder="Describe la raz√≥n del movimiento..."></textarea>
            </div>
            <div class="form-group" style="margin-top: 20px;">
    <label>üìÑ Evidencia (PDF de la documentaci√≥n):</label>
    <div class="file-management-container">
        <input type="file" id="mov-evidencia" accept=".pdf" onchange="handleFileSelection('mov-evidencia')" style="display: none;">
        <div class="file-upload-area" onclick="document.getElementById('mov-evidencia').click()">
            <div id="mov-evidencia-status" class="file-status">
                <span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>
            </div>
        </div>
        <div id="mov-evidencia-actions" class="file-actions" style="display: none;">
            <button type="button" class="btn btn-sm btn-warning" onclick="replaceFile('mov-evidencia')">üîÑ Reemplazar</button>
            <button type="button" class="btn btn-sm btn-danger" onclick="removeFile('mov-evidencia')">üóëÔ∏è Eliminar</button>
            <button type="button" class="btn btn-sm btn-info" onclick="viewFileHistory('mov-evidencia')">üìã Historial</button>
        </div>
    </div>
</div>
<button type="button" class="btn btn-success" onclick="saveMovementReport()">üì¶ Guardar Movimiento</button>
        </form>
    </div>

    <!-- Resumen de Reportes -->
    <div class="card">
        <h3>üìä Reportes del Turno Actual</h3>
        <div id="production-summary"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-primary" onclick="generateTheoreticalBalance()">üßÆ Calcular Balance Te√≥rico</button>
            <button class="btn btn-info" onclick="showProductionReport()">üìã Ver Reporte Completo</button>
        </div>
    </div>
</div>
    <script>
        // Variables globales
        let inventory = [];
        let movements = [];
        let pallets = [];
        let selectedWarehouse = '';
        let selectedMovement = '';
        let palletCounter = 1;
        let theoreticalInventory = {}; // Para calcular inventario te√≥rico
        let physicalVerification = {}; // Para almacenar verificaciones f√≠sicas
        let shiftReports = []; // Para reportes por turno
        let productionReports = []; // Para almacenar reportes de producci√≥n
let movementReports = []; // Para almacenar movimientos de material
let theoreticalBalance = {}; // Para el balance te√≥rico calculado

// Configuraci√≥n de modelos por m√°quina
const MACHINE_MODELS = {
    '30': ['PX13-10-382-FUN', 'PEDD-10-382-A-FUN', 'P54G-10-382-FUN'],
    '31': ['PX13-10-382-FUN', 'PEDD-10-382-A-FUN', 'P54G-10-382-FUN'],
    '32': ['PX13-10-301-FUN', 'PEDD-10-301-A-FUN', 'P54G-10-301-A-FUN'],
    '33': ['PX13-10-301-FUN', 'PEDD-10-301-A-FUN', 'P54G-10-301-A-FUN'],
    '34': ['PX13-10-301-FUN', 'PEDD-10-301-A-FUN', 'P54G-10-301-A-FUN']
};

// Moldes disponibles (actualizados)
const MODEL_MOLDS = {
    'PX13-10-382-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'PEDD-10-382-A-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'P54G-10-382-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'PX13-10-301-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'PEDD-10-301-A-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'P54G-10-301-A-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2']
};

        const STATE_MAPPING = {
            'FUNDIDO': 'fundidos',
            'FUNDIDOS': 'fundidos',
            'ACABADO': 'acabados',
            'ACABADOS': 'acabados',
            'FINISHED': 'acabados',
            'CAST': 'fundidos'
        };
        
        // Funci√≥n para cambiar pesta√±as
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
        }

        function generatePalletId() {
            return 'PAL-' + String(palletCounter++).padStart(4, '0');
        }

        function checkExistingCodes(codes) {
            const existingCodes = [];
            const newCodes = [];
            
            codes.forEach(code => {
                const existing = inventory.find(item => item.code === code && item.quantity > 0);
                if (existing) {
                    existingCodes.push({ code: code, data: existing });
                } else {
                    newCodes.push(code);
                }
            });
            
            return { existingCodes, newCodes };
        }

        function getWarehouseName(warehouse) {
            const names = {
                'fundidos': 'üî• FUNDIDOS',
                'acabados': '‚úÖ ACABADOS',
                'scrap': '‚ôªÔ∏è SCRAP',
                'retenciones': '‚è∏Ô∏è RETENCIONES',
                'envios': 'üì¶ ENV√çOS',
                'pruebas': 'üß™ PRUEBAS'
            };
            return names[warehouse] || warehouse.toUpperCase();
        }

        function updateFormSections() {
            const inventoryType = document.getElementById('inventory-type').value;
            const movementSection = document.getElementById('movement-destination-section');
            
            if (inventoryType === 'movimiento') {
                movementSection.style.display = 'block';
            } else {
                movementSection.style.display = 'none';
                document.querySelectorAll('#movement-selector .warehouse-btn').forEach(btn => 
                    btn.classList.remove('selected'));
                selectedMovement = '';
            }
        }

function analyzeQRCode() {
   const input = document.getElementById('qr-input').value.trim();
   const analysisDiv = document.getElementById('qr-analysis');
   
   document.getElementById('warehouse-override-section').style.display = 'none';
   document.getElementById('individual-state-section').style.display = 'none';
   
   if (!input) {
       analysisDiv.innerHTML = '';
       return;
   }
   
   const analysis = parseQRCode(input);
   
   if (analysis.isPallet) {
       const codeCheck = checkExistingCodes(analysis.codes);
       
       if (!analysis.detectedState) {
           document.getElementById('warehouse-override-section').style.display = 'block';
       }
       
       analysisDiv.innerHTML = '<div class="alert alert-info"><strong>üéØ TARIMA DETECTADA</strong><br>' +
           '<span class="code-badge" style="background: #17a2b8;">ID: ' + analysis.palletId + '</span>' +
           '<span class="code-badge" style="background: #28a745;">' + analysis.type + '</span>' +
           '<span class="code-badge" style="background: #6c757d;">' + analysis.codes.length + ' piezas</span>' +
           '<span class="code-badge" style="background: #17a2b8;">' + codeCheck.newCodes.length + ' nuevas</span></div>';
       
   } else if (analysis.isValid) {
       const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
       
       if (existingItem) {
           analysisDiv.innerHTML = `
               <div class="existing-code">
                   <strong>‚ö†Ô∏è C√ìDIGO YA REGISTRADO</strong><br>
                   <span class="code-badge" style="background: #28a745;">${analysis.type}</span>
                   <span class="code-badge" style="background: #6c757d;">${analysis.code}</span>
                   
                   <div class="existing-info">
                       <strong>Informaci√≥n actual:</strong><br>
                       <span class="existing-badge" style="background: ${existingItem.state === 'FUNDIDOS' ? '#e74c3c' : '#27ae60'};">
                           ${existingItem.state}
                       </span>
                       <span class="existing-badge" style="background: #6c757d;">
                           ${getWarehouseName(existingItem.warehouse)}
                       </span>
                       <span class="existing-badge" style="background: #17a2b8;">
                           Cant: ${existingItem.quantity}
                       </span>
                       <br><small>√öltimo movimiento: ${formatLastMovement(existingItem.lastMovement)}</small>
                   </div>
               </div>
               
               <div class="alert alert-info">
                   <strong>üîÑ ¬øQuieres cambiar su estado?</strong><br>
                   Selecciona el nuevo estado abajo para transferir el c√≥digo.
               </div>
           `;
           
           document.getElementById('individual-state').value = existingItem.warehouse;
       } else {
           analysisDiv.innerHTML = `
               <div class="alert alert-success">
                   <strong>‚úÖ C√ìDIGO NUEVO</strong><br>
                   <span class="code-badge" style="background: #28a745;">${analysis.type}</span>
                   <span class="code-badge" style="background: #6c757d;">${analysis.code}</span>
                   <div class="auto-detect">üí° <strong>Selecciona el estado del material abajo</strong></div>
               </div>
           `;
       }
       
       document.getElementById('individual-state-section').style.display = 'block';
       
   } else {
       analysisDiv.innerHTML = '<div class="alert" style="background: #f8d7da; color: #721c24;">' +
           '‚ùå <strong>C√≥digo no v√°lido</strong></div>';
   }
   
   updateFormSections();
}
function parseQRCode(input) {
    if (input.includes('|')) {
        const parts = input.split('|');
        if (parts.length >= 3) {
            const palletId = parts[0];
            const state = parts[1];
            const codes = parts.slice(2).filter(code => code.trim().length > 0);
            
            let type = 'UNKNOWN';
            if (codes.length > 0) {
                const firstCode = codes[0];
                type = firstCode.length === 13 ? 'UPR' : 'LWR';
            }
            
            // Mejorar detecci√≥n de estado
            let detectedState = null;
            const stateUpper = state.toUpperCase();
            if (stateUpper.includes('FUNDIDO') || stateUpper.includes('CAST') || stateUpper.includes('MOLTEN')) {
    detectedState = 'fundidos';
} else if (stateUpper.includes('ACABADO') || stateUpper.includes('FINISHED')) {
    detectedState = 'acabados';
}
            return {
                isPallet: true,
                isValid: true,
                palletId: palletId,
                type: type,
                state: state,
                detectedState: detectedState,
                codes: codes
            };
        }
    } else {
        const cleanCode = input.trim();
        if (cleanCode.length === 13 || cleanCode.length === 17) {
            return {
                isPallet: false,
                isValid: true,
                code: cleanCode,
                type: cleanCode.length === 13 ? 'UPR' : 'LWR'
            };
        }
    }
    
    return { isPallet: false, isValid: false };
}
function extractCodeData(code) {
    if (code.length === 13) { // UPR
        const lote = code.substring(0, 3);
        const disparo = code.substring(3, 8);
        const maquinaRaw = parseInt(code.substring(8, 10));
        const maquina = maquinaRaw + 30;
        const modelo = code.substring(10, 12);
        const molde = code.substring(12, 13);
        
        return {
            type: 'UPR',
            lote,
            disparo,
            maquina,
            modelo,
            molde,
            partNumber: `UPR-${modelo}`
        };
    } else if (code.length === 17) { // LWR
        const lote = code.substring(0, 5);
        const maquina = parseInt(code.substring(5, 7));
        const molde = code.substring(7, 9);
        const disparo = code.substring(9, 15);
        const modelo = code.substring(15, 17);
        
        return {
            type: 'LWR',
            lote,
            disparo,
            maquina,
            modelo,
            molde,
            partNumber: `LWR-${modelo}`
        };
    }
    
    return null;
}
function processQRCode() {
    const input = document.getElementById('qr-input').value.trim();
    const inventoryType = document.getElementById('inventory-type').value;
    const shift = document.getElementById('shift').value;
    const resultDiv = document.getElementById('process-result');
    
    if (!input) {
        alert('Por favor escanea o pega un c√≥digo QR');
        return;
    }
    
    const analysis = parseQRCode(input);
    if (!analysis.isValid) {
        alert('C√≥digo QR no v√°lido');
        return;
    }
    // ========== NUEVAS VALIDACIONES ==========
    
    // Validaci√≥n para movimientos a env√≠os
    if (inventoryType === 'movimiento' && selectedMovement === 'envios') {
        if (analysis.isPallet) {
            // Para tarimas: verificar que todas las piezas est√©n acabadas
            const codesInWrongState = analysis.codes.filter(code => {
                const item = inventory.find(i => i.code === code && i.quantity > 0);
                return item && item.warehouse !== 'acabados';
            });
            
            if (codesInWrongState.length > 0) {
                alert('‚ö†Ô∏è ENV√çO NO PERMITIDO\n\nEsta tarima contiene piezas que NO est√°n acabadas.\n\nSolo se pueden enviar piezas ACABADAS.\n\nVerifica el estado de todas las piezas de la tarima.');
                return;
            }
        } else {
            // Para piezas individuales: verificar que est√© acabada
            const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
            if (existingItem && existingItem.warehouse !== 'acabados') {
                alert('‚ö†Ô∏è ENV√çO NO PERMITIDO\n\nEsta pieza NO est√° acabada.\n\nEstado actual: ' + getWarehouseName(existingItem.warehouse) + '\n\nSolo se pueden enviar piezas ACABADAS.');
                return;
            }
        }
    }
    
    // Validaci√≥n para evitar mover piezas desde estados restringidos
    if (inventoryType === 'movimiento') {
        const restrictedStates = ['scrap', 'retenciones', 'pruebas'];
        
        if (analysis.isPallet) {
            // Para tarimas: verificar que no vengan de estados restringidos
            const codesInRestrictedState = analysis.codes.filter(code => {
                const item = inventory.find(i => i.code === code && i.quantity > 0);
                return item && restrictedStates.includes(item.warehouse);
            });
            
            if (codesInRestrictedState.length > 0) {
                const restrictedItem = inventory.find(i => i.code === codesInRestrictedState[0] && i.quantity > 0);
                alert('‚ö†Ô∏è MOVIMIENTO NO PERMITIDO\n\nEsta tarima contiene piezas en estado restringido:\n\nEstado: ' + getWarehouseName(restrictedItem.warehouse) + '\n\nLas piezas en Scrap, Retenciones o Pruebas no se pueden mover.');
                return;
            }
        } else {
            // Para piezas individuales: verificar que no est√© en estado restringido
            const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
            if (existingItem && restrictedStates.includes(existingItem.warehouse)) {
                alert('‚ö†Ô∏è MOVIMIENTO NO PERMITIDO\n\nEsta pieza est√° en estado restringido:\n\nEstado actual: ' + getWarehouseName(existingItem.warehouse) + '\n\nLas piezas en Scrap, Retenciones o Pruebas no se pueden mover.');
                return;
            }
        }
    }
    
    // ========== FIN DE VALIDACIONES ==========
    
    // Contin√∫a con el resto del c√≥digo original...
    let processedCount = 0;
    let targetWarehouse = '';
    let processedCount = 0;
    let targetWarehouse = '';
    
    if (analysis.isPallet) {
        const codeCheck = checkExistingCodes(analysis.codes);
        
        // VERIFICACI√ìN F√çSICA - Inventario por Turno
        if (inventoryType === 'turno') {
            let targetWarehouse = '';
            
            if (analysis.detectedState) {
                targetWarehouse = analysis.detectedState;
            } else {
                if (!selectedWarehouse) {
                    alert('Por favor selecciona Fundidos o Acabados para la verificaci√≥n f√≠sica');
                    return;
                }
                targetWarehouse = selectedWarehouse;
            }
            
            // Verificar si ya fue escaneada en este turno
            const alreadyScanned = analysis.codes.some(code => 
                physicalVerification[code] && 
                physicalVerification[code].shift === shift
            );

            if (alreadyScanned) {
                alert(`‚ö†Ô∏è TARIMA YA VERIFICADA\n\nEsta tarima ya fue escaneada en el turno ${shift}.\n\nNo se permite verificar la misma tarima dos veces en el mismo turno.`);
                return;
            }
            
            analysis.codes.forEach(code => {
                const codeData = extractCodeData(code);
                if (!physicalVerification[code]) {
                    physicalVerification[code] = {
                        code: code,
                        partNumber: codeData ? codeData.partNumber : 'Unknown',
                        type: analysis.type,
                        verifiedQuantity: 0,
                        lastVerified: new Date(),
                        shift: shift,
                        warehouse: targetWarehouse,
                        palletId: analysis.palletId
                    };
                }
                physicalVerification[code].verifiedQuantity += 1;
                physicalVerification[code].lastVerified = new Date();
            });
            
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    üîç <strong>Tarima verificada f√≠sicamente</strong><br>
                    üì¶ ID Original: ${analysis.palletId}<br>
                    üìä ${analysis.codes.length} piezas verificadas ${analysis.type}<br>
                    üè™ Estado verificado: ${getWarehouseName(targetWarehouse)}<br>
                    ‚è∞ Turno: ${shift} - Verificaci√≥n f√≠sica (NO modifica inventario)
                </div>
            `;
            
            updateAllDisplays();
            clearForm();
            setTimeout(() => resultDiv.innerHTML = '', 6000);
            return; // Salir aqu√≠ para evitar el resto del procesamiento
        }
        
        // MOVIMIENTOS O INVENTARIOS INICIALES DE TARIMAS
        if (inventoryType === 'movimiento') {
            if (!selectedMovement) {
                alert('Por favor selecciona el destino del movimiento');
                return;
            }
            targetWarehouse = selectedMovement;
        } else {
            if (analysis.detectedState) {
                targetWarehouse = analysis.detectedState;
            } else {
                if (!selectedWarehouse) {
                    alert('Por favor selecciona Fundidos o Acabados manualmente');
                    return;
                }
                targetWarehouse = selectedWarehouse;
            }
        }
        
        const palletSystemId = generatePalletId();
        
        // Manejar cuando todos los c√≥digos ya existen - permitir transferencia
        if (codeCheck.newCodes.length === 0 && codeCheck.existingCodes.length > 0) {
            // Detectar si es transferencia l√≥gica (fundidos -> acabados)
            const currentState = codeCheck.existingCodes[0].data.warehouse;
            const isLogicalTransfer = (currentState === 'fundidos' && targetWarehouse === 'acabados') || 
                                     (currentState === 'acabados' && targetWarehouse === 'fundidos');

            const transferMessage = isLogicalTransfer ? 
                `üîÑ PROCESAMIENTO DE TARIMA\n\nEsta tarima ya est√° registrada en ${getWarehouseName(currentState)}.\n¬øQuieres procesarla y moverla a ${getWarehouseName(targetWarehouse)}?` :
                `üîÑ TRANSFERENCIA DE TARIMA\n\nTodos los c√≥digos ya existen en el sistema.\n¬øQuieres transferir esta tarima completa a ${getWarehouseName(targetWarehouse)}?`;

            const confirmTransfer = confirm(`${transferMessage}\n\n‚úÖ Aceptar = Transferir\n‚ùå Cancelar = No hacer nada`);
            
            if (!confirmTransfer) {
                return;
            }
            
            // Transferir todos los c√≥digos existentes
            codeCheck.existingCodes.forEach(existingItem => {
                const item = existingItem.data;
                item.warehouse = targetWarehouse;
                item.state = targetWarehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
                item.lastMovement = new Date();
                item.palletId = palletSystemId;
                
                movements.push({
                    id: Date.now() + Math.random(),
                    code: item.code,
                    partNumber: item.partNumber,
                    type: 'transferencia',
                    warehouse: targetWarehouse,
                    quantity: 1,
                    date: new Date(),
                    shift: shift,
                    palletId: palletSystemId
                });
            });
            
            processedCount = codeCheck.existingCodes.length;
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>Tarima transferida exitosamente</strong><br>
                    üÜî ID Sistema: <strong>${palletSystemId}</strong><br>
                    üì¶ ID Original: ${analysis.palletId}<br>
                    üîÑ ${processedCount} piezas TRANSFERIDAS ${analysis.type}<br>
                    üè™ Destino: ${getWarehouseName(targetWarehouse)}<br>
                    üìä Tipo: transferencia - Turno ${shift}
                </div>
            `;
            
            clearForm();
            updateAllDisplays();
            setTimeout(() => resultDiv.innerHTML = '', 6000);
            return;
        }
        
        // Procesar c√≥digos nuevos normalmente
        if (codeCheck.newCodes.length === 0) {
            alert('‚ö†Ô∏è Todos los c√≥digos ya existen y no se confirm√≥ transferencia');
            return;
        }
        
        const palletRecord = {
            systemId: palletSystemId,
            originalId: analysis.palletId,
            state: targetWarehouse,
            type: analysis.type,
            codesCount: codeCheck.newCodes.length,
            warehouse: targetWarehouse,
            codes: codeCheck.newCodes,
            createdDate: new Date(),
            inventoryType: inventoryType,
            shift: shift,
            duplicatesFound: codeCheck.existingCodes.length
        };
        
        pallets.push(palletRecord);
        
        codeCheck.newCodes.forEach(code => {
            processIndividualCode(code, analysis.type, inventoryType, shift, targetWarehouse, palletSystemId);
            processedCount++;
        });
        
        const duplicateInfo = codeCheck.existingCodes.length > 0 ? 
            `<br>‚ö†Ô∏è ${codeCheck.existingCodes.length} c√≥digos duplicados omitidos` : '';
        
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                ‚úÖ <strong>Tarima procesada exitosamente</strong><br>
                üÜî ID Sistema: <strong>${palletSystemId}</strong><br>
                üì¶ ID Original: ${analysis.palletId}<br>
                üìä ${processedCount} piezas NUEVAS ${analysis.type}<br>
                üè™ Destino: ${getWarehouseName(targetWarehouse)}<br>
                üîÑ Tipo: ${inventoryType} - Turno ${shift}${duplicateInfo}
            </div>
        `;
        
    } else {
        // PIEZAS INDIVIDUALES
        const individualState = document.getElementById('individual-state').value;
        const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
        
        if (inventoryType === 'movimiento') {
            // MOVIMIENTO DE PIEZA INDIVIDUAL
            if (!selectedMovement) {
                alert('Por favor selecciona el destino del movimiento');
                return;
            }
            
            targetWarehouse = selectedMovement;
            processIndividualCode(analysis.code, analysis.type, inventoryType, shift, targetWarehouse);
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>C√≥digo movido exitosamente</strong><br>
                    üì¶ ${analysis.code}<br>
                    üè™ Destino: ${getWarehouseName(targetWarehouse)}<br>
                    üîÑ Tipo: movimiento - Turno ${shift}
                </div>
            `;
            
        } else if (inventoryType === 'turno') {
            // VERIFICACI√ìN F√çSICA DE PIEZA INDIVIDUAL
            let targetWarehouse = individualState;
            
            // Verificar si ya fue escaneada
            if (physicalVerification[analysis.code] && 
                physicalVerification[analysis.code].shift === shift) {
                alert(`‚ö†Ô∏è PIEZA YA VERIFICADA\n\nEsta pieza ya fue verificada en el turno ${shift}.`);
                return;
            }
            
            const codeData = extractCodeData(analysis.code);
            physicalVerification[analysis.code] = {
                code: analysis.code,
                partNumber: codeData ? codeData.partNumber : 'Unknown',
                type: 'individual',
                verifiedQuantity: 1,
                lastVerified: new Date(),
                shift: shift,
                warehouse: targetWarehouse,
                palletId: null
            };
            
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    üîç <strong>Pieza individual verificada</strong><br>
                    üì¶ C√≥digo: ${analysis.code}<br>
                    üè™ Estado verificado: ${getWarehouseName(targetWarehouse)}<br>
                    ‚è∞ Turno: ${shift} - Verificaci√≥n f√≠sica
                </div>
            `;
            
        } else {
            // INVENTARIO INICIAL DE PIEZA INDIVIDUAL
            if (existingItem) {
                if (existingItem.warehouse === individualState) {
                    alert(`‚ö†Ô∏è C√ìDIGO YA REGISTRADO\n\nEl c√≥digo ${analysis.code} ya est√° registrado en ${getWarehouseName(individualState)}.\n\nCantidad actual: ${existingItem.quantity}\n√öltimo registro: ${formatLastMovement(existingItem.lastMovement)}`);
                    return;
                } else {
                    const confirmChange = confirm(`üîÑ CAMBIO DE ESTADO DETECTADO\n\nEl c√≥digo ${analysis.code} est√° actualmente en:\n${getWarehouseName(existingItem.warehouse)}\n\n¬øQuieres moverlo a ${getWarehouseName(individualState)}?\n\n‚úÖ Aceptar = Mover\n‚ùå Cancelar = No hacer nada`);
                    
                    if (!confirmChange) {
                        clearForm();
                        return;
                    }
                }
            }
            
            targetWarehouse = individualState;
            processIndividualCode(analysis.code, analysis.type, inventoryType, shift, targetWarehouse);
            
            const statusMessage = existingItem ? 
                `<br>üîÑ C√≥digo movido desde ${getWarehouseName(existingItem.warehouse)}` : 
                '<br>‚ú® C√≥digo nuevo registrado';
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>C√≥digo individual procesado</strong><br>
                    üì¶ ${analysis.code}<br>
                    üè™ Registrado en: ${getWarehouseName(targetWarehouse)}<br>
                    üìä Estado: ${getWarehouseName(individualState)}<br>
                    üîÑ Tipo: ${inventoryType} - Turno ${shift}${statusMessage}
                </div>
            `;
        }
    }
    
    clearForm();
    updateAllDisplays();
    setTimeout(() => resultDiv.innerHTML = '', 6000);
}

        function clearForm() {
            document.getElementById('qr-input').value = '';
            document.getElementById('qr-analysis').innerHTML = '';
            
            document.getElementById('warehouse-override-section').style.display = 'none';
            document.getElementById('individual-state-section').style.display = 'none';
            document.getElementById('movement-destination-section').style.display = 'none';
            
            document.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            selectedWarehouse = '';
            selectedMovement = '';
            
            document.getElementById('qr-input').focus();
        }

function processIndividualCode(code, type, movementType, shift, warehouse, palletId = null) {
    const codeData = extractCodeData(code);
    const partNumber = codeData ? codeData.partNumber : (type === 'UPR' ? 'PX13-10-301' : 'PX13-10-382');
    
    let item = inventory.find(i => i.code === code);
    
    if (!item) {
        item = {
            code: code,
            partNumber: partNumber,
            type: type,
            state: warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS',
            warehouse: warehouse,
            quantity: 0,
            lastMovement: new Date(),
            shift: shift,
            palletId: palletId,
            codeData: codeData
        };
        inventory.push(item);
    }
    
    // Manejar transferencia de fundidos a acabados
    if (movementType === 'movimiento' || (item.warehouse !== warehouse && item.quantity > 0)) {
        item.warehouse = warehouse;
        item.state = warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
        item.lastMovement = new Date();
        item.palletId = palletId;
    } else {
        item.quantity += 1;
        item.warehouse = warehouse;
        item.state = warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
        item.lastMovement = new Date();
        item.palletId = palletId;
    }
    
    movements.push({
        id: Date.now() + Math.random(),
        code: code,
        partNumber: partNumber,
        type: movementType,
        warehouse: warehouse,
        quantity: 1,
        date: new Date(),
        shift: shift,
        palletId: palletId
    });
}
function movePallet(palletId) {
    const pallet = pallets.find(p => p.systemId === palletId);
    if (!pallet) {
        alert('Tarima no encontrada');
        return;
    }
    
    // Crear modal con selector
    const modalHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" id="moveModal">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                <h3>üì¶ Mover Tarima ${palletId}</h3>
                <p style="margin: 15px 0; color: #666;">Estado actual: ${getWarehouseName(pallet.warehouse)}</p>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Selecciona el almac√©n destino:</label>
                    <div class="warehouse-selector" id="move-warehouse-selector">
                        <div class="warehouse-btn" data-warehouse="fundidos">üî• FUNDIDOS</div>
                        <div class="warehouse-btn" data-warehouse="acabados">‚úÖ ACABADOS</div>
                        <div class="warehouse-btn" data-warehouse="scrap">‚ôªÔ∏è SCRAP</div>
                        <div class="warehouse-btn" data-warehouse="retenciones">‚è∏Ô∏è RETENCIONES</div>
                        <div class="warehouse-btn" data-warehouse="envios">üì¶ ENV√çOS</div>
                        <div class="warehouse-btn" data-warehouse="pruebas">üß™ PRUEBAS</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="confirmPalletMove('${palletId}')" id="confirmMoveBtn" disabled>‚úÖ Confirmar Movimiento</button>
                    <button class="btn btn-danger" onclick="closeMoveModal()" style="margin-left: 10px;">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Event listener para selector
    document.getElementById('move-warehouse-selector').addEventListener('click', function(e) {
        if (e.target.classList.contains('warehouse-btn')) {
            this.querySelectorAll('.warehouse-btn').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            document.getElementById('confirmMoveBtn').disabled = false;
            window.selectedMoveWarehouse = e.target.dataset.warehouse;
        }
    });
}

function confirmPalletMove(palletId) {
    if (!window.selectedMoveWarehouse) return;
    
    const pallet = pallets.find(p => p.systemId === palletId);
    const newWarehouse = window.selectedMoveWarehouse;
    
    // VALIDACI√ìN: Solo acabadas pueden ir a env√≠os
    if (newWarehouse === 'envios' && pallet.state !== 'acabados') {
        alert('‚ö†Ô∏è MOVIMIENTO NO PERMITIDO\n\nSolo las tarimas ACABADAS pueden enviarse.\n\nEsta tarima est√° en estado: ' + getWarehouseName(pallet.state));
        return;
    }
    
    pallet.warehouse = newWarehouse;
    pallet.state = newWarehouse;
    
    inventory.forEach(item => {
        if (item.palletId === palletId) {
            item.warehouse = newWarehouse;
            item.state = newWarehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
            item.lastMovement = new Date();
        }
    });
    
    alert('‚úÖ Tarima ' + palletId + ' movida a ' + getWarehouseName(newWarehouse));
    updateAllDisplays();
    closeMoveModal();
}

function closeMoveModal() {
    const modal = document.getElementById('moveModal');
    if (modal) modal.remove();
    window.selectedMoveWarehouse = null;
}

        function viewPalletDetails(palletId) {
            const pallet = pallets.find(function(p) {
                return p.systemId === palletId;
            });
            if (!pallet) {
                alert('Tarima no encontrada');
                return;
            }

            const codes = pallet.codes.length > 10 ? 
                pallet.codes.slice(0, 10).join('\n') + '\n... y ' + (pallet.codes.length - 10) + ' m√°s' :
                pallet.codes.join('\n');

            alert('üì¶ DETALLES DE TARIMA\n\nüÜî ID: ' + pallet.systemId + '\nüìã Original: ' + pallet.originalId + '\nüîß Tipo: ' + pallet.type + '\nüì¶ Piezas: ' + pallet.codesCount + '\nüè™ Almac√©n: ' + getWarehouseName(pallet.warehouse) + '\n\nüìã C√ìDIGOS:\n' + codes);
        }

        function exportData() {
            const data = {
                inventory: inventory,
                movements: movements,
                pallets: pallets,
                exportDate: new Date()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'almacen-completo-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

   function loadSampleData() {
    const samples = [
        { code: 'P6102448O2P52', type: 'UPR' },
        { code: '25E153003154276P5', type: 'LWR' },
        { code: 'P6205362O3P54', type: 'UPR' },
        { code: '25F164004265387P7', type: 'LWR' }
    ];
    
    samples.forEach(function(sample) {
        const codeData = extractCodeData(sample.code);
        if (codeData) {
            inventory.push({
                code: sample.code,
                partNumber: codeData.partNumber,
                type: sample.type,
                state: 'ACABADOS',
                warehouse: 'acabados',
                quantity: Math.floor(Math.random() * 15) + 5,
                lastMovement: new Date(),
                shift: '1',
                palletId: null,
                codeData: codeData
            });
        }
    });

    const samplePallet = {
        systemId: generatePalletId(),
        originalId: 'TARM001',
        state: 'acabados',
        type: 'UPR',
        codesCount: 3,
        warehouse: 'acabados',
        codes: ['P6102448O2P52', 'P6205362O3P54', 'P6308476O4P56'],
        createdDate: new Date()
    };
    pallets.push(samplePallet);
}
        function formatLastMovement(date) {
    if (!date) return 'N/A';
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    
    if (minutes < 1) return 'Ahora mismo';
    if (minutes < 60) return `Hace ${minutes} min`;
    if (minutes < 1440) return `Hace ${Math.floor(minutes / 60)} hrs`;
    return date.toLocaleDateString();
}
       function calculateTheoreticalInventory() {
    const theoretical = {};
    
    // 1. Partir del inventario actual real como base
    inventory.forEach(item => {
        if (item.quantity > 0) {
            if (!theoretical[item.partNumber]) {
                theoretical[item.partNumber] = { fundidos: 0, acabados: 0 };
            }
            
            if (item.warehouse === 'fundidos') {
                theoretical[item.partNumber].fundidos += item.quantity;
            } else if (item.warehouse === 'acabados') {
                theoretical[item.partNumber].acabados += item.quantity;
            }
        }
    });
    
    return theoretical;
}
                function startNewShiftVerification() {
    const confirmReset = confirm('üîÑ NUEVO TURNO\n\n¬øQuieres limpiar las verificaciones f√≠sicas del turno anterior para comenzar una nueva verificaci√≥n?\n\n‚úÖ S√≠ = Limpiar verificaciones\n‚ùå No = Mantener datos actuales');
    
    if (confirmReset) {
        physicalVerification = {};
        alert('‚úÖ Verificaciones f√≠sicas limpiadas. Puedes comenzar el nuevo turno.');
        updateAllDisplays();
    }
}
        function showVerificationProgress() {
    if (Object.keys(physicalVerification).length === 0) {
        return '<div class="alert alert-info">No hay verificaciones f√≠sicas registradas en este turno.</div>';
    }
    
    let progressHtml = '<h4>üìä Progreso de Verificaci√≥n F√≠sica:</h4>';
    progressHtml += '<table class="inventory-table"><thead><tr><th>C√≥digo</th><th>N√∫mero de Parte</th><th>Tipo</th><th>Estado</th><th>Cantidad Verificada</th></tr></thead><tbody>';
    
    Object.values(physicalVerification).forEach(item => {
        progressHtml += `<tr>
            <td style="font-family: monospace;">${item.code}</td>
            <td>${item.partNumber}</td>
            <td><span class="code-badge" style="background: #17a2b8;">${item.type}</span></td>
            <td><span class="code-badge" style="background: ${item.warehouse === 'fundidos' ? '#e74c3c' : '#27ae60'};">${getWarehouseName(item.warehouse)}</span></td>
            <td style="text-align: center; font-weight: bold;">${item.verifiedQuantity}</td>
        </tr>`;
    });
    
    progressHtml += '</tbody></table>';
    return progressHtml;
}
        function showCurrentVerification() {
    document.getElementById('current-verification').innerHTML = showVerificationProgress();
}
        function generateTheoreticalReport() {
    const theoretical = calculateTheoreticalInventory();
    const summaryDiv = document.getElementById('theoretical-summary');
    const comparisonDiv = document.getElementById('verification-comparison');
    const discrepanciesDiv = document.getElementById('discrepancies-report');
    
    // Mostrar inventario te√≥rico
    let theoreticalHtml = '<h4>üìã Inventario Te√≥rico Calculado:</h4><table class="inventory-table"><thead><tr><th>N√∫mero de Parte</th><th>Fundidos</th><th>Acabados</th><th>Total Disponible</th></tr></thead><tbody>';
    
    Object.keys(theoretical).forEach(partNumber => {
        const data = theoretical[partNumber];
        const available = data.fundidos + data.acabados;
        theoreticalHtml += `<tr><td>${partNumber}</td><td>üî• ${data.fundidos}</td><td>‚úÖ ${data.acabados}</td><td><strong>${available}</strong></td></tr>`;
    });
    
    theoreticalHtml += '</tbody></table>';
    summaryDiv.innerHTML = theoreticalHtml;
    
    // Generar comparaci√≥n con verificaci√≥n f√≠sica
    generateComparisonReport(theoretical, comparisonDiv, discrepanciesDiv);
}

function generateComparisonReport(theoretical, comparisonDiv, discrepanciesDiv) {
    let comparisonHtml = '<h4>üîç Comparaci√≥n F√≠sico vs Te√≥rico:</h4>';
    let discrepanciesHtml = '';
    let hasDiscrepancies = false;
    
    // Agrupar verificaciones f√≠sicas por n√∫mero de parte
    const physicalByPart = {};
    Object.values(physicalVerification).forEach(item => {
        if (!physicalByPart[item.partNumber]) {
            physicalByPart[item.partNumber] = { fundidos: 0, acabados: 0 };
        }
        if (item.warehouse === 'fundidos') {
            physicalByPart[item.partNumber].fundidos += item.verifiedQuantity;
        } else if (item.warehouse === 'acabados') {
            physicalByPart[item.partNumber].acabados += item.verifiedQuantity;
        }
    });
    
    comparisonHtml += '<table class="inventory-table"><thead><tr><th>N√∫mero de Parte</th><th>Estado</th><th>Te√≥rico</th><th>F√≠sico</th><th>Diferencia</th><th>Status</th></tr></thead><tbody>';
    
    // Comparar cada n√∫mero de parte
    const allParts = new Set([...Object.keys(theoretical), ...Object.keys(physicalByPart)]);
    
    allParts.forEach(partNumber => {
        const theo = theoretical[partNumber] || { fundidos: 0, acabados: 0 };
        const phys = physicalByPart[partNumber] || { fundidos: 0, acabados: 0 };
        
        // Verificar fundidos
        const diffFundidos = phys.fundidos - theo.fundidos;
        const statusFundidos = diffFundidos === 0 ? '‚úÖ OK' : (diffFundidos > 0 ? '‚¨ÜÔ∏è Exceso' : '‚¨áÔ∏è Faltante');
        
        comparisonHtml += `<tr><td>${partNumber}</td><td>üî• Fundidos</td><td>${theo.fundidos}</td><td>${phys.fundidos}</td><td style="color: ${diffFundidos === 0 ? 'green' : 'red'};">${diffFundidos > 0 ? '+' : ''}${diffFundidos}</td><td>${statusFundidos}</td></tr>`;
        
        // Verificar acabados
        const diffAcabados = phys.acabados - theo.acabados;
        const statusAcabados = diffAcabados === 0 ? '‚úÖ OK' : (diffAcabados > 0 ? '‚¨ÜÔ∏è Exceso' : '‚¨áÔ∏è Faltante');
        
        comparisonHtml += `<tr><td>${partNumber}</td><td>‚úÖ Acabados</td><td>${theo.acabados}</td><td>${phys.acabados}</td><td style="color: ${diffAcabados === 0 ? 'green' : 'red'};">${diffAcabados > 0 ? '+' : ''}${diffAcabados}</td><td>${statusAcabados}</td></tr>`;
        
        // Registrar discrepancias
        if (diffFundidos !== 0 || diffAcabados !== 0) {
            hasDiscrepancies = true;
            discrepanciesHtml += `<div class="alert" style="background: #f8d7da; color: #721c24; margin: 10px 0;"><strong>‚ö†Ô∏è ${partNumber}</strong><br>`;
            if (diffFundidos !== 0) {
                discrepanciesHtml += `üî• Fundidos: ${diffFundidos > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diffFundidos)} piezas<br>`;
            }
            if (diffAcabados !== 0) {
                discrepanciesHtml += `‚úÖ Acabados: ${diffAcabados > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diffAcabados)} piezas<br>`;
            }
            discrepanciesHtml += '</div>';
        }
    });
    
    comparisonHtml += '</tbody></table>';
    comparisonDiv.innerHTML = comparisonHtml;
    
    if (hasDiscrepancies) {
        discrepanciesDiv.innerHTML = '<h4>‚ö†Ô∏è Diferencias Encontradas:</h4>' + discrepanciesHtml;
    } else {
        discrepanciesDiv.innerHTML = '<div class="alert alert-success"><h4>‚úÖ ¬°Perfecto!</h4>No se encontraron diferencias entre el inventario te√≥rico y f√≠sico.</div>';
    }
}
        function exportVerificationReport() {
    const theoretical = calculateTheoreticalInventory();
    const discrepancies = calculateDiscrepancies(theoretical);
    const currentDate = new Date().toLocaleDateString('es-ES');
    const currentTime = new Date().toLocaleTimeString('es-ES');
    const shift = document.getElementById('shift').value;
    
    // Agrupar verificaciones f√≠sicas por n√∫mero de parte
    const physicalByPart = {};
    Object.values(physicalVerification).forEach(item => {
        if (!physicalByPart[item.partNumber]) {
            physicalByPart[item.partNumber] = { fundidos: 0, acabados: 0 };
        }
        if (item.warehouse === 'fundidos') {
            physicalByPart[item.partNumber].fundidos += item.verifiedQuantity;
        } else if (item.warehouse === 'acabados') {
            physicalByPart[item.partNumber].acabados += item.verifiedQuantity;
        }
    });
    
    // Calcular totales
    const totalTeorico = Object.values(theoretical).reduce((sum, item) => sum + item.fundidos + item.acabados, 0);
    const totalVerificado = Object.values(physicalVerification).reduce((sum, item) => sum + item.verifiedQuantity, 0);
    const codigosVerificados = Object.keys(physicalVerification).length;
    
    // Crear contenido HTML para el PDF
    let htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Reporte de Verificaci√≥n de Inventario</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    line-height: 1.4;
                    color: #333;
                }
                .header { 
                    text-align: center; 
                    border-bottom: 3px solid #e74c3c; 
                    padding-bottom: 20px; 
                    margin-bottom: 30px;
                }
                .company-name {
                    font-size: 24px;
                    font-weight: bold;
                    color: #e74c3c;
                    margin-bottom: 5px;
                }
                .report-title {
                    font-size: 18px;
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                .report-info {
                    font-size: 14px;
                    color: #666;
                }
                .section { 
                    margin: 25px 0; 
                    page-break-inside: avoid;
                }
                .section-title { 
                    font-size: 16px; 
                    font-weight: bold; 
                    color: #2c3e50; 
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 5px;
                    margin-bottom: 15px;
                }
                .summary-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 20px;
                    margin: 20px 0;
                }
                .summary-card {
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 15px;
                    text-align: center;
                    background: #f8f9fa;
                }
                .summary-number {
                    font-size: 24px;
                    font-weight: bold;
                    color: #e74c3c;
                }
                .summary-label {
                    font-size: 12px;
                    color: #666;
                    margin-top: 5px;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 15px 0;
                    font-size: 12px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 8px; 
                    text-align: left; 
                }
                th { 
                    background-color: #34495e; 
                    color: white; 
                    font-weight: bold;
                }
                tr:nth-child(even) { 
                    background-color: #f9f9f9; 
                }
                .difference-positive { color: #27ae60; font-weight: bold; }
                .difference-negative { color: #e74c3c; font-weight: bold; }
                .difference-zero { color: #2c3e50; }
                .status-ok { color: #27ae60; font-weight: bold; }
                .status-issue { color: #e74c3c; font-weight: bold; }
                .alert-success {
                    background: #d4edda;
                    border: 1px solid #c3e6cb;
                    color: #155724;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                }
                .alert-warning {
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                }
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="company-name">üè≠ CONTROL DE ALMAC√âN - FUNDICI√ìN</div>
                <div class="report-title">üìä REPORTE DE VERIFICACI√ìN DE INVENTARIO</div>
                <div class="report-info">
                    üìÖ Fecha: ${currentDate} | ‚è∞ Hora: ${currentTime} | üîÑ Turno: ${shift}
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìã RESUMEN EJECUTIVO</div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-number">${codigosVerificados}</div>
                        <div class="summary-label">C√≥digos Verificados</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${Object.keys(theoretical).length}</div>
                        <div class="summary-label">N√∫meros de Parte</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${Object.keys(discrepancies).length}</div>
                        <div class="summary-label">Diferencias Encontradas</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìä INVENTARIO TE√ìRICO</div>
                <table>
                    <thead>
                        <tr>
                            <th>N√∫mero de Parte</th>
                            <th>üî• Fundidos</th>
                            <th>‚úÖ Acabados</th>
                            <th>Total Disponible</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Agregar datos del inventario te√≥rico
    Object.keys(theoretical).forEach(partNumber => {
        const data = theoretical[partNumber];
        const available = data.fundidos + data.acabados;
        htmlContent += `
            <tr>
                <td><strong>${partNumber}</strong></td>
                <td style="text-align: center;">${data.fundidos}</td>
                <td style="text-align: center;">${data.acabados}</td>
                <td style="text-align: center;"><strong>${available}</strong></td>
            </tr>
        `;
    });
    
    htmlContent += `
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">üîç COMPARACI√ìN F√çSICO vs TE√ìRICO</div>
                <table>
                    <thead>
                        <tr>
                            <th>N√∫mero de Parte</th>
                            <th>Estado</th>
                            <th>Te√≥rico</th>
                            <th>F√≠sico</th>
                            <th>Diferencia</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Agregar comparaci√≥n
    const allParts = new Set([...Object.keys(theoretical), ...Object.keys(physicalByPart)]);
    allParts.forEach(partNumber => {
        const theo = theoretical[partNumber] || { fundidos: 0, acabados: 0 };
        const phys = physicalByPart[partNumber] || { fundidos: 0, acabados: 0 };
        
        // Fila de fundidos
        const diffFundidos = phys.fundidos - theo.fundidos;
        const statusFundidos = diffFundidos === 0 ? '‚úÖ OK' : (diffFundidos > 0 ? '‚¨ÜÔ∏è Exceso' : '‚¨áÔ∏è Faltante');
        const classFundidos = diffFundidos === 0 ? 'difference-zero' : (diffFundidos > 0 ? 'difference-positive' : 'difference-negative');
        const statusClassFundidos = diffFundidos === 0 ? 'status-ok' : 'status-issue';
        
        htmlContent += `
            <tr>
                <td><strong>${partNumber}</strong></td>
                <td>üî• Fundidos</td>
                <td style="text-align: center;">${theo.fundidos}</td>
                <td style="text-align: center;">${phys.fundidos}</td>
                <td style="text-align: center;" class="${classFundidos}">${diffFundidos > 0 ? '+' : ''}${diffFundidos}</td>
                <td class="${statusClassFundidos}">${statusFundidos}</td>
            </tr>
        `;
        
        // Fila de acabados
        const diffAcabados = phys.acabados - theo.acabados;
        const statusAcabados = diffAcabados === 0 ? '‚úÖ OK' : (diffAcabados > 0 ? '‚¨ÜÔ∏è Exceso' : '‚¨áÔ∏è Faltante');
        const classAcabados = diffAcabados === 0 ? 'difference-zero' : (diffAcabados > 0 ? 'difference-positive' : 'difference-negative');
        const statusClassAcabados = diffAcabados === 0 ? 'status-ok' : 'status-issue';
        
        htmlContent += `
            <tr>
                <td></td>
                <td>‚úÖ Acabados</td>
                <td style="text-align: center;">${theo.acabados}</td>
                <td style="text-align: center;">${phys.acabados}</td>
                <td style="text-align: center;" class="${classAcabados}">${diffAcabados > 0 ? '+' : ''}${diffAcabados}</td>
                <td class="${statusClassAcabados}">${statusAcabados}</td>
            </tr>
        `;
    });
    
    htmlContent += `
                    </tbody>
                </table>
            </div>
    `;
    
    // Secci√≥n de diferencias
    if (Object.keys(discrepancies).length > 0) {
        htmlContent += `
            <div class="section">
                <div class="section-title">‚ö†Ô∏è DIFERENCIAS CR√çTICAS DETECTADAS</div>
        `;
        
        Object.keys(discrepancies).forEach(partNumber => {
            const diff = discrepancies[partNumber];
            htmlContent += `
                <div class="alert-warning">
                    <strong>‚ö†Ô∏è ${partNumber}</strong><br>
            `;
            if (diff.fundidos.diferencia !== 0) {
                htmlContent += `&nbsp;&nbsp;üî• Fundidos: ${diff.fundidos.diferencia > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diff.fundidos.diferencia)} piezas<br>`;
            }
            if (diff.acabados.diferencia !== 0) {
                htmlContent += `&nbsp;&nbsp;‚úÖ Acabados: ${diff.acabados.diferencia > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diff.acabados.diferencia)} piezas<br>`;
            }
            htmlContent += `</div>`;
        });
        
        htmlContent += `</div>`;
    } else {
        htmlContent += `
            <div class="section">
                <div class="alert-success">
                    <h3>‚úÖ ¬°VERIFICACI√ìN PERFECTA!</h3>
                    <p>No se encontraron diferencias entre el inventario te√≥rico y f√≠sico.</p>
                </div>
            </div>
        `;
    }
    
    htmlContent += `
            <div class="footer">
                Reporte generado autom√°ticamente por el Sistema de Control de Almac√©n - Fundici√≥n v1.3<br>
                üìß Para soporte t√©cnico contacte al administrador del sistema
            </div>
        </body>
        </html>
    `;
    
    // Crear y descargar el archivo HTML que puede abrirse como PDF
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `reporte-verificacion-${currentDate.replace(/\//g, '-')}-turno${shift}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('üìä Reporte exportado como HTML.\n\nüí° Instrucciones:\n1. Abre el archivo descargado en tu navegador\n2. Presiona Ctrl+P (o Cmd+P en Mac)\n3. Selecciona "Guardar como PDF"\n4. ¬°Listo! Tendr√°s tu reporte en PDF');
}
function calculateDiscrepancies(theoretical) {
    const discrepancies = {};
    
    // Agrupar verificaciones f√≠sicas por n√∫mero de parte
    const physicalByPart = {};
    Object.values(physicalVerification).forEach(item => {
        if (!physicalByPart[item.partNumber]) {
            physicalByPart[item.partNumber] = { fundidos: 0, acabados: 0 };
        }
        if (item.warehouse === 'fundidos') {
            physicalByPart[item.partNumber].fundidos += item.verifiedQuantity;
        } else if (item.warehouse === 'acabados') {
            physicalByPart[item.partNumber].acabados += item.verifiedQuantity;
        }
    });
    
    // Calcular diferencias
    const allParts = new Set([...Object.keys(theoretical), ...Object.keys(physicalByPart)]);
    allParts.forEach(partNumber => {
        const theo = theoretical[partNumber] || { fundidos: 0, acabados: 0 };
        const phys = physicalByPart[partNumber] || { fundidos: 0, acabados: 0 };
        
        const diffFundidos = phys.fundidos - theo.fundidos;
        const diffAcabados = phys.acabados - theo.acabados;
        
        if (diffFundidos !== 0 || diffAcabados !== 0) {
            discrepancies[partNumber] = {
                fundidos: { teorico: theo.fundidos, fisico: phys.fundidos, diferencia: diffFundidos },
                acabados: { teorico: theo.acabados, fisico: phys.acabados, diferencia: diffAcabados }
            };
        }
    });
    
    return discrepancies;
}
        function printVerificationSummary() {
    const theoretical = calculateTheoreticalInventory();
    const discrepancies = calculateDiscrepancies(theoretical);
    const currentDate = new Date().toLocaleDateString();
    const shift = document.getElementById('shift').value;
    
    let printContent = `
        <h2>üìä REPORTE DE VERIFICACI√ìN DE INVENTARIO</h2>
        <p><strong>Fecha:</strong> ${currentDate} | <strong>Turno:</strong> ${shift}</p>
        <hr>
        
        <h3>üìã RESUMEN EJECUTIVO</h3>
        <p>‚Ä¢ C√≥digos verificados: ${Object.keys(physicalVerification).length}</p>
        <p>‚Ä¢ N√∫meros de parte: ${Object.keys(theoretical).length}</p>
        <p>‚Ä¢ Diferencias encontradas: ${Object.keys(discrepancies).length}</p>
        <hr>
    `;
    
    if (Object.keys(discrepancies).length > 0) {
        printContent += '<h3>‚ö†Ô∏è DIFERENCIAS CR√çTICAS</h3>';
        Object.keys(discrepancies).forEach(partNumber => {
            const diff = discrepancies[partNumber];
            printContent += `<p><strong>${partNumber}:</strong><br>`;
            if (diff.fundidos.diferencia !== 0) {
                printContent += `&nbsp;&nbsp;üî• Fundidos: ${diff.fundidos.diferencia > 0 ? '+' : ''}${diff.fundidos.diferencia}<br>`;
            }
            if (diff.acabados.diferencia !== 0) {
                printContent += `&nbsp;&nbsp;‚úÖ Acabados: ${diff.acabados.diferencia > 0 ? '+' : ''}${diff.acabados.diferencia}<br>`;
            }
            printContent += '</p>';
        });
    } else {
        printContent += '<h3 style="color: green;">‚úÖ SIN DIFERENCIAS ENCONTRADAS</h3>';
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>Reporte Verificaci√≥n</title></head><body>${printContent}</body></html>`);
    printWindow.document.close();
    printWindow.print();
}
        function clearAllData() {
    const confirmClear = confirm('‚ö†Ô∏è LIMPIAR TODOS LOS DATOS\n\n¬øEst√°s SEGURO de que quieres eliminar:\n‚Ä¢ Todo el inventario\n‚Ä¢ Todos los movimientos\n‚Ä¢ Todas las tarimas\n‚Ä¢ Todas las verificaciones f√≠sicas\n\nEsta acci√≥n NO se puede deshacer.\n\n‚úÖ Aceptar = Eliminar todo\n‚ùå Cancelar = Mantener datos');
    
    if (confirmClear) {
        // Limpiar todas las variables
        inventory = [];
        movements = [];
        pallets = [];
        physicalVerification = {};
        theoreticalInventory = {};
        
        // Actualizar displays
        updateAllDisplays();
        
        alert('üóëÔ∏è Todos los datos han sido eliminados.\n\nPuedes comenzar con datos frescos.');
    }
}
        function updateAllDisplays() {
    updateDashboard();
    updateGroupedInventory();
    updateDetailedInventory();
    updatePalletsTable();
    updateVerificationSummary(); // <- AGREGAR ESTA L√çNEA
    updateProductionSummary(); // ‚¨ÖÔ∏è AGREGAR ESTA L√çNEA
}

        function updateDashboard() {
            const fundidos = inventory.filter(function(i) {
                return i.state === 'FUNDIDOS' && i.quantity > 0;
            }).length;
            const acabados = inventory.filter(function(i) {
                return i.state === 'ACABADOS' && i.quantity > 0;
            }).length;
            const upr = inventory.filter(function(i) {
                return i.type === 'UPR' && i.quantity > 0;
            }).length;
            const lwr = inventory.filter(function(i) {
                return i.type === 'LWR' && i.quantity > 0;
            }).length;
            const totalPallets = pallets.length;
            
            document.getElementById('total-fundidos').textContent = fundidos;
            document.getElementById('total-acabados').textContent = acabados;
            document.getElementById('total-upr').textContent = upr;
            document.getElementById('total-lwr').textContent = lwr;
            document.getElementById('total-pallets').textContent = totalPallets;
        }

        function updateGroupedInventory() {
            const tbody = document.getElementById('grouped-inventory-tbody');
            tbody.innerHTML = '';
            
            const grouped = {};
            
            inventory.forEach(function(item) {
                if (item.quantity > 0) {
                    if (!grouped[item.partNumber]) {
                        grouped[item.partNumber] = { 
                            fundidos: 0, acabados: 0, envios: 0, 
                            retenciones: 0, scrap: 0, pruebas: 0 
                        };
                    }
                    
                    if (item.warehouse === 'fundidos') {
                        grouped[item.partNumber].fundidos += item.quantity;
                    } else if (item.warehouse === 'acabados') {
                        grouped[item.partNumber].acabados += item.quantity;
                    } else if (item.warehouse === 'envios') {
                        grouped[item.partNumber].envios += item.quantity;
                    } else if (item.warehouse === 'retenciones') {
                        grouped[item.partNumber].retenciones += item.quantity;
                    } else if (item.warehouse === 'scrap') {
                        grouped[item.partNumber].scrap += item.quantity;
                    } else if (item.warehouse === 'pruebas') {
                        grouped[item.partNumber].pruebas += item.quantity;
                    }
                }
            });
            
            Object.keys(grouped).forEach(function(partNumber) {
                const data = grouped[partNumber];
                const total = data.fundidos + data.acabados + data.envios + data.retenciones + data.scrap + data.pruebas;
                
                const row = document.createElement('tr');
                row.innerHTML = '<td><strong>' + partNumber + '</strong></td>' +
                    '<td style="text-align: center;">üî• ' + data.fundidos + '</td>' +
                    '<td style="text-align: center;">‚úÖ ' + data.acabados + '</td>' +
                    '<td style="text-align: center;">üì¶ ' + data.envios + '</td>' +
                    '<td style="text-align: center;">‚è∏Ô∏è ' + data.retenciones + '</td>' +
                    '<td style="text-align: center;">‚ôªÔ∏è ' + data.scrap + '</td>' +
                    '<td style="text-align: center;">üß™ ' + data.pruebas + '</td>' +
                    '<td style="text-align: center; font-weight: bold;">' + total + '</td>';
                tbody.appendChild(row);
            });
        }

function updateDetailedInventory() {
    const detailedDiv = document.getElementById('detailed-inventory');
    
    // Filtros
    let html = `
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
            <h4>üîç Filtros</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <select id="filter-model" onchange="applyFilters()">
                    <option value="">Todos los Modelos</option>
                </select>
                <select id="filter-lote" onchange="applyFilters()">
                    <option value="">Todos los Lotes</option>
                </select>
                <select id="filter-molde" onchange="applyFilters()">
                    <option value="">Todos los Moldes</option>
                </select>
            </div>
        </div>
    `;
    
    // Filtrar solo inventario disponible (fundidos y acabados)
    const availableInventory = inventory.filter(i => 
        i.quantity > 0 && (i.warehouse === 'fundidos' || i.warehouse === 'acabados')
    );
    
    // Obtener valores √∫nicos para filtros
    const modelos = [...new Set(availableInventory.filter(i => i.codeData).map(i => i.codeData.modelo))];
    const lotes = [...new Set(availableInventory.filter(i => i.codeData).map(i => i.codeData.lote))];
    const moldes = [...new Set(availableInventory.filter(i => i.codeData).map(i => i.codeData.molde))];
    
    // Agrupar por tipo
    const uprItems = availableInventory.filter(i => i.type === 'UPR');
    const lwrItems = availableInventory.filter(i => i.type === 'LWR');
    
    // Secci√≥n UPR
    html += '<div class="model-section">';
    html += `<div class="model-header">üî∫ UPR (${uprItems.length} piezas disponibles)</div>`;
    html += generateDetailedSection(uprItems, 'UPR');
    html += '</div>';
    
    // Secci√≥n LWR
    html += '<div class="model-section">';
    html += `<div class="model-header">üîª LWR (${lwrItems.length} piezas disponibles)</div>`;
    html += generateDetailedSection(lwrItems, 'LWR');
    html += '</div>';
    
    detailedDiv.innerHTML = html;
    
    // Llenar opciones de filtros
    fillFilterOptions('filter-model', modelos);
    fillFilterOptions('filter-lote', lotes);
    fillFilterOptions('filter-molde', moldes);
}
function generateDetailedSection(items, type) {
    if (items.length === 0) return '<p>No hay piezas registradas</p>';
    
    // Agrupar por modelo
    const groupedByModel = {};
    items.forEach(item => {
        if (item.codeData) {
            const model = item.codeData.modelo;
            if (!groupedByModel[model]) {
                groupedByModel[model] = [];
            }
            groupedByModel[model].push(item);
        }
    });
    
    let html = '';
    Object.keys(groupedByModel).forEach(model => {
        const modelItems = groupedByModel[model];
        const totalCount = modelItems.reduce((sum, item) => sum + item.quantity, 0);
        
        html += `
            <div class="state-subsection">
                <div class="state-header" onclick="toggleModelSection('model-${type}-${model}')" style="cursor: pointer;">
                    üì¶ Modelo ${model} (${totalCount} piezas) <span id="toggle-${type}-${model}">‚ñº</span>
                </div>
                <div id="model-${type}-${model}">
                    <table class="inventory-table" style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Lote</th>
                                <th>M√°quina</th>
                                <th>Molde</th>
                                <th>Disparo</th>
                                <th>Estado</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        modelItems.forEach(item => {
            const data = item.codeData;
            html += `
                <tr>
                    <td style="font-family: monospace; font-size: 0.8em;">${item.code}</td>
                    <td>${data.lote}</td>
                    <td>${data.maquina}</td>
                    <td>${data.molde}</td>
                    <td>${data.disparo}</td>
                    <td><span class="code-badge" style="background: ${item.state === 'FUNDIDOS' ? '#e74c3c' : '#27ae60'};">${item.state}</span></td>
                    <td style="text-align: center; font-weight: bold;">${item.quantity}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
    
    return html;
}

function fillFilterOptions(selectId, options) {
    const select = document.getElementById(selectId);
    if (select) {
        // Limpiar opciones existentes excepto la primera
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // Agregar nuevas opciones
        options.sort().forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            select.appendChild(optionElement);
        });
    }
}
function applyFilters() {
    const filterModel = document.getElementById('filter-model').value;
    const filterLote = document.getElementById('filter-lote').value;
    const filterMolde = document.getElementById('filter-molde').value;
    
    // Filtrar inventario disponible
    let filteredInventory = inventory.filter(i => 
        i.quantity > 0 && 
        (i.warehouse === 'fundidos' || i.warehouse === 'acabados') &&
        i.codeData
    );
    
    // Aplicar filtros
    if (filterModel) {
        filteredInventory = filteredInventory.filter(i => i.codeData.modelo === filterModel);
    }
    if (filterLote) {
        filteredInventory = filteredInventory.filter(i => i.codeData.lote === filterLote);
    }
    if (filterMolde) {
        filteredInventory = filteredInventory.filter(i => i.codeData.molde === filterMolde);
    }
    
    // Regenerar secciones con items filtrados
    const uprItems = filteredInventory.filter(i => i.type === 'UPR');
    const lwrItems = filteredInventory.filter(i => i.type === 'LWR');
    
    // Actualizar contenido de las secciones existentes
    const uprSection = document.querySelector('[id^="model-UPR"]')?.parentElement;
    const lwrSection = document.querySelector('[id^="model-LWR"]')?.parentElement;
    
    if (uprSection) {
        uprSection.querySelector('.model-header').innerHTML = `üî∫ UPR (${uprItems.length} piezas disponibles)`;
        const contentDiv = uprSection.querySelector('[id^="model-UPR"]').parentElement;
        contentDiv.innerHTML = generateDetailedSection(uprItems, 'UPR');
    }
    
    if (lwrSection) {
        lwrSection.querySelector('.model-header').innerHTML = `üîª LWR (${lwrItems.length} piezas disponibles)`;
        const contentDiv = lwrSection.querySelector('[id^="model-LWR"]').parentElement;
        contentDiv.innerHTML = generateDetailedSection(lwrItems, 'LWR');
    }
}
function toggleModelSection(sectionId) {
    const section = document.getElementById(sectionId);
    const toggleIcon = document.getElementById('toggle-' + sectionId.replace('model-', ''));
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        toggleIcon.textContent = '‚ñº';
    } else {
        section.style.display = 'none';
        toggleIcon.textContent = '‚ñ∂';
    }
}
        function updatePalletsTable() {
            const tbody = document.getElementById('pallets-tbody');
            tbody.innerHTML = '';
            
            pallets.forEach(function(pallet) {
                const row = document.createElement('tr');
                row.innerHTML = '<td><strong>' + pallet.systemId + '</strong></td>' +
                    '<td>' + pallet.originalId + '</td>' +
                    '<td><span class="code-badge" style="background: ' + (pallet.state === 'fundidos' ? '#e74c3c' : '#27ae60') + ';">' + pallet.state.toUpperCase() + '</span></td>' +
                    '<td><span class="code-badge" style="background: #17a2b8;">' + pallet.type + '</span></td>' +
                    '<td style="text-align: center;">' + pallet.codesCount + '</td>' +
                    '<td>' + getWarehouseName(pallet.warehouse) + '</td>' +
                    '<td>' + pallet.createdDate.toLocaleDateString() + '</td>' +
                    '<td>' +
                    '<button class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;" onclick="movePallet(\'' + pallet.systemId + '\')">üì¶ Mover</button>' +
                    '<button class="btn btn-info" style="padding: 5px 10px; font-size: 12px;" onclick="viewPalletDetails(\'' + pallet.systemId + '\')">üëÅÔ∏è Ver</button>' +
                    '</td>';
                tbody.appendChild(row);
            });
        }

        // Configurar event listeners cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para pesta√±as
            document.querySelectorAll('.nav-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });
            
            // Event listeners
            document.getElementById('qr-input').addEventListener('input', analyzeQRCode);
            document.getElementById('inventory-type').addEventListener('change', updateFormSections);
            
            document.getElementById('qr-input').addEventListener('paste', function(e) {
                setTimeout(function() {
                    const content = e.target.value.trim();
                    if (content && (content.includes('|') || content.length >= 13)) {
                        analyzeQRCode();
                    }
                }, 100);
            });
            
            document.getElementById('warehouse-selector').addEventListener('click', function(e) {
                if (e.target.classList.contains('warehouse-btn')) {
                    this.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                        btn.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    selectedWarehouse = e.target.dataset.warehouse;
                }
            });
            
            document.getElementById('movement-selector').addEventListener('click', function(e) {
                if (e.target.classList.contains('warehouse-btn')) {
                    this.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                        btn.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    selectedMovement = e.target.dataset.movement;
                }
            });
            
            // Inicializar datos y displays
            loadSampleData();
            updateAllDisplays();
        });
        function updateVerificationSummary() {
    // Actualizar contador de verificaciones en dashboard si existe
    const verificationCount = Object.keys(physicalVerification).length;
    
    // Si hay un elemento para mostrar verificaciones, actualizarlo
    const verificationElement = document.getElementById('verification-count');
    if (verificationElement) {
        verificationElement.textContent = verificationCount;
    }
}
        // Mostrar formulario seg√∫n el tipo seleccionado
function showProductionForm() {
    const productionType = document.getElementById('production-type').value;
    
    // Ocultar todos los formularios
    document.getElementById('fundicion-form').style.display = 'none';
    document.getElementById('acabado-form').style.display = 'none';
    document.getElementById('movimientos-form').style.display = 'none';
    
    // Mostrar el formulario seleccionado
    if (productionType) {
        document.getElementById(productionType + '-form').style.display = 'block';
        
        // Establecer fecha actual por defecto
        const today = new Date().toISOString().split('T')[0];
        if (productionType === 'fundicion') {
            document.getElementById('fund-fecha').value = today;
        } else if (productionType === 'acabado') {
            document.getElementById('acab-fecha').value = today;
        } else if (productionType === 'movimientos') {
            document.getElementById('mov-fecha').value = today;
        }
    }
}

// Actualizar opciones de modelo seg√∫n la m√°quina seleccionada
function updateModelOptions(prefix) {
    const maquina = document.getElementById(prefix + '-maquina').value;
    const modeloSelect = document.getElementById(prefix + '-modelo');
    const moldeSelect = document.getElementById(prefix + '-molde');
    
    // Limpiar opciones
    modeloSelect.innerHTML = '<option value="">Seleccionar modelo...</option>';
    moldeSelect.innerHTML = '<option value="">Primero selecciona modelo...</option>';
    
    if (maquina && MACHINE_MODELS[maquina]) {
        MACHINE_MODELS[maquina].forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo;
            option.textContent = modelo;
            modeloSelect.appendChild(option);
        });
    }
}

// Actualizar opciones de molde seg√∫n el modelo seleccionado
function updateMoldeOptions(prefix) {
    const modelo = document.getElementById(prefix + '-modelo').value;
    const moldeSelect = document.getElementById(prefix + '-molde');
    
    // Limpiar opciones
    moldeSelect.innerHTML = '<option value="">Seleccionar molde...</option>';
    
    if (modelo && MODEL_MOLDS[modelo]) {
        MODEL_MOLDS[modelo].forEach(molde => {
            const option = document.createElement('option');
            option.value = molde;
            option.textContent = 'Molde ' + molde;
            moldeSelect.appendChild(option);
        });
    }
}

// Calcular piezas buenas autom√°ticamente
function calculateGoodParts(prefix) {
    const total = parseInt(document.getElementById(prefix + '-total').value) || 0;
    const ng = parseInt(document.getElementById(prefix + '-ng').value) || 0;
    const buenas = Math.max(0, total - ng);
    
    document.getElementById(prefix + '-buenas').value = buenas;
}

// Guardar reporte de producci√≥n
async function saveProductionReport(tipo) {
    const prefix = tipo === 'fundicion' ? 'fund' : 'acab';
    const form = document.getElementById('production-' + tipo + '-form');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
     // VALIDACI√ìN OBLIGATORIA DE EVIDENCIA
    const evidencia = await getEvidenceFile(prefix + '-evidencia');
    if (!evidencia) {
        alert('‚ö†Ô∏è EVIDENCIA REQUERIDA\n\nDebe adjuntar un archivo PDF como evidencia del reporte antes de guardar.\n\nPor favor, selecciona un archivo PDF.');
        return;
    }
    
    // Obtener evidencia si existe
    const evidencia = await getEvidenceFile(prefix + '-evidencia');
    
    const reporte = {
        id: Date.now(),
        tipo: tipo,
        fecha: document.getElementById(prefix + '-fecha').value,
        turno: document.getElementById(prefix + '-turno').value,
        modelo: document.getElementById(prefix + '-modelo').value,
        cantidadTotal: parseInt(document.getElementById(prefix + '-total').value),
        cantidadNG: parseInt(document.getElementById(prefix + '-ng').value),
        piezasBuenas: parseInt(document.getElementById(prefix + '-buenas').value),
        evidencia: evidencia, // Archivo PDF
        timestamp: new Date()
    };
    
    // Para fundici√≥n agregar m√°quina y molde
    if (tipo === 'fundicion') {
        reporte.maquina = document.getElementById('fund-maquina').value;
        reporte.molde = document.getElementById('fund-molde').value;
    } else {
        // Para acabado agregar m√°quina de acabado
        reporte.maquina = document.getElementById('acab-maquina').value;
    }
    
    productionReports.push(reporte);
    
    let alertMessage = `‚úÖ Reporte de ${tipo} guardado exitosamente!\n\nüìä Resumen:\n‚Ä¢ Modelo: ${reporte.modelo}\n‚Ä¢ M√°quina: ${reporte.maquina}\n‚Ä¢ Piezas buenas: ${reporte.piezasBuenas}\n‚Ä¢ Fecha: ${reporte.fecha}\n‚Ä¢ Turno: ${reporte.turno}`;
    
    if (evidencia) {
        alertMessage += `\n‚Ä¢ üìÑ Evidencia: ${evidencia.nombre}`;
    }
    
    alert(alertMessage);
    
    // Limpiar formulario
    form.reset();
    // Limpiar archivos despu√©s de guardar
clearFormFiles('production-' + tipo + '-form'); // Para producci√≥n
    updateProductionSummary();
}
// Guardar movimiento de material
async function saveMovementReport() {
    const form = document.getElementById('production-movimientos-form');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
     // VALIDACI√ìN OBLIGATORIA DE EVIDENCIA
    const evidencia = await getEvidenceFile('mov-evidencia');
    if (!evidencia) {
        alert('‚ö†Ô∏è EVIDENCIA REQUERIDA\n\nDebe adjuntar un archivo PDF como evidencia del movimiento antes de guardar.\n\nPor favor, selecciona un archivo PDF.');
        return;
    }
    // Obtener evidencia si existe
    const evidencia = await getEvidenceFile('mov-evidencia');
    
    const movimiento = {
        id: Date.now(),
        tipo: document.getElementById('mov-tipo').value,
        fecha: document.getElementById('mov-fecha').value,
        maquina: document.getElementById('mov-maquina').value, // Nueva m√°quina
        modelo: document.getElementById('mov-modelo').value,
        cantidad: parseInt(document.getElementById('mov-cantidad').value),
        comentarios: document.getElementById('mov-comentarios').value,
        evidencia: evidencia, // Archivo PDF
        timestamp: new Date()
    };
    
    movementReports.push(movimiento);
    
    const tipoNames = {
        'scrap': '‚ôªÔ∏è Scrap',
        'envios': 'üì¶ Env√≠os',
        'retenciones': '‚è∏Ô∏è Retenciones',
        'pruebas': 'üß™ Pruebas'
    };
    
    let alertMessage = `‚úÖ Movimiento registrado exitosamente!\n\nüìä Resumen:\n‚Ä¢ Tipo: ${tipoNames[movimiento.tipo]}\n‚Ä¢ M√°quina: ${movimiento.maquina}\n‚Ä¢ Modelo: ${movimiento.modelo}\n‚Ä¢ Cantidad: ${movimiento.cantidad}\n‚Ä¢ Fecha: ${movimiento.fecha}`;
    
    if (evidencia) {
        alertMessage += `\n‚Ä¢ üìÑ Evidencia: ${evidencia.nombre}`;
    }
    
    alert(alertMessage);
    
    // Limpiar formulario
    form.reset();
    // Limpiar archivos despu√©s de guardar
    clearFormFiles('production-movimientos-form'); // Para movimientos
    updateProductionSummary();
}
// Actualizar resumen de producci√≥n
function updateProductionSummary() {
    const summaryDiv = document.getElementById('production-summary');
    const currentShift = document.getElementById('shift').value;
    const today = new Date().toISOString().split('T')[0];
    
    // Filtrar reportes del turno actual
    const currentReports = productionReports.filter(r => 
        r.fecha === today && r.turno === currentShift
    );
    const currentMovements = movementReports.filter(m => 
        m.fecha === today
    );
    
    if (currentReports.length === 0 && currentMovements.length === 0) {
        summaryDiv.innerHTML = '<div class="alert alert-info">No hay reportes registrados para el turno actual.</div>';
        return;
    }
    
    let html = '<h4>üìã Reportes del Turno:</h4>';
    
    // Mostrar reportes de producci√≥n
    if (currentReports.length > 0) {
        html += '<table class="inventory-table"><thead><tr><th>Tipo</th><th>Modelo</th><th>M√°quina</th><th>Molde</th><th>Total</th><th>NG</th><th>Buenas</th><th>Evidencia</th><th>Hora</th></tr></thead><tbody>';
        
        // TABLA CORREGIDA - Para reportes de producci√≥n
        currentReports.forEach(r => {
            const evidenciaIcon = r.evidencia ? 
                `<button onclick="showEvidenceInfo('${r.id}')" class="btn btn-sm" style="background: #28a745; color: white;">üìÑ</button>` : 
                '‚Äî';
            
            html += `<tr>
                <td>${r.tipo.toUpperCase()}</td>
                <td>${r.modelo}</td>
                <td>${r.maquina || 'N/A'}</td>
                <td>${r.molde || 'N/A'}</td>
                <td>${r.cantidadTotal}</td>
                <td>${r.cantidadNG}</td>
                <td><strong>${r.piezasBuenas}</strong></td>
                <td>${evidenciaIcon}</td>
                <td>${r.timestamp.toLocaleTimeString()}</td>
            </tr>`;
        });
        html += '</tbody></table>';
    }
    
    // Mostrar movimientos
    if (currentMovements.length > 0) {
        html += '<h4>üì¶ Movimientos Registrados:</h4>';
        html += '<table class="inventory-table"><thead><tr><th>Tipo</th><th>M√°quina</th><th>Modelo</th><th>Cantidad</th><th>Evidencia</th><th>Comentarios</th><th>Hora</th></tr></thead><tbody>';
        
        currentMovements.forEach(m => {
            const tipoIcons = {'scrap': '‚ôªÔ∏è', 'envios': 'üì¶', 'retenciones': '‚è∏Ô∏è', 'pruebas': 'üß™'};
            const evidenciaIcon = m.evidencia ? 
                `<button onclick="showEvidenceInfo('${m.id}')" class="btn btn-sm" style="background: #28a745; color: white;">üìÑ</button>` : 
                '‚Äî';
            
            html += `<tr>
                <td>${tipoIcons[m.tipo]} ${m.tipo.toUpperCase()}</td>
                <td>${m.maquina}</td>
                <td>${m.modelo}</td>
                <td>${m.cantidad}</td>
                <td>${evidenciaIcon}</td>
                <td>${m.comentarios || 'Sin comentarios'}</td>
                <td>${m.timestamp.toLocaleTimeString()}</td>
            </tr>`;
        });
        html += '</tbody></table>';
    }
    
    summaryDiv.innerHTML = html;
}
// Generar balance te√≥rico
function generateTheoreticalBalance() {
    const currentShift = document.getElementById('shift').value;
    const today = new Date().toISOString().split('T')[0];
    
    // Obtener reportes del turno actual
    const currentReports = productionReports.filter(r => 
        r.fecha === today && r.turno === currentShift
    );
    const currentMovements = movementReports.filter(m => 
        m.fecha === today
    );
    
    if (currentReports.length === 0) {
        alert('‚ö†Ô∏è No hay reportes de producci√≥n para calcular el balance te√≥rico.\n\nPrimero registra reportes de fundici√≥n y/o acabado.');
        return;
    }
    
    // Inicializar balance te√≥rico
    theoreticalBalance = {};
    
    // Obtener inventario inicial de todos los modelos √∫nicos
    const allModels = new Set();
    currentReports.forEach(r => {
        const modelo = r.modelo.replace('-FUN', '');
        allModels.add(modelo);
    });
    
    // Inicializar con inventario inicial
    allModels.forEach(modelo => {
        theoreticalBalance[modelo] = {
            inventarioInicial: {
                fundidos: getInitialInventory(modelo + '-FUN', 'fundidos'),
                acabados: getInitialInventory(modelo, 'acabados')
            },
            fundicion: { 
                reportado: 0, 
                teorico: 0 
            },
            acabado: { 
                reportado: 0, 
                teorico: 0 
            },
            movimientos: { 
                scrap: 0, 
                envios: 0, 
                retenciones: 0, 
                pruebas: 0 
            },
            balanceFinal: {
                fundidos: 0,
                acabados: 0
            }
        };
        
        // Establecer balance inicial = inventario inicial
        theoreticalBalance[modelo].balanceFinal.fundidos = theoreticalBalance[modelo].inventarioInicial.fundidos;
        theoreticalBalance[modelo].balanceFinal.acabados = theoreticalBalance[modelo].inventarioInicial.acabados;
    });
    
    // Procesar reportes de producci√≥n
    currentReports.forEach(reporte => {
        const modelo = reporte.modelo.replace('-FUN', '');
        
        if (reporte.tipo === 'fundicion') {
            theoreticalBalance[modelo].fundicion.reportado += reporte.piezasBuenas;
            
            // SUMAR piezas fundidas al balance de fundidos
            theoreticalBalance[modelo].balanceFinal.fundidos += reporte.piezasBuenas;
            
            // Para LWR: las piezas fundidas van directo a acabado (mismo turno)
            if (modelo.includes('382')) {
                theoreticalBalance[modelo].balanceFinal.fundidos -= reporte.piezasBuenas; // Se van de fundidos
                theoreticalBalance[modelo].balanceFinal.acabados += reporte.piezasBuenas; // Llegan a acabados
            }
            // Para UPR: se quedan en fundidos (van a tratamiento t√©rmico)
            
        } else if (reporte.tipo === 'acabado') {
            theoreticalBalance[modelo].acabado.reportado += reporte.piezasBuenas;
            
            // Para acabado: las piezas procesadas se RESTAN del inventario de acabados
            // porque salen del almac√©n para enviarse
            theoreticalBalance[modelo].balanceFinal.acabados -= reporte.cantidadTotal; // Total procesado
            theoreticalBalance[modelo].balanceFinal.acabados += reporte.piezasBuenas; // Solo las buenas regresan
        }
    });
    
    // Procesar movimientos
    currentMovements.forEach(movimiento => {
        const modelo = movimiento.modelo;
        if (theoreticalBalance[modelo]) {
            theoreticalBalance[modelo].movimientos[movimiento.tipo] += movimiento.cantidad;
            
            // Aplicar movimientos al balance final
            switch(movimiento.tipo) {
                case 'scrap':
                    // Scrap se resta del almac√©n correspondiente
                    if (modelo.includes('-FUN')) {
                        theoreticalBalance[modelo.replace('-FUN', '')].balanceFinal.fundidos -= movimiento.cantidad;
                    } else {
                        theoreticalBalance[modelo].balanceFinal.acabados -= movimiento.cantidad;
                    }
                    break;
                case 'envios':
                    // Env√≠os se restan de acabados
                    theoreticalBalance[modelo].balanceFinal.acabados -= movimiento.cantidad;
                    break;
                case 'retenciones':
                    // Retenciones no afectan el balance (siguen en almac√©n)
                    break;
                case 'pruebas':
                    // Pruebas se restan temporalmente
                    theoreticalBalance[modelo].balanceFinal.acabados -= movimiento.cantidad;
                    break;
            }
        }
    });
    
    // Mostrar balance te√≥rico
    showTheoreticalBalanceReport();
}

// Funci√≥n auxiliar para obtener inventario inicial
function getInitialInventory(partNumber, warehouse) {
    let total = 0;
    Object.values(inventory).forEach(item => {
        if (item.partNumber === partNumber && item.warehouse === warehouse) {
            total += item.quantity;
        }
    });
    return total;
}
// Mostrar reporte de balance te√≥rico
function showTheoreticalBalanceReport() {
    let html = `
        <div class="card" style="margin-top: 20px;">
            <h3>üßÆ Balance Te√≥rico Calculado</h3>
            <div class="alert alert-info">
                <strong>üí° Interpretaci√≥n:</strong><br>
                ‚Ä¢ <strong>Reportado:</strong> Lo que el personal report√≥ en producci√≥n<br>
                ‚Ä¢ <strong>Te√≥rico:</strong> Lo que deber√≠a haber seg√∫n flujo de proceso<br>
                ‚Ä¢ <strong>F√≠sico:</strong> Lo que se encontr√≥ al escanear (de verificaciones f√≠sicas)
            </div>
    `;
    
    if (Object.keys(theoreticalBalance).length === 0) {
        html += '<div class="alert alert-warning">No hay datos para mostrar. Genera primero el balance te√≥rico.</div>';
    } else {
        html += '<table class="inventory-table"><thead><tr><th>Modelo</th><th>Proceso</th><th>Inv. Inicial</th><th>Producci√≥n</th><th>Balance Calculado</th><th>F√≠sico</th><th>Diferencia</th><th>Status</th></tr></thead><tbody>';
        
        Object.keys(theoreticalBalance).forEach(modelo => {
            const balance = theoreticalBalance[modelo];
            
            // Obtener verificaci√≥n f√≠sica para este modelo
            const physicalFundidos = getPhysicalCountForModel(modelo, 'fundidos');
            const physicalAcabados = getPhysicalCountForModel(modelo, 'acabados');
            
            // Fila de fundici√≥n
            const diffRepTeoFund = balance.fundicion.reportado - balance.fundicion.teorico;
            const diffTeoFisFund = balance.fundicion.teorico - physicalFundidos;
            const statusFund = getStatusIcon(diffRepTeoFund, diffTeoFisFund);
            
            html += `
                <tr>
                    <td rowspan="2"><strong>${modelo}</strong></td>
                    <td>üî• Fundici√≥n</td>
                    <td style="text-align: center;">${balance.fundicion.reportado}</td>
                    <td style="text-align: center;">${balance.fundicion.teorico}</td>
                    <td style="text-align: center;">${physicalFundidos}</td>
                    <td style="text-align: center;" class="${getDifferenceClass(diffRepTeoFund)}">${diffRepTeoFund}</td>
                    <td style="text-align: center;" class="${getDifferenceClass(diffTeoFisFund)}">${diffTeoFisFund}</td>
                    <td>${statusFund}</td>
                </tr>
            `;
            
            // Fila de acabado
            const diffRepTeoAcab = balance.acabado.reportado - balance.acabado.teorico;
            const diffTeoFisAcab = balance.acabado.teorico - physicalAcabados;
            const statusAcab = getStatusIcon(diffRepTeoAcab, diffTeoFisAcab);
            
            html += `
                <tr>
                    <td>‚úÖ Acabado</td>
                    <td style="text-align: center;">${balance.acabado.reportado}</td>
                    <td style="text-align: center;">${balance.acabado.teorico}</td>
                    <td style="text-align: center;">${physicalAcabados}</td>
                    <td style="text-align: center;" class="${getDifferenceClass(diffRepTeoAcab)}">${diffRepTeoAcab}</td>
                    <td style="text-align: center;" class="${getDifferenceClass(diffTeoFisAcab)}">${diffTeoFisAcab}</td>
                    <td>${statusAcab}</td>
                </tr>
            `;
            
            // Mostrar movimientos si existen
            const totalMovements = balance.movimientos.scrap + balance.movimientos.envios + 
                                 balance.movimientos.retenciones + balance.movimientos.pruebas;
            if (totalMovements > 0) {
                html += `
                    <tr style="background: #f8f9fa;">
                        <td colspan="2"><em>üì¶ Movimientos:</em></td>
                        <td colspan="6" style="font-size: 0.9em;">
                            ‚ôªÔ∏è Scrap: ${balance.movimientos.scrap} | 
                            üì¶ Env√≠os: ${balance.movimientos.envios} | 
                            ‚è∏Ô∏è Retenciones: ${balance.movimientos.retenciones} | 
                            üß™ Pruebas: ${balance.movimientos.pruebas}
                        </td>
                    </tr>
                `;
            }
        });
        
        html += '</tbody></table>';
        
        // Agregar an√°lisis de diferencias cr√≠ticas
        html += generateCriticalAnalysis();
    }
    
    html += '</div>';
    
    // Mostrar el reporte
   // Mostrar el reporte en una nueva ventana para no sobrescribir
const reportWindow = window.open('', '_blank', 'width=1200,height=800');
reportWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Balance Te√≥rico vs F√≠sico</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
            .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            .inventory-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
            .inventory-table th, .inventory-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .inventory-table th { background-color: #34495e; color: white; }
            .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
            .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; }
            .alert-success { background: #d4edda; border: 1px solid #c3e6cb; }
            .difference-zero { color: #6c757d; }
            .difference-positive { color: #28a745; font-weight: bold; }
            .difference-negative { color: #dc3545; font-weight: bold; }
        </style>
    </head>
    <body>${html}</body>
    </html>
`);
reportWindow.document.close();
}

// Funciones auxiliares
function getPhysicalCountForModel(modelo, warehouse) {
    let count = 0;
    Object.values(physicalVerification).forEach(item => {
        if (item.partNumber && item.partNumber.includes(modelo) && item.warehouse === warehouse) {
            count += item.verifiedQuantity;
        }
    });
    return count;
}

function getDifferenceClass(diff) {
    if (diff === 0) return 'difference-zero';
    return diff > 0 ? 'difference-positive' : 'difference-negative';
}

function getStatusIcon(diffRepTeo, diffTeoFis) {
    if (diffRepTeo === 0 && diffTeoFis === 0) return '‚úÖ Perfecto';
    if (Math.abs(diffRepTeo) <= 2 && Math.abs(diffTeoFis) <= 2) return '‚ö†Ô∏è Revisar';
    return '‚ùå Cr√≠tico';
}

function generateCriticalAnalysis() {
    let criticalIssues = [];
    
    Object.keys(theoreticalBalance).forEach(modelo => {
        const balance = theoreticalBalance[modelo];
        
        // Obtener verificaci√≥n f√≠sica para este modelo
        const physicalFundidos = getPhysicalCountForModel(modelo, 'fundidos');
        const physicalAcabados = getPhysicalCountForModel(modelo, 'acabados');
        
        // Verificar diferencias cr√≠ticas en fundidos
        const diffFund = balance.balanceFinal.fundidos - physicalFundidos;
        if (Math.abs(diffFund) > 5) {
            criticalIssues.push(`${modelo} - Fundidos: ${diffFund > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diffFund)} piezas`);
        }
        
        // Verificar diferencias cr√≠ticas en acabados
        const diffAcab = balance.balanceFinal.acabados - physicalAcabados;
        if (Math.abs(diffAcab) > 5) {
            criticalIssues.push(`${modelo} - Acabados: ${diffAcab > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diffAcab)} piezas`);
        }
    });
    
    if (criticalIssues.length > 0) {
        return `
            <div class="alert" style="background: #f8d7da; color: #721c24; margin-top: 20px;">
                <h4>üö® Diferencias Cr√≠ticas Detectadas (>5 piezas):</h4>
                <ul style="margin: 10px 0;">
                    ${criticalIssues.map(issue => `<li>${issue}</li>`).join('')}
                </ul>
            </div>
        `;
    } else {
        return `
            <div class="alert alert-success" style="margin-top: 20px;">
                <h4>‚úÖ Balance Aceptable</h4>
                <p>No se detectaron diferencias cr√≠ticas. Todas las variaciones est√°n dentro del rango normal (‚â§5 piezas).</p>
            </div>
        `;
    }
}
// Mostrar reporte completo de producci√≥n
function showProductionReport() {
    const currentShift = document.getElementById('shift').value;
    const today = new Date().toISOString().split('T')[0];
    
    // Generar reporte completo en una nueva ventana
    const reportWindow = window.open('', '_blank');
    
    let reportContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Reporte Completo de Producci√≥n</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                .header { text-align: center; border-bottom: 2px solid #e74c3c; padding-bottom: 20px; margin-bottom: 30px; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #34495e; color: white; }
                .section { margin: 25px 0; page-break-inside: avoid; }
                .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
                .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üè≠ REPORTE COMPLETO DE PRODUCCI√ìN</h1>
                <p>üìÖ Fecha: ${today} | ‚è∞ Turno: ${currentShift} | üïê Generado: ${new Date().toLocaleString()}</p>
            </div>
            
            <div class="section">
                <h2>üìä Reportes de Producci√≥n Registrados</h2>
    `;
    
    // Agregar reportes de producci√≥n
    const currentReports = productionReports.filter(r => r.fecha === today && r.turno === currentShift);
    if (currentReports.length > 0) {
        reportContent += `
            <table>
                <thead>
                    <tr><th>Tipo</th><th>Modelo</th><th>M√°quina</th><th>Molde</th><th>Total</th><th>NG</th><th>Buenas</th><th>Hora</th></tr>
                </thead>
                <tbody>
        `;
        currentReports.forEach(r => {
            reportContent += `
                <tr>
                    <td>${r.tipo.toUpperCase()}</td>
                    <td>${r.modelo}</td>
                    <td>${r.maquina || 'N/A'}</td>
                    <td>${r.molde || 'N/A'}</td>
                    <td>${r.cantidadTotal}</td>
                    <td>${r.cantidadNG}</td>
                    <td><strong>${r.piezasBuenas}</strong></td>
                    <td>${r.timestamp.toLocaleTimeString()}</td>
                </tr>
            `;
        });
        reportContent += '</tbody></table>';
    } else {
        reportContent += '<div class="alert alert-info">No hay reportes de producci√≥n registrados.</div>';
    }
    
    reportContent += `
            </div>
            
            <div class="section">
                <h2>üì¶ Movimientos de Material</h2>
    `;
    
    // Agregar movimientos
    const currentMovements = movementReports.filter(m => m.fecha === today);
    if (currentMovements.length > 0) {
        reportContent += `
            <table>
                <thead>
                    <tr><th>Tipo</th><th>Modelo</th><th>Cantidad</th><th>Comentarios</th><th>Hora</th></tr>
                </thead>
                <tbody>
        `;
        currentMovements.forEach(m => {
            reportContent += `
                <tr>
                    <td>${m.tipo.toUpperCase()}</td>
                    <td>${m.modelo}</td>
                    <td>${m.cantidad}</td>
                    <td>${m.comentarios || 'Sin comentarios'}</td>
                    <td>${m.timestamp.toLocaleTimeString()}</td>
                </tr>
            `;
        });
        reportContent += '</tbody></table>';
    } else {
        reportContent += '<div class="alert alert-info">No hay movimientos registrados.</div>';
    }
    
    reportContent += `
            </div>
        </body>
        </html>
    `;
    
    reportWindow.document.write(reportContent);
    reportWindow.document.close();
    reportWindow.print();
}
    // Validar archivo PDF
function validatePDF(inputId) {
    const fileInput = document.getElementById(inputId);
    const file = fileInput.files[0];
    
    if (file) {
        // Verificar que sea PDF
        if (file.type !== 'application/pdf') {
            alert('‚ö†Ô∏è Solo se permiten archivos PDF.');
            fileInput.value = '';
            return false;
        }
        
        // Verificar tama√±o (5MB m√°ximo)
        const maxSize = 5 * 1024 * 1024; // 5MB en bytes
        if (file.size > maxSize) {
            alert('‚ö†Ô∏è El archivo es demasiado grande. M√°ximo permitido: 5MB.');
            fileInput.value = '';
            return false;
        }
        
        // Mostrar confirmaci√≥n
        const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
        console.log(`‚úÖ Archivo v√°lido: ${file.name} (${sizeInMB}MB)`);
        return true;
    }
    return true;
}

// Convertir archivo a Base64 para almacenamiento
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Funci√≥n auxiliar para obtener archivo de evidencia
async function getEvidenceFile(inputId) {
    const fileInput = document.getElementById(inputId);
    const file = fileInput.files[0];
    
    if (file && validatePDF(inputId)) {
        try {
            const base64 = await fileToBase64(file);
            return {
                nombre: file.name,
                tama√±o: file.size,
                fecha: new Date().toISOString(),
                contenido: base64
            };
        } catch (error) {
            console.error('Error al procesar archivo:', error);
            alert('‚ùå Error al procesar el archivo. Intenta de nuevo.');
            return null;
        }
    }
    return null;
}
    // Variables globales para gesti√≥n de archivos
let currentFiles = {};
let fileHistories = {};

// Manejar selecci√≥n de archivo
async function handleFileSelection(inputId) {
    const fileInput = document.getElementById(inputId);
    const file = fileInput.files[0];
    const statusDiv = document.getElementById(inputId + '-status');
    const actionsDiv = document.getElementById(inputId + '-actions');
    
    if (file && validatePDF(inputId)) {
        try {
            // Mostrar estado de carga
            statusDiv.innerHTML = '<span class="file-info">‚è≥ Procesando archivo...</span>';
            
            const fileData = await fileToBase64(file);
            const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
            
            // Crear objeto de archivo con metadatos
            const fileObject = {
                nombre: file.name,
                tama√±o: file.size,
                fechaSubida: new Date().toISOString(),
                contenido: fileData,
                version: getNextVersion(inputId)
            };
            
            // Guardar en historial
            saveFileToHistory(inputId, fileObject);
            
            // Guardar archivo actual
            currentFiles[inputId] = fileObject;
            
            // Actualizar interfaz
            statusDiv.innerHTML = `<span class="file-success">‚úÖ ${file.name} (${sizeInMB}MB) - v${fileObject.version}</span>`;
            actionsDiv.style.display = 'block';
            
        } catch (error) {
            console.error('Error al procesar archivo:', error);
            statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error al procesar archivo</span>';
            fileInput.value = '';
        }
    } else if (file) {
        statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Archivo inv√°lido</span>';
        fileInput.value = '';
    }
}

// Obtener siguiente versi√≥n
function getNextVersion(inputId) {
    if (!fileHistories[inputId]) {
        fileHistories[inputId] = [];
    }
    return fileHistories[inputId].length + 1;
}

// Guardar archivo en historial
function saveFileToHistory(inputId, fileObject) {
    if (!fileHistories[inputId]) {
        fileHistories[inputId] = [];
    }
    
    fileHistories[inputId].push({
        ...fileObject,
        accion: fileHistories[inputId].length === 0 ? 'Carga inicial' : 'Reemplazo',
        fechaAccion: new Date().toISOString()
    });
}

// Reemplazar archivo
function replaceFile(inputId) {
    if (confirm('¬øEst√°s seguro de que quieres reemplazar el archivo actual?')) {
        const fileInput = document.getElementById(inputId);
        fileInput.click();
    }
}

// Eliminar archivo
function removeFile(inputId) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar el archivo actual?')) {
        const fileInput = document.getElementById(inputId);
        const statusDiv = document.getElementById(inputId + '-status');
        const actionsDiv = document.getElementById(inputId + '-actions');
        
        // Guardar eliminaci√≥n en historial
        if (currentFiles[inputId]) {
            if (!fileHistories[inputId]) {
                fileHistories[inputId] = [];
            }
            
            fileHistories[inputId].push({
                nombre: currentFiles[inputId].nombre,
                accion: 'Eliminaci√≥n',
                fechaAccion: new Date().toISOString(),
                eliminadoPor: 'Usuario'
            });
        }
        
        // Limpiar archivo actual
        currentFiles[inputId] = null;
        fileInput.value = '';
        
        // Resetear interfaz
        statusDiv.innerHTML = '<span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>';
        actionsDiv.style.display = 'none';
        
        alert('‚úÖ Archivo eliminado correctamente.');
    }
}

// Ver historial de archivos
function viewFileHistory(inputId) {
    const history = fileHistories[inputId] || [];
    
    if (history.length === 0) {
        alert('üìã No hay historial de archivos para este campo.');
        return;
    }
    
    let modalHtml = `
        <div class="file-history-modal" id="historyModal">
            <div class="file-history-content">
                <button class="file-history-close" onclick="closeFileHistory()">√ó</button>
                <h3>üìã Historial de Archivos</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px;">Versi√≥n</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Archivo</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Acci√≥n</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Fecha</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    history.forEach((item, index) => {
        const isDeleted = item.accion === 'Eliminaci√≥n';
        const rowStyle = isDeleted ? 'background: #f8d7da;' : '';
        const fecha = new Date(item.fechaAccion).toLocaleString();
        const tama√±o = item.tama√±o ? `(${(item.tama√±o / 1024 / 1024).toFixed(2)}MB)` : '';
        
        modalHtml += `
            <tr style="${rowStyle}">
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">v${item.version || index + 1}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${item.nombre} ${tama√±o}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    ${item.accion === 'Carga inicial' ? 'üìÅ' : item.accion === 'Reemplazo' ? 'üîÑ' : 'üóëÔ∏è'} 
                    ${item.accion}
                </td>
                <td style="border: 1px solid #ddd; padding: 8px; font-size: 0.9em;">${fecha}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                    ${!isDeleted && item.contenido ? 
                        `<button onclick="downloadFile('${inputId}', ${index})" class="btn btn-sm" style="background: #007bff; color: white; border: none; padding: 3px 8px; border-radius: 3px;">üì• Descargar</button>` : 
                        '‚Äî'
                    }
                </td>
            </tr>
        `;
    });
    
    modalHtml += `
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 15px;">
                    <button onclick="closeFileHistory()" class="btn" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px;">Cerrar</button>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Cerrar modal de historial
function closeFileHistory() {
    const modal = document.getElementById('historyModal');
    if (modal) {
        modal.remove();
    }
}

// Descargar archivo del historial
function downloadFile(inputId, historyIndex) {
    const history = fileHistories[inputId];
    if (history && history[historyIndex] && history[historyIndex].contenido) {
        const fileData = history[historyIndex];
        
        // Crear enlace de descarga
        const link = document.createElement('a');
        link.href = fileData.contenido;
        link.download = fileData.nombre;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`üì• Descargando ${fileData.nombre}`);
    } else {
        alert('‚ùå No se puede descargar el archivo. Datos no disponibles.');
    }
}

// Obtener archivo actual (actualizada)
async function getEvidenceFile(inputId) {
    return currentFiles[inputId] || null;
}

// Limpiar archivos al resetear formulario
function clearFormFiles(formId) {
    const form = document.getElementById(formId);
    const inputs = form.querySelectorAll('input[type="file"]');
    
    inputs.forEach(input => {
        const inputId = input.id;
        currentFiles[inputId] = null;
        
        const statusDiv = document.getElementById(inputId + '-status');
        const actionsDiv = document.getElementById(inputId + '-actions');
        
        if (statusDiv) {
            statusDiv.innerHTML = '<span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>';
        }
        if (actionsDiv) {
            actionsDiv.style.display = 'none';
        }
    });
}
function showEvidenceInfo(reportId) {
    const reporte = productionReports.find(r => r.id == reportId) || 
                   movementReports.find(m => m.id == reportId);
    
    if (reporte && reporte.evidencia) {
        const evidencia = reporte.evidencia;
        const sizeInMB = (evidencia.tama√±o / 1024 / 1024).toFixed(2);
        const fecha = new Date(evidencia.fechaSubida).toLocaleString();
        
        if (confirm(`üìÑ Evidencia Adjunta:\n\n‚Ä¢ Archivo: ${evidencia.nombre}\n‚Ä¢ Tama√±o: ${sizeInMB}MB\n‚Ä¢ Subido: ${fecha}\n‚Ä¢ Versi√≥n: v${evidencia.version || 1}\n\n¬øDeseas descargar el archivo?`)) {
            const link = document.createElement('a');
            link.href = evidencia.contenido;
            link.download = evidencia.nombre;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    } else {
        alert('‚ùå No hay evidencia disponible para este reporte.');
    }
}

// Configurar event listeners cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para pesta√±as
    document.querySelectorAll('.nav-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            showTab(tabName);
        });
    });
    
    // Event listeners
    document.getElementById('qr-input').addEventListener('input', analyzeQRCode);
    document.getElementById('inventory-type').addEventListener('change', updateFormSections);
    
    document.getElementById('qr-input').addEventListener('paste', function(e) {
        setTimeout(function() {
            const content = e.target.value.trim();
            if (content && (content.includes('|') || content.length >= 13)) {
                analyzeQRCode();
            }
        }, 100);
    });
    
    document.getElementById('warehouse-selector').addEventListener('click', function(e) {
        if (e.target.classList.contains('warehouse-btn')) {
            this.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            e.target.classList.add('selected');
            selectedWarehouse = e.target.dataset.warehouse;
        }
    });
    
    document.getElementById('movement-selector').addEventListener('click', function(e) {
        if (e.target.classList.contains('warehouse-btn')) {
            this.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            e.target.classList.add('selected');
            selectedMovement = e.target.dataset.movement;
        }
    });
    
    // Inicializar datos y displays
    loadSampleData();
    updateAllDisplays();
});

</script>
</body>
</html>
