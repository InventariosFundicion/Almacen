<!DOCTYPE html>
<html lang="es">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<head>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Almac√©n - Fundici√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

.nav-tabs {
    display: flex;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 20%, #667eea 100%);
    border-bottom: none;
    overflow-x: auto;
    padding: 15px 20px 0 20px;
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
}

.nav-tab {
    background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
    border: none;
    padding: 16px 24px;
    margin: 0 8px;
    border-radius: 15px 15px 0 0;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    color: #495057;
    font-weight: 600;
    font-size: 15px;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255,255,255,0.3);
    overflow: hidden;
    min-width: 120px;
    text-align: center;
}

.nav-tab:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.8s;
}

.nav-tab:hover:before {
    left: 100%;
}

.nav-tab:hover {
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(240,248,255,0.9));
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    border-color: rgba(0,123,255,0.4);
    color: #007bff;
}

.nav-tab.active {
    background: linear-gradient(135deg, #ffffff, #f8fbff);
    color: #0056b3;
    transform: translateY(-6px) scale(1.05);
    box-shadow: 0 12px 35px rgba(0,123,255,0.3);
    border-color: #007bff;
    font-weight: bold;
    z-index: 10;
}

.nav-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    height: 4px;
    background: linear-gradient(90deg, #007bff, #0056b3, #007bff);
    border-radius: 2px 2px 0 0;
    box-shadow: 0 2px 8px rgba(0,123,255,0.5);
}

.nav-tab.active::before {
    background: linear-gradient(90deg, transparent, rgba(0,123,255,0.1), transparent);
}

/* Animaci√≥n de entrada */
.nav-tab {
    animation: slideInFromTop 0.6s ease-out;
}

@keyframes slideInFromTop {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive para m√≥viles */
@media (max-width: 768px) {
    .nav-tabs {
        padding: 10px 15px 0 15px;
    }
    
    .nav-tab {
        padding: 12px 16px;
        margin: 0 4px;
        font-size: 14px;
        min-width: 100px;
    }
}
       .tab-content {
            display: none;
            padding: 30px;
        }

       .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
        }

        #qr-input {
            background: #f8f9fa;
            border: 3px solid #28a745;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            line-height: 1.4;
        }

        #qr-input:focus {
            outline: none;
            border-color: #20c997;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 8px 5px;
            text-transform: uppercase;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 6px solid #3498db;
            margin: 20px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .stats-card {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .stats-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .alert {
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .warehouse-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .warehouse-btn {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .warehouse-btn.selected {
            border-color: #e74c3c;
            background: #e74c3c;
            color: white;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .inventory-table th, .inventory-table td {
            padding: 18px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        .inventory-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: bold;
        }

        .code-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            margin: 2px;
            display: inline-block;
        }

        .pallet-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .pallet-code {
            font-size: 12px;
            padding: 2px 5px;
            margin: 1px;
            background: #e9ecef;
            border-radius: 3px;
            display: inline-block;
        }

        .pallet-info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .pallet-id {
            font-size: 1.2em;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .scanner-hint {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }

        .auto-detect {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .existing-code {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .existing-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .existing-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .duplicate-warning {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #721c24;
        }

        .model-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
        }

        .model-header {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
        }

        .state-subsection {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
        }

        .state-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .movement-list {
            font-size: 0.9em;
            color: #6c757d;
            margin: 5px 0;
        }

        .collapsible-content {
            display: block;
        }
        .file-management-container {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    background: #f8f9fa;
}

.file-upload-area {
    cursor: pointer;
    text-align: center;
    padding: 20px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.file-upload-area:hover {
    background: #e9ecef;
}

.file-status {
    font-size: 14px;
}

.file-placeholder {
    color: #6c757d;
}

.file-info {
    color: #495057;
    font-weight: bold;
}

.file-success {
    color: #28a745;
    font-weight: bold;
}

.file-actions {
    margin-top: 15px;
    text-align: center;
}

.file-actions .btn {
    margin: 0 5px;
    font-size: 12px;
    padding: 5px 10px;
}

.btn-sm {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

.file-history-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.file-history-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 600px;
    max-height: 70vh;
    overflow-y: auto;
    position: relative;
}

.file-history-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}
    .camera-container {
    position: relative;
    margin: 15px 0;
    border: 2px solid #28a745;
    border-radius: 10px;
    overflow: hidden;
    background: #000;
}

.camera-video {
    width: 100%;
    max-width: 400px;
    height: 300px;
    object-fit: cover;
}

.camera-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 200px;
    border: 2px solid #28a745;
    border-radius: 10px;
    pointer-events: none;
}

.camera-controls {
    text-align: center;
    margin: 10px 0;
}

.camera-status {
    background: #e3f2fd;
    border: 1px solid #2196f3;
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    text-align: center;
    font-size: 14px;
}
.mode-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.codes-list {
    max-height: 300px;
    overflow-y: auto;
    scroll-behavior: smooth;  /* üÜï AGREGAR ESTA L√çNEA */
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    background: #f8f9fa;
}
/* üÜï AGREGAR ESTAS L√çNEAS NUEVAS: */
.codes-list::-webkit-scrollbar {
    width: 8px;
}

.codes-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.codes-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.codes-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
.code-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    margin: 3px 0;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
}

.code-valid {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.code-duplicate {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.code-invalid {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

.qr-display-container {
    border: 2px solid #28a745;
    border-radius: 10px;
    padding: 20px;
    background: white;
    display: inline-block;
}
/* CSS PARA TODAS LAS SUB-PESTA√ëAS (RETENCI√ìN, SCRAP Y GESTI√ìN DE INVENTARIO) */
.sub-nav-tabs {
    display: flex;
    margin-bottom: 25px;
    gap: 12px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: none;
}

.sub-nav-tab {
    padding: 14px 28px;
    background: white;
    border: 2px solid #e9ecef;
    cursor: pointer;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: #495057;
    font-size: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    position: relative;
    overflow: hidden;
    flex: 1;
    text-align: center;
    line-height: 1.4;
}

.sub-nav-tab:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0,123,255,0.1), transparent);
    transition: left 0.6s;
}

.sub-nav-tab:hover:before {
    left: 100%;
}

.sub-nav-tab.active {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-color: #007bff;
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,123,255,0.25);
    font-weight: bold;
    animation: fadeIn 0.3s ease-out;
}

.sub-nav-tab:hover:not(.active) {
    background: linear-gradient(135deg, #ffffff, #f0f8ff);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    border-color: #007bff;
    color: #007bff;
}

.sub-nav-tab:active {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

@keyframes fadeIn {
    from {
        opacity: 0.8;
        transform: translateY(5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.grid-2 {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}
.sub-tab-content {
    display: none;
}

.sub-tab-content.active {
    display: block;
}
/* Estilos para la visualizaci√≥n de shots */
.shots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.shot-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    transition: all 0.3s ease;
}

.shot-item:hover {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.shot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
}

.shot-details p {
    margin: 5px 0;
    font-size: 0.9em;
}

/* Ocultar el campo "otro" por defecto */
#other-reason-container {
    display: none;
}

#scrap-reason:has(option[value="OTRO"]:checked) ~ #other-reason-container {
    display: block;
}
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}
/* DASHBOARD MEJORADO */
.dashboard-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    color: white;
}

.dashboard-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.dashboard-stat-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
    border-left: 5px solid;
    position: relative;
    overflow: hidden;
}

.dashboard-stat-card:before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
    border-radius: 50%;
}

.dashboard-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
}

.dashboard-stat-card.fundidos { border-left-color: #e74c3c; }
.dashboard-stat-card.acabados { border-left-color: #27ae60; }
.dashboard-stat-card.upr { border-left-color: #3498db; }
.dashboard-stat-card.lwr { border-left-color: #f39c12; }
.dashboard-stat-card.pallets { border-left-color: #9b59b6; }
.dashboard-stat-card.verification { border-left-color: #1abc9c; }

.stat-icon {
    font-size: 40px;
    opacity: 0.8;
}

.stat-content {
    flex: 1;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9em;
    color: #7f8c8d;
    font-weight: 600;
}

.dashboard-charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.chart-container:hover {
    box-shadow: 0 12px 35px rgba(0,0,0,0.12);
}

.chart-container.full-width {
    grid-column: 1 / -1;
}

.chart-header {
    margin-bottom: 20px;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 15px;
}

.chart-header h3 {
    margin: 0 0 5px 0;
    color: #2c3e50;
    font-size: 1.3em;
}

.chart-header p {
    margin: 0;
    color: #7f8c8d;
    font-size: 0.9em;
}

.chart-content {
    position: relative;
    height: 300px;
}

.quality-metrics {
    display: flex;
    justify-content: space-around;
    align-items: center;
    height: 250px;
}

.quality-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border: 8px solid #ecf0f1;
    transition: all 0.3s ease;
    position: relative;
}

.quality-circle.excellent { border-color: #27ae60; }
.quality-circle.good { border-color: #f39c12; }
.quality-circle.poor { border-color: #e74c3c; }

.quality-percentage {
    font-size: 1.8em;
    font-weight: bold;
    color: #2c3e50;
}

.quality-label {
    font-size: 0.8em;
    color: #7f8c8d;
    margin-top: 5px;
}

.activity-feed {
    max-height: 250px;
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px;
    border-bottom: 1px solid #ecf0f1;
    transition: background 0.2s ease;
}

.activity-item:hover {
    background: #f8f9fa;
}

.activity-icon {
    font-size: 1.2em;
}

.activity-text {
    flex: 1;
    color: #2c3e50;
}

.activity-time {
    font-size: 0.8em;
    color: #95a5a6;
}

.dashboard-actions {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
}

.dashboard-btn {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 25px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    cursor: pointer;
    text-decoration: none;
}

.dashboard-btn.primary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
}

.dashboard-btn.secondary {
    background: linear-gradient(135deg, #95a5a6, #7f8c8d);
    color: white;
}

.dashboard-btn.success {
    background: linear-gradient(135deg, #27ae60, #229954);
    color: white;
}

.dashboard-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.btn-icon {
    font-size: 1.2em;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard-charts-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .dashboard-actions {
        flex-direction: column;
        align-items: center;
    }
}
/* Agrega estas reglas CSS dentro del <style> */
.chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    min-height: 400px; /* Aumentar altura m√≠nima */
}

.chart-container .chart-content {
    position: relative;
    height: 350px; /* Aumentar altura del gr√°fico */
}
/* Agrega al CSS existente */
.chart-container.activity-feed {
    min-height: 350px; /* M√°s altura */
}

.activity-feed {
    max-height: 300px; /* Aumentar altura m√°xima */
    overflow-y: auto;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 12px; /* M√°s padding */
    border-bottom: 1px solid #ecf0f1;
    transition: background 0.2s ease;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Control de Almacen</h1>
            <p>Fundici√≥n 1.3</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="nav-tab" data-tab="scanner">üì± Esc√°ner QR</button>
            <button class="nav-tab" data-tab="inventory">üìã Informaci√≥n de Inventario</button>
            <button class="nav-tab" data-tab="pallets">‚öôÔ∏è Gesti√≥n de Inventario</button>
            <button class="nav-tab" data-tab="production">üè≠ Producci√≥n</button>
            <button class="nav-tab" data-tab="theoretical">üìä Te√≥rico vs F√≠sico</button>
	    <button class="nav-tab" data-tab="scrap-retention"> ‚ôªÔ∏è Retenci√≥n y Scrap</button>
             
        </div>

<!-- Dashboard Tab -->
<div id="dashboard" class="tab-content active">
    <div class="dashboard-header">
        <h2>üìä Dashboard de Control de Almac√©n</h2>
        <p style="color: #666; margin: 5px 0;">Panel de control en tiempo real</p>
    </div>

    <!-- Tarjetas de estad√≠sticas principales -->
    <div class="dashboard-stats-grid">
        <div class="dashboard-stat-card fundidos">
            <div class="stat-icon">üî•</div>
            <div class="stat-content">
                <div class="stat-number" id="total-fundidos">0</div>
                <div class="stat-label">FUNDIDOS</div>
            </div>
        </div>
        
        <div class="dashboard-stat-card acabados">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
                <div class="stat-number" id="total-acabados">0</div>
                <div class="stat-label">ACABADOS</div>
            </div>
        </div>
        
        <div class="dashboard-stat-card upr">
            <div class="stat-icon">üî∫</div>
            <div class="stat-content">
                <div class="stat-number" id="total-upr">0</div>
                <div class="stat-label">UPR</div>
            </div>
        </div>
        
        <div class="dashboard-stat-card lwr">
            <div class="stat-icon">üîª</div>
            <div class="stat-content">
                <div class="stat-number" id="total-lwr">0</div>
                <div class="stat-label">LWR</div>
            </div>
        </div>
        
        <div class="dashboard-stat-card pallets">
            <div class="stat-icon">üì¶</div>
            <div class="stat-content">
                <div class="stat-number" id="total-pallets">0</div>
                <div class="stat-label">TARIMAS</div>
            </div>
        </div>
        
        <div class="dashboard-stat-card verification">
            <div class="stat-icon">üîç</div>
            <div class="stat-content">
                <div class="stat-number" id="verification-count">0</div>
                <div class="stat-label">VERIFICADAS</div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos principales -->
    <div class="dashboard-charts-grid">
        <!-- Gr√°fico de estatus por modelo -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>üìà Estatus de Material por Modelo</h3>
                <p>Distribuci√≥n actual del inventario</p>
            </div>
            <div class="chart-content">
                <canvas id="statusByModelChart"></canvas>
            </div>
        </div>

        <!-- Gr√°fico de distribuci√≥n general -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>üç© Distribuci√≥n de Almacenes</h3>
                <p>Vista general de ubicaciones</p>
            </div>
            <div class="chart-content">
                <canvas id="warehouseDistributionChart"></canvas>
            </div>
        </div>

        <!-- Gr√°fico de producci√≥n diaria -->
        <div class="chart-container full-width">
            <div class="chart-header">
                <h3>üìä Resultados de Producci√≥n Diarios</h3>
                <p>Eficiencia y porcentajes de calidad</p>
            </div>
            <div class="chart-content">
                <canvas id="dailyProductionChart"></canvas>
            </div>
        </div>

        <!-- M√©tricas de calidad -->
<div class="chart-container">
    <div class="chart-header">
        <h3>üéØ M√©tricas de Calidad</h3>
        <p>Porcentajes de eficiencia</p>
        <!-- AGREGAR FILTROS -->
        <div style="display: flex; gap: 15px; margin: 15px 0;">
            <div>
                <label>M√°quina:</label>
                <select id="quality-machine-filter" onchange="updateQualityMetrics()" style="padding: 5px;">
                    <option value="">Todas</option>
                    <option value="30">M√°quina 30</option>
                    <option value="31">M√°quina 31</option>
                    <option value="32">M√°quina 32</option>
                    <option value="33">M√°quina 33</option>
                    <option value="34">M√°quina 34</option>
                </select>
            </div>
            <div>
                <label>Fecha:</label>
                <input type="date" id="quality-date-filter" onchange="updateQualityMetrics()" style="padding: 5px;">
            </div>
        </div>
    </div>
    <div class="quality-metrics" style="height: 300px;"> <!-- M√°s altura -->
        <div class="quality-metric">
            <div class="quality-circle" id="quality-efficiency">
                <span class="quality-percentage" id="efficiency-percentage">0%</span>
                <span class="quality-label">Eficiencia</span>
            </div>
        </div>
        <div class="quality-metric">
            <div class="quality-circle" id="quality-defects">
                <span class="quality-percentage" id="defects-percentage">0%</span>
                <span class="quality-label">Defectos</span>
            </div>
        </div>
    </div>
</div>

        <!-- Resumen de actividad -->
        <div class="chart-container">
            <div class="chart-header">
                <h3>‚ö° Actividad Reciente</h3>
                <p>√öltimos movimientos</p>
            </div>
            <div class="activity-feed" id="recent-activity">
                <div class="activity-item">
                    <span class="activity-icon">üì¶</span>
                    <span class="activity-text">Sistema iniciado</span>
                    <span class="activity-time">Ahora</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="dashboard-actions">
        <button class="dashboard-btn primary" onclick="exportData()">
            <span class="btn-icon">üìä</span>
            <span class="btn-text">Exportar Datos</span>
        </button>
        <button class="dashboard-btn secondary" onclick="refreshDashboard()">
            <span class="btn-icon">üîÑ</span>
            <span class="btn-text">Actualizar</span>
        </button>
        <button class="dashboard-btn success" onclick="generateReport()">
            <span class="btn-icon">üìã</span>
            <span class="btn-text">Generar Reporte</span>
        </button>
    </div>
</div>

<!-- Scanner Tab -->
<div id="scanner" class="tab-content">
    <h2>üì± Procesamiento de C√≥digos QR</h2>

    <!-- Selector de Modo -->
    <div class="card">
        <h3>Selecciona el Modo de Trabajo</h3>
        <div class="warehouse-selector">
            <div class="warehouse-btn" id="mode-scanner" onclick="showScannerMode()">üì± Escanear QR Existente</div>
            <div class="warehouse-btn" id="mode-generator" onclick="showGeneratorMode()">üè∑Ô∏è Generar QR de Tarima</div>
        </div>
    </div>

    <!-- Modo Scanner (Original) -->
    <div id="scanner-mode" class="card">
        <h3>Procesar C√≥digo QR</h3>

        <div class="scanner-hint">
            üí° <strong>Opciones disponibles:</strong> üì± Usa la c√°mara para escanear QR, üñ•Ô∏è usa scanner f√≠sico, o ‚úçÔ∏è pega el c√≥digo manualmente.
        </div>

        <!-- Controles de c√°mara -->
        <div class="camera-controls">
            <button class="btn btn-success" id="start-camera-btn" onclick="startCamera()">üì∑ Activar C√°mara</button>
            <button class="btn btn-danger" id="stop-camera-btn" onclick="stopCamera()" style="display: none;">‚èπÔ∏è Detener C√°mara</button>
            <button class="btn btn-info" id="switch-camera-btn" onclick="switchCamera()" style="display: none;">üîÑ Cambiar C√°mara</button>
        </div>

        <!-- Contenedor de la c√°mara -->
        <div id="camera-container" class="camera-container" style="display: none;">
            <video id="camera-video" class="camera-video" autoplay muted playsinline></video>
            <div class="camera-overlay"></div>
            <div id="camera-status" class="camera-status">üì∑ Posiciona el c√≥digo QR dentro del recuadro verde</div>
        </div>

        <div class="form-group">
            <label>C√≥digo QR (Tarima o Individual):</label>
            <textarea id="qr-input" rows="4" placeholder="El c√≥digo aparecer√° aqu√≠ autom√°ticamente al escanearlo, o puedes pegarlo manualmente..." autofocus></textarea>
            <div id="qr-analysis"></div>
        </div>

        <div class="form-group">
            <label>Tipo de Inventario:</label>
            <select id="inventory-type">
                <option value="movimiento">üì¶ Movimiento Normal</option>
                <option value="inicial">üéØ Inventario Inicial</option>
                <option value="turno">‚è∞ Inventario por Turno</option>
            </select>
        </div>

        <div class="form-group">
            <label>Turno:</label>
            <select id="shift">
                <option value="1">Primer Turno (07:00 am - 07:00 pm)</option>
                <option value="2">Segundo Turno (07:00 pm - 07:00 am)</option>
            </select>
        </div>

        <div class="form-group" id="individual-state-section" style="display: none;">
            <label>Estado del Material (Pieza Individual):</label>
            <select id="individual-state">
                <option value="fundidos">üî• Fundido</option>
                <option value="acabados">‚úÖ Acabado</option>
            </select>
        </div>

        <div class="form-group" id="movement-destination-section" style="display: none;">
            <label>Destino del Movimiento:</label>
            <div class="warehouse-selector" id="movement-selector">
                <div class="warehouse-btn" data-movement="envios">üì¶ ENV√çOS</div>
                <div class="warehouse-btn" data-movement="retenciones">‚è∏Ô∏è RETENCIONES</div>
                <div class="warehouse-btn" data-movement="scrap">‚ôªÔ∏è SCRAP</div>
                <div class="warehouse-btn" data-movement="pruebas">üß™ PRUEBAS</div>
            </div>
        </div>

        <div class="form-group" id="warehouse-override-section" style="display: none;">
            <label>Forzar Almac√©n (Tarima sin estado detectado):</label>
            <div class="warehouse-selector" id="warehouse-selector">
                <div class="warehouse-btn" data-warehouse="fundidos">üî• FUNDIDOS</div>
                <div class="warehouse-btn" data-warehouse="acabados">‚úÖ ACABADOS</div>
            </div>
        </div>
        <button class="btn btn-success" onclick="handleAsyncCall(() => processQRCode())">‚úÖ Procesar C√≥digo QR</button>
        <button class="btn btn-info" onclick="clearForm()">üîÑ Limpiar</button>
        <button class="btn btn-warning" onclick="handleStartNewShiftVerification()">üÜï Nuevo Turno</button>
        <div id="process-result" style="margin-top: 20px;"></div>
    </div>
    <!-- Modo Generador (Nuevo) -->
    <div id="generator-mode" class="card" style="display: none;">
        <h3>üè∑Ô∏è Generar C√≥digo QR de Tarima</h3>

        <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
            <div class="form-group">
                <label>üè≠ Zona/ID de Tarima:</label>
                <input type="text" id="gen-zona" placeholder="Ej: A3, B7, TARM001..." required />
            </div>
            <div class="form-group">
                <label>üì¶ Tipo de Material:</label>
                <select id="gen-tipo" required>
                    <option value="">Seleccionar...</option>
                    <option value="FUNDIDO">üî• Fundido</option>
                    <option value="ACABADO">‚úÖ Acabado</option>
                    <option value="MIXED">üîÄ Mixto</option>
                </select>
            </div>
        </div>

        <!-- Entrada de c√≥digos con c√°mara -->
        <div class="form-group">
            <label>üìã C√≥digos de Piezas Individuales:</label>
            <div class="camera-controls">
                <button class="btn btn-success" id="gen-start-camera-btn" onclick="startGeneratorCamera()">üì∑ Usar C√°mara</button>
                <button class="btn btn-danger" id="gen-stop-camera-btn" onclick="stopGeneratorCamera()" style="display: none;">‚èπÔ∏è Detener</button>
                <button class="btn btn-info" onclick="pasteCodesFromClipboard()">üìã Pegar desde Portapapeles</button>
                <button class="btn btn-warning" onclick="clearAllCodes()">üóëÔ∏è Limpiar Todo</button>
            </div>

            <!-- C√°mara para c√≥digos individuales -->
            <div id="gen-camera-container" class="camera-container" style="display: none;">
                <video id="gen-camera-video" class="camera-video" autoplay muted playsinline></video>
                <div class="camera-overlay"></div>
                <div id="gen-camera-status" class="camera-status">üì∑ Escanea los c√≥digos individuales uno por uno</div>
            </div>

            <textarea id="gen-codigos" rows="8" placeholder="Los c√≥digos aparecer√°n aqu√≠ conforme los escanees, o puedes pegarlos manualmente (uno por l√≠nea)..."></textarea>
            <div id="gen-validation-info" class="auto-detect" style="display: none;">
                <strong>üìä Resumen:</strong> <span id="codes-count">0</span> c√≥digos | <span id="duplicates-count">0</span> duplicados | <span id="invalid-count">0</span> inv√°lidos
            </div>
        </div>

        <!-- Lista de c√≥digos con validaci√≥n visual -->
        <div class="form-group">
            <label>üîç C√≥digos Validados:</label>
            <div id="codes-validation-list" class="pallet-preview">
                <p style="color: #6c757d; font-style: italic;">Los c√≥digos aparecer√°n aqu√≠ conforme los agregues...</p>
            </div>
        </div>

        <button class="btn btn-success" onclick="generatePalletQR()" id="generate-qr-btn" disabled>üè∑Ô∏è Generar C√≥digo QR de Tarima</button>
        <button class="btn btn-info" onclick="clearGeneratorForm()">üîÑ Limpiar Formulario</button>
    </div>

    <!-- Resultado de QR Generado -->
    <div id="qr-result" class="card" style="display: none; position: relative; z-index: 1; background: white; margin: 20px 0; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
        <h3>‚úÖ C√≥digo QR de Tarima Generado</h3>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <h4>üìã Informaci√≥n de la Tarima:</h4>
                <div id="qr-info"></div>
            </div>
            <div style="text-align: center;">
                <h4>üè∑Ô∏è C√≥digo QR:</h4>
                <div id="qr-display"></div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="downloadQRImage()">üì• Descargar Imagen</button>
                    <button class="btn btn-info" onclick="copyQRText()">üìã Copiar Texto</button>
                    <button class="btn btn-warning" onclick="printQR()">üñ®Ô∏è Imprimir</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>üìù Texto del QR (para verificaci√≥n):</label>
            <textarea id="qr-text" rows="3" readonly style="background: #f8f9fa;"></textarea>
        </div>
    </div>
</div>
<!-- Cierre del Scanner -->

<!-- Inventory Tab -->
<div id="inventory" class="tab-content">
    <h2>üìã Inventario Detallado</h2>

    <div style="text-align: center; margin-bottom: 20px;">
        <button onclick="clearAllInventoryData()" class="btn" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 10px 0;">
            üóëÔ∏è LIMPIAR TODOS LOS DATOS
        </button>
    </div>
    <div class="card">
        <h3>üìä Inventario por Modelo y Estado</h3>
        <div id="detailed-inventory"></div>
    </div>

    <div class="card">
        <h3>üìä Resumen por N√∫mero de Parte</h3>
        <table class="inventory-table">
            <thead>
                <tr>
                    <th>N√∫mero de Parte</th>
                    <th>Fundidos</th>
                    <th>Acabados</th>
                    <th>Env√≠os</th>
                    <th>Retenciones</th>
                    <th>Scrap</th>
                    <th>Pruebas</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="grouped-inventory-tbody"></tbody>
        </table>
    </div>
</div>

<!-- Pallets Tab -->
<!-- Gesti√≥n de Inventario Tab -->
<div id="pallets" class="tab-content">
    <h2>‚öôÔ∏è Gesti√≥n de Inventario</h2>

    <!-- Sub-navegaci√≥n -->
    <div class="sub-nav-tabs">
        <button class="sub-nav-tab active" onclick="showInventorySubTab('tarimas-management')">üì¶ Gestionar Tarimas</button>
        <button class="sub-nav-tab" onclick="showInventorySubTab('individual-management')">üîç Gestionar C√≥digos Individuales</button>
    </div>

    <!-- Gesti√≥n de Tarimas (funcionalidad actual) -->
    <div id="tarimas-management" class="sub-tab-content active">
        <h3>üì¶ Gesti√≥n de Tarimas Completas</h3>
        <div class="card">
            <h4>üìã Registro de Tarimas</h4>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>ID Tarima</th>
                        <th>ID Original</th>
                        <th>Estado</th>
                        <th>Tipo</th>
                        <th>Piezas</th>
                        <th>Almac√©n</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="pallets-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- Gesti√≥n de C√≥digos Individuales (nueva funcionalidad) -->
    <div id="individual-management" class="sub-tab-content">
        <h3>üîç Gesti√≥n de C√≥digos QR Individuales</h3>
        
        <!-- Filtros y b√∫squeda -->
        <div class="card">
            <h4>üîç Filtros de B√∫squeda</h4>
            <div class="grid" style="grid-template-columns: repeat(4, 1fr);">
                <div class="form-group">
                    <label>üî§ Buscar por C√≥digo:</label>
                    <input type="text" id="search-individual-code" placeholder="Ej: P5QF4181O1PX2" oninput="filterIndividualItems()">
                </div>
                <div class="form-group">
                    <label>üì¶ Tipo:</label>
                    <select id="filter-individual-type" onchange="filterIndividualItems()">
                        <option value="">Todos</option>
                        <option value="UPR">üî∫ UPR</option>
                        <option value="LWR">üîª LWR</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üè™ Almac√©n:</label>
                    <select id="filter-individual-warehouse" onchange="filterIndividualItems()">
                        <option value="">Todos</option>
                        <option value="fundidos">üî• Fundidos</option>
                        <option value="acabados">‚úÖ Acabados</option>
                        <option value="envios">üì¶ Env√≠os</option>
                        <option value="retenciones">‚è∏Ô∏è Retenciones</option>
                        <option value="scrap">‚ôªÔ∏è Scrap</option>
                        <option value="pruebas">üß™ Pruebas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üìä Estado:</label>
                    <select id="filter-individual-state" onchange="filterIndividualItems()">
                        <option value="">Todos</option>
                        <option value="FUNDIDOS">üî• Fundidos</option>
                        <option value="ACABADOS">‚úÖ Acabados</option>
                        <option value="SCRAP">‚ôªÔ∏è Scrap</option>
                        <option value="RETENIDO">‚è∏Ô∏è Retenido</option>
                        <option value="ENVIADO">üì¶ Enviado</option>
                        <option value="EN_PRUEBAS">üß™ En Pruebas</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-info" onclick="clearIndividualFilters()">üîÑ Limpiar Filtros</button>
                <span id="individual-results-count" style="margin-left: 20px; font-weight: bold;">0 elementos encontrados</span>
            </div>
        </div>

        <!-- Tabla de c√≥digos individuales -->
        <div class="card">
            <h4>üìã C√≥digos QR Individuales</h4>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>C√≥digo QR</th>
                        <th>Tipo</th>
                        <th>Part Number</th>
                        <th>Estado</th>
                        <th>Almac√©n</th>
                        <th>Cantidad</th>
                        <th>√öltimo Movimiento</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="individual-codes-tbody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Production Tab -->
<div id="production" class="tab-content">
    <h2>üè≠ Control de Producci√≥n</h2>

    <!-- Selector de Proceso -->
    <div class="card">
        <h3>üìã Seleccionar Proceso</h3>
        <div class="form-group">
            <label>Tipo de Reporte:</label>
            <select id="production-type" onchange="showProductionForm()">
                <option value="">Selecciona un proceso...</option>
                <option value="fundicion">üî• Reporte de Fundici√≥n</option>
                <option value="acabado">‚úÖ Reporte de Acabado</option>
                <option value="movimientos">üì¶ Movimientos de Material</option>
            </select>
        </div>
    </div>

    <!-- Formulario de Fundici√≥n -->
    <div id="fundicion-form" class="card" style="display: none;">
        <h3>üî• Reporte de Fundici√≥n</h3>
        <form id="production-fundicion-form">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>Fecha de Producci√≥n:</label>
                    <input type="date" id="fund-fecha" required />
                </div>
                <div class="form-group">
                    <label>Turno:</label>
                    <select id="fund-turno" required>
                        <option value="1">Primer Turno (07:00-19:00)</option>
                        <option value="2">Segundo Turno (19:00-07:00)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>M√°quina:</label>
                    <select id="fund-maquina" onchange="updateModelOptions('fund')" required>
                        <option value="">Seleccionar...</option>
                        <option value="30">M√°quina #30 (LWR)</option>
                        <option value="31">M√°quina #31 (LWR)</option>
                        <option value="32">M√°quina #32 (UPR)</option>
                        <option value="33">M√°quina #33 (UPR)</option>
                        <option value="34">M√°quina #34 (UPR)</option>
                    </select>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Modelo:</label>
                    <select id="fund-modelo" onchange="updateMoldeOptions('fund')" required>
                        <option value="">Primero selecciona m√°quina...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Molde:</label>
                    <select id="fund-molde" required>
                        <option value="">Primero selecciona modelo...</option>
                    </select>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>Cantidad Total Producida:</label>
                    <input type="number" id="fund-total" min="0" oninput="calculateGoodParts('fund')" required />
                </div>
                <div class="form-group">
                    <label>Cantidad NG (No Good):</label>
                    <input type="number" id="fund-ng" min="0" oninput="calculateGoodParts('fund')" required />
                </div>
                <div class="form-group">
                    <label>Piezas Buenas (Autom√°tico):</label>
                    <input type="number" id="fund-buenas" readonly style="background: #e9ecef;" />
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label>üìÑ Evidencia (PDF del reporte escaneado):</label>
                <div class="file-management-container">
                    <input type="file" id="fund-evidencia" accept=".pdf" onchange="handleFileSelection('fund-evidencia')" style="display: none;" />
                    <div class="file-upload-area" onclick="document.getElementById('fund-evidencia').click()">
                        <div id="fund-evidencia-status" class="file-status">
                            <span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>
                        </div>
                    </div>
                    <div id="fund-evidencia-actions" class="file-actions" style="display: none;">
                        <button type="button" class="btn btn-sm btn-warning" onclick="replaceFile('fund-evidencia')">üîÑ Reemplazar</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeFile('fund-evidencia')">üóëÔ∏è Eliminar</button>
                        <button type="button" class="btn btn-sm btn-info" onclick="viewFileHistory('fund-evidencia')">üìã Historial</button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success" onclick="handleSaveProductionReport('fundicion')">üî• Guardar Reporte de Fundici√≥n</button>
        </form>
    </div>

    <!-- Formulario de Acabado -->
    <div id="acabado-form" class="card" style="display: none;">
        <h3>‚úÖ Reporte de Acabado</h3>
        <form id="production-acabado-form">
            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>Fecha de Producci√≥n:</label>
                    <input type="date" id="acab-fecha" required />
                </div>
                <div class="form-group">
                    <label>Turno:</label>
                    <select id="acab-turno" required>
                        <option value="1">Primer Turno (07:00-19:00)</option>
                        <option value="2">Segundo Turno (19:00-07:00)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>M√°quina de Acabado:</label>
                    <select id="acab-maquina" required>
                        <option value="">Seleccionar...</option>
                        <option value="30">Acabado AC-30</option>
                        <option value="31">Acabado AC-31</option>
                        <option value="32">Acabado AC-32</option>
                        <option value="33">Acabado AC-33</option>
                        <option value="34">Acabado AC-34</option>
                    </select>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>N√∫mero de parte:</label>
                    <select id="acab-modelo" onchange="updateMoldeOptions('acab')" required>
                        <option value="">Seleccionar...</option>
                        <option value="PX13-10-382-FUN">PX13-10-382 (LWR)</option>
                        <option value="PEDD-10-382-A-FUN">PEDD-10-382-A (LWR)</option>
                        <option value="P54G-10-382-FUN">P54G-10-382 (LWR)</option>
                        <option value="PX13-10-301-FUN">PX13-10-301 (UPR)</option>
                        <option value="PEDD-10-301-A-FUN">PEDD-10-301-A (UPR)</option>
                        <option value="P54G-10-301-A-FUN">P54G-10-301-A (UPR)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Molde:</label>
                    <select id="acab-molde" required>
                        <option value="">Primero selecciona modelo...</option>
                    </select>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>Cantidad Total Procesada:</label>
                    <input type="number" id="acab-total" min="0" oninput="calculateGoodParts('acab')" required />
                </div>
                <div class="form-group">
                    <label>Cantidad NG (No Good):</label>
                    <input type="number" id="acab-ng" min="0" oninput="calculateGoodParts('acab')" required />
                </div>
                <div class="form-group">
                    <label>Piezas Buenas (Autom√°tico):</label>
                    <input type="number" id="acab-buenas" readonly style="background: #e9ecef;" />
                </div>
            </div>
            <div class="form-group" style="margin-top: 20px;">
                <label>üìÑ Evidencia (PDF del reporte escaneado):</label>
                <div class="file-management-container">
                    <input type="file" id="acab-evidencia" accept=".pdf" onchange="handleFileSelection('acab-evidencia')" style="display: none;" />
                    <div class="file-upload-area" onclick="document.getElementById('acab-evidencia').click()">
                        <div id="acab-evidencia-status" class="file-status">
                            <span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>
                        </div>
                    </div>
                    <div id="acab-evidencia-actions" class="file-actions" style="display: none;">
                        <button type="button" class="btn btn-sm btn-warning" onclick="replaceFile('acab-evidencia')">üîÑ Reemplazar</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeFile('acab-evidencia')">üóëÔ∏è Eliminar</button>
                        <button type="button" class="btn btn-sm btn-info" onclick="viewFileHistory('acab-evidencia')">üìã Historial</button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success" onclick="handleSaveProductionReport('acabado')">‚úÖ Guardar Reporte de Acabado</button>
        </form>
    </div>

    <!-- Formulario de Movimientos -->
    <div id="movimientos-form" class="card" style="display: none;">
        <h3>üì¶ Movimientos de Material</h3>
        <form id="production-movimientos-form">
            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Tipo de Movimiento:</label>
                    <select id="mov-tipo" required>
                        <option value="">Seleccionar...</option>
                        <option value="scrap">‚ôªÔ∏è Scrap Adicional</option>
                        <option value="envios">üì¶ Env√≠os</option>
                        <option value="retenciones">‚è∏Ô∏è Retenciones</option>
                        <option value="pruebas">üß™ Pruebas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha:</label>
                    <input type="date" id="mov-fecha" required />
                </div>
            </div>

            <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                <div class="form-group">
                    <label>M√°quina/√Årea:</label>
                    <select id="mov-maquina" required>
                        <option value="">Seleccionar...</option>
                        <option value="30">M√°quina #30 (LWR)</option>
                        <option value="31">M√°quina #31 (LWR)</option>
                        <option value="32">M√°quina #32 (UPR)</option>
                        <option value="33">M√°quina #33 (UPR)</option>
                        <option value="34">M√°quina #34 (UPR)</option>
                        <option value="AC-30">Acabado AC-30</option>
                        <option value="AC-31">Acabado AC-31</option>
                        <option value="AC-32">Acabado AC-32</option>
                        <option value="AC-33">Acabado AC-33</option>
                        <option value="AC-34">Acabado AC-34</option>
                        <option value="ALMACEN">Almac√©n General</option>
                        <option value="ENVIOS">√Årea de Env√≠os</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Modelo/N√∫mero de Parte:</label>
                    <select id="mov-modelo" onchange="updateMoldeOptions('mov')" required>
                        <option value="">Seleccionar...</option>
                        <option value="PX13-10-382-FUN">PX13-10-382 (LWR)</option>
                        <option value="PEDD-10-382-A-FUN">PEDD-10-382-A (LWR)</option>
                        <option value="P54G-10-382-FUN">P54G-10-382 (LWR)</option>
                        <option value="PX13-10-301-FUN">PX13-10-301 (UPR)</option>
                        <option value="PEDD-10-301-A-FUN">PEDD-10-301-A (UPR)</option>
                        <option value="P54G-10-301-A-FUN">P54G-10-301-A (UPR)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Molde:</label>
                    <select id="mov-molde" required>
                        <option value="">Primero selecciona modelo...</option>
                    </select>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Cantidad:</label>
                    <input type="number" id="mov-cantidad" min="1" required />
                </div>
                <div class="form-group">
                    <label>Comentarios/Raz√≥n:</label>
                    <textarea id="mov-comentarios" rows="3" placeholder="Describe la raz√≥n del movimiento..."></textarea>
                </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label>üìÑ Evidencia (PDF de la documentaci√≥n):</label>
                <div class="file-management-container">
                    <input type="file" id="mov-evidencia" accept=".pdf" onchange="handleFileSelection('mov-evidencia')" style="display: none;" />
                    <div class="file-upload-area" onclick="document.getElementById('mov-evidencia').click()">
                        <div id="mov-evidencia-status" class="file-status">
                            <span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>
                        </div>
                    </div>
                    <div id="mov-evidencia-actions" class="file-actions" style="display: none;">
                        <button type="button" class="btn btn-sm btn-warning" onclick="replaceFile('mov-evidencia')">üîÑ Reemplazar</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeFile('mov-evidencia')">üóëÔ∏è Eliminar</button>
                        <button type="button" class="btn btn-sm btn-info" onclick="viewFileHistory('mov-evidencia')">üìã Historial</button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success" onclick="handleSaveMovementReport()">üì¶ Guardar Movimiento</button>
        </form>
    </div>

    <!-- Resumen de Reportes -->
    <div class="card">
        <h3>üìä Reportes del Turno Actual</h3>
        <div id="production-summary"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-primary" onclick="generateTheoreticalBalance()">üßÆ Calcular Balance Te√≥rico</button>
            <button class="btn btn-info" onclick="showProductionReport()">üìã Ver Reporte Completo</button>
        </div>
    </div>

    <!-- Nueva secci√≥n: Gesti√≥n de Reportes -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>üìã Gesti√≥n de Reportes de Producci√≥n</h3>
            <button class="btn btn-primary" onclick="refreshProductionReports()">üîÑ Actualizar</button>
        </div>

        <!-- Filtros -->
        <div class="production-filters" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="form-group">
                    <label>üìÖ Fecha Desde:</label>
                    <input type="date" id="filter-date-from" onchange="filterProductionReports()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div class="form-group">
                    <label>üìÖ Fecha Hasta:</label>
                    <input type="date" id="filter-date-to" onchange="filterProductionReports()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div class="form-group">
                    <label>üè≠ Proceso:</label>
                    <select id="filter-process" onchange="filterProductionReports()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Todos los procesos</option>
                        <option value="fundicion">üî• Fundici√≥n</option>
                        <option value="acabado">‚úÖ Acabado</option>
                        <option value="movimientos">üì¶ Movimientos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‚öôÔ∏è M√°quina:</label>
                    <select id="filter-machine" onchange="filterProductionReports()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Todas las m√°quinas</option>
                        <option value="30">M√°quina #30</option>
                        <option value="31">M√°quina #31</option>
                        <option value="32">M√°quina #32</option>
                        <option value="33">M√°quina #33</option>
                        <option value="34">M√°quina #34</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div id="production-reports-table" style="overflow-x: auto;">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>üìÖ Fecha</th>
                        <th>üè≠ Tipo</th>
                        <th>‚öôÔ∏è M√°quina</th>
                        <th>üì¶ Modelo</th>
                        <th>üîß Molde</th>
                        <th>üìä Total</th>
                        <th>‚ùå NG</th>
                        <th>‚úÖ Buenas</th>
                        <th>üìà Eficiencia</th>
                        <th>üìÑ Evidencia</th>
                        <th>‚öôÔ∏è Acciones</th>
                    </tr>
                </thead>
                <tbody id="production-reports-tbody">
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 20px;">
                            üìä Selecciona filtros para ver los reportes
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Contador de resultados -->
            <div style="margin-top: 15px; text-align: center;">
                <span id="reports-count" style="color: #666; font-style: italic;">
                    Selecciona filtros para mostrar reportes
                </span>
            </div>

            <!-- Modal para editar reporte -->
            <div id="edit-report-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="closeEditReportModal()">&times;</span>
                    <h3>‚úèÔ∏è Editar Reporte de Producci√≥n</h3>
                    <div id="edit-report-form-container"></div>
                </div>
            </div>
        </div> <!-- ‚úÖ Cierra production-reports-table -->
    </div> <!-- ‚úÖ Cierra card de Gesti√≥n de Reportes -->
</div> <!-- ‚úÖ Cierra div principal de production -->

<!-- Theoretical vs Physical Tab -->
<div id="theoretical" class="tab-content">
    <h2>üìä Inventario Te√≥rico vs F√≠sico</h2>

    <div class="card">
        <h3>üéØ Verificaci√≥n F√≠sica del Turno</h3>
        <div id="current-verification">
            <div class="alert alert-info">
                üí° <strong>Instrucciones:</strong>
                <br /> 1. Selecciona "Inventario por Turno" en el esc√°ner
                <br /> 2. Escanea las tarimas/piezas f√≠sicamente presentes
                <br /> 3. Genera el reporte de comparaci√≥n aqu√≠
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üìã Inventario Te√≥rico Calculado</h3>
        <div id="theoretical-summary">
            <div class="alert alert-info">
                Presiona "Generar Reporte" para calcular el inventario te√≥rico basado en los registros del sistema.
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üîç Comparaci√≥n Detallada</h3>
        <div id="verification-comparison">
            <div class="alert alert-info">
                La comparaci√≥n aparecer√° aqu√≠ despu√©s de generar el reporte.
            </div>
        </div>
    </div>

    <div class="card">
        <h3>‚ö†Ô∏è Diferencias Encontradas</h3>
        <div id="discrepancies-report">
            <div class="alert alert-info">
                Las diferencias cr√≠ticas aparecer√°n aqu√≠ si las hay.
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button class="btn btn-primary" onclick="generateTheoreticalReport()">üìä Generar Reporte</button>
        <button class="btn btn-success" onclick="exportVerificationReport()">üì§ Exportar PDF</button>
        <button class="btn btn-info" onclick="printVerificationSummary()">üñ®Ô∏è Imprimir Resumen</button>
        <button class="btn btn-warning" onclick="startNewShiftVerification()">üÜï Nuevo Turno</button>
    </div>
</div> <!-- ‚úÖ CIERRE de la pesta√±a THEORETICAL -->

<!-- Retenci√≥n y Scrap Tab -->
<div id="scrap-retention" class="tab-content">
    <h2>‚ôªÔ∏è Retenci√≥n y Scrap Adicional</h2>
    
    <div class="sub-nav-tabs">
        <button class="sub-nav-tab active" onclick="showSubTab('new-scrap')">üìù Crear Nueva Hoja de Reporte de Scrap Adicional</button>
        <button class="sub-nav-tab" onclick="showSubTab('retenciones')">‚è∏Ô∏è Crear Retenci√≥n de material</button>
        <button class="sub-nav-tab" onclick="showSubTab('manage-sheets')">üìã Gestionar Hojas de Scrap Adicional</button>
        <button class="sub-nav-tab" onclick="showSubTab('reports')">üìä Reporte general de estado de hojas creadas</button>
    </div>
    
    <!-- ==================== SUB-PESTA√ëA 1: Nueva Hoja de Scrap ==================== -->
    <div id="new-scrap" class="sub-tab-content active">
        <h2>üìù Nueva Hoja de Scrap Adicional</h2>
        
        <div class="card">
            <h3>üìã Informaci√≥n General</h3>
            <div class="grid grid-3">
                <div class="form-group">
                    <label>üìÑ Folio:</label>
                    <input type="text" id="folio" readonly style="background: #e9ecef;">
                </div>
                <div class="form-group">
                    <label>üìÖ Fecha de Operaci√≥n:</label>
                    <input type="date" id="fecha-operacion" required>
                </div>
                <div class="form-group">
                    <label>üë§ Sector de Trabajo:</label>
                    <select id="sector-trabajo">
                        <option value="">Seleccionar...</option>
                        <option value="FUNDICION">üî• Fundici√≥n</option>
                        <option value="ACABADO">‚úÖ Acabado</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="form-group">
                    <label>üè≠ N√∫mero de Producto:</label>
                    <select id="numero-producto" onchange="updateProductInfo()">
                        <option value="">Seleccionar...</option>
                        <option value="PX13-10-382">PX13-10-382 (LWR)</option>
                        <option value="PEDD-10-382-A">PEDD-10-382-A (LWR)</option>
                        <option value="P54G-10-382">P54G-10-382 (LWR)</option>
                        <option value="PX13-10-301">PX13-10-301 (UPR)</option>
                        <option value="PEDD-10-301-A">PEDD-10-301-A (UPR)</option>
                        <option value="P54G-10-301-A">P54G-10-301-A (UPR)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üìù Nombre del Producto:</label>
                    <input type="text" id="nombre-producto" value="" readonly style="background: #e9ecef;">
                </div>
            </div>

            <div class="grid grid-3">
                <div class="form-group">
                    <label>üîß N√∫mero de Molde:</label>
                    <select id="molde-producto">
                        <option value="">Primero selecciona un producto...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üë∑ Creado por:</label>
                    <input type="text" id="creado-por" placeholder="Nombre del operador" required>
                </div>
                <div class="form-group">
                    <label>üè¢ Almac√©n Origen:</label>
                    <select id="almacen-origen" required>
                        <option value="">Seleccionar...</option>
                        <option value="ALMACEN_FUNDICION">üî• Almac√©n Fundici√≥n</option>
                        <option value="ALMACEN_ACABADO">‚úÖ Almac√©n Acabado</option>
                        <option value="ALMACEN_RETENCION">‚ö†Ô∏è Almac√©n Retenci√≥n</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN DE ESC√ÅNER DE SHOTS INTEGRADA -->
        <div class="card">
            <h3>üîç Esc√°ner de Shots</h3>

            <!-- Opci√≥n de entrada manual o c√°mara -->
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-info" onclick="toggleScrapCameraMode()">
                    <span id="camera-mode-text">üì∑ Activar C√°mara</span>
                </button>
            </div>

            <!-- Contenedor de la c√°mara (oculto por defecto) -->
            <div id="scrap-camera-section" style="display: none;">
                <div class="camera-controls" style="text-align: center; margin-bottom: 15px;">
                    <button class="btn btn-danger" onclick="stopScrapCamera()">‚èπÔ∏è Detener C√°mara</button>
                </div>
                <div id="scrap-camera-container" class="camera-container">
                    <video id="scrap-camera-video" class="camera-video" autoplay muted playsinline></video>
                    <div class="camera-overlay"></div>
                    <div id="scrap-camera-status" class="camera-status">üì∑ Posiciona el c√≥digo QR del shot</div>
                </div>
            </div>

            <!-- Entrada manual -->
            <div id="manual-entry-section">
                <div class="grid grid-2">
                    <div class="form-group">
                        <div class="form-group">
                            <label>üì± Ingresa C√≥digo QR:</label>
                            <input type="text" id="shot-number" placeholder="Ej: P5QF4181O1PX2 (UPR) o 25E153003154276P5 (LWR)" maxlength="17">
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="form-group">
                    <label>üìù Motivo del Scrap:</label>
                    <select id="scrap-reason">
                        <option value="">Seleccionar...</option>
                        <option value="RALLADURA">ü™ö Ralladura</option>
                        <option value="RALLADURA_PRENSA">ü™ö Ralladura por Prensa</option>
                        <option value="MANCHA">üü§ Mancha</option>
                        <option value="MANCHA_AGUA">üíß Mancha de Agua</option>
                        <option value="ARRASTRE">‚ÜóÔ∏è Arrastre</option>
                        <option value="PIN_ROTO">üî© Pin Roto</option>
                        <option value="PIN_ALTO">‚¨ÜÔ∏è Pin Alto</option>
                        <option value="PIN_BAJO">‚¨áÔ∏è Pin Bajo</option>
                        <option value="PIN_DESVIADO">‚ÜóÔ∏è Pin Desviado</option>
                        <option value="PIN_DOBLADO">„Ä∞Ô∏è Pin Doblado</option>
                        <option value="PIN_BACK">üîÑ Pin Back</option>
                        <option value="FRACTURA_CASTING">üí• Fractura en Casting</option>
                        <option value="GRIETA">üåã Grieta</option>
                        <option value="GRIETA_RECHUPE">üåã Grieta por Rechupe</option>
                        <option value="RECHUPE_CASTING">üï≥Ô∏è Rechupe/Casting</option>
                        <option value="LAMINACION_CASTING">üìÑ Laminaci√≥n/Casting</option>
                        <option value="FUGA_CASTING">üí® Fuga/Casting</option>
                        <option value="FALTA_MATERIAL_DESPOSTILLAMIENTO">‚ùå Falta de Material por Despostillamiento</option>
                        <option value="FALTA_MATERIAL_ADHERENCIA">‚ùå Falta de Material por Adherencia</option>
                        <option value="FALTA_MATERIAL_ARRANCAMIENTO">‚ùå Falta de Material por Arrancamiento</option>
                        <option value="FALTA_MATERIAL_ELEVACION">‚ùå Falta de Material por Elevaci√≥n</option>
                        <option value="FALTA_MATERIAL_OTROS">‚ùå Falta de Material (Otros)</option>
                        <option value="FALTA_MATERIAL_BARRENOS">‚ùå Falta de Material en Barrenos</option>
                        <option value="MAL_LLENADO">üåä Mal Llenado</option>
                        <option value="ROMPIMIENTO_GALLETA">üç™ Rompimiento de Galleta</option>
                        <option value="GALLETA_ANORMAL">üç™ Galleta Anormal (rota o fuera de tama√±o)</option>
                        <option value="MARCA_GOLPE_CASTING">üëä Marca de Golpe/Casting</option>
                        <option value="PUNTO_DURO">üîò Punto Duro</option>
                        <option value="DESPRENDIMIENTOS">ü™® Desprendimientos</option>
                        <option value="GRABADO_BORROSO">üî§ Grabado NG (Borroso)</option>
                        <option value="GRABADO_POSICION">üî§ Grabado Posici√≥n NG</option>
                        <option value="GRABADO_DOBLE">üî§ Grabado NG (Doble)</option>
                        <option value="NO_LEER_CODIGO">üî§ No Puede Leer C√≥digo</option>
                        <option value="OTROS_GRABADO">üî§ Otros Defectos de Grabado</option>
                        <option value="PORO_GATE">üï≥Ô∏è Poro en Gate</option>
                        <option value="PORO_OTROS">üï≥Ô∏è Poro (Otros)</option>
                        <option value="PEAK_VACUUM_ERROR">‚öôÔ∏è Peak Vacuum Pressure Time Error</option>
                        <option value="CYCLE_TIME_ERROR">‚è±Ô∏è Cycle Time Error</option>
                        <option value="TEMPERATURA_ANORMAL">üå°Ô∏è Temperatura Anormal</option>
                        <option value="SQUEEZE_ALTO">‚¨ÜÔ∏è Squeeze Alto</option>
                        <option value="SQUEEZE_BAJO">‚¨áÔ∏è Squeeze Bajo</option>
                        <option value="MAL_ACABADO_OPERADOR">üë∑ Mal Acabado por Operador</option>
                        <option value="MAL_ACABADO_OP">üë∑ Mal Acabado por OP</option>
                        <option value="PIEZAS_CAIDAS_ROBOT">ü§ñ Piezas Ca√≠das por Robot</option>
                        <option value="PIEZAS_CAIDAS_OPERADOR">üë∑ Piezas Ca√≠das por Operador</option>
                        <option value="GOLPE_OPERADOR">üë∑ Golpe en Pieza por Operador</option>
                        <option value="MARCA_HERRAMIENTA">üîß Marca de Herramienta (Robodrill)</option>
                        <option value="PIEZAS_DEFORMACION">üìè Piezas con Deformaci√≥n</option>
                        <option value="REBORDE_PLANICIDAD">üìè Reborde o Falta de Material en Zona de Planicidad</option>
                        <option value="QW_NG">üìä QW NG</option>
                        <option value="OTROS_MOLDE_CASTING">üîß Otros (Problemas de Molde)/Casting</option>
                        <option value="OTRO">üìù Otro (Especificar)</option>
                    </select>
                </div>
                <div class="form-group" id="other-reason-container">
                    <label>üìù Especificar (si es "Otro"):</label>
                    <input type="text" id="other-reason" placeholder="Describe el motivo...">
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-success" onclick="addShot()">‚ûï Agregar Shot</button>
            </div>

            <!-- Lista de shots registrados -->
            <div style="margin-top: 20px;">
                <h4>üìã Shots Registrados (<span id="total-shots">0</span>)</h4>
                <div id="current-shots-display">
                    <div class="alert alert-info">
                        üîç Los shots escaneados aparecer√°n aqu√≠
                    </div>
                </div>
                <div id="shots-list"></div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-warning" onclick="clearScannedShots()">üóëÔ∏è Limpiar Lista</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>üìù Observaciones:</label>
            <textarea id="observaciones" rows="3" placeholder="Observaciones adicionales..."></textarea>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn btn-success" onclick="handleAsyncCall(() => saveScrapSheet())">üíæ Guardar Hoja</button>
            <button class="btn btn-info" onclick="printScrapSheet()">üñ®Ô∏è Imprimir Hoja</button>
        </div>
    </div>

    <!-- ==================== SUB-PESTA√ëA 2: Retenciones ==================== -->
    <div id="retenciones" class="sub-tab-content">
        <h2>‚è∏Ô∏è Sistema de Retenciones</h2>

        <!-- Crear Nueva Retenci√≥n -->
        <div class="card">
            <h3>üìù Nueva Retenci√≥n</h3>

            <div class="grid grid-3">
                <div class="form-group">
                    <label>üìÑ Folio de Retenci√≥n:</label>
                    <input type="text" id="retencion-folio" readonly style="background: #e9ecef;">
                </div>
                <div class="form-group">
                    <label>üìÖ Fecha de Producci√≥n:</label>
                    <input type="date" id="retencion-fecha-produccion" required>
                </div>
                <div class="form-group">
                    <label>üë§ Creado por:</label>
                    <input type="text" id="retencion-creado-por" placeholder="Nombre del responsable" required>
                </div>
            </div>

            <div class="grid grid-2">
                <div class="form-group">
                    <label>üè≠ N√∫mero de Producto:</label>
                    <select id="retencion-producto" onchange="updateRetencionProductInfo()">
                        <option value="">Seleccionar...</option>
                        <option value="PX13-10-382">PX13-10-382 (LWR)</option>
                        <option value="PEDD-10-382-A">PEDD-10-382-A (LWR)</option>
                        <option value="P54G-10-382">P54G-10-382 (LWR)</option>
                        <option value="PX13-10-301">PX13-10-301 (UPR)</option>
                        <option value="PEDD-10-301-A">PEDD-10-301-A (UPR)</option>
                        <option value="P54G-10-301-A">P54G-10-301-A (UPR)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üîß N√∫mero de Molde:</label>
                    <select id="retencion-molde">
                        <option value="">Primero selecciona un producto...</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h4>üìä C√≥digos QR a Retener</h4>

                <!-- Esc√°ner integrado -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn btn-info" onclick="toggleRetencionCameraMode()">
                        <span id="retencion-camera-mode-text">üì∑ Activar C√°mara</span>
                    </button>
                </div>

                <!-- Contenedor de la c√°mara -->
                <div id="retencion-camera-section" style="display: none;">
                    <div class="camera-controls" style="text-align: center; margin-bottom: 15px;">
                        <button class="btn btn-danger" onclick="stopRetencionCamera()">‚èπÔ∏è Detener C√°mara</button>
                    </div>
                    <div id="retencion-camera-container" class="camera-container">
                        <video id="retencion-camera-video" class="camera-video" autoplay muted playsinline></video>
                        <div class="camera-overlay"></div>
                        <div id="retencion-camera-status" class="camera-status">üì∑ Posiciona el c√≥digo QR</div>
                    </div>
                </div>

                <!-- Entrada manual -->
                <div id="retencion-manual-entry-section">
                    <div class="form-group">
                        <label>üì± C√≥digo QR Individual:</label>
                        <input type="text" id="retencion-shot-code" placeholder="Ej: P5QF4181O1PX2 (UPR) o 25E153003154276P5 (LWR)" maxlength="17">
                    </div>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-success" onclick="addCodeToRetencion()">‚ûï Agregar C√≥digo</button>
                    <button class="btn btn-warning" onclick="clearRetencionCodes()">üóëÔ∏è Limpiar Lista</button>
                </div>

                <!-- Lista de c√≥digos agregados -->
                <div style="margin-top: 20px;">
                    <h5>üìã C√≥digos Agregados (<span id="retencion-total-codes">0</span>)</h5>
                    <div id="retencion-codes-display">
                        <div class="alert alert-info">
                            üîç Los c√≥digos validados aparecer√°n aqu√≠
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>üìù Motivo de la Retenci√≥n:</label>
                <select id="retencion-motivo">
                    <option value="">Seleccionar motivo...</option>
                    <option value="RALLADURA">ü™ö Ralladura</option>
                    <option value="RALLADURA_PRENSA">ü™ö Ralladura por Prensa</option>
                    <option value="MANCHA">üü§ Mancha</option>
                    <option value="MANCHA_AGUA">üíß Mancha de Agua</option>
                    <option value="ARRASTRE">‚ÜóÔ∏è Arrastre</option>
                    <option value="PIN_ROTO">üî© Pin Roto</option>
                    <option value="PIN_ALTO">‚¨ÜÔ∏è Pin Alto</option>
                    <option value="PIN_BAJO">‚¨áÔ∏è Pin Bajo</option>
                    <option value="PIN_DESVIADO">‚ÜóÔ∏è Pin Desviado</option>
                    <option value="PIN_DOBLADO">„Ä∞Ô∏è Pin Doblado</option>
                    <option value="PIN_BACK">üîÑ Pin Back</option>
                    <option value="FRACTURA_CASTING">üí• Fractura en Casting</option>
                    <option value="GRIETA">üåã Grieta</option>
                    <option value="GRIETA_RECHUPE">üåã Grieta por Rechupe</option>
                    <option value="RECHUPE_CASTING">üï≥Ô∏è Rechupe/Casting</option>
                    <option value="LAMINACION_CASTING">üìÑ Laminaci√≥n/Casting</option>
                    <option value="FUGA_CASTING">üí® Fuga/Casting</option>
                    <option value="FALTA_MATERIAL_DESPOSTILLAMIENTO">‚ùå Falta de Material por Despostillamiento</option>
                    <option value="FALTA_MATERIAL_ADHERENCIA">‚ùå Falta de Material por Adherencia</option>
                    <option value="FALTA_MATERIAL_ARRANCAMIENTO">‚ùå Falta de Material por Arrancamiento</option>
                    <option value="FALTA_MATERIAL_ELEVACION">‚ùå Falta de Material por Elevaci√≥n</option>
                    <option value="FALTA_MATERIAL_OTROS">‚ùå Falta de Material (Otros)</option>
                    <option value="FALTA_MATERIAL_BARRENOS">‚ùå Falta de Material en Barrenos</option>
                    <option value="MAL_LLENADO">üåä Mal Llenado</option>
                    <option value="ROMPIMIENTO_GALLETA">üç™ Rompimiento de Galleta</option>
                    <option value="GALLETA_ANORMAL">üç™ Galleta Anormal (rota o fuera de tama√±o)</option>
                    <option value="MARCA_GOLPE_CASTING">üëä Marca de Golpe/Casting</option>
                    <option value="PUNTO_DURO">üîò Punto Duro</option>
                    <option value="DESPRENDIMIENTOS">ü™® Desprendimientos</option>
                    <option value="GRABADO_BORROSO">üî§ Grabado NG (Borroso)</option>
                    <option value="GRABADO_POSICION">üî§ Grabado Posici√≥n NG</option>
                    <option value="GRABADO_DOBLE">üî§ Grabado NG (Doble)</option>
                    <option value="NO_LEER_CODIGO">üî§ No Puede Leer C√≥digo</option>
                    <option value="OTROS_GRABADO">üî§ Otros Defectos de Grabado</option>
                    <option value="PORO_GATE">üï≥Ô∏è Poro en Gate</option>
                    <option value="PORO_OTROS">üï≥Ô∏è Poro (Otros)</option>
                    <option value="PEAK_VACUUM_ERROR">‚öôÔ∏è Peak Vacuum Pressure Time Error</option>
                    <option value="CYCLE_TIME_ERROR">‚è±Ô∏è Cycle Time Error</option>
                    <option value="TEMPERATURA_ANORMAL">üå°Ô∏è Temperatura Anormal</option>
                    <option value="SQUEEZE_ALTO">‚¨ÜÔ∏è Squeeze Alto</option>
                    <option value="SQUEEZE_BAJO">‚¨áÔ∏è Squeeze Bajo</option>
                    <option value="MAL_ACABADO_OPERADOR">üë∑ Mal Acabado por Operador</option>
                    <option value="MAL_ACABADO_OP">üë∑ Mal Acabado por OP</option>
                    <option value="PIEZAS_CAIDAS_ROBOT">ü§ñ Piezas Ca√≠das por Robot</option>
                    <option value="PIEZAS_CAIDAS_OPERADOR">üë∑ Piezas Ca√≠das por Operador</option>
                    <option value="GOLPE_OPERADOR">üë∑ Golpe en Pieza por Operador</option>
                    <option value="MARCA_HERRAMIENTA">üîß Marca de Herramienta (Robodrill)</option>
                    <option value="PIEZAS_DEFORMACION">üìè Piezas con Deformaci√≥n</option>
                    <option value="REBORDE_PLANICIDAD">üìè Reborde o Falta de Material en Zona de Planicidad</option>
                    <option value="QW_NG">üìä QW NG</option>
                    <option value="OTROS_MOLDE_CASTING">üîß Otros (Problemas de Molde)/Casting</option>
                    <option value="OTRO">üìù Otro (Especificar)</option>
                </select>
            </div>

            <div class="form-group" id="retencion-otro-motivo" style="display: none;">
                <label>üìù Especificar motivo:</label>
                <input type="text" id="retencion-motivo-otro" placeholder="Describe el motivo de la retenci√≥n...">
            </div>

            <div class="form-group">
                <label>üìù Observaciones:</label>
                <textarea id="retencion-observaciones" rows="3" placeholder="Observaciones adicionales sobre la retenci√≥n..."></textarea>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-warning" onclick="validateRetencion()">üîç Validar Shots</button>
                <button class="btn btn-success" onclick="handleCreateRetencion()" id="create-retencion-btn" disabled>‚è∏Ô∏è Crear Retenci√≥n</button>
                <button class="btn btn-info" onclick="clearRetencionForm()">üîÑ Limpiar</button>
            </div>

            <!-- Resultado de validaci√≥n -->
            <div id="retencion-validation-result" style="margin-top: 20px;"></div>
        </div>

        <!-- Lista de Retenciones Activas -->
        <div class="card">
            <h3>üìã Retenciones Activas</h3>
            <div style="margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="refreshRetencionList()">üîÑ Actualizar Lista</button>
            </div>

            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Fecha Prod.</th>
                        <th>Producto</th>
                        <th>Molde</th>
                        <th>Rango Shots</th>
                        <th>Piezas</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="retenciones-table-body">
                    <!-- Se llenar√° din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ==================== SUB-PESTA√ëA 3: Gestionar Hojas ==================== -->
    <div id="manage-sheets" class="sub-tab-content">
        <h2>üìã Gestionar Hojas de Scrap</h2>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>üìä Hojas Registradas</h3>
                <button class="btn btn-primary" onclick="refreshSheetsList()">üîÑ Actualizar</button>
            </div>

            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Folio</th>
                        <th>Fecha</th>
                        <th>Producto</th>
                        <th>Molde</th>
                        <th>Sector</th>
                        <th>Shots</th>
                        <th>Creado por</th>
                        <th>Estado</th>
                        <th>Evidencia</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="sheets-table-body">
                    <!-- Se llenar√° din√°micamente -->
                </tbody>
            </table>
        </div>

        <!-- Modal para gestionar estado -->
        <div id="manage-state-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>üìã Gestionar Estado de Hoja</h3>

                <div class="form-group">
                    <label>üìÑ Folio:</label>
                    <input type="text" id="modal-folio-manage" readonly style="background: #e9ecef;">
                </div>

                <div class="form-group">
                    <label>üìä Estado Actual:</label>
                    <input type="text" id="modal-current-state" readonly style="background: #e9ecef;">
                </div>

                <div class="form-group">
                    <label>üîÑ Nuevo Estado:</label>
                    <select id="modal-new-state">
                        <option value="">Seleccionar nuevo estado...</option>
                        <option value="EN_PROCESO">üîÑ En Proceso</option>
                        <option value="PENDIENTE_FIRMA">‚úçÔ∏è Pendiente de Firma</option>
                        <option value="CERRADA">‚úÖ Cerrada</option>
                    </select>
                </div>

                <div class="form-group" id="evidence-upload-section" style="display: none;">
                    <label>üìé Subir Hoja Firmada (PDF):</label>
                    <div class="file-management-container">
                        <input type="file" id="modal-evidencia-file" accept=".pdf" style="display: none;" onchange="handleModalEvidenceUpload()">
                        <div class="file-upload-area" onclick="document.getElementById('modal-evidencia-file').click()">
                            <div id="modal-file-status">
                                <span class="file-placeholder">üìé Haz clic para seleccionar archivo PDF</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-2" id="signatures-section" style="display: none;">
                    <div class="form-group">
                        <label>‚úçÔ∏è Firma Supervisor:</label>
                        <input type="text" id="modal-firma-supervisor" placeholder="Nombre del supervisor">
                    </div>
                    <div class="form-group">
                        <label>‚úçÔ∏è Firma Gerente:</label>
                        <input type="text" id="modal-firma-gerente" placeholder="Nombre del gerente">
                    </div>
                </div>

                <div class="form-group">
                    <label>üìù Comentarios:</label>
                    <textarea id="modal-comentarios" rows="3" placeholder="Comentarios sobre el cambio de estado..."></textarea>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="handleConfirmStateChange()">‚úÖ Actualizar Estado</button>
                    <button class="btn btn-secondary" onclick="closeManageModal()">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SUB-PESTA√ëA 4: Reportes ==================== -->
    <div id="reports" class="sub-tab-content">
        <h2>üìä Reportes de Scrap Adicional</h2>

        <div class="card">
            <h3>üìà Filtros de Reporte</h3>
            <div class="grid grid-3">
                <div class="form-group">
                    <label>üìÖ Fecha Desde:</label>
                    <input type="date" id="report-date-from">
                </div>
                <div class="form-group">
                    <label>üìÖ Fecha Hasta:</label>
                    <input type="date" id="report-date-to">
                </div>
                <div class="form-group">
                    <label>üè≠ Producto:</label>
                    <select id="report-product">
                        <option value="">Todos los productos...</option>
                        <option value="PX13-10-382">PX13-10-382 (LWR)</option>
                        <option value="PEDD-10-382-A">PEDD-10-382-A (LWR)</option>
                        <option value="P54G-10-382">P54G-10-382 (LWR)</option>
                        <option value="PX13-10-301">PX13-10-301 (UPR)</option>
                        <option value="PEDD-10-301-A">PEDD-10-301-A (UPR)</option>
                        <option value="P54G-10-301-A">P54G-10-301-A (UPR)</option>
                    </select>
                </div>
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-primary" onclick="generateReport()">üìä Generar Reporte</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìó Exportar Excel</button>
                <button class="btn btn-info" onclick="exportToPDF()">üìÑ Exportar PDF</button>
            </div>
        </div>

        <div class="card">
            <h3>üìà Resumen de Scrap</h3>
            <div id="scrap-summary">
                <div class="alert alert-info">
                    üìä El resumen aparecer√° despu√©s de generar el reporte
                </div>
            </div>
        </div>
    </div>

</div> <!-- ‚úÖ CIERRE CORRECTO del contenedor principal scrap-retention -->
<script type="module">
// üî• FUNCIONES BASE DE FIREBASE - VERSI√ìN COMPAT
function initializeFirebase() {
    const firebaseConfig = {
        apiKey: "AIzaSyAzZFG2GeL1qvUhwgK_9UeVXSbG6_FeZa",
        authDomain: "control-almacen-fundicion.firebaseapp.com",
        databaseURL: "https://control-almacen-fundicion-default-rtdb.firebaseio.com",
        projectId: "control-almacen-fundicion",
        storageBucket: "control-almacen-fundicion.firebasestorage.app",
        messagingSenderId: "944421577173",
        appId: "1:944421577173:web:1db4ae3a41e7128ce55d5c"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    window.database = firebase.database();
}
</script>
    <script>
  // üöÄ TUS VARIABLES GLOBALES (sin cambios)
  let currentShots = [];
  let scrapSheets = [];
  let folioCounter = 1;
  let scannedShots = []; // Usar esta variable consistentemente
  let retenciones = [];
  let retencionCounter = 1;
  let validatedShots = []; // Para almacenar shots validados
  let usuarios = [];
  let currentUser = null;
  let isLoggedIn = false;
// Variables para retenciones con c√≥digos individuales
  let retencionScanner = null;
  let retencionCameraMode = false;
  let retencionValidatedCodes = [];

  // üîê ROLES Y PERMISOS (sin cambios)
  const ROLES = {
      ADMIN: 'ADMIN',
      SUPERVISOR: 'SUPERVISOR', 
      OPERADOR: 'OPERADOR',
      CONSULTA: 'CONSULTA'
  };

  const ROLE_NAMES = {
      ADMIN: 'üëë Administrador',
      SUPERVISOR: 'üë∑ Supervisor',
      OPERADOR: 'üìã Operador',
      CONSULTA: 'üëÅÔ∏è Consulta'
  };

  const PERMISSIONS = {
      ADMIN: ['dashboard', 'scanner', 'inventory', 'pallets', 'production', 'theoretical', 'scrap-retention', 'usuarios'],
      SUPERVISOR: ['dashboard', 'scanner', 'inventory', 'pallets', 'production', 'theoretical', 'scrap-retention'],
      OPERADOR: ['dashboard', 'scanner', 'inventory', 'pallets', 'production', 'scrap-retention'],
      CONSULTA: ['dashboard', 'inventory', 'theoretical']
  };
  // üîÑ NAVEGACI√ìN (sin cambios)
 function showTab(tabName) {
    console.log('üîÑ Cambiando a pesta√±a:', tabName); // DEBUG
    
    // Ocultar todas las pesta√±as
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    // Remover active de todos los botones
    document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar la pesta√±a seleccionada
    const targetTab = document.getElementById(tabName);
    if (targetTab) {
        targetTab.style.display = 'block';
        targetTab.classList.add('active');
        console.log('‚úÖ Pesta√±a mostrada:', tabName); // DEBUG
    } else {
        console.error('‚ùå No se encontr√≥ la pesta√±a:', tabName); // DEBUG
    }
    
    // Activar el bot√≥n correspondiente
    const activeButton = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
        console.log('‚úÖ Bot√≥n activado'); // DEBUG
    } else {
        console.error('‚ùå No se encontr√≥ el bot√≥n para:', tabName); // DEBUG
    }
    
    // L√≥gica especial para scrap-retention
    if (tabName === 'scrap-retention') {
        showSubTab('new-scrap');
    }
}
// üîÑ FUNCI√ìN generateNewFolio ACTUALIZADA
async function generateNewFolio() {
    const today = new Date();
    const year = today.getFullYear().toString().slice(-2);
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    
    // Asegurar que tenemos el contador m√°s reciente
    const currentCounter = await loadFromFirebase('folioCounter');
    if (currentCounter) {
        folioCounter = parseInt(currentCounter);
    }
    
    const folio = `SA-${year}${month}-${folioCounter.toString().padStart(4, '0')}`;
    document.getElementById('folio').value = folio;
}

        // Establecer fecha de hoy
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-operacion').value = today;
        }

// Actualizar informaci√≥n del producto
function updateProductInfo() {
    const producto = document.getElementById('numero-producto').value;
    const nombreInput = document.getElementById('nombre-producto');
    const moldeSelect = document.getElementById('molde-producto');
    
    if (producto) {
        // Determinar si es LWR o UPR bas√°ndose en el texto de la opci√≥n seleccionada
        const selectElement = document.getElementById('numero-producto');
        const selectedOption = selectElement.options[selectElement.selectedIndex].text;
        const tipo = selectedOption.includes('LWR') ? 'LWR' : 'UPR';
        
        // Actualizar nombre del producto
        nombreInput.value = `CYLINDER BLOCK - ${tipo}`;
        
        // Limpiar y actualizar opciones de molde
        moldeSelect.innerHTML = '<option value="">Seleccionar molde...</option>';
        
        // Buscar el modelo en MODEL_MOLDS usando el formato con -FUN
        const modeloConFUN = producto + '-FUN';
        if (MODEL_MOLDS[modeloConFUN]) {
            MODEL_MOLDS[modeloConFUN].forEach(molde => {
                const option = document.createElement('option');
                option.value = molde;
                option.textContent = molde;
                moldeSelect.appendChild(option);
            });
        }
    } else {
        // Limpiar campos si no hay producto seleccionado
        nombreInput.value = '';
        moldeSelect.innerHTML = '<option value="">Primero selecciona un producto...</option>';
    }
}
function clearShotForm() {
    document.getElementById('shot-number').value = '';
    // Ya no limpiar molde-number porque ya no existe
    document.getElementById('scrap-reason').value = '';
    document.getElementById('other-reason').value = '';
}
        // Actualizar visualizaci√≥n de shots
        function updateShotsDisplay() {
            const totalShots = document.getElementById('total-shots');
            const shotsList = document.getElementById('shots-list');
            const currentShotsDisplay = document.getElementById('current-shots-display');

            totalShots.textContent = currentShots.length;

            if (currentShots.length === 0) {
                shotsList.innerHTML = '<div class="alert alert-info">üîç No hay shots registrados</div>';
                currentShotsDisplay.innerHTML = '<div class="alert alert-info">üîç Los shots escaneados aparecer√°n aqu√≠</div>';
                return;
            }

            const shotsHTML = currentShots.map(shot => `
                <div class="shot-item">
                    <div>
                        <strong>Shot #${shot.number}</strong> - Molde: ${shot.molde}
                        <br><small>Motivo: ${shot.reason === 'OTRO' ? shot.otherReason : shot.reason}</small>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="removeShot(${shot.id})">üóëÔ∏è</button>
                </div>
            `).join('');

            shotsList.innerHTML = shotsHTML;
            currentShotsDisplay.innerHTML = shotsHTML;
        }

        // Remover shot
        function removeShot(shotId) {
            currentShots = currentShots.filter(shot => shot.id !== shotId);
            updateShotsDisplay();
        }

        // Limpiar shots actuales
        function clearCurrentShots() {
            if (confirm('¬øEst√°s seguro de limpiar todos los shots registrados?')) {
                currentShots = [];
                updateShotsDisplay();
            }
        }

        // Manejar subida de evidencia
        function handleEvidenceUpload() {
            const file = document.getElementById('evidencia-file').files[0];
            const fileStatus = document.getElementById('file-status');
            
            if (file) {
                if (file.type !== 'application/pdf') {
                    alert('‚ö†Ô∏è Solo se permiten archivos PDF');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ö†Ô∏è El archivo no puede ser mayor a 5MB');
                    return;
                }
                
                fileStatus.innerHTML = `
                    <span style="color: green;">‚úÖ ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)</span>
                `;
            }
        }
        // Limpiar formulario
        function clearForm() {
            document.getElementById('fecha-operacion').value = '';
            document.getElementById('sector-trabajo').value = '';
            document.getElementById('numero-producto').value = '';
            document.getElementById('nombre-producto').value = '';
            document.getElementById('firma-captura').value = '';
            document.getElementById('firma-director').value = '';
            document.getElementById('observaciones').value = '';
            document.getElementById('evidencia-file').value = '';
            document.getElementById('file-status').innerHTML = '<span>üìé Haz clic para seleccionar archivo PDF</span>';
            
            currentShots = [];
            updateShotsDisplay();
            setTodayDate();
        }

        // Refrescar lista de hojas
// üîÑ FUNCI√ìN refreshSheetsList ACTUALIZADA
async function refreshSheetsList() {
    console.log('üîÑ Refrescando lista de hojas...'); // DEBUG
    
    // Cargar datos m√°s recientes desde Firebase
    const sheetsData = await loadFromFirebase('scrapSheets');
    if (sheetsData) {
        scrapSheets = firebaseObjectToArray(JSON.parse(sheetsData));
    }
    
    console.log('üìä Hojas cargadas:', scrapSheets.length); // DEBUG
    
    const tbody = document.getElementById('sheets-table-body');
    
    if (!tbody) {
        console.error('‚ùå No se encontr√≥ sheets-table-body');
        return;
    }
    
    if (scrapSheets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">üìù No hay hojas registradas</td></tr>';
        return;
    }

    tbody.innerHTML = scrapSheets.map(sheet => {
        const estadoBadge = getEstadoBadge(sheet.estado);
        const evidenciaIcon = sheet.evidencia ? 
            `<button onclick="viewEvidence('${sheet.folio}')" class="btn btn-sm" style="background: #28a745; color: white;">üìÑ</button>` : 
            '<span style="color: #6c757d;">Sin evidencia</span>';
        
        const accionesButtons = getAccionesButtons(sheet);
        
        return `
            <tr>
                <td><strong>${sheet.folio}</strong></td>
                <td>${sheet.fechaOperacion}</td>
                <td>${sheet.numeroProducto}</td>
                <td>${sheet.moldeProducto || 'N/A'}</td>
                <td>${sheet.sectorTrabajo}</td>
                <td style="text-align: center;">${sheet.shots ? sheet.shots.length : 0}</td>
                <td>${sheet.creadoPor}</td>
                <td>${estadoBadge}</td>
                <td style="text-align: center;">${evidenciaIcon}</td>
                <td>${accionesButtons}</td>
            </tr>
        `;
    }).join('');
    
    console.log('‚úÖ Lista de hojas actualizada'); // DEBUG
}
function getEstadoBadge(estado) {
    const badges = {
        'ABIERTA': '<span style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üìù Abierta</span>',
        'EN_PROCESO': '<span style="background: #ffc107; color: black; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üîÑ En Proceso</span>',
        'PENDIENTE_FIRMA': '<span style="background: #fd7e14; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úçÔ∏è Pendiente Firma</span>',
        'CERRADA': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úÖ Cerrada</span>'
    };
    return badges[estado] || badges['ABIERTA'];
}

function getAccionesButtons(sheet) {
    let buttons = ''; // ‚Üê Declarar la variable al inicio
    
    // Bot√≥n Ver
    buttons += `<button class="btn btn-info btn-sm" onclick="viewSheet('${sheet.folio}')">üëÅÔ∏è Ver</button>`;
    
    // Bot√≥n Gestionar (solo si no est√° cerrada)
    if (sheet.estado !== 'CERRADA') {
        buttons += ` <button class="btn btn-warning btn-sm" onclick="openManageStateModal('${sheet.folio}')">‚öôÔ∏è Gestionar</button>`;
    }
    
    // Bot√≥n PDF
    buttons += ` <button class="btn btn-success btn-sm" onclick="generateSheetPDF('${sheet.folio}')">üìÑ PDF</button>`;
    
    // Bot√≥n de eliminar solo para administradores
    if (currentUser && currentUser.rol === 'ADMIN') {
        buttons += ` <button class="btn btn-danger btn-sm" onclick="deleteSheet('${sheet.folio}')" style="margin-left: 5px;">üóëÔ∏è Eliminar</button>`;
    }
    
    return buttons;
}

        // Generar PDF
        function generatePDF() {
            alert('üìÑ Funcionalidad de PDF en desarrollo. Por ahora puedes usar "Guardar Hoja" y luego "Generar PDF" desde la lista.');
        }

        // Generar PDF de hoja espec√≠fica
function generateSheetPDF(folio) {
    const sheet = scrapSheets.find(s => s.folio === folio);
    if (!sheet) return;

    // Crear contenido HTML igual al de impresi√≥n
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Hoja de Scrap - ${sheet.folio}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 15px; line-height: 1.3; font-size: 14px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
                .department-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 10px 0; font-size: 12px; }
                .signatures { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0; }
                .signature-box { border: 1px solid #333; padding: 8px; text-align: center; min-height: 50px; }
                .section { margin: 10px 0; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 8px 0; }
                .info-item { font-size: 12px; }
                .shots-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
                .shots-table th, .shots-table td { border: 1px solid #333; padding: 6px; text-align: left; }
                .shots-table th { background: #f0f0f0; font-weight: bold; }
                .folio-box { border: 2px solid #333; padding: 8px; text-align: center; margin-bottom: 10px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 style="margin: 0; font-size: 18px;">REPORTE DIARIO DE SCRAP ADICIONAL</h1>
                <div class="department-info">
                    <div><strong>Departamento:</strong> Fundici√≥n 1</div>
                    <div><strong>Secci√≥n:</strong> Fundici√≥n 1.3</div>
                </div>
            </div>
            
            <div class="folio-box">
                <strong>FOLIO: ${sheet.folio}</strong>
            </div>
            
            <div class="signatures">
                <div class="signature-box">
                    <strong>ELABORACI√ìN</strong><br><br>
                    <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 5px;">
                        Nombre y Firma
                    </div>
                </div>
                <div class="signature-box">
                    <strong>REVISI√ìN</strong><br><br>
                    <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 5px;">
                        Nombre y Firma
                    </div>
                </div>
                <div class="signature-box">
                    <strong>APROBACI√ìN</strong><br><br>
                    <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 5px;">
                        Nombre y Firma
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 style="margin: 10px 0 8px 0; font-size: 14px;">INFORMACI√ìN GENERAL</h3>
                <div class="info-grid">
                    <div class="info-item"><strong>Fecha:</strong> ${sheet.fechaOperacion}</div>
                    <div class="info-item"><strong>Sector:</strong> ${sheet.sectorTrabajo}</div>
                    <div class="info-item"><strong>Creado por:</strong> ${sheet.creadoPor}</div>
                    <div class="info-item"><strong>Producto:</strong> ${sheet.numeroProducto}</div>
                    <div class="info-item"><strong>Molde:</strong> ${sheet.moldeProducto}</div>
                    <div class="info-item"><strong>Almac√©n:</strong> ${sheet.almacenOrigen}</div>
                </div>
                <div class="info-item" style="margin-top: 8px;"><strong>Nombre:</strong> ${sheet.nombreProducto}</div>
            </div>
            
            <div class="section">
                <h3 style="margin: 10px 0 8px 0; font-size: 14px;">SHOTS REGISTRADOS (${sheet.shots.length})</h3>
                <table class="shots-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">Shot #</th>
                            <th style="width: 15%;">Molde</th>
                            <th style="width: 50%;">Motivo del Scrap</th>
                            <th style="width: 20%;">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sheet.shots.map(shot => `
                            <tr>
                                <td>${shot.shotNumber}</td>
                                <td>${shot.moldeNumber}</td>
                                <td>${shot.scrapReason}</td>
                                <td>${shot.timestamp}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h3 style="margin: 10px 0 8px 0; font-size: 14px;">OBSERVACIONES</h3>
                <div style="border: 1px solid #333; padding: 8px; min-height: 40px; font-size: 12px;">
                    ${sheet.observaciones}
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center; font-size: 10px; color: #666;">
                <p>Estado: ${getEstadoText(sheet.estado)}</p>
                <p>Generado: ${new Date().toLocaleString()}</p>
                <p>Sistema de Control de Almac√©n - Fundici√≥n v1.3</p>
            </div>
        </body>
        </html>
    `;

    // Crear blob y descargar como HTML
    const blob = new Blob([printContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Scrap_${sheet.folio}_${new Date().toISOString().split('T')[0]}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('üìÑ Archivo HTML descargado.\n\nüí° Instrucciones:\n1. Abre el archivo en tu navegador\n2. Presiona Ctrl+P (Cmd+P en Mac)\n3. Selecciona "Guardar como PDF"');
}
        // Ver detalles de hoja
        function viewSheet(folio) {
            const sheet = scrapSheets.find(s => s.folio === folio);
            if (!sheet) return;

            alert(`üìã DETALLES DE LA HOJA ${folio}\n\n` +
                  `Fecha: ${sheet.fechaOperacion}\n` +
                  `Sector: ${sheet.sectorTrabajo}\n` +
                  `Producto: ${sheet.numeroProducto}\n` +
                  `Shots: ${sheet.shots.length}\n` +
                  `Estado: ${sheet.estado}\n` +
                  `Creada: ${sheet.fechaCreacion}`);
        }

        // Editar hoja
	async function editSheet(folio) {
            const sheet = scrapSheets.find(s => s.folio === folio);
            if (!sheet) return;

            const newStatus = prompt(`Cambiar estado de ${folio}:\n\n1. Abierta\n2. En Proceso\n3. Cerrada\n\nEscribe el nuevo estado:`, sheet.estado);
            
            if (newStatus && ['Abierta', 'En Proceso', 'Cerrada'].includes(newStatus)) {
                sheet.estado = newStatus;
                if (newStatus === 'Cerrada') {
                    sheet.fechaCierre = new Date().toLocaleString();
                }
                await saveToFirebase('scrapSheets', JSON.stringify(scrapSheets));
                refreshSheetsList();
                alert(`‚úÖ Estado actualizado a: ${newStatus}`);
            }
        }

        // Escanear c√≥digo QR
function scanQRCode() {
    // Simplemente activar la c√°mara
    startScrapCamera();
}
        // Generar reporte
        function generateReport() {
            const dateFrom = document.getElementById('report-date-from').value;
            const dateTo = document.getElementById('report-date-to').value;
            const product = document.getElementById('report-product').value;

            let filteredSheets = scrapSheets;

            if (dateFrom) {
                filteredSheets = filteredSheets.filter(sheet => sheet.fechaOperacion >= dateFrom);
            }
            if (dateTo) {
                filteredSheets = filteredSheets.filter(sheet => sheet.fechaOperacion <= dateTo);
            }
            if (product) {
                filteredSheets = filteredSheets.filter(sheet => sheet.numeroProducto === product);
            }

            const totalShots = filteredSheets.reduce((sum, sheet) => sum + sheet.shots.length, 0);
            const totalSheets = filteredSheets.length;

            const summaryHTML = `
                <div class="grid grid-3">
                    <div class="card">
                        <h4>üìä Total de Hojas</h4>
                        <h2 style="color: #007bff;">${totalSheets}</h2>
                    </div>
                    <div class="card">
                        <h4>üî¢ Total de Shots</h4>
                        <h2 style="color: #28a745;">${totalShots}</h2>
                    </div>
                    <div class="card">
                        <h4>üìà Promedio por Hoja</h4>
                        <h2 style="color: #ffc107;">${totalSheets > 0 ? (totalShots / totalSheets).toFixed(1) : 0}</h2>
                    </div>
                </div>
                
                <div class="card">
                    <h4>üìã Resumen por Estado</h4>
                    <table class="scrap-table">
                        <thead>
                            <tr><th>Estado</th><th>Cantidad</th><th>Shots</th></tr>
                        </thead>
                        <tbody>
                            ${['Abierta', 'En Proceso', 'Cerrada'].map(estado => {
                                const sheets = filteredSheets.filter(s => s.estado === estado);
                                const shots = sheets.reduce((sum, s) => sum + s.shots.length, 0);
                                return `<tr>
                                    <td><span class="status-badge status-${estado.toLowerCase()}">${estado}</span></td>
                                    <td>${sheets.length}</td>
                                    <td>${shots}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('scrap-summary').innerHTML = summaryHTML;
        }

// Actualizar la funci√≥n exportToExcel
function exportToExcel() {
    const sheets = getFromLocalStorage('scrapSheets') || [];
    
    // Preparar datos para Excel
    const excelData = [];
    
    sheets.forEach(sheet => {
        sheet.shots.forEach(shot => {
            excelData.push({
                'Folio': sheet.folio,
                'Fecha': sheet.fechaOperacion,
                'Producto': sheet.numeroProducto,
                'Nombre Producto': sheet.nombreProducto,
                'Molde': sheet.moldeProducto,
                'Sector': sheet.sectorTrabajo,
                'Shot': shot.shotNumber,
                'Molde Shot': shot.moldeNumber,
                'Motivo Scrap': shot.scrapReason,
                'Almac√©n Origen': sheet.almacenOrigen,
                'Almac√©n Proveniente': shot.almacenProveniente || sheet.almacenOrigen,
                'Creado Por': sheet.creadoPor,
                'Estado': sheet.estado,
                'Observaciones': sheet.observaciones
            });
        });
    });
    
    // Crear libro de Excel
    const ws = XLSX.utils.json_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Reporte Scrap");
    
    // Descargar archivo
    XLSX.writeFile(wb, `Reporte_Scrap_${new Date().toISOString().split('T')[0]}.xlsx`);
}
    </script>
</body>
</html>
</div>
	    
    <script>
        // Variables globales
        let inventory = [];
        let movements = [];
        let pallets = [];
        let selectedWarehouse = '';
        let selectedMovement = '';
        let palletCounter = 1;
        let theoreticalInventory = {}; // Para calcular inventario te√≥rico
        let physicalVerification = {}; // Para almacenar verificaciones f√≠sicas
        let shiftReports = []; // Para reportes por turno
        let productionReports = []; // Para almacenar reportes de producci√≥n
        let movementReports = []; // Para almacenar movimientos de material
        let theoreticalBalance = {}; // Para el balance te√≥rico calculado
        // Variables para el generador de QR
        let generatorScanner = null;
        let generatedCodes = [];
        let palletHistory = [];
        let duplicateAttempts = 0;
	let scrapScanner = null;
	// Variable para el modo de c√°mara
        let cameraMode = false;
// üî• FUNCIONES BASE DE FIREBASE - DEBE IR ANTES DEL DOMContentLoaded
function initializeFirebase() {
    const firebaseConfig = {
        apiKey: "AIzaSyAzZFG2GeL1qvUhwgK_9UeVXSbG6_FeZa",
        authDomain: "control-almacen-fundicion.firebaseapp.com",
        databaseURL: "https://control-almacen-fundicion-default-rtdb.firebaseio.com",
        projectId: "control-almacen-fundicion",
        storageBucket: "control-almacen-fundicion.firebasestorage.app",
        messagingSenderId: "944421577173",
        appId: "1:944421577173:web:1db4ae3a41e7128ce55d5c"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    window.database = firebase.database();
    console.log('üî• Firebase inicializado correctamente');
}

async function saveToFirebase(path, data) {
    try {
        await window.database.ref(path).set(data);
        console.log(`‚úÖ Guardado en Firebase: ${path}`);
    } catch (error) {
        console.error(`‚ùå Error guardando ${path}:`, error);
        throw error;
    }
}

async function loadFromFirebase(path) {
    try {
        const snapshot = await window.database.ref(path).once('value');
        if (snapshot.exists()) {
            const data = snapshot.val();
            console.log(`‚úÖ Cargado de Firebase: ${path}`);
            return data;
        } else {
            console.log(`üì≠ No existe en Firebase: ${path}`);
            return null;
        }
    } catch (error) {
        console.error(`‚ùå Error cargando ${path}:`, error);
        throw error;
    }
}

function listenToFirebaseChanges(key, callback) {
    try {
        window.database.ref(key).on('value', (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                callback(data);
            }
        });
    } catch (error) {
        console.error(`‚ùå Error escuchando cambios en ${key}:`, error);
    }
}

async function deleteFromFirebase(path) {
    try {
        await window.database.ref(path).remove();
        console.log(`üóëÔ∏è Eliminado de Firebase: ${path}`);
    } catch (error) {
        console.error(`‚ùå Error eliminando ${path}:`, error);
        throw error;
    }
}

async function pushToFirebase(path, data) {
    try {
        const newRef = await window.database.ref(path).push(data);
        console.log(`‚úÖ Push a Firebase: ${path}`);
        return newRef.key;
    } catch (error) {
        console.error(`‚ùå Error push ${path}:`, error);
        throw error;
    }
}

// Funci√≥n helper para arrays (Firebase guarda objetos, no arrays)
function arrayToFirebaseObject(array) {
    if (!Array.isArray(array)) return array;
    const obj = {};
    array.forEach((item, index) => {
        obj[index] = item;
    });
    return obj;
}

// Funci√≥n para convertir objeto de Firebase a array
function firebaseObjectToArray(obj) {
    if (!obj || typeof obj !== 'object') return [];
    
    // Si ya es un array, devolverlo directamente
    if (Array.isArray(obj)) return obj;
    
    // Convertir objeto a array
    const array = [];
    Object.keys(obj).forEach(key => {
        if (obj[key] !== null && obj[key] !== undefined) {
            array.push(obj[key]);
        }
    });
    
    return array;
}

// Funci√≥n helper para guardar en Firebase
async function saveToFirebaseHelper(path, data) {
    try {
        await saveToFirebase(path, JSON.stringify(data));
        console.log(`‚úÖ Guardado con helper: ${path}`);
    } catch (error) {
        console.error(`‚ùå Error guardando con helper ${path}:`, error);
        throw error;
    }
}
// Configuraci√≥n de modelos por m√°quina
const MACHINE_MODELS = {
    '30': ['PX13-10-382-FUN', 'PEDD-10-382-A-FUN', 'P54G-10-382-FUN'],
    '31': ['PX13-10-382-FUN', 'PEDD-10-382-A-FUN', 'P54G-10-382-FUN'],
    '32': ['PX13-10-301-FUN', 'PEDD-10-301-A-FUN', 'P54G-10-301-A-FUN'],
    '33': ['PX13-10-301-FUN', 'PEDD-10-301-A-FUN', 'P54G-10-301-A-FUN'],
    '34': ['PX13-10-301-FUN', 'PEDD-10-301-A-FUN', 'P54G-10-301-A-FUN']
};

// Moldes disponibles (actualizados)
const MODEL_MOLDS = {
    'PX13-10-382-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'PEDD-10-382-A-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'P54G-10-382-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'PX13-10-301-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'PEDD-10-301-A-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2'],
    'P54G-10-301-A-FUN': ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '1.1', '2.1', '3.1', '5.1', '5.2']
};

        const STATE_MAPPING = {
            'FUNDIDO': 'fundidos',
            'FUNDIDOS': 'fundidos',
            'ACABADO': 'acabados',
            'ACABADOS': 'acabados',
            'FINISHED': 'acabados',
            'CAST': 'fundidos'
        };

        function generatePalletId() {
            return 'PAL-' + String(palletCounter++).padStart(4, '0');
        }

        function checkExistingCodes(codes) {
            const existingCodes = [];
            const newCodes = [];
            
            codes.forEach(code => {
                const existing = inventory.find(item => item.code === code && item.quantity > 0);
                if (existing) {
                    existingCodes.push({ code: code, data: existing });
                } else {
                    newCodes.push(code);
                }
            });
            
            return { existingCodes, newCodes };
        }

        function getWarehouseName(warehouse) {
            const names = {
                'fundidos': 'üî• FUNDIDOS',
                'acabados': '‚úÖ ACABADOS',
                'scrap': '‚ôªÔ∏è SCRAP',
                'retenciones': '‚è∏Ô∏è RETENCIONES',
                'envios': 'üì¶ ENV√çOS',
                'pruebas': 'üß™ PRUEBAS'
            };
            return names[warehouse] || warehouse.toUpperCase();
        }

        function updateFormSections() {
            const inventoryType = document.getElementById('inventory-type').value;
            const movementSection = document.getElementById('movement-destination-section');
            
            if (inventoryType === 'movimiento') {
                movementSection.style.display = 'block';
            } else {
                movementSection.style.display = 'none';
                document.querySelectorAll('#movement-selector .warehouse-btn').forEach(btn => 
                    btn.classList.remove('selected'));
                selectedMovement = '';
            }
        }

function analyzeQRCode() {
   const input = document.getElementById('qr-input').value.trim();
   const analysisDiv = document.getElementById('qr-analysis');
   
   document.getElementById('warehouse-override-section').style.display = 'none';
   document.getElementById('individual-state-section').style.display = 'none';
   
   if (!input) {
       analysisDiv.innerHTML = '';
       return;
   }
   
   const analysis = parseQRCode(input);
   
   if (analysis.isPallet) {
       const codeCheck = checkExistingCodes(analysis.codes);
       
       if (!analysis.detectedState) {
           document.getElementById('warehouse-override-section').style.display = 'block';
       }
       
       analysisDiv.innerHTML = '<div class="alert alert-info"><strong>üéØ TARIMA DETECTADA</strong><br>' +
           '<span class="code-badge" style="background: #17a2b8;">ID: ' + analysis.palletId + '</span>' +
           '<span class="code-badge" style="background: #28a745;">' + analysis.type + '</span>' +
           '<span class="code-badge" style="background: #6c757d;">' + analysis.codes.length + ' piezas</span>' +
           '<span class="code-badge" style="background: #17a2b8;">' + codeCheck.newCodes.length + ' nuevas</span></div>';
       
   } else if (analysis.isValid) {
       const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
       
       if (existingItem) {
           analysisDiv.innerHTML = `
               <div class="existing-code">
                   <strong>‚ö†Ô∏è C√ìDIGO YA REGISTRADO</strong><br>
                   <span class="code-badge" style="background: #28a745;">${analysis.type}</span>
                   <span class="code-badge" style="background: #6c757d;">${analysis.code}</span>
                   
                   <div class="existing-info">
                       <strong>Informaci√≥n actual:</strong><br>
                       <span class="existing-badge" style="background: ${existingItem.state === 'FUNDIDOS' ? '#e74c3c' : '#27ae60'};">
                           ${existingItem.state}
                       </span>
                       <span class="existing-badge" style="background: #6c757d;">
                           ${getWarehouseName(existingItem.warehouse)}
                       </span>
                       <span class="existing-badge" style="background: #17a2b8;">
                           Cant: ${existingItem.quantity}
                       </span>
                       <br><small>√öltimo movimiento: ${formatLastMovement(existingItem.lastMovement)}</small>
                   </div>
               </div>
               
               <div class="alert alert-info">
                   <strong>üîÑ ¬øQuieres cambiar su estado?</strong><br>
                   Selecciona el nuevo estado abajo para transferir el c√≥digo.
               </div>
           `;
           
           document.getElementById('individual-state').value = existingItem.warehouse;
       } else {
           analysisDiv.innerHTML = `
               <div class="alert alert-success">
                   <strong>‚úÖ C√ìDIGO NUEVO</strong><br>
                   <span class="code-badge" style="background: #28a745;">${analysis.type}</span>
                   <span class="code-badge" style="background: #6c757d;">${analysis.code}</span>
                   <div class="auto-detect">üí° <strong>Selecciona el estado del material abajo</strong></div>
               </div>
           `;
       }
       
       document.getElementById('individual-state-section').style.display = 'block';
       
   } else {
       analysisDiv.innerHTML = '<div class="alert" style="background: #f8d7da; color: #721c24;">' +
           '‚ùå <strong>C√≥digo no v√°lido</strong></div>';
   }
   
   updateFormSections();
}
function parseQRCode(input) {
    if (input.includes('|')) {
        const parts = input.split('|');
        if (parts.length >= 3) {
            const palletId = parts[0];
            const state = parts[1];
            const codes = parts.slice(2).filter(code => code.trim().length > 0);
            
            let type = 'UNKNOWN';
            if (codes.length > 0) {
                const firstCode = codes[0];
                type = firstCode.length === 13 ? 'UPR' : 'LWR';
            }
            
            // Mejorar detecci√≥n de estado
            let detectedState = null;
            const stateUpper = state.toUpperCase();
            if (stateUpper.includes('FUNDIDO') || stateUpper.includes('CAST') || stateUpper.includes('MOLTEN')) {
    detectedState = 'fundidos';
} else if (stateUpper.includes('ACABADO') || stateUpper.includes('FINISHED')) {
    detectedState = 'acabados';
}
            return {
                isPallet: true,
                isValid: true,
                palletId: palletId,
                type: type,
                state: state,
                detectedState: detectedState,
                codes: codes
            };
        }
    } else {
        const cleanCode = input.trim();
        if (cleanCode.length === 13 || cleanCode.length === 17) {
            return {
                isPallet: false,
                isValid: true,
                code: cleanCode,
                type: cleanCode.length === 13 ? 'UPR' : 'LWR'
            };
        }
    }
    
    return { isPallet: false, isValid: false };
}
function extractCodeData(code) {
    if (code.length === 13) { // UPR
        const lote = code.substring(0, 3);        // P61 (posiciones 0-2)
        const maquina = parseInt(code.substring(4, 5)) + 30;  // 2+30=32 (posici√≥n 4)
        const disparo = code.substring(5, 8);     // 448 (posiciones 5-7)
        const modelo = code.substring(10, 12);    // P5 (posiciones 10-11)
        const molde = code.substring(12, 13);     // 2 (posici√≥n 12)
        
        return {
            type: 'UPR',
            lote,           // "P61"
            disparo,        // "448"  
            maquina,        // 32
            modelo,         // "P5"
            molde,          // "2"
            partNumber: `UPR-${modelo}`  // "UPR-P5"
        };
    } else if (code.length === 17) { // LWR
        const lote = code.substring(0, 5);
        const maquina = parseInt(code.substring(5, 7));
        const molde = code.substring(7, 9);
        const disparo = code.substring(9, 15);
        const modelo = code.substring(15, 17);
        
        return {
            type: 'LWR',
            lote,
            disparo,
            maquina,
            modelo,
            molde,
            partNumber: `LWR-${modelo}`
        };
    }
    
    return null;
}
async function processQRCode() {
    const input = document.getElementById('qr-input').value.trim();
    const inventoryType = document.getElementById('inventory-type').value;
    const shift = document.getElementById('shift').value;
    const resultDiv = document.getElementById('process-result');
    
    if (!input) {
        alert('Por favor escanea o pega un c√≥digo QR');
        return;
    }
    
    const analysis = parseQRCode(input);
    if (!analysis.isValid) {
        alert('C√≥digo QR no v√°lido');
        return;
    }
    // ========== NUEVAS VALIDACIONES ==========
    
    // Validaci√≥n para movimientos a env√≠os
    if (inventoryType === 'movimiento' && selectedMovement === 'envios') {
        if (analysis.isPallet) {
            // Para tarimas: verificar que todas las piezas est√©n acabadas
            const codesInWrongState = analysis.codes.filter(code => {
                const item = inventory.find(i => i.code === code && i.quantity > 0);
                return item && item.warehouse !== 'acabados';
            });
            
            if (codesInWrongState.length > 0) {
                alert('‚ö†Ô∏è ENV√çO NO PERMITIDO\n\nEsta tarima contiene piezas que NO est√°n acabadas.\n\nSolo se pueden enviar piezas ACABADAS.\n\nVerifica el estado de todas las piezas de la tarima.');
                return;
            }
        } else {
            // Para piezas individuales: verificar que est√© acabada
            const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
            if (existingItem && existingItem.warehouse !== 'acabados') {
                alert('‚ö†Ô∏è ENV√çO NO PERMITIDO\n\nEsta pieza NO est√° acabada.\n\nEstado actual: ' + getWarehouseName(existingItem.warehouse) + '\n\nSolo se pueden enviar piezas ACABADAS.');
                return;
            }
        }
    }
    
    // Validaci√≥n para evitar mover piezas desde estados restringidos
    if (inventoryType === 'movimiento') {
        const restrictedStates = ['scrap', 'retenciones', 'pruebas'];
        
        if (analysis.isPallet) {
            // Para tarimas: verificar que no vengan de estados restringidos
            const codesInRestrictedState = analysis.codes.filter(code => {
                const item = inventory.find(i => i.code === code && i.quantity > 0);
                return item && restrictedStates.includes(item.warehouse);
            });
            
            if (codesInRestrictedState.length > 0) {
                const restrictedItem = inventory.find(i => i.code === codesInRestrictedState[0] && i.quantity > 0);
                alert('‚ö†Ô∏è MOVIMIENTO NO PERMITIDO\n\nEsta tarima contiene piezas en estado restringido:\n\nEstado: ' + getWarehouseName(restrictedItem.warehouse) + '\n\nLas piezas en Scrap, Retenciones o Pruebas no se pueden mover.');
                return;
            }
        } else {
            // Para piezas individuales: verificar que no est√© en estado restringido
            const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
            if (existingItem && restrictedStates.includes(existingItem.warehouse)) {
                alert('‚ö†Ô∏è MOVIMIENTO NO PERMITIDO\n\nEsta pieza est√° en estado restringido:\n\nEstado actual: ' + getWarehouseName(existingItem.warehouse) + '\n\nLas piezas en Scrap, Retenciones o Pruebas no se pueden mover.');
                return;
            }
        }
    }
    
    // ========== FIN DE VALIDACIONES ==========
    
    // Contin√∫a con el resto del c√≥digo original...
    let processedCount = 0;
    let targetWarehouse = '';
    
    if (analysis.isPallet) {
        const codeCheck = checkExistingCodes(analysis.codes);
        
        // VERIFICACI√ìN F√çSICA - Inventario por Turno
        if (inventoryType === 'turno') {
            targetWarehouse = '';
            
            if (analysis.detectedState) {
                targetWarehouse = analysis.detectedState;
            } else {
                if (!selectedWarehouse) {
                    alert('Por favor selecciona Fundidos o Acabados para la verificaci√≥n f√≠sica');
                    return;
                }
                targetWarehouse = selectedWarehouse;
            }
            
            // Verificar si ya fue escaneada en este turno
            const alreadyScanned = analysis.codes.some(code => 
                physicalVerification[code] && 
                physicalVerification[code].shift === shift
            );

            if (alreadyScanned) {
                alert(`‚ö†Ô∏è TARIMA YA VERIFICADA\n\nEsta tarima ya fue escaneada en el turno ${shift}.\n\nNo se permite verificar la misma tarima dos veces en el mismo turno.`);
                return;
            }
            
            analysis.codes.forEach(code => {
                const codeData = extractCodeData(code);
                if (!physicalVerification[code]) {
                    physicalVerification[code] = {
                        code: code,
                        partNumber: codeData ? codeData.partNumber : 'Unknown',
                        type: analysis.type,
                        verifiedQuantity: 0,
                        lastVerified: new Date(),
                        shift: shift,
                        warehouse: targetWarehouse,
                        palletId: analysis.palletId
                    };
                }
                physicalVerification[code].verifiedQuantity += 1;
                physicalVerification[code].lastVerified = new Date();
            });
            
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    üîç <strong>Tarima verificada f√≠sicamente</strong><br>
                    üì¶ ID Original: ${analysis.palletId}<br>
                    üìä ${analysis.codes.length} piezas verificadas ${analysis.type}<br>
                    üè™ Estado verificado: ${getWarehouseName(targetWarehouse)}<br>
                    ‚è∞ Turno: ${shift} - Verificaci√≥n f√≠sica (NO modifica inventario)
                </div>
            `;
            
            updateAllDisplays();
            clearForm();
            setTimeout(() => resultDiv.innerHTML = '', 6000);
            return; // Salir aqu√≠ para evitar el resto del procesamiento
        }
        
        // MOVIMIENTOS O INVENTARIOS INICIALES DE TARIMAS
        if (inventoryType === 'movimiento') {
            if (!selectedMovement) {
                alert('Por favor selecciona el destino del movimiento');
                return;
            }
            targetWarehouse = selectedMovement;
	// üî• INTEGRACI√ìN AUTOM√ÅTICA CON HOJAS DE SCRAP Y RETENCIONES
if (selectedMovement === 'scrap') {
   // Para scrap
const codeInfo = analysis.isValid ? `\n\nC√≥digo detectado: ${analysis.code}\nTipo: ${analysis.type}` : '';
const confirmScrapSheet = confirm(`üîÑ SCRAP DETECTADO${codeInfo}\n\n¬øQuieres crear autom√°ticamente una hoja de scrap con este c√≥digo?\n\n‚úÖ S√≠ = Abrir formulario de scrap\n‚ùå No = Solo mover a scrap`);
    
    if (confirmScrapSheet) {
        // Cambiar a la pesta√±a de scrap y pre-llenar datos
        showTab('scrap-retention');
        showSubTab('new-scrap');
        
        // Pre-llenar formulario de scrap con datos del c√≥digo
        setTimeout(() => {
            prefillScrapForm(analysis);
        }, 500);
        
        return; // Salir para que el usuario complete el formulario de scrap
    }
}
if (selectedMovement === 'retenciones') {
   // Para retenci√≥n  
const confirmRetencion = confirm(`‚è∏Ô∏è RETENCI√ìN DETECTADA${codeInfo}\n\n¬øQuieres crear una nueva retenci√≥n basada en este c√≥digo?\n\n‚úÖ S√≠ = Abrir formulario de retenci√≥n\n‚ùå No = Solo mover a retenciones`);
    
    if (confirmRetencion) {
        // Cambiar a la pesta√±a de retenciones
        showTab('scrap-retention');
        showSubTab('retenciones');
        
        // Pre-llenar formulario de retenci√≥n con datos del c√≥digo
        setTimeout(() => {
            prefillRetencionForm(analysis);
        }, 500);
        
        return; // Salir para que el usuario complete el formulario
    }
}
        } else {
            if (analysis.detectedState) {
                targetWarehouse = analysis.detectedState;
            } else {
                if (!selectedWarehouse) {
                    alert('Por favor selecciona Fundidos o Acabados manualmente');
                    return;
                }
                targetWarehouse = selectedWarehouse;
            }
        }
        
        const palletSystemId = generatePalletId();
        
        // Manejar cuando todos los c√≥digos ya existen - permitir transferencia
        if (codeCheck.newCodes.length === 0 && codeCheck.existingCodes.length > 0) {
            // Detectar si es transferencia l√≥gica (fundidos -> acabados)
            const currentState = codeCheck.existingCodes[0].data.warehouse;
            const isLogicalTransfer = (currentState === 'fundidos' && targetWarehouse === 'acabados') || 
                                     (currentState === 'acabados' && targetWarehouse === 'fundidos');

            const transferMessage = isLogicalTransfer ? 
                `üîÑ PROCESAMIENTO DE TARIMA\n\nEsta tarima ya est√° registrada en ${getWarehouseName(currentState)}.\n¬øQuieres procesarla y moverla a ${getWarehouseName(targetWarehouse)}?` :
                `üîÑ TRANSFERENCIA DE TARIMA\n\nTodos los c√≥digos ya existen en el sistema.\n¬øQuieres transferir esta tarima completa a ${getWarehouseName(targetWarehouse)}?`;

            const confirmTransfer = confirm(`${transferMessage}\n\n‚úÖ Aceptar = Transferir\n‚ùå Cancelar = No hacer nada`);
            
            if (!confirmTransfer) {
                return;
            }
            
            // Transferir todos los c√≥digos existentes
            codeCheck.existingCodes.forEach(existingItem => {
                const item = existingItem.data;
                item.warehouse = targetWarehouse;
                item.state = targetWarehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
                item.lastMovement = new Date();
                item.palletId = palletSystemId;
                
                movements.push({
                    id: Date.now() + Math.random(),
                    code: item.code,
                    partNumber: item.partNumber,
                    type: 'transferencia',
                    warehouse: targetWarehouse,
                    quantity: 1,
                    date: new Date(),
                    shift: shift,
                    palletId: palletSystemId
                });
            });
            
            processedCount = codeCheck.existingCodes.length;
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>Tarima transferida exitosamente</strong><br>
                    üÜî ID Sistema: <strong>${palletSystemId}</strong><br>
                    üì¶ ID Original: ${analysis.palletId}<br>
                    üîÑ ${processedCount} piezas TRANSFERIDAS ${analysis.type}<br>
                    üè™ Destino: ${getWarehouseName(targetWarehouse)}<br>
                    üìä Tipo: transferencia - Turno ${shift}
                </div>
            `;
            
            clearForm();
            updateAllDisplays();
            setTimeout(() => resultDiv.innerHTML = '', 6000);
            return;
        }
        
        // Procesar c√≥digos nuevos normalmente
        if (codeCheck.newCodes.length === 0) {
            alert('‚ö†Ô∏è Todos los c√≥digos ya existen y no se confirm√≥ transferencia');
            return;
        }
        
const palletRecord = {
    systemId: palletSystemId,
    originalId: analysis.palletId,
    state: targetWarehouse,
    type: analysis.type,
    codesCount: codeCheck.newCodes.length,
    warehouse: targetWarehouse,
    codes: codeCheck.newCodes,
    createdDate: new Date().toISOString(), // ‚Üê CORREGIDO
    inventoryType: inventoryType,
    shift: shift,
    duplicatesFound: codeCheck.existingCodes.length
};
        
        pallets.push(palletRecord);
        
        codeCheck.newCodes.forEach(code => {
            processIndividualCode(code, analysis.type, inventoryType, shift, targetWarehouse, palletSystemId);
            processedCount++;
        });
        
        const duplicateInfo = codeCheck.existingCodes.length > 0 ? 
            `<br>‚ö†Ô∏è ${codeCheck.existingCodes.length} c√≥digos duplicados omitidos` : '';
        
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                ‚úÖ <strong>Tarima procesada exitosamente</strong><br>
                üÜî ID Sistema: <strong>${palletSystemId}</strong><br>
                üì¶ ID Original: ${analysis.palletId}<br>
                üìä ${processedCount} piezas NUEVAS ${analysis.type}<br>
                üè™ Destino: ${getWarehouseName(targetWarehouse)}<br>
                üîÑ Tipo: ${inventoryType} - Turno ${shift}${duplicateInfo}
            </div>
        `;
        
    } else {
        // PIEZAS INDIVIDUALES
        const individualState = document.getElementById('individual-state').value;
        const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
        
        if (inventoryType === 'movimiento') {
            // MOVIMIENTO DE PIEZA INDIVIDUAL
            if (!selectedMovement) {
                alert('Por favor selecciona el destino del movimiento');
                return;
            }
            
            targetWarehouse = selectedMovement;
		        // üî• INTEGRACI√ìN AUTOM√ÅTICA CON HOJAS DE SCRAP Y RETENCIONES PARA C√ìDIGOS INDIVIDUALES
        if (selectedMovement === 'scrap') {
            const confirmScrapSheet = confirm('üîÑ SCRAP DETECTADO\n\n¬øQuieres crear autom√°ticamente una hoja de scrap con este c√≥digo?\n\n‚úÖ S√≠ = Abrir formulario de scrap\n‚ùå No = Solo mover a scrap');
            
            if (confirmScrapSheet) {
                showTab('scrap-retention');
                showSubTab('new-scrap');
                
                setTimeout(() => {
                    prefillScrapForm(analysis);
                }, 500);
                
                return;
            }
        }
        
        if (selectedMovement === 'retenciones') {
            const confirmRetencion = confirm('‚è∏Ô∏è RETENCI√ìN DETECTADA\n\n¬øQuieres crear una nueva retenci√≥n basada en este c√≥digo?\n\n‚úÖ S√≠ = Abrir formulario de retenci√≥n\n‚ùå No = Solo mover a retenciones');
            
            if (confirmRetencion) {
                showTab('scrap-retention');
                showSubTab('retenciones');
                
                setTimeout(() => {
                    prefillRetencionForm(analysis);
                }, 500);
                
                return;
            }
        }
            processIndividualCode(analysis.code, analysis.type, inventoryType, shift, targetWarehouse);
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>C√≥digo movido exitosamente</strong><br>
                    üì¶ ${analysis.code}<br>
                    üè™ Destino: ${getWarehouseName(targetWarehouse)}<br>
                    üîÑ Tipo: movimiento - Turno ${shift}
                </div>
            `;
            
        } else if (inventoryType === 'turno') {
            // VERIFICACI√ìN F√çSICA DE PIEZA INDIVIDUAL
            targetWarehouse = individualState;
            
            // Verificar si ya fue escaneada
            if (physicalVerification[analysis.code] && 
                physicalVerification[analysis.code].shift === shift) {
                alert(`‚ö†Ô∏è PIEZA YA VERIFICADA\n\nEsta pieza ya fue verificada en el turno ${shift}.`);
                return;
            }
            
            const codeData = extractCodeData(analysis.code);
            physicalVerification[analysis.code] = {
                code: analysis.code,
                partNumber: codeData ? codeData.partNumber : 'Unknown',
                type: 'individual',
                verifiedQuantity: 1,
                lastVerified: new Date(),
                shift: shift,
                warehouse: targetWarehouse,
                palletId: null
            };
            
            resultDiv.innerHTML = `
                <div class="alert alert-info">
                    üîç <strong>Pieza individual verificada</strong><br>
                    üì¶ C√≥digo: ${analysis.code}<br>
                    üè™ Estado verificado: ${getWarehouseName(targetWarehouse)}<br>
                    ‚è∞ Turno: ${shift} - Verificaci√≥n f√≠sica
                </div>
            `;
            
        } else {
            // INVENTARIO INICIAL DE PIEZA INDIVIDUAL
            if (existingItem) {
                if (existingItem.warehouse === individualState) {
                    alert(`‚ö†Ô∏è C√ìDIGO YA REGISTRADO\n\nEl c√≥digo ${analysis.code} ya est√° registrado en ${getWarehouseName(individualState)}.\n\nCantidad actual: ${existingItem.quantity}\n√öltimo registro: ${formatLastMovement(existingItem.lastMovement)}`);
                    return;
                } else {
                    const confirmChange = confirm(`üîÑ CAMBIO DE ESTADO DETECTADO\n\nEl c√≥digo ${analysis.code} est√° actualmente en:\n${getWarehouseName(existingItem.warehouse)}\n\n¬øQuieres moverlo a ${getWarehouseName(individualState)}?\n\n‚úÖ Aceptar = Mover\n‚ùå Cancelar = No hacer nada`);
                    
                    if (!confirmChange) {
                        clearForm();
                        return;
                    }
                }
            }
            
            targetWarehouse = individualState;
            processIndividualCode(analysis.code, analysis.type, inventoryType, shift, targetWarehouse);
            
            const statusMessage = existingItem ? 
                `<br>üîÑ C√≥digo movido desde ${getWarehouseName(existingItem.warehouse)}` : 
                '<br>‚ú® C√≥digo nuevo registrado';
            
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ <strong>C√≥digo individual procesado</strong><br>
                    üì¶ ${analysis.code}<br>
                    üè™ Registrado en: ${getWarehouseName(targetWarehouse)}<br>
                    üìä Estado: ${getWarehouseName(individualState)}<br>
                    üîÑ Tipo: ${inventoryType} - Turno ${shift}${statusMessage}
                </div>
            `;
        }
    }
	    try {
        // Guardar datos actualizados
        await saveToFirebase('inventory', JSON.stringify(arrayToFirebaseObject(inventory)));
        await saveToFirebase('movements', JSON.stringify(arrayToFirebaseObject(movements)));
        if (analysis.isPallet) {
            await saveToFirebase('pallets', JSON.stringify(arrayToFirebaseObject(pallets)));
        }
        if (inventoryType === 'turno') {
            await saveToFirebase('physicalVerification', JSON.stringify(physicalVerification));
        }
    } catch (error) {
        console.error('Error guardando datos:', error);
    }
    
    clearForm();
    updateAllDisplays();
    setTimeout(() => resultDiv.innerHTML = '', 6000);
}
        function clearForm() {
            document.getElementById('qr-input').value = '';
            document.getElementById('qr-analysis').innerHTML = '';
            
            document.getElementById('warehouse-override-section').style.display = 'none';
            document.getElementById('individual-state-section').style.display = 'none';
            document.getElementById('movement-destination-section').style.display = 'none';
            
            document.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            selectedWarehouse = '';
            selectedMovement = '';
            
            document.getElementById('qr-input').focus();
        }

// üîÑ FUNCI√ìN processIndividualCode ACTUALIZADA
async function processIndividualCode(code, type, movementType, shift, warehouse, palletId = null) {
    const codeData = extractCodeData(code);
    const partNumber = codeData ? codeData.partNumber : (type === 'UPR' ? 'PX13-10-301' : 'PX13-10-382');
    
    let item = inventory.find(i => i.code === code);
    
    if (!item) {
        item = {
            code: code,
            partNumber: partNumber,
            type: type,
            state: warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS',
            warehouse: warehouse,
            quantity: 0,
            lastMovement: new Date(),
            shift: shift,
            palletId: palletId,
            codeData: codeData
        };
        inventory.push(item);
    }
    
    // Manejar transferencia de fundidos a acabados
    if (movementType === 'movimiento' || (item.warehouse !== warehouse && item.quantity > 0)) {
        item.warehouse = warehouse;
        // Actualizar estado seg√∫n el warehouse destino
if (warehouse === 'fundidos') {
    item.state = 'FUNDIDOS';
} else if (warehouse === 'acabados') {
    item.state = 'ACABADOS';
} else if (warehouse === 'scrap') {
    item.state = 'SCRAP';
} else if (warehouse === 'retenciones') {
    item.state = 'RETENIDO';
} else if (warehouse === 'envios') {
    item.state = 'ENVIADO';
} else if (warehouse === 'pruebas') {
    item.state = 'EN_PRUEBAS';
} else {
    // Mantener estado actual si no es un warehouse reconocido
    item.state = item.state || 'DESCONOCIDO';
}
        item.lastMovement = new Date();
        item.palletId = palletId;
} else {
    item.quantity += 1;
    item.warehouse = warehouse;
    
    // Actualizar estado seg√∫n el warehouse destino
    if (warehouse === 'fundidos') {
        item.state = 'FUNDIDOS';
    } else if (warehouse === 'acabados') {
        item.state = 'ACABADOS';
    } else if (warehouse === 'scrap') {
        item.state = 'SCRAP';
    } else if (warehouse === 'retenciones') {
        item.state = 'RETENIDO';
    } else if (warehouse === 'envios') {
        item.state = 'ENVIADO';
    } else if (warehouse === 'pruebas') {
        item.state = 'EN_PRUEBAS';
    } else {
        // Mantener estado actual si no es un warehouse reconocido
        item.state = item.state || 'DESCONOCIDO';
    }
    
    item.lastMovement = new Date();
    item.palletId = palletId;
}
    
movements.push({
    id: Date.now() + Math.random(),
    code: code,
    partNumber: partNumber,
    type: specificMovementType,
    warehouse: warehouse,
    quantity: 1,
    date: new Date(),
    shift: shift,
    palletId: palletId,
    // Agregar informaci√≥n adicional del estado anterior
    previousWarehouse: item.warehouse !== warehouse ? item.warehouse : null,
    previousState: item.state !== (warehouse === 'fundidos' ? 'FUNDIDOS' : warehouse === 'acabados' ? 'ACABADOS' : 'SCRAP') ? item.state : null
});
    
    // üî• GUARDAR EN FIREBASE
    await saveToFirebase('inventory', JSON.stringify(arrayToFirebaseObject(inventory)));
    await saveToFirebase('movements', JSON.stringify(arrayToFirebaseObject(movements)));
}
// Reemplaza la funci√≥n movePallet() completa
function movePallet(palletId) {
    const pallet = pallets.find(p => p.systemId === palletId);
    if (!pallet) {
        alert('Tarima no encontrada');
        return;
    }
    
    // üÜï NUEVAS REGLAS DE MOVIMIENTO
    const allowedMoves = {
        'fundidos': ['acabados', 'retenciones', 'pruebas', 'scrap'], // ‚úÖ FUNDIDOS: solo a acabados, retenci√≥n, pruebas o scrap
        'acabados': ['envios', 'retenciones', 'pruebas', 'scrap'],   // ‚úÖ ACABADOS: solo a env√≠os, retenci√≥n, pruebas o scrap
        'scrap': [], // Scrap no se puede mover
        'retenciones': ['fundidos', 'acabados', 'scrap'], // Retenciones puede liberarse o scrapearse
        'envios': [], // Env√≠os no se pueden mover
        'pruebas': ['fundidos', 'acabados', 'scrap'] // Pruebas puede regresar seg√∫n resultado
    };
    
    const currentState = pallet.warehouse || pallet.state;
    const availableMoves = allowedMoves[currentState] || [];
    
    if (availableMoves.length === 0) {
        alert(`‚ùå MOVIMIENTO NO PERMITIDO\n\nLas tarimas en estado "${getWarehouseName(currentState)}" no pueden moverse a otros almacenes.`);
        return;
    }
    
    // Generar opciones de almac√©n filtradas
    const warehouseOptions = {
        'fundidos': '<div class="warehouse-btn" data-warehouse="fundidos">üî• FUNDIDOS</div>',
        'acabados': '<div class="warehouse-btn" data-warehouse="acabados">‚úÖ ACABADOS</div>',
        'scrap': '<div class="warehouse-btn" data-warehouse="scrap">‚ôªÔ∏è SCRAP</div>',
        'retenciones': '<div class="warehouse-btn" data-warehouse="retenciones">‚è∏Ô∏è RETENCIONES</div>',
        'envios': '<div class="warehouse-btn" data-warehouse="envios">üì¶ ENV√çOS</div>',
        'pruebas': '<div class="warehouse-btn" data-warehouse="pruebas">üß™ PRUEBAS</div>'
    };
    
    let optionsHTML = '';
    availableMoves.forEach(move => {
        optionsHTML += warehouseOptions[move];
    });
    
    // Crear modal con opciones filtradas
    const modalHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" id="moveModal">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                <h3>üì¶ Mover Tarima ${palletId}</h3>
                <p style="margin: 15px 0; color: #666;">Estado actual: ${getWarehouseName(currentState)}</p>
                <p style="margin: 15px 0; color: #333; font-size: 14px;">üí° Solo se muestran destinos permitidos</p>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Selecciona el almac√©n destino:</label>
                    <div class="warehouse-selector" id="move-warehouse-selector">
                        ${optionsHTML}
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="confirmPalletMove('${palletId}')" id="confirmMoveBtn" disabled>‚úÖ Confirmar Movimiento</button>
                    <button class="btn btn-danger" onclick="closeMoveModal()" style="margin-left: 10px;">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Event listener para selector
    document.getElementById('move-warehouse-selector').addEventListener('click', function(e) {
        if (e.target.classList.contains('warehouse-btn')) {
            this.querySelectorAll('.warehouse-btn').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            document.getElementById('confirmMoveBtn').disabled = false;
            window.selectedMoveWarehouse = e.target.dataset.warehouse;
        }
    });
}

// Reemplaza la funci√≥n confirmPalletMove() completa
async function confirmPalletMove(palletId) {
    if (!window.selectedMoveWarehouse) return;
    
    const pallet = pallets.find(p => p.systemId === palletId);
    const newWarehouse = window.selectedMoveWarehouse;
    
    // üÜï AUTOMATIZACI√ìN DE FLUJOS
    if (newWarehouse === 'retenciones') {
        const confirmRetencion = confirm(`‚è∏Ô∏è CREAR RETENCI√ìN AUTOM√ÅTICA\n\nSe crear√° autom√°ticamente una retenci√≥n para esta tarima.\n\n¬øContinuar?`);
        
        if (confirmRetencion) {
            // Crear retenci√≥n autom√°tica
            await createAutomaticRetencion(pallet);
            closeMoveModal();
            return;
        } else {
            return; // Cancelar movimiento
        }
    }
    
    if (newWarehouse === 'pruebas') {
        const confirmPruebas = confirm(`üß™ ENVIAR A PRUEBAS\n\nEsta tarima ser√° enviada a pruebas. Se puede crear una hoja de seguimiento.\n\n¬øContinuar?`);
        
        if (confirmPruebas) {
            // Opcional: crear hoja de seguimiento de pruebas
            const createSheet = confirm(`üìã ¬øDeseas crear una hoja de seguimiento para las pruebas?`);
            
            if (createSheet) {
                await createAutomaticTestSheet(pallet);
            }
        } else {
            return;
        }
    }
    
    // Continuar con movimiento normal
    pallet.warehouse = newWarehouse;
    pallet.state = newWarehouse;
    
    // Actualizar inventario
    inventory.forEach(item => {
        if (item.palletId === palletId) {
            item.warehouse = newWarehouse;
            item.state = getStateFromWarehouse(newWarehouse);
            item.lastMovement = new Date();
        }
    });
    
    // Guardar cambios
    await saveToFirebase('pallets', JSON.stringify(arrayToFirebaseObject(pallets)));
    await saveToFirebase('inventory', JSON.stringify(arrayToFirebaseObject(inventory)));
    
    alert('‚úÖ Tarima ' + palletId + ' movida a ' + getWarehouseName(newWarehouse));
    updateAllDisplays();
    closeMoveModal();
}

function closeMoveModal() {
    const modal = document.getElementById('moveModal');
    if (modal) modal.remove();
    window.selectedMoveWarehouse = null;
}

        function viewPalletDetails(palletId) {
            const pallet = pallets.find(function(p) {
                return p.systemId === palletId;
            });
            if (!pallet) {
                alert('Tarima no encontrada');
                return;
            }

            const codes = pallet.codes.length > 10 ? 
                pallet.codes.slice(0, 10).join('\n') + '\n... y ' + (pallet.codes.length - 10) + ' m√°s' :
                pallet.codes.join('\n');

            alert('üì¶ DETALLES DE TARIMA\n\nüÜî ID: ' + pallet.systemId + '\nüìã Original: ' + pallet.originalId + '\nüîß Tipo: ' + pallet.type + '\nüì¶ Piezas: ' + pallet.codesCount + '\nüè™ Almac√©n: ' + getWarehouseName(pallet.warehouse) + '\n\nüìã C√ìDIGOS:\n' + codes);
        }

// üîÑ FUNCI√ìN exportData ACTUALIZADA (mantener igual, solo para referencia)
function exportData() {
    const data = {
        inventory: inventory,
        movements: movements,
        pallets: pallets,
        exportDate: new Date()
    };
    
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'almacen-completo-' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

   function loadSampleData() {
    const samples = [
        { code: 'P6102448O2P52', type: 'UPR' },
        { code: '25E153003154276P5', type: 'LWR' },
        { code: 'P6205362O3P54', type: 'UPR' },
        { code: '25F164004265387P7', type: 'LWR' }
    ];
    
    samples.forEach(function(sample) {
        const codeData = extractCodeData(sample.code);
        if (codeData) {
            inventory.push({
                code: sample.code,
                partNumber: codeData.partNumber,
                type: sample.type,
                state: 'ACABADOS',
                warehouse: 'acabados',
                quantity: Math.floor(Math.random() * 15) + 5,
                lastMovement: new Date(),
                shift: '1',
                palletId: null,
                codeData: codeData
            });
        }
    });

    const samplePallet = {
        systemId: generatePalletId(),
        originalId: 'TARM001',
        state: 'acabados',
        type: 'UPR',
        codesCount: 3,
        warehouse: 'acabados',
        codes: ['P6102448O2P52', 'P6205362O3P54', 'P6308476O4P56'],
        createdDate: new Date().toISOString(),
    };
    pallets.push(samplePallet);
}
function formatLastMovement(date) {
    if (!date) return 'N/A';
    
    // Convertir a objeto Date si es un string
    let dateObj;
    if (typeof date === 'string') {
        dateObj = new Date(date);
    } else if (date instanceof Date) {
        dateObj = date;
    } else {
        return 'N/A';
    }
    
    // Verificar que la fecha sea v√°lida
    if (isNaN(dateObj.getTime())) {
        return 'Fecha inv√°lida';
    }
    
    const now = new Date();
    const diff = now - dateObj;
    const minutes = Math.floor(diff / 60000);
    
    if (minutes < 1) return 'Ahora mismo';
    if (minutes < 60) return `Hace ${minutes} min`;
    if (minutes < 1440) return `Hace ${Math.floor(minutes / 60)} hrs`;
    return dateObj.toLocaleDateString();
}
       function calculateTheoreticalInventory() {
    const theoretical = {};
    
    // 1. Partir del inventario actual real como base
    inventory.forEach(item => {
        if (item.quantity > 0) {
            if (!theoretical[item.partNumber]) {
                theoretical[item.partNumber] = { fundidos: 0, acabados: 0 };
            }
            
            if (item.warehouse === 'fundidos') {
                theoretical[item.partNumber].fundidos += item.quantity;
            } else if (item.warehouse === 'acabados') {
                theoretical[item.partNumber].acabados += item.quantity;
            }
        }
    });
    
    return theoretical;
}
// üîÑ FUNCI√ìN startNewShiftVerification ACTUALIZADA
async function startNewShiftVerification() {
    const confirmReset = confirm('üîÑ NUEVO TURNO\n\n¬øQuieres limpiar las verificaciones f√≠sicas del turno anterior para comenzar una nueva verificaci√≥n?\n\n‚úÖ S√≠ = Limpiar verificaciones\n‚ùå No = Mantener datos actuales');
    
    if (confirmReset) {
        physicalVerification = {};
        
        // üî• GUARDAR EN FIREBASE
        await saveToFirebase('physicalVerification', JSON.stringify({}));
        
        alert('‚úÖ Verificaciones f√≠sicas limpiadas. Puedes comenzar el nuevo turno.');
        updateAllDisplays();
    }
}
        function showVerificationProgress() {
    if (Object.keys(physicalVerification).length === 0) {
        return '<div class="alert alert-info">No hay verificaciones f√≠sicas registradas en este turno.</div>';
    }
    
    let progressHtml = '<h4>üìä Progreso de Verificaci√≥n F√≠sica:</h4>';
    progressHtml += '<table class="inventory-table"><thead><tr><th>C√≥digo</th><th>N√∫mero de Parte</th><th>Tipo</th><th>Estado</th><th>Cantidad Verificada</th></tr></thead><tbody>';
    
    Object.values(physicalVerification).forEach(item => {
        progressHtml += `<tr>
            <td style="font-family: monospace;">${item.code}</td>
            <td>${item.partNumber}</td>
            <td><span class="code-badge" style="background: #17a2b8;">${item.type}</span></td>
            <td><span class="code-badge" style="background: ${item.warehouse === 'fundidos' ? '#e74c3c' : '#27ae60'};">${getWarehouseName(item.warehouse)}</span></td>
            <td style="text-align: center; font-weight: bold;">${item.verifiedQuantity}</td>
        </tr>`;
    });
    
    progressHtml += '</tbody></table>';
    return progressHtml;
}
        function showCurrentVerification() {
    document.getElementById('current-verification').innerHTML = showVerificationProgress();
}
        function generateTheoreticalReport() {
    const theoretical = calculateTheoreticalInventory();
    const summaryDiv = document.getElementById('theoretical-summary');
    const comparisonDiv = document.getElementById('verification-comparison');
    const discrepanciesDiv = document.getElementById('discrepancies-report');
    
    // Mostrar inventario te√≥rico
    let theoreticalHtml = '<h4>üìã Inventario Te√≥rico Calculado:</h4><table class="inventory-table"><thead><tr><th>N√∫mero de Parte</th><th>Fundidos</th><th>Acabados</th><th>Total Disponible</th></tr></thead><tbody>';
    
    Object.keys(theoretical).forEach(partNumber => {
        const data = theoretical[partNumber];
        const available = data.fundidos + data.acabados;
        theoreticalHtml += `<tr><td>${partNumber}</td><td>üî• ${data.fundidos}</td><td>‚úÖ ${data.acabados}</td><td><strong>${available}</strong></td></tr>`;
    });
    
    theoreticalHtml += '</tbody></table>';
    summaryDiv.innerHTML = theoreticalHtml;
    
    // Generar comparaci√≥n con verificaci√≥n f√≠sica
    generateComparisonReport(theoretical, comparisonDiv, discrepanciesDiv);
}

function generateComparisonReport(theoretical, comparisonDiv, discrepanciesDiv) {
    let comparisonHtml = '<h4>üîç Comparaci√≥n F√≠sico vs Te√≥rico:</h4>';
    let discrepanciesHtml = '';
    let hasDiscrepancies = false;
    
    // Agrupar verificaciones f√≠sicas por n√∫mero de parte
    const physicalByPart = {};
    Object.values(physicalVerification).forEach(item => {
        if (!physicalByPart[item.partNumber]) {
            physicalByPart[item.partNumber] = { fundidos: 0, acabados: 0 };
        }
        if (item.warehouse === 'fundidos') {
            physicalByPart[item.partNumber].fundidos += item.verifiedQuantity;
        } else if (item.warehouse === 'acabados') {
            physicalByPart[item.partNumber].acabados += item.verifiedQuantity;
        }
    });
    
    comparisonHtml += '<table class="inventory-table"><thead><tr><th>N√∫mero de Parte</th><th>Estado</th><th>Te√≥rico</th><th>F√≠sico</th><th>Diferencia</th><th>Status</th></tr></thead><tbody>';
    
    // Comparar cada n√∫mero de parte
    const allParts = new Set([...Object.keys(theoretical), ...Object.keys(physicalByPart)]);
    
    allParts.forEach(partNumber => {
        const theo = theoretical[partNumber] || { fundidos: 0, acabados: 0 };
        const phys = physicalByPart[partNumber] || { fundidos: 0, acabados: 0 };
        
        // Verificar fundidos
        const diffFundidos = phys.fundidos - theo.fundidos;
        const statusFundidos = diffFundidos === 0 ? '‚úÖ OK' : (diffFundidos > 0 ? '‚¨ÜÔ∏è Exceso' : '‚¨áÔ∏è Faltante');
        
        comparisonHtml += `<tr><td>${partNumber}</td><td>üî• Fundidos</td><td>${theo.fundidos}</td><td>${phys.fundidos}</td><td style="color: ${diffFundidos === 0 ? 'green' : 'red'};">${diffFundidos > 0 ? '+' : ''}${diffFundidos}</td><td>${statusFundidos}</td></tr>`;
        
        // Verificar acabados
        const diffAcabados = phys.acabados - theo.acabados;
        const statusAcabados = diffAcabados === 0 ? '‚úÖ OK' : (diffAcabados > 0 ? '‚¨ÜÔ∏è Exceso' : '‚¨áÔ∏è Faltante');
        
        comparisonHtml += `<tr><td>${partNumber}</td><td>‚úÖ Acabados</td><td>${theo.acabados}</td><td>${phys.acabados}</td><td style="color: ${diffAcabados === 0 ? 'green' : 'red'};">${diffAcabados > 0 ? '+' : ''}${diffAcabados}</td><td>${statusAcabados}</td></tr>`;
        
        // Registrar discrepancias
        if (diffFundidos !== 0 || diffAcabados !== 0) {
            hasDiscrepancies = true;
            discrepanciesHtml += `<div class="alert" style="background: #f8d7da; color: #721c24; margin: 10px 0;"><strong>‚ö†Ô∏è ${partNumber}</strong><br>`;
            if (diffFundidos !== 0) {
                discrepanciesHtml += `üî• Fundidos: ${diffFundidos > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diffFundidos)} piezas<br>`;
            }
            if (diffAcabados !== 0) {
                discrepanciesHtml += `‚úÖ Acabados: ${diffAcabados > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diffAcabados)} piezas<br>`;
            }
            discrepanciesHtml += '</div>';
        }
    });
    
    comparisonHtml += '</tbody></table>';
    comparisonDiv.innerHTML = comparisonHtml;
    
    if (hasDiscrepancies) {
        discrepanciesDiv.innerHTML = '<h4>‚ö†Ô∏è Diferencias Encontradas:</h4>' + discrepanciesHtml;
    } else {
        discrepanciesDiv.innerHTML = '<div class="alert alert-success"><h4>‚úÖ ¬°Perfecto!</h4>No se encontraron diferencias entre el inventario te√≥rico y f√≠sico.</div>';
    }
}
        function exportVerificationReport() {
    const theoretical = calculateTheoreticalInventory();
    const discrepancies = calculateDiscrepancies(theoretical);
    const currentDate = new Date().toLocaleDateString('es-ES');
    const currentTime = new Date().toLocaleTimeString('es-ES');
    const shift = document.getElementById('shift').value;
    
    // Agrupar verificaciones f√≠sicas por n√∫mero de parte
    const physicalByPart = {};
    Object.values(physicalVerification).forEach(item => {
        if (!physicalByPart[item.partNumber]) {
            physicalByPart[item.partNumber] = { fundidos: 0, acabados: 0 };
        }
        if (item.warehouse === 'fundidos') {
            physicalByPart[item.partNumber].fundidos += item.verifiedQuantity;
        } else if (item.warehouse === 'acabados') {
            physicalByPart[item.partNumber].acabados += item.verifiedQuantity;
        }
    });
    
    // Calcular totales
    const totalTeorico = Object.values(theoretical).reduce((sum, item) => sum + item.fundidos + item.acabados, 0);
    const totalVerificado = Object.values(physicalVerification).reduce((sum, item) => sum + item.verifiedQuantity, 0);
    const codigosVerificados = Object.keys(physicalVerification).length;
    
    // Crear contenido HTML para el PDF
    let htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Reporte de Verificaci√≥n de Inventario</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    line-height: 1.4;
                    color: #333;
                }
                .header { 
                    text-align: center; 
                    border-bottom: 3px solid #e74c3c; 
                    padding-bottom: 20px; 
                    margin-bottom: 30px;
                }
                .company-name {
                    font-size: 24px;
                    font-weight: bold;
                    color: #e74c3c;
                    margin-bottom: 5px;
                }
                .report-title {
                    font-size: 18px;
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                .report-info {
                    font-size: 14px;
                    color: #666;
                }
                .section { 
                    margin: 25px 0; 
                    page-break-inside: avoid;
                }
                .section-title { 
                    font-size: 16px; 
                    font-weight: bold; 
                    color: #2c3e50; 
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 5px;
                    margin-bottom: 15px;
                }
                .summary-grid {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 20px;
                    margin: 20px 0;
                }
                .summary-card {
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 15px;
                    text-align: center;
                    background: #f8f9fa;
                }
                .summary-number {
                    font-size: 24px;
                    font-weight: bold;
                    color: #e74c3c;
                }
                .summary-label {
                    font-size: 12px;
                    color: #666;
                    margin-top: 5px;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 15px 0;
                    font-size: 12px;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 8px; 
                    text-align: left; 
                }
                th { 
                    background-color: #34495e; 
                    color: white; 
                    font-weight: bold;
                }
                tr:nth-child(even) { 
                    background-color: #f9f9f9; 
                }
                .difference-positive { color: #27ae60; font-weight: bold; }
                .difference-negative { color: #e74c3c; font-weight: bold; }
                .difference-zero { color: #2c3e50; }
                .status-ok { color: #27ae60; font-weight: bold; }
                .status-issue { color: #e74c3c; font-weight: bold; }
                .alert-success {
                    background: #d4edda;
                    border: 1px solid #c3e6cb;
                    color: #155724;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                }
                .alert-warning {
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    color: #856404;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 15px 0;
                }
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    font-size: 12px;
                    color: #666;
                    text-align: center;
                }
                @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="company-name">üè≠ CONTROL DE ALMAC√âN - FUNDICI√ìN</div>
                <div class="report-title">üìä REPORTE DE VERIFICACI√ìN DE INVENTARIO</div>
                <div class="report-info">
                    üìÖ Fecha: ${currentDate} | ‚è∞ Hora: ${currentTime} | üîÑ Turno: ${shift}
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìã RESUMEN EJECUTIVO</div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-number">${codigosVerificados}</div>
                        <div class="summary-label">C√≥digos Verificados</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${Object.keys(theoretical).length}</div>
                        <div class="summary-label">N√∫meros de Parte</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${Object.keys(discrepancies).length}</div>
                        <div class="summary-label">Diferencias Encontradas</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üìä INVENTARIO TE√ìRICO</div>
                <table>
                    <thead>
                        <tr>
                            <th>N√∫mero de Parte</th>
                            <th>üî• Fundidos</th>
                            <th>‚úÖ Acabados</th>
                            <th>Total Disponible</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Agregar datos del inventario te√≥rico
    Object.keys(theoretical).forEach(partNumber => {
        const data = theoretical[partNumber];
        const available = data.fundidos + data.acabados;
        htmlContent += `
            <tr>
                <td><strong>${partNumber}</strong></td>
                <td style="text-align: center;">${data.fundidos}</td>
                <td style="text-align: center;">${data.acabados}</td>
                <td style="text-align: center;"><strong>${available}</strong></td>
            </tr>
        `;
    });
    
    htmlContent += `
                    </tbody>
                </table>
            </div>

            <div class="section">
                <div class="section-title">üîç COMPARACI√ìN F√çSICO vs TE√ìRICO</div>
                <table>
                    <thead>
                        <tr>
                            <th>N√∫mero de Parte</th>
                            <th>Estado</th>
                            <th>Te√≥rico</th>
                            <th>F√≠sico</th>
                            <th>Diferencia</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // Agregar comparaci√≥n
    const allParts = new Set([...Object.keys(theoretical), ...Object.keys(physicalByPart)]);
    allParts.forEach(partNumber => {
        const theo = theoretical[partNumber] || { fundidos: 0, acabados: 0 };
        const phys = physicalByPart[partNumber] || { fundidos: 0, acabados: 0 };
        
        // Fila de fundidos
        const diffFundidos = phys.fundidos - theo.fundidos;
        const statusFundidos = diffFundidos === 0 ? '‚úÖ OK' : (diffFundidos > 0 ? '‚¨ÜÔ∏è Exceso' : '‚¨áÔ∏è Faltante');
        const classFundidos = diffFundidos === 0 ? 'difference-zero' : (diffFundidos > 0 ? 'difference-positive' : 'difference-negative');
        const statusClassFundidos = diffFundidos === 0 ? 'status-ok' : 'status-issue';
        
        htmlContent += `
            <tr>
                <td><strong>${partNumber}</strong></td>
                <td>üî• Fundidos</td>
                <td style="text-align: center;">${theo.fundidos}</td>
                <td style="text-align: center;">${phys.fundidos}</td>
                <td style="text-align: center;" class="${classFundidos}">${diffFundidos > 0 ? '+' : ''}${diffFundidos}</td>
                <td class="${statusClassFundidos}">${statusFundidos}</td>
            </tr>
        `;
        
        // Fila de acabados
        const diffAcabados = phys.acabados - theo.acabados;
        const statusAcabados = diffAcabados === 0 ? '‚úÖ OK' : (diffAcabados > 0 ? '‚¨ÜÔ∏è Exceso' : '‚¨áÔ∏è Faltante');
        const classAcabados = diffAcabados === 0 ? 'difference-zero' : (diffAcabados > 0 ? 'difference-positive' : 'difference-negative');
        const statusClassAcabados = diffAcabados === 0 ? 'status-ok' : 'status-issue';
        
        htmlContent += `
            <tr>
                <td></td>
                <td>‚úÖ Acabados</td>
                <td style="text-align: center;">${theo.acabados}</td>
                <td style="text-align: center;">${phys.acabados}</td>
                <td style="text-align: center;" class="${classAcabados}">${diffAcabados > 0 ? '+' : ''}${diffAcabados}</td>
                <td class="${statusClassAcabados}">${statusAcabados}</td>
            </tr>
        `;
    });
    
    htmlContent += `
                    </tbody>
                </table>
            </div>
    `;
    
    // Secci√≥n de diferencias
    if (Object.keys(discrepancies).length > 0) {
        htmlContent += `
            <div class="section">
                <div class="section-title">‚ö†Ô∏è DIFERENCIAS CR√çTICAS DETECTADAS</div>
        `;
        
        Object.keys(discrepancies).forEach(partNumber => {
            const diff = discrepancies[partNumber];
            htmlContent += `
                <div class="alert-warning">
                    <strong>‚ö†Ô∏è ${partNumber}</strong><br>
            `;
            if (diff.fundidos.diferencia !== 0) {
                htmlContent += `&nbsp;&nbsp;üî• Fundidos: ${diff.fundidos.diferencia > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diff.fundidos.diferencia)} piezas<br>`;
            }
            if (diff.acabados.diferencia !== 0) {
                htmlContent += `&nbsp;&nbsp;‚úÖ Acabados: ${diff.acabados.diferencia > 0 ? 'Exceso' : 'Faltante'} de ${Math.abs(diff.acabados.diferencia)} piezas<br>`;
            }
            htmlContent += `</div>`;
        });
        
        htmlContent += `</div>`;
    } else {
        htmlContent += `
            <div class="section">
                <div class="alert-success">
                    <h3>‚úÖ ¬°VERIFICACI√ìN PERFECTA!</h3>
                    <p>No se encontraron diferencias entre el inventario te√≥rico y f√≠sico.</p>
                </div>
            </div>
        `;
    }
    
    htmlContent += `
            <div class="footer">
                Reporte generado autom√°ticamente por el Sistema de Control de Almac√©n - Fundici√≥n v1.3<br>
                üìß Para soporte t√©cnico contacte al administrador del sistema
            </div>
        </body>
        </html>
    `;
    
    // Crear y descargar el archivo HTML que puede abrirse como PDF
    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `reporte-verificacion-${currentDate.replace(/\//g, '-')}-turno${shift}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('üìä Reporte exportado como HTML.\n\nüí° Instrucciones:\n1. Abre el archivo descargado en tu navegador\n2. Presiona Ctrl+P (o Cmd+P en Mac)\n3. Selecciona "Guardar como PDF"\n4. ¬°Listo! Tendr√°s tu reporte en PDF');
}
function calculateDiscrepancies(theoretical) {
    const discrepancies = {};
    
    // Agrupar verificaciones f√≠sicas por n√∫mero de parte
    const physicalByPart = {};
    Object.values(physicalVerification).forEach(item => {
        if (!physicalByPart[item.partNumber]) {
            physicalByPart[item.partNumber] = { fundidos: 0, acabados: 0 };
        }
        if (item.warehouse === 'fundidos') {
            physicalByPart[item.partNumber].fundidos += item.verifiedQuantity;
        } else if (item.warehouse === 'acabados') {
            physicalByPart[item.partNumber].acabados += item.verifiedQuantity;
        }
    });
    
    // Calcular diferencias
    const allParts = new Set([...Object.keys(theoretical), ...Object.keys(physicalByPart)]);
    allParts.forEach(partNumber => {
        const theo = theoretical[partNumber] || { fundidos: 0, acabados: 0 };
        const phys = physicalByPart[partNumber] || { fundidos: 0, acabados: 0 };
        
        const diffFundidos = phys.fundidos - theo.fundidos;
        const diffAcabados = phys.acabados - theo.acabados;
        
        if (diffFundidos !== 0 || diffAcabados !== 0) {
            discrepancies[partNumber] = {
                fundidos: { teorico: theo.fundidos, fisico: phys.fundidos, diferencia: diffFundidos },
                acabados: { teorico: theo.acabados, fisico: phys.acabados, diferencia: diffAcabados }
            };
        }
    });
    
    return discrepancies;
}
        function printVerificationSummary() {
    const theoretical = calculateTheoreticalInventory();
    const discrepancies = calculateDiscrepancies(theoretical);
    const currentDate = new Date().toLocaleDateString();
    const shift = document.getElementById('shift').value;
    
    let printContent = `
        <h2>üìä REPORTE DE VERIFICACI√ìN DE INVENTARIO</h2>
        <p><strong>Fecha:</strong> ${currentDate} | <strong>Turno:</strong> ${shift}</p>
        <hr>
        
        <h3>üìã RESUMEN EJECUTIVO</h3>
        <p>‚Ä¢ C√≥digos verificados: ${Object.keys(physicalVerification).length}</p>
        <p>‚Ä¢ N√∫meros de parte: ${Object.keys(theoretical).length}</p>
        <p>‚Ä¢ Diferencias encontradas: ${Object.keys(discrepancies).length}</p>
        <hr>
    `;
    
    if (Object.keys(discrepancies).length > 0) {
        printContent += '<h3>‚ö†Ô∏è DIFERENCIAS CR√çTICAS</h3>';
        Object.keys(discrepancies).forEach(partNumber => {
            const diff = discrepancies[partNumber];
            printContent += `<p><strong>${partNumber}:</strong><br>`;
            if (diff.fundidos.diferencia !== 0) {
                printContent += `&nbsp;&nbsp;üî• Fundidos: ${diff.fundidos.diferencia > 0 ? '+' : ''}${diff.fundidos.diferencia}<br>`;
            }
            if (diff.acabados.diferencia !== 0) {
                printContent += `&nbsp;&nbsp;‚úÖ Acabados: ${diff.acabados.diferencia > 0 ? '+' : ''}${diff.acabados.diferencia}<br>`;
            }
            printContent += '</p>';
        });
    } else {
        printContent += '<h3 style="color: green;">‚úÖ SIN DIFERENCIAS ENCONTRADAS</h3>';
    }
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`<html><head><title>Reporte Verificaci√≥n</title></head><body>${printContent}</body></html>`);
    printWindow.document.close();
    printWindow.print();
}
// üîÑ FUNCI√ìN clearAllData ACTUALIZADA
async function clearAllData() {
    const confirmClear = confirm('‚ö†Ô∏è LIMPIAR TODOS LOS DATOS\n\n¬øEst√°s SEGURO de que quieres eliminar:\n‚Ä¢ Todo el inventario\n‚Ä¢ Todos los movimientos\n‚Ä¢ Todas las tarimas\n‚Ä¢ Todas las verificaciones f√≠sicas\n\nEsta acci√≥n NO se puede deshacer.\n\n‚úÖ Aceptar = Eliminar todo\n‚ùå Cancelar = Mantener datos');
    
    if (confirmClear) {
        // Limpiar todas las variables
        inventory = [];
        movements = [];
        pallets = [];
        physicalVerification = {};
        theoreticalInventory = {};
        productionReports = [];
        movementReports = [];
        scrapSheets = [];
        retenciones = [];
        
        // üî• LIMPIAR EN FIREBASE
        await saveToFirebase('inventory', JSON.stringify([]));
        await saveToFirebase('movements', JSON.stringify([]));
        await saveToFirebase('pallets', JSON.stringify([]));
        await saveToFirebase('physicalVerification', JSON.stringify({}));
        await saveToFirebase('productionReports', JSON.stringify([]));
        await saveToFirebase('movementReports', JSON.stringify([]));
        await saveToFirebase('scrapSheets', JSON.stringify([]));
        await saveToFirebase('retenciones', JSON.stringify([]));
        
        // Actualizar displays
        updateAllDisplays();
        
        alert('üóëÔ∏è Todos los datos han sido eliminados.\n\nPuedes comenzar con datos frescos.');
    }
}
        function updateAllDisplays() {
    updateDashboard();
    initializeDashboardCharts(); // ‚Üê AGREGAR ESTA L√çNEA
    updateGroupedInventory();
    updateDetailedInventory();
    updatePalletsTable();
    updateVerificationSummary(); // <- AGREGAR ESTA L√çNEA
    updateProductionSummary(); // ‚¨ÖÔ∏è AGREGAR ESTA L√çNEA

}

        function updateDashboard() {
            const fundidos = inventory.filter(function(i) {
                return i.state === 'FUNDIDOS' && i.quantity > 0;
            }).length;
            const acabados = inventory.filter(function(i) {
                return i.state === 'ACABADOS' && i.quantity > 0;
            }).length;
            const upr = inventory.filter(function(i) {
                return i.type === 'UPR' && i.quantity > 0;
            }).length;
            const lwr = inventory.filter(function(i) {
                return i.type === 'LWR' && i.quantity > 0;
            }).length;
            const totalPallets = pallets.length;
            
            document.getElementById('total-fundidos').textContent = fundidos;
            document.getElementById('total-acabados').textContent = acabados;
            document.getElementById('total-upr').textContent = upr;
            document.getElementById('total-lwr').textContent = lwr;
            document.getElementById('total-pallets').textContent = totalPallets;
        }

        function updateGroupedInventory() {
            const tbody = document.getElementById('grouped-inventory-tbody');
            tbody.innerHTML = '';
            
            const grouped = {};
            
            inventory.forEach(function(item) {
                if (item.quantity > 0) {
                    if (!grouped[item.partNumber]) {
                        grouped[item.partNumber] = { 
                            fundidos: 0, acabados: 0, envios: 0, 
                            retenciones: 0, scrap: 0, pruebas: 0 
                        };
                    }
                    
                    if (item.warehouse === 'fundidos') {
                        grouped[item.partNumber].fundidos += item.quantity;
                    } else if (item.warehouse === 'acabados') {
                        grouped[item.partNumber].acabados += item.quantity;
                    } else if (item.warehouse === 'envios') {
                        grouped[item.partNumber].envios += item.quantity;
                    } else if (item.warehouse === 'retenciones') {
                        grouped[item.partNumber].retenciones += item.quantity;
                    } else if (item.warehouse === 'scrap') {
                        grouped[item.partNumber].scrap += item.quantity;
                    } else if (item.warehouse === 'pruebas') {
                        grouped[item.partNumber].pruebas += item.quantity;
                    }
                }
            });
            
            Object.keys(grouped).forEach(function(partNumber) {
                const data = grouped[partNumber];
                const total = data.fundidos + data.acabados + data.envios + data.retenciones + data.scrap + data.pruebas;
                
                const row = document.createElement('tr');
                row.innerHTML = '<td><strong>' + partNumber + '</strong></td>' +
                    '<td style="text-align: center;">üî• ' + data.fundidos + '</td>' +
                    '<td style="text-align: center;">‚úÖ ' + data.acabados + '</td>' +
                    '<td style="text-align: center;">üì¶ ' + data.envios + '</td>' +
                    '<td style="text-align: center;">‚è∏Ô∏è ' + data.retenciones + '</td>' +
                    '<td style="text-align: center;">‚ôªÔ∏è ' + data.scrap + '</td>' +
                    '<td style="text-align: center;">üß™ ' + data.pruebas + '</td>' +
                    '<td style="text-align: center; font-weight: bold;">' + total + '</td>';
                tbody.appendChild(row);
            });
        }

function updateDetailedInventory() {
    const detailedDiv = document.getElementById('detailed-inventory');
    
    // Filtros jer√°rquicos mejorados
    let html = `
        <div style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e9ecef;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4>üîç Filtros de B√∫squeda</h4>
                <button onclick="clearAllFilters()" class="btn" style="background: #6c757d; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">
                    üóëÔ∏è Limpiar Filtros
                </button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">1Ô∏è‚É£ Tipo:</label>
                    <select id="filter-type" onchange="updateDependentFilters()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <option value="">üîç Todos los Tipos</option>
                        <option value="UPR">üî∫ UPR</option>
                        <option value="LWR">üîª LWR</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">2Ô∏è‚É£ N√∫mero de Parte:</label>
                    <select id="filter-part" onchange="updateDependentFilters()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <option value="">üì¶ Todos los N√∫meros</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">3Ô∏è‚É£ Molde:</label>
                    <select id="filter-molde" onchange="updateDependentFilters()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <option value="">üîß Todos los Moldes</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">4Ô∏è‚É£ Lote:</label>
                    <select id="filter-lote" onchange="applyHierarchicalFilters()" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                        <option value="">üìã Todos los Lotes</option>
                    </select>
                </div>
            </div>
            <div id="filter-summary" style="margin-top: 10px; padding: 8px; background: #e7f3ff; border-radius: 4px; font-size: 14px; display: none;">
                <strong>üéØ Filtros activos:</strong> <span id="active-filters-text"></span>
            </div>
        </div>
    `;
    
    // Filtrar solo inventario disponible
    const availableInventory = inventory.filter(i => 
        i.quantity > 0 && (i.warehouse === 'fundidos' || i.warehouse === 'acabados')
    );
    
    // Agrupar por tipo
    const uprItems = availableInventory.filter(i => i.type === 'UPR');
    const lwrItems = availableInventory.filter(i => i.type === 'LWR');
    
    // Secci√≥n UPR
    html += '<div class="model-section">';
    html += `<div class="model-header">üî∫ UPR (${uprItems.length} piezas disponibles)</div>`;
    html += generateDetailedSection(uprItems, 'UPR');
    html += '</div>';
    
    // Secci√≥n LWR
    html += '<div class="model-section">';
    html += `<div class="model-header">üîª LWR (${lwrItems.length} piezas disponibles)</div>`;
    html += generateDetailedSection(lwrItems, 'LWR');
    html += '</div>';
    
    detailedDiv.innerHTML = html;
    
    // Inicializar filtros
    initializeHierarchicalFilters();
}
function initializeHierarchicalFilters() {
    // Obtener inventario disponible
    const availableInventory = inventory.filter(i => 
        i.quantity > 0 && (i.warehouse === 'fundidos' || i.warehouse === 'acabados') && i.codeData
    );
    
    // Poblar n√∫meros de parte √∫nicos
    const partNumbers = [...new Set(availableInventory.map(i => i.codeData.modelo))];
    const partSelect = document.getElementById('filter-part');
    if (partSelect) {
        partSelect.innerHTML = '<option value="">üì¶ Todos los N√∫meros</option>';
        partNumbers.sort().forEach(part => {
            const option = document.createElement('option');
            option.value = part;
            option.textContent = `üì¶ ${part}`;
            partSelect.appendChild(option);
        });
    }
    
    // Poblar moldes √∫nicos
    const moldes = [...new Set(availableInventory.map(i => i.codeData.molde))];
    const moldeSelect = document.getElementById('filter-molde');
    if (moldeSelect) {
        moldeSelect.innerHTML = '<option value="">üîß Todos los Moldes</option>';
        moldes.sort((a, b) => {
            // Ordenar num√©ricamente
            const numA = parseFloat(a) || 0;
            const numB = parseFloat(b) || 0;
            return numA - numB;
        }).forEach(molde => {
            const option = document.createElement('option');
            option.value = molde;
            option.textContent = `üîß ${molde}`;
            moldeSelect.appendChild(option);
        });
    }
    
    // Poblar lotes √∫nicos
    const lotes = [...new Set(availableInventory.map(i => i.codeData.lote))];
    const loteSelect = document.getElementById('filter-lote');
    if (loteSelect) {
        loteSelect.innerHTML = '<option value="">üìã Todos los Lotes</option>';
        lotes.sort().forEach(lote => {
            const option = document.createElement('option');
            option.value = lote;
            option.textContent = `üìã ${lote}`;
            loteSelect.appendChild(option);
        });
    }
}
function updateDependentFilters() {
    const filterType = document.getElementById('filter-type').value;
    const filterPart = document.getElementById('filter-part').value;
    const filterMolde = document.getElementById('filter-molde').value;
    
    console.log('üîÑ Actualizando filtros dependientes:', { filterType, filterPart, filterMolde });
    
    // Obtener inventario base
    let filteredInventory = inventory.filter(i => 
        i.quantity > 0 && (i.warehouse === 'fundidos' || i.warehouse === 'acabados') && i.codeData
    );
    
    // Aplicar filtro de tipo si est√° seleccionado
    if (filterType) {
        filteredInventory = filteredInventory.filter(i => i.type === filterType);
    }
    
    // Actualizar n√∫meros de parte basado en tipo
    const partNumbers = [...new Set(filteredInventory.map(i => i.codeData.modelo))];
    const partSelect = document.getElementById('filter-part');
    if (partSelect) {
        const currentPart = partSelect.value;
        partSelect.innerHTML = '<option value="">üì¶ Todos los N√∫meros</option>';
        
        partNumbers.sort().forEach(part => {
            const option = document.createElement('option');
            option.value = part;
            option.textContent = `üì¶ ${part}`;
            option.selected = part === currentPart && partNumbers.includes(currentPart);
            partSelect.appendChild(option);
        });
        
        // Si la parte seleccionada ya no est√° disponible, limpiarla
        if (currentPart && !partNumbers.includes(currentPart)) {
            partSelect.value = '';
        }
    }
    
    // Aplicar filtro de n√∫mero de parte si est√° seleccionado
    if (filterPart) {
        filteredInventory = filteredInventory.filter(i => i.codeData.modelo === filterPart);
    }
    
    // Actualizar moldes basado en tipo y n√∫mero de parte
    const moldes = [...new Set(filteredInventory.map(i => i.codeData.molde))];
    const moldeSelect = document.getElementById('filter-molde');
    if (moldeSelect) {
        const currentMolde = moldeSelect.value;
        moldeSelect.innerHTML = '<option value="">üîß Todos los Moldes</option>';
        
        moldes.sort((a, b) => {
            const numA = parseFloat(a) || 0;
            const numB = parseFloat(b) || 0;
            return numA - numB;
        }).forEach(molde => {
            const option = document.createElement('option');
            option.value = molde;
            option.textContent = `üîß ${molde}`;
            option.selected = molde === currentMolde && moldes.includes(currentMolde);
            moldeSelect.appendChild(option);
        });
        
        // Si el molde seleccionado ya no est√° disponible, limpiarlo
        if (currentMolde && !moldes.includes(currentMolde)) {
            moldeSelect.value = '';
        }
    }
    
    // Aplicar filtro de molde si est√° seleccionado
    if (filterMolde) {
        filteredInventory = filteredInventory.filter(i => i.codeData.molde === filterMolde);
    }
    
    // Actualizar lotes basado en todos los filtros anteriores
    const lotes = [...new Set(filteredInventory.map(i => i.codeData.lote))];
    const loteSelect = document.getElementById('filter-lote');
    if (loteSelect) {
        const currentLote = loteSelect.value;
        loteSelect.innerHTML = '<option value="">üìã Todos los Lotes</option>';
        
        lotes.sort().forEach(lote => {
            const option = document.createElement('option');
            option.value = lote;
            option.textContent = `üìã ${lote}`;
            option.selected = lote === currentLote && lotes.includes(currentLote);
            loteSelect.appendChild(option);
        });
        
        // Si el lote seleccionado ya no est√° disponible, limpiarlo
        if (currentLote && !lotes.includes(currentLote)) {
            loteSelect.value = '';
        }
    }
    
    // Aplicar filtros finales
    applyHierarchicalFilters();
}
function generateDetailedSection(items, type) {
    if (items.length === 0) return '<p>No hay piezas registradas</p>';
    
    // Agrupar por modelo
    const groupedByModel = {};
    items.forEach(item => {
        if (item.codeData) {
            const model = item.codeData.modelo;
            if (!groupedByModel[model]) {
                groupedByModel[model] = [];
            }
            groupedByModel[model].push(item);
        }
    });
    
    let html = '';
    Object.keys(groupedByModel).forEach(model => {
        const modelItems = groupedByModel[model];
        const totalCount = modelItems.reduce((sum, item) => sum + item.quantity, 0);
        
        html += `
            <div class="state-subsection">
                <div class="state-header" onclick="toggleModelSection('model-${type}-${model}')" style="cursor: pointer;">
                    üì¶ Modelo ${model} (${totalCount} piezas) <span id="toggle-${type}-${model}">‚ñº</span>
                </div>
                <div id="model-${type}-${model}">
                    <table class="inventory-table" style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Lote</th>
                                <th>M√°quina</th>
                                <th>Molde</th>
                                <th>Disparo</th>
                                <th>Estado</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        modelItems.forEach(item => {
            const data = item.codeData;
            html += `
                <tr>
                    <td style="font-family: monospace; font-size: 0.8em;">${item.code}</td>
                    <td>${data.lote}</td>
                    <td>${data.maquina}</td>
                    <td>${data.molde}</td>
                    <td>${data.disparo}</td>
                    <td><span class="code-badge" style="background: ${item.state === 'FUNDIDOS' ? '#e74c3c' : '#27ae60'};">${item.state}</span></td>
                    <td style="text-align: center; font-weight: bold;">${item.quantity}</td>
                </tr>
            `;
        });
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    });
    
    return html;
}
function fillFilterOptions(selectId, options) {
    const select = document.getElementById(selectId);
    if (select) {
        const currentValue = select.value; // Preservar selecci√≥n actual
        
        // Limpiar opciones existentes excepto la primera
        while (select.children.length > 1) {
            select.removeChild(select.lastChild);
        }
        
        // Agregar nuevas opciones
        options.sort().forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            optionElement.selected = option === currentValue;
            select.appendChild(optionElement);
        });
    }
}
function applyHierarchicalFilters() {
    const filterType = document.getElementById('filter-type').value;
    const filterPart = document.getElementById('filter-part').value;
    const filterMolde = document.getElementById('filter-molde').value;
    const filterLote = document.getElementById('filter-lote').value;
    
    console.log('üéØ Aplicando filtros:', { filterType, filterPart, filterMolde, filterLote });
    
    // Filtrar inventario
    let filteredInventory = inventory.filter(i => 
        i.quantity > 0 && 
        (i.warehouse === 'fundidos' || i.warehouse === 'acabados') &&
        i.codeData
    );
    
    // Aplicar cada filtro
    if (filterType) {
        filteredInventory = filteredInventory.filter(i => i.type === filterType);
    }
    if (filterPart) {
        filteredInventory = filteredInventory.filter(i => i.codeData.modelo === filterPart);
    }
    if (filterMolde) {
        filteredInventory = filteredInventory.filter(i => i.codeData.molde === filterMolde);
    }
    if (filterLote) {
        filteredInventory = filteredInventory.filter(i => i.codeData.lote === filterLote);
    }
    
    console.log('üìä Inventario filtrado:', filteredInventory.length, 'items');
    
    // Agrupar por tipo
    const uprItems = filteredInventory.filter(i => i.type === 'UPR');
    const lwrItems = filteredInventory.filter(i => i.type === 'LWR');
    
    // Actualizar solo las secciones de contenido
    updateInventorySections(uprItems, lwrItems);
    
    // Actualizar resumen de filtros
    updateFilterSummary(filterType, filterPart, filterMolde, filterLote);
}
function updateInventorySections(uprItems, lwrItems) {
    const hasFilters = hasActiveFilters();
    const filterType = document.getElementById('filter-type').value;
    
    // Encontrar el contenedor principal donde est√°n las secciones
    const detailedDiv = document.getElementById('detailed-inventory');
    const uprSection = detailedDiv.querySelector('.model-section:nth-child(2)'); // Primera secci√≥n despu√©s de los filtros
    const lwrSection = detailedDiv.querySelector('.model-section:nth-child(3)'); // Segunda secci√≥n despu√©s de los filtros
    
    console.log('üìä Actualizando secciones:', { uprItems: uprItems.length, lwrItems: lwrItems.length, filterType });
    
    // Actualizar secci√≥n UPR
    if (uprSection) {
        if (filterType === 'LWR') {
            // Si filtro por LWR, ocultar UPR completamente
            uprSection.style.display = 'none';
        } else {
            // Mostrar UPR (con o sin filtros)
            uprSection.style.display = 'block';
            uprSection.innerHTML = `
                <div class="model-header">üî∫ UPR (${uprItems.length} piezas ${hasFilters ? 'filtradas' : 'disponibles'})</div>
                ${generateDetailedSection(uprItems, 'UPR')}
            `;
        }
    }
    
    // Actualizar secci√≥n LWR
    if (lwrSection) {
        if (filterType === 'UPR') {
            // Si filtro por UPR, ocultar LWR completamente
            lwrSection.style.display = 'none';
        } else {
            // Mostrar LWR (con o sin filtros)
            lwrSection.style.display = 'block';
            lwrSection.innerHTML = `
                <div class="model-header">üîª LWR (${lwrItems.length} piezas ${hasFilters ? 'filtradas' : 'disponibles'})</div>
                ${generateDetailedSection(lwrItems, 'LWR')}
            `;
        }
    }
}
function updateFilterSummary(filterType, filterPart, filterMolde, filterLote) {
    const summaryDiv = document.getElementById('filter-summary');
    const summaryText = document.getElementById('active-filters-text');
    
    if (!summaryDiv || !summaryText) return;
    
    const activeFilters = [];
    if (filterType) activeFilters.push(`Tipo: ${filterType}`);
    if (filterPart) activeFilters.push(`Parte: ${filterPart}`);
    if (filterMolde) activeFilters.push(`Molde: ${filterMolde}`);
    if (filterLote) activeFilters.push(`Lote: ${filterLote}`);
    
    if (activeFilters.length > 0) {
        summaryText.textContent = activeFilters.join(' | ');
        summaryDiv.style.display = 'block';
    } else {
        summaryDiv.style.display = 'none';
    }
}

function hasActiveFilters() {
    const filterType = document.getElementById('filter-type')?.value;
    const filterPart = document.getElementById('filter-part')?.value;
    const filterMolde = document.getElementById('filter-molde')?.value;
    const filterLote = document.getElementById('filter-lote')?.value;
    
    return filterType || filterPart || filterMolde || filterLote;
}

function clearAllFilters() {
    try {
        // Limpiar todos los selectores
        const filterType = document.getElementById('filter-type');
        const filterPart = document.getElementById('filter-part');
        const filterMolde = document.getElementById('filter-molde');
        const filterLote = document.getElementById('filter-lote');
        
        if (filterType) filterType.value = '';
        if (filterPart) filterPart.value = '';
        if (filterMolde) filterMolde.value = '';
        if (filterLote) filterLote.value = '';
        
        // Asegurar que ambas secciones sean visibles
        const detailedDiv = document.getElementById('detailed-inventory');
        const sections = detailedDiv.querySelectorAll('.model-section');
        sections.forEach(section => {
            section.style.display = 'block';
        });
        
        // Reinicializar filtros
        initializeHierarchicalFilters();
        
        // Mostrar todo el inventario sin filtros
        const availableInventory = inventory.filter(i => 
            i.quantity > 0 && (i.warehouse === 'fundidos' || i.warehouse === 'acabados')
        );
        
        const uprItems = availableInventory.filter(i => i.type === 'UPR');
        const lwrItems = availableInventory.filter(i => i.type === 'LWR');
        
        updateInventorySections(uprItems, lwrItems);
        updateFilterSummary('', '', '', '');
        
        console.log('üóëÔ∏è Filtros limpiados correctamente');
        
    } catch (error) {
        console.error('‚ùå Error al limpiar filtros:', error);
        // Fallback: recargar toda la vista
        updateDetailedInventory();
    }
}
async function clearAllInventoryData() {
    const adminPassword = prompt('üîê ACCESO RESTRINGIDO\nIngresa la contrase√±a de administrador:');
    const correctPassword = 'FUNDICION2025';
    
    if (adminPassword !== correctPassword) {
        alert('‚ùå Contrase√±a incorrecta. Acceso denegado.');
        return;
    }
    
    const confirmClear = confirm('‚ö†Ô∏è ¬øEst√°s COMPLETAMENTE seguro de eliminar TODO el inventario Y tarimas?\n\nüî• Esta acci√≥n es IRREVERSIBLE.\n\nüì¶ Se eliminar√°n:\n‚Ä¢ Todo el inventario\n‚Ä¢ Todas las tarimas registradas');
    
    if (confirmClear) {
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; color: white;">
                <div style="text-align: center; background: #333; padding: 30px; border-radius: 10px;">
                    <div style="font-size: 24px;">üóëÔ∏è Eliminando inventario...</div>
                    <div style="margin-top: 15px;">üî• Limpiando Firebase...</div>
                </div>
            </div>
        `;
        document.body.appendChild(loadingDiv);
        
        try {
            console.log('üóëÔ∏è Iniciando limpieza TOTAL del inventario...');
            
            // 1. üî• LIMPIAR FIREBASE
            try {
                const emptyArray = [];
                const emptyFirebaseObject = arrayToFirebaseObject(emptyArray);
                await saveToFirebaseHelper('inventory', emptyFirebaseObject);
		await saveToFirebaseHelper('pallets', emptyFirebaseObject);
                console.log('‚úÖ Firebase limpiado');
                
                const verification = await getFromFirebase('inventory');
                const verificationArray = firebaseObjectToArray(verification || {});
                console.log('üîç Verificaci√≥n Firebase:', verificationArray.length, 'elementos');
                
            } catch (firebaseError) {
                console.error('‚ùå Error cr√≠tico en Firebase:', firebaseError);
                throw new Error('No se pudo limpiar Firebase: ' + firebaseError.message);
            }
            
            // 2. Limpiar memoria
            inventory.length = 0;
	    pallets.length = 0;
            console.log('‚úÖ Array inventory limpiado - Longitud:', inventory.length);
            
            // üî• ACTUALIZAR TABLAS INMEDIATAMENTE
            if (typeof updateGroupedInventory === 'function') {
                updateGroupedInventory();
                console.log('‚úÖ Tabla de resumen actualizada');
            }
            
            if (typeof updateDetailedInventory === 'function') {
                updateDetailedInventory();
                console.log('‚úÖ Vista detallada actualizada');
            }
	    if (typeof updatePalletsTable === 'function') {
                updatePalletsTable();
                console.log('‚úÖ Tabla de tarimas actualizada');
            }
            
            // 3. Limpiar localStorage
            ['inventory', 'inventoryBackup', 'lastScan', 'inventoryData'].forEach(key => {
                localStorage.removeItem(key);
            });
            
            // 4. Limpiar estad√≠sticas
            clearAllStatistics();
            
            document.body.removeChild(loadingDiv);
            
            alert('üî• INVENTARIO Y TARIMAS ELIMINADOS COMPLETAMENTE\n\n‚úÖ Firebase: Limpiado\n‚úÖ Memoria: Limpiada\n‚úÖ Tablas: Actualizadas\n\nüìä Inventario: ' + inventory.length + ' elementos\nüì¶ Tarimas: ' + pallets.length + ' elementos');

            
            console.log('‚úÖ LIMPIEZA TOTAL COMPLETADA');
            
        } catch (error) {
            const loadingDiv = document.querySelector('[style*="position: fixed"]');
            if (loadingDiv) document.body.removeChild(loadingDiv);
            
            console.error('‚ùå ERROR:', error);
            alert('üö® ERROR: ' + error.message);
        }
    }
}
function clearAllStatistics() {
    try {
        // Limpiar tabla de resumen por n√∫mero de parte
        const statsTable = document.querySelector('#part-number-stats tbody');
        if (statsTable) {
            statsTable.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px; color: #6c757d;">
                        üìä No hay datos para mostrar
                    </td>
                </tr>
            `;
        }
        
        // Limpiar estad√≠sticas del dashboard principal
        const dashboardStats = document.querySelectorAll('.stat-card, .dashboard-stat, .inventory-stat');
        dashboardStats.forEach(stat => {
            const countElement = stat.querySelector('.stat-number, .count, .stat-value');
            if (countElement) {
                countElement.textContent = '0';
            }
        });
        
        // Limpiar contadores espec√≠ficos si existen
        const counterSelectors = [
            '#total-fundidos',
            '#total-acabados',
            '#total-envios',
            '#total-devoluciones',
            '#total-scrap',
            '#total-pruebas',
            '#total-items'
        ];
        
        counterSelectors.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.textContent = '0';
            }
        });
        
        console.log('üìä Estad√≠sticas limpiadas');
        
    } catch (error) {
        console.error('‚ùå Error al limpiar estad√≠sticas:', error);
    }
}
function clearAllCharts() {
    try {
        // Si tienes gr√°ficos de Chart.js, los destruimos
        if (typeof Chart !== 'undefined') {
            Chart.getChart('inventory-chart')?.destroy();
            Chart.getChart('warehouse-chart')?.destroy();
            Chart.getChart('trends-chart')?.destroy();
        }
        
        // Limpiar contenedores de gr√°ficos
        const chartContainers = document.querySelectorAll('canvas[id*="chart"]');
        chartContainers.forEach(canvas => {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
        
        console.log('üìà Gr√°ficos limpiados');
        
    } catch (error) {
        console.error('‚ùå Error al limpiar gr√°ficos:', error);
    }
}
function fillFilterOptionsWithSelection(selectedModel, selectedLote, selectedMolde) {
    // Obtener valores √∫nicos del inventario original (no filtrado)
    const availableInventory = inventory.filter(i => 
        i.quantity > 0 && (i.warehouse === 'fundidos' || i.warehouse === 'acabados') && i.codeData
    );
    
    const modelos = [...new Set(availableInventory.map(i => i.codeData.modelo))];
    const lotes = [...new Set(availableInventory.map(i => i.codeData.lote))];
    const moldes = [...new Set(availableInventory.map(i => i.codeData.molde))];
    
    // Llenar select de modelos
    const modelSelect = document.getElementById('filter-model');
    if (modelSelect) {
        modelSelect.innerHTML = '<option value="">Todos los Modelos</option>';
        modelos.sort().forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo;
            option.textContent = modelo;
            option.selected = modelo === selectedModel;
            modelSelect.appendChild(option);
        });
    }
    
    // Llenar select de lotes
    const loteSelect = document.getElementById('filter-lote');
    if (loteSelect) {
        loteSelect.innerHTML = '<option value="">Todos los Lotes</option>';
        lotes.sort().forEach(lote => {
            const option = document.createElement('option');
            option.value = lote;
            option.textContent = lote;
            option.selected = lote === selectedLote;
            loteSelect.appendChild(option);
        });
    }
    
    // Llenar select de moldes
    const moldeSelect = document.getElementById('filter-molde');
    if (moldeSelect) {
        moldeSelect.innerHTML = '<option value="">Todos los Moldes</option>';
        moldes.sort().forEach(molde => {
            const option = document.createElement('option');
            option.value = molde;
            option.textContent = molde;
            option.selected = molde === selectedMolde;
            moldeSelect.appendChild(option);
        });
    }
}
function toggleModelSection(sectionId) {
    const section = document.getElementById(sectionId);
    const toggleIcon = document.getElementById('toggle-' + sectionId.replace('model-', ''));
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        toggleIcon.textContent = '‚ñº';
    } else {
        section.style.display = 'none';
        toggleIcon.textContent = '‚ñ∂';
    }
}
function updatePalletsTable() {
    const tbody = document.getElementById('pallets-tbody');
    tbody.innerHTML = '';
    
    pallets.forEach(function(pallet) {
        const row = document.createElement('tr');
        row.innerHTML = '<td><strong>' + pallet.systemId + '</strong></td>' +
            '<td>' + pallet.originalId + '</td>' +
            '<td><span class="code-badge" style="background: ' + (pallet.state === 'fundidos' ? '#e74c3c' : '#27ae60') + ';">' + pallet.state.toUpperCase() + '</span></td>' +
            '<td><span class="code-badge" style="background: #17a2b8;">' + pallet.type + '</span></td>' +
            '<td style="text-align: center;">' + pallet.codesCount + '</td>' +
            '<td>' + getWarehouseName(pallet.warehouse) + '</td>' +
            '<td>' + (pallet.createdDate ? new Date(pallet.createdDate).toLocaleDateString() : 'N/A') + '</td>' +
            '<td>' +
            '<button class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;" onclick="movePallet(\'' + pallet.systemId + '\')">üì¶ Mover</button>' +
            '<button class="btn btn-info" style="padding: 5px 10px; font-size: 12px;" onclick="viewPalletDetails(\'' + pallet.systemId + '\')">üëÅÔ∏è Ver</button>' +
            '</td>';
        tbody.appendChild(row);
    });
    
    // Si estamos en la sub-pesta√±a individual, actualizar tambi√©n
    const individualTab = document.getElementById('individual-management');
    if (individualTab && individualTab.classList.contains('active')) {
        filterIndividualItems();
    }
}
// üîÑ DOMCONTENTLOADED PRINCIPAL - VERSI√ìN CORREGIDA SIN DUPLICACIONES
document.addEventListener('DOMContentLoaded', async function() {
    // ‚ö†Ô∏è AGREGAR ESTA VERIFICACI√ìN AL INICIO:
    if (window.appInitialized) {
        console.log('‚ö†Ô∏è Aplicaci√≥n ya inicializada, evitando duplicaci√≥n');
        return;
    }
    window.appInitialized = true;
    
    console.log('üöÄ Iniciando aplicaci√≥n...');
    
    try {
        // 1. INICIALIZAR FIREBASE PRIMERO
        initializeFirebase();
        
        // 2. Inicializar Firebase y cargar datos principales
        console.log('üìä Cargando datos principales...');
        await initializeAppData();
        
        // 3. Inicializar sistema de usuarios
        console.log('üë• Inicializando sistema de usuarios...');
        await initUserSystem();
        
        console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
        
    } catch (error) {
        console.error('‚ùå Error inicializando aplicaci√≥n:', error);
        alert('‚ùå Error inicializando la aplicaci√≥n. Por favor, recarga la p√°gina.');
    }
});
console.log('üîß Funciones helper cargadas');
        function updateVerificationSummary() {
    // Actualizar contador de verificaciones en dashboard si existe
    const verificationCount = Object.keys(physicalVerification).length;
    
    // Si hay un elemento para mostrar verificaciones, actualizarlo
    const verificationElement = document.getElementById('verification-count');
    if (verificationElement) {
        verificationElement.textContent = verificationCount;
    }
}
        // Mostrar formulario seg√∫n el tipo seleccionado
function showProductionForm() {
    const productionType = document.getElementById('production-type').value;
    
    // Ocultar todos los formularios
    document.getElementById('fundicion-form').style.display = 'none';
    document.getElementById('acabado-form').style.display = 'none';
    document.getElementById('movimientos-form').style.display = 'none';
    
    // Mostrar el formulario seleccionado
    if (productionType) {
        document.getElementById(productionType + '-form').style.display = 'block';
        
        // Establecer fecha actual por defecto
        const today = new Date().toISOString().split('T')[0];
        if (productionType === 'fundicion') {
            document.getElementById('fund-fecha').value = today;
        } else if (productionType === 'acabado') {
            document.getElementById('acab-fecha').value = today;
        } else if (productionType === 'movimientos') {
            document.getElementById('mov-fecha').value = today;
        }
    }
}

// Actualizar opciones de modelo seg√∫n la m√°quina seleccionada
function updateModelOptions(prefix) {
    const maquina = document.getElementById(prefix + '-maquina').value;
    const modeloSelect = document.getElementById(prefix + '-modelo');
    const moldeSelect = document.getElementById(prefix + '-molde');
    
    // Limpiar opciones
    modeloSelect.innerHTML = '<option value="">Seleccionar modelo...</option>';
    moldeSelect.innerHTML = '<option value="">Primero selecciona modelo...</option>';
    
    if (maquina && MACHINE_MODELS[maquina]) {
        MACHINE_MODELS[maquina].forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo;
            option.textContent = modelo;
            modeloSelect.appendChild(option);
        });
    }
}

// Actualizar opciones de molde seg√∫n el modelo seleccionado
function updateMoldeOptions(prefix) {
    const modelo = document.getElementById(prefix + '-modelo').value;
    const moldeSelect = document.getElementById(prefix + '-molde');
    
    // Limpiar opciones
    moldeSelect.innerHTML = '<option value="">Seleccionar molde...</option>';
    
    if (modelo && MODEL_MOLDS[modelo]) {
        MODEL_MOLDS[modelo].forEach(molde => {
            const option = document.createElement('option');
            option.value = molde;
            option.textContent = molde;
            moldeSelect.appendChild(option);
        });
    }
}

// Calcular piezas buenas autom√°ticamente
function calculateGoodParts(prefix) {
    const total = parseInt(document.getElementById(prefix + '-total').value) || 0;
    const ng = parseInt(document.getElementById(prefix + '-ng').value) || 0;
    const buenas = Math.max(0, total - ng);
    
    document.getElementById(prefix + '-buenas').value = buenas;
}

// üîÑ FUNCI√ìN saveProductionReport ACTUALIZADA
async function saveProductionReport(tipo) {
    const prefix = tipo === 'fundicion' ? 'fund' : 'acab';
    const form = document.getElementById('production-' + tipo + '-form');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // VALIDACI√ìN OBLIGATORIA DE EVIDENCIA
    const evidencia = await getEvidenceFile(prefix + '-evidencia');
    if (!evidencia) {
        alert('‚ö†Ô∏è EVIDENCIA REQUERIDA\n\nDebe adjuntar un archivo PDF como evidencia del reporte antes de guardar.\n\nPor favor, selecciona un archivo PDF.');
        return;
    }      
    
    const reporte = {
        id: Date.now(),
        tipo: tipo,
        fecha: document.getElementById(prefix + '-fecha').value, // ‚úÖ Correcto
        turno: document.getElementById(prefix + '-turno').value,
        modelo: document.getElementById(prefix + '-modelo').value,
        cantidadTotal: parseInt(document.getElementById(prefix + '-total').value),
        cantidadNG: parseInt(document.getElementById(prefix + '-ng').value),
        piezasBuenas: parseInt(document.getElementById(prefix + '-buenas').value),
        evidencia: evidencia,
        timestamp: new Date().toISOString(),
        createdBy: currentUser.nombre
    };
    
    // Para fundici√≥n agregar m√°quina y molde
    if (tipo === 'fundicion') {
        reporte.maquina = document.getElementById('fund-maquina').value;
        reporte.molde = document.getElementById('fund-molde').value;
    } else {
        reporte.maquina = document.getElementById('acab-maquina').value;
    }
    
    productionReports.push(reporte);
    
   // üî• GUARDAR EVIDENCIA POR SEPARADO
if (reporte.evidencia) {
    await saveToFirebase(`evidencia_${reporte.id}`, JSON.stringify(reporte.evidencia));
    reporte.evidencia = { hasEvidence: true, evidenceId: reporte.id }; // Solo guardar referencia
}

// üî• GUARDAR REPORTES SIN EVIDENCIA PESADA
await saveToFirebase('productionReports', JSON.stringify(arrayToFirebaseObject(productionReports)));
    
    let alertMessage = `‚úÖ Reporte de ${tipo} guardado exitosamente!\n\nüìä Resumen:\n‚Ä¢ Modelo: ${reporte.modelo}\n‚Ä¢ M√°quina: ${reporte.maquina}\n‚Ä¢ Piezas buenas: ${reporte.piezasBuenas}\n‚Ä¢ Fecha: ${reporte.fecha}\n‚Ä¢ Turno: ${reporte.turno}`;
    
    if (evidencia) {
        alertMessage += `\n‚Ä¢ üìÑ Evidencia: ${evidencia.nombre}`;
    }
    
    alert(alertMessage);
    
    form.reset();
    clearFormFiles('production-' + tipo + '-form');
    updateProductionSummary();
    filterProductionReports(); // Actualizar tabla
}

// üîÑ FUNCI√ìN saveMovementReport ACTUALIZADA
async function saveMovementReport() {
    const form = document.getElementById('production-movimientos-form');
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // VALIDACI√ìN OBLIGATORIA DE EVIDENCIA
    const evidencia = await getEvidenceFile('mov-evidencia');
    if (!evidencia) {
        alert('‚ö†Ô∏è EVIDENCIA REQUERIDA\n\nDebe adjuntar un archivo PDF como evidencia del movimiento antes de guardar.\n\nPor favor, selecciona un archivo PDF.');
        return;
    }
    
    const movimiento = {
        id: Date.now(),
        tipo: document.getElementById('mov-tipo').value,
        fecha: document.getElementById('mov-fecha').value,
        maquina: document.getElementById('mov-maquina').value,
        modelo: document.getElementById('mov-modelo').value,
        cantidad: parseInt(document.getElementById('mov-cantidad').value),
        comentarios: document.getElementById('mov-comentarios').value,
        evidencia: evidencia,
        timestamp: new Date()
    };
    
    movementReports.push(movimiento);
    
    // üî• GUARDAR EN FIREBASE
    await saveToFirebase('movementReports', JSON.stringify(arrayToFirebaseObject(movementReports)));
    
    const tipoNames = {
        'scrap': '‚ôªÔ∏è Scrap',
        'envios': 'üì¶ Env√≠os',
        'retenciones': '‚è∏Ô∏è Retenciones',
        'pruebas': 'üß™ Pruebas'
    };
    
    let alertMessage = `‚úÖ Movimiento registrado exitosamente!\n\nüìä Resumen:\n‚Ä¢ Tipo: ${tipoNames[movimiento.tipo]}\n‚Ä¢ M√°quina: ${movimiento.maquina}\n‚Ä¢ Modelo: ${movimiento.modelo}\n‚Ä¢ Cantidad: ${movimiento.cantidad}\n‚Ä¢ Fecha: ${movimiento.fecha}`;
    
    if (evidencia) {
        alertMessage += `\n‚Ä¢ üìÑ Evidencia: ${evidencia.nombre}`;
    }
    
    alert(alertMessage);
    
    form.reset();
    clearFormFiles('production-movimientos-form');
    updateProductionSummary();
}
// Guardar reportes de forma simple (sin chunks complicados)
async function saveProductionReportsSimple() {
    try {
        console.log('üíæ Guardando reportes en Firebase...');
        
        // Si hay m√°s de 50 reportes, mantener solo los √∫ltimos 50
        if (productionReports.length > 50) {
            productionReports = productionReports
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 50);
            console.log('üßπ Limitados a 50 reportes m√°s recientes');
        }
        
        // Crear versi√≥n sin evidencia para guardar (reducir tama√±o)
        const reportsWithoutEvidence = productionReports.map(report => ({
            ...report,
            evidencia: report.evidencia ? { hasEvidence: true, evidenceId: report.id } : null
        }));
        
        // Guardar reportes principales
        await saveToFirebase('productionReports_simple', JSON.stringify(arrayToFirebaseObject(reportsWithoutEvidence)));
        
        // Guardar evidencias por separado
        for (const report of productionReports) {
            if (report.evidencia && report.evidencia.contenido) {
                await saveToFirebase(`evidencia_${report.id}`, JSON.stringify(report.evidencia));
            }
        }
        
        console.log('‚úÖ Reportes guardados correctamente');
        
    } catch (error) {
        console.error('‚ùå Error guardando reportes:', error);
        throw error;
    }
}

// Cargar reportes de forma simple
async function loadProductionReportsSimple() {
    try {
        console.log('üìä Cargando reportes desde Firebase...');
        
        const reportsData = await loadFromFirebase('productionReports_simple');
        if (reportsData) {
            const reportsArray = firebaseObjectToArray(JSON.parse(reportsData));
            
            // Cargar evidencias por separado
            for (const report of reportsArray) {
                if (report.evidencia && report.evidencia.hasEvidence) {
                    try {
                        const evidenciaData = await loadFromFirebase(`evidencia_${report.id}`);
                        if (evidenciaData) {
                            report.evidencia = JSON.parse(evidenciaData);
                        }
                    } catch (evidenceError) {
                        console.warn(`‚ö†Ô∏è No se pudo cargar evidencia para reporte ${report.id}`);
                        report.evidencia = null;
                    }
                }
            }
            
            productionReports = reportsArray;
            console.log(`‚úÖ ${productionReports.length} reportes cargados`);
        } else {
            productionReports = [];
            console.log('üì≠ No hay reportes de producci√≥n');
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando reportes:', error);
        productionReports = [];
    }
}
// Actualizar resumen de producci√≥n
function updateProductionSummary() {
    const summaryDiv = document.getElementById('production-summary');
    const currentShift = document.getElementById('shift').value;
    // üîÑ CORREGIR: Usar fecha local en lugar de UTC
    const now = new Date();
    const today = now.getFullYear() + '-' + 
    String(now.getMonth() + 1).padStart(2, '0') + '-' + 
    String(now.getDate()).padStart(2, '0');

console.log('üîç DEBUG updateProductionSummary:');
console.log('- today calculado (CORREGIDO):', today);
    
    // Filtrar reportes del turno actual
    const currentReports = productionReports.filter(r => 
        r.fecha === today && r.turno === currentShift
    );
    const currentMovements = movementReports.filter(m => 
        m.fecha === today
    );
    
    if (currentReports.length === 0 && currentMovements.length === 0) {
        summaryDiv.innerHTML = '<div class="alert alert-info">No hay reportes registrados para el turno actual.</div>';
        return;
    }
    
    let html = '<h4>üìã Reportes del Turno:</h4>';
    
    // Mostrar reportes de producci√≥n
    if (currentReports.length > 0) {
        html += '<table class="inventory-table"><thead><tr><th>Tipo</th><th>Modelo</th><th>M√°quina</th><th>Molde</th><th>Total</th><th>NG</th><th>Buenas</th><th>Evidencia</th><th>Hora</th></tr></thead><tbody>';
        
        // TABLA CORREGIDA - Para reportes de producci√≥n
        currentReports.forEach(r => {
            const evidenciaIcon = r.evidencia ? 
                `<button onclick="showEvidenceInfo('${r.id}')" class="btn btn-sm" style="background: #28a745; color: white;">üìÑ</button>` : 
                '‚Äî';
            
            html += `<tr>
                <td>${r.tipo.toUpperCase()}</td>
                <td>${r.modelo}</td>
                <td>${r.maquina || 'N/A'}</td>
                <td>${r.molde || 'N/A'}</td>
                <td>${r.cantidadTotal}</td>
                <td>${r.cantidadNG}</td>
                <td><strong>${r.piezasBuenas}</strong></td>
                <td>${evidenciaIcon}</td>
                <td>${new Date(r.timestamp).toLocaleTimeString()}</td>
            </tr>`;
        });
        html += '</tbody></table>';
    }
    
    // Mostrar movimientos
    if (currentMovements.length > 0) {
        html += '<h4>üì¶ Movimientos Registrados:</h4>';
        html += '<table class="inventory-table"><thead><tr><th>Tipo</th><th>M√°quina</th><th>Modelo</th><th>Cantidad</th><th>Evidencia</th><th>Comentarios</th><th>Hora</th></tr></thead><tbody>';
        
        currentMovements.forEach(m => {
            const tipoIcons = {'scrap': '‚ôªÔ∏è', 'envios': 'üì¶', 'retenciones': '‚è∏Ô∏è', 'pruebas': 'üß™'};
            const evidenciaIcon = m.evidencia ? 
                `<button onclick="showEvidenceInfo('${m.id}')" class="btn btn-sm" style="background: #28a745; color: white;">üìÑ</button>` : 
                '‚Äî';
            
            html += `<tr>
                <td>${tipoIcons[m.tipo]} ${m.tipo.toUpperCase()}</td>
                <td>${m.maquina}</td>
                <td>${m.modelo}</td>
                <td>${m.cantidad}</td>
                <td>${evidenciaIcon}</td>
                <td>${m.comentarios || 'Sin comentarios'}</td>
                <td>${new Date(m.timestamp).toLocaleTimeString()}</td>
            </tr>`;
        });
        html += '</tbody></table>';
    }
    
    summaryDiv.innerHTML = html;
}
// NUEVO SISTEMA DE REPORTES - Funciona con estructura actual
function generateTheoreticalBalance() {
    const currentShift = document.getElementById('shift').value;
    const today = new Date().toISOString().split('T')[0];
    
    // Verificar que hay datos para trabajar
    if (inventory.length === 0 && Object.keys(physicalVerification).length === 0 && productionReports.length === 0) {
        alert('‚ö†Ô∏è No hay datos suficientes para generar el reporte.\n\nNecesitas al menos:\n‚Ä¢ Inventario registrado, O\n‚Ä¢ Verificaciones f√≠sicas, O\n‚Ä¢ Reportes de producci√≥n');
        return;
    }
    
    // Crear el reporte
    createTheoreticalReport();
}

function createTheoreticalReport() {
    const currentShift = document.getElementById('shift').value;
    const today = new Date().toISOString().split('T')[0];
    
    // 1. OBTENER INVENTARIO ACTUAL (TE√ìRICO)
    const inventarioTeorico = calcularInventarioTeorico();
    
    // 2. OBTENER VERIFICACI√ìN F√çSICA
    const inventarioFisico = calcularInventarioFisico();
    
    // 3. OBTENER REPORTES DE PRODUCCI√ìN DEL D√çA
    const reportesProduccion = obtenerReportesProduccion(today, currentShift);
    
    // 4. GENERAR HTML DEL REPORTE
    const reportHTML = generarHTMLReporte(inventarioTeorico, inventarioFisico, reportesProduccion, today, currentShift);
    
    // 5. MOSTRAR REPORTE EN NUEVA VENTANA
    mostrarReporteEnVentana(reportHTML);
}

// Funci√≥n 1: Calcular inventario te√≥rico (lo que est√° registrado en el sistema)
function calcularInventarioTeorico() {
    const teorico = {};
    
    inventory.forEach(item => {
        if (item.quantity > 0 && (item.warehouse === 'fundidos' || item.warehouse === 'acabados')) {
            const modelo = extraerModelo(item.partNumber || item.code);
            
            if (!teorico[modelo]) {
                teorico[modelo] = { fundidos: 0, acabados: 0 };
            }
            
            if (item.warehouse === 'fundidos') {
                teorico[modelo].fundidos += item.quantity;
            } else if (item.warehouse === 'acabados') {
                teorico[modelo].acabados += item.quantity;
            }
        }
    });
    
    return teorico;
}

// Funci√≥n 2: Calcular inventario f√≠sico (verificaciones)
function calcularInventarioFisico() {
    const fisico = {};
    
    Object.values(physicalVerification).forEach(item => {
        const modelo = extraerModelo(item.partNumber || item.code);
        
        if (!fisico[modelo]) {
            fisico[modelo] = { fundidos: 0, acabados: 0 };
        }
        
        if (item.warehouse === 'fundidos') {
            fisico[modelo].fundidos += item.verifiedQuantity || 1;
        } else if (item.warehouse === 'acabados') {
            fisico[modelo].acabados += item.verifiedQuantity || 1;
        }
    });
    
    return fisico;
}

// Funci√≥n 3: Obtener reportes de producci√≥n
function obtenerReportesProduccion(fecha, turno) {
    return productionReports.filter(r => 
        r.fecha === fecha && r.turno === turno
    );
}

// Funci√≥n auxiliar: Extraer modelo del c√≥digo o part number
function extraerModelo(codigo) {
    if (!codigo) return 'DESCONOCIDO';
    
    // Si es un part number directo
    if (codigo.includes('PX13-10-382') || codigo.includes('382')) return 'LWR-382';
    if (codigo.includes('PEDD-10-382-A')) return 'LWR-382-A';
    if (codigo.includes('P54G-10-382')) return 'LWR-382-G';
    if (codigo.includes('PX13-10-301') || codigo.includes('301')) return 'UPR-301';
    if (codigo.includes('PEDD-10-301-A')) return 'UPR-301-A';
    if (codigo.includes('P54G-10-301-A')) return 'UPR-301-G';
    
    // Si es un c√≥digo QR, extraer el modelo
    if (codigo.length === 13) { // UPR
        const modelo = codigo.substring(10, 12);
        return `UPR-${modelo}`;
    } else if (codigo.length === 17) { // LWR
        const modelo = codigo.substring(15, 17);
        return `LWR-${modelo}`;
    }
    
    return 'OTRO';
}

// Funci√≥n 4: Generar HTML del reporte
function generarHTMLReporte(teorico, fisico, reportes, fecha, turno) {
    const fechaFormato = new Date(fecha).toLocaleDateString('es-ES');
    const horaActual = new Date().toLocaleTimeString('es-ES');
    
    // Obtener todos los modelos √∫nicos
    const todosModelos = new Set([
        ...Object.keys(teorico),
        ...Object.keys(fisico)
    ]);
    
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Reporte Te√≥rico vs F√≠sico - ${fechaFormato}</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    line-height: 1.4; 
                    background: #f5f5f5; 
                }
                .header { 
                    text-align: center; 
                    background: white;
                    padding: 20px; 
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    margin-bottom: 20px;
                }
                .company-name {
                    font-size: 24px;
                    font-weight: bold;
                    color: #e74c3c;
                    margin-bottom: 5px;
                }
                .report-title {
                    font-size: 18px;
                    color: #2c3e50;
                    margin-bottom: 10px;
                }
                .report-info {
                    font-size: 14px;
                    color: #666;
                }
                .section { 
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    margin: 20px 0; 
                }
                .section-title { 
                    font-size: 16px; 
                    font-weight: bold; 
                    color: #2c3e50; 
                    border-bottom: 2px solid #3498db;
                    padding-bottom: 5px;
                    margin-bottom: 15px;
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 15px 0;
                }
                th, td { 
                    border: 1px solid #ddd; 
                    padding: 12px 8px; 
                    text-align: center; 
                }
                th { 
                    background-color: #34495e; 
                    color: white; 
                    font-weight: bold;
                    font-size: 14px;
                }
                tr:nth-child(even) { 
                    background-color: #f8f9fa; 
                }
                .modelo-col {
                    text-align: left !important;
                    font-weight: bold;
                }
                .diferencia-ok { 
                    color: #28a745; 
                    font-weight: bold; 
                }
                .diferencia-warning { 
                    color: #ffc107; 
                    font-weight: bold; 
                }
                .diferencia-error { 
                    color: #dc3545; 
                    font-weight: bold; 
                }
                .status-ok { 
                    background: #d4edda; 
                    color: #155724; 
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                }
                .status-warning { 
                    background: #fff3cd; 
                    color: #856404; 
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                }
                .status-error { 
                    background: #f8d7da; 
                    color: #721c24; 
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 12px;
                }
                .summary-cards {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin: 20px 0;
                }
                .summary-card {
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 20px;
                    border-radius: 8px;
                    text-align: center;
                }
                .summary-number {
                    font-size: 2em;
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                .summary-label {
                    font-size: 14px;
                    opacity: 0.9;
                }
                .no-data {
                    text-align: center;
                    padding: 30px;
                    color: #6c757d;
                    font-style: italic;
                }
                @media print {
                    body { margin: 0; background: white; }
                    .section { box-shadow: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="company-name">üè≠ CONTROL DE ALMAC√âN - FUNDICI√ìN</div>
                <div class="report-title">üìä REPORTE TE√ìRICO vs F√çSICO</div>
                <div class="report-info">
                    üìÖ Fecha: ${fechaFormato} | ‚è∞ Generado: ${horaActual} | üîÑ Turno: ${turno}
                </div>
            </div>
    `;
    
    // SECCI√ìN DE RESUMEN
    const totalModelos = todosModelos.size;
    const totalVerificaciones = Object.keys(physicalVerification).length;
    const totalReportes = reportes.length;
    const diferenciasEncontradas = calcularDiferenciasEncontradas(teorico, fisico, todosModelos);
    
    html += `
        <div class="section">
            <div class="section-title">üìã RESUMEN EJECUTIVO</div>
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-number">${totalModelos}</div>
                    <div class="summary-label">Modelos Analizados</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${totalVerificaciones}</div>
                    <div class="summary-label">C√≥digos Verificados</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${totalReportes}</div>
                    <div class="summary-label">Reportes de Producci√≥n</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number">${diferenciasEncontradas}</div>
                    <div class="summary-label">Diferencias Detectadas</div>
                </div>
            </div>
        </div>
    `;
    
    // SECCI√ìN DE COMPARACI√ìN PRINCIPAL
    html += `
        <div class="section">
            <div class="section-title">üîç COMPARACI√ìN INVENTARIO TE√ìRICO vs F√çSICO</div>
    `;
    
    if (todosModelos.size === 0) {
        html += '<div class="no-data">No hay datos de inventario o verificaciones f√≠sicas para comparar</div>';
    } else {
        html += `
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">Modelo</th>
                        <th colspan="3">üî• FUNDIDOS</th>
                        <th colspan="3">‚úÖ ACABADOS</th>
                        <th rowspan="2">Estado General</th>
                    </tr>
                    <tr>
                        <th>Te√≥rico</th>
                        <th>F√≠sico</th>
                        <th>Diferencia</th>
                        <th>Te√≥rico</th>
                        <th>F√≠sico</th>
                        <th>Diferencia</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        Array.from(todosModelos).sort().forEach(modelo => {
            const teo = teorico[modelo] || { fundidos: 0, acabados: 0 };
            const fis = fisico[modelo] || { fundidos: 0, acabados: 0 };
            
            const difFund = fis.fundidos - teo.fundidos;
            const difAcab = fis.acabados - teo.acabados;
            
            const statusFund = getStatusClass(difFund);
            const statusAcab = getStatusClass(difAcab);
            const statusGeneral = getGeneralStatus(difFund, difAcab);
            
            html += `
                <tr>
                    <td class="modelo-col">${modelo}</td>
                    <td>${teo.fundidos}</td>
                    <td>${fis.fundidos}</td>
                    <td class="${statusFund.class}">${difFund >= 0 ? '+' : ''}${difFund}</td>
                    <td>${teo.acabados}</td>
                    <td>${fis.acabados}</td>
                    <td class="${statusAcab.class}">${difAcab >= 0 ? '+' : ''}${difAcab}</td>
                    <td><span class="${statusGeneral.class}">${statusGeneral.text}</span></td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
    }
    
    html += '</div>';
    
    // SECCI√ìN DE REPORTES DE PRODUCCI√ìN
    html += `
        <div class="section">
            <div class="section-title">üè≠ REPORTES DE PRODUCCI√ìN DEL TURNO</div>
    `;
    
    if (reportes.length === 0) {
        html += '<div class="no-data">No hay reportes de producci√≥n registrados para este turno</div>';
    } else {
        html += `
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Modelo</th>
                        <th>M√°quina</th>
                        <th>Total Producido</th>
                        <th>NG</th>
                        <th>Piezas Buenas</th>
                        <th>Hora Registro</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        reportes.forEach(reporte => {
            html += `
                <tr>
                    <td>${reporte.tipo.toUpperCase()}</td>
                    <td>${reporte.modelo}</td>
                    <td>${reporte.maquina || 'N/A'}</td>
                    <td>${reporte.cantidadTotal}</td>
                    <td>${reporte.cantidadNG}</td>
                    <td><strong>${reporte.piezasBuenas}</strong></td>
                    <td>${new Date(reporte.timestamp).toLocaleTimeString()}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
    }
    
    html += '</div>';
    
    // PIE DE P√ÅGINA
    html += `
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 12px;">
                Reporte generado autom√°ticamente por el Sistema de Control de Almac√©n - Fundici√≥n v1.3<br>
                üí° Diferencias dentro de ¬±2 piezas se consideran normales
            </div>
        </body>
        </html>
    `;
    
    return html;
}

// Funciones auxiliares para el reporte
function calcularDiferenciasEncontradas(teorico, fisico, modelos) {
    let diferencias = 0;
    
    modelos.forEach(modelo => {
        const teo = teorico[modelo] || { fundidos: 0, acabados: 0 };
        const fis = fisico[modelo] || { fundidos: 0, acabados: 0 };
        
        const difFund = Math.abs(fis.fundidos - teo.fundidos);
        const difAcab = Math.abs(fis.acabados - teo.acabados);
        
        if (difFund > 0 || difAcab > 0) {
            diferencias++;
        }
    });
    
    return diferencias;
}

function getStatusClass(diferencia) {
    const abs = Math.abs(diferencia);
    
    if (abs === 0) {
        return { class: 'diferencia-ok', text: '‚úÖ Perfecto' };
    } else if (abs <= 2) {
        return { class: 'diferencia-warning', text: '‚ö†Ô∏è Revisar' };
    } else {
        return { class: 'diferencia-error', text: '‚ùå Cr√≠tico' };
    }
}

function getGeneralStatus(difFund, difAcab) {
    const totalDif = Math.abs(difFund) + Math.abs(difAcab);
    
    if (totalDif === 0) {
        return { class: 'status-ok', text: '‚úÖ Perfecto' };
    } else if (totalDif <= 3) {
        return { class: 'status-warning', text: '‚ö†Ô∏è Revisar' };
    } else {
        return { class: 'status-error', text: '‚ùå Cr√≠tico' };
    }
}

// Funci√≥n 5: Mostrar reporte en nueva ventana
function mostrarReporteEnVentana(html) {
    const reportWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
    reportWindow.document.write(html);
    reportWindow.document.close();
    
    // Enfocar la nueva ventana
    reportWindow.focus();
    
    // Mostrar mensaje de √©xito
    setTimeout(() => {
        alert('üìä Reporte generado exitosamente\n\nüí° El reporte se abri√≥ en una nueva ventana.\n\nPuedes imprimirlo presionando Ctrl+P');
    }, 500);
}
// Mostrar reporte completo de producci√≥n
function showProductionReport() {
    const currentShift = document.getElementById('shift').value;
    const today = new Date().toISOString().split('T')[0];
    
    // Generar reporte completo en una nueva ventana
    const reportWindow = window.open('', '_blank');
    
    let reportContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Reporte Completo de Producci√≥n</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
                .header { text-align: center; border-bottom: 2px solid #e74c3c; padding-bottom: 20px; margin-bottom: 30px; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #34495e; color: white; }
                .section { margin: 25px 0; page-break-inside: avoid; }
                .alert { padding: 15px; margin: 15px 0; border-radius: 5px; }
                .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üè≠ REPORTE COMPLETO DE PRODUCCI√ìN</h1>
                <p>üìÖ Fecha: ${today} | ‚è∞ Turno: ${currentShift} | üïê Generado: ${new Date().toLocaleString()}</p>
            </div>
            
            <div class="section">
                <h2>üìä Reportes de Producci√≥n Registrados</h2>
    `;
    
    // Agregar reportes de producci√≥n
    const currentReports = productionReports.filter(r => r.fecha === today && r.turno === currentShift);
    if (currentReports.length > 0) {
        reportContent += `
            <table>
                <thead>
                    <tr><th>Tipo</th><th>Modelo</th><th>M√°quina</th><th>Molde</th><th>Total</th><th>NG</th><th>Buenas</th><th>Hora</th></tr>
                </thead>
                <tbody>
        `;
        currentReports.forEach(r => {
            reportContent += `
                <tr>
                    <td>${r.tipo.toUpperCase()}</td>
                    <td>${r.modelo}</td>
                    <td>${r.maquina || 'N/A'}</td>
                    <td>${r.molde || 'N/A'}</td>
                    <td>${r.cantidadTotal}</td>
                    <td>${r.cantidadNG}</td>
                    <td><strong>${r.piezasBuenas}</strong></td>
                    <td>${r.timestamp.toLocaleTimeString()}</td>
                </tr>
            `;
        });
        reportContent += '</tbody></table>';
    } else {
        reportContent += '<div class="alert alert-info">No hay reportes de producci√≥n registrados.</div>';
    }
    
    reportContent += `
            </div>
            
            <div class="section">
                <h2>üì¶ Movimientos de Material</h2>
    `;
    
    // Agregar movimientos
    const currentMovements = movementReports.filter(m => m.fecha === today);
    if (currentMovements.length > 0) {
        reportContent += `
            <table>
                <thead>
                    <tr><th>Tipo</th><th>Modelo</th><th>Cantidad</th><th>Comentarios</th><th>Hora</th></tr>
                </thead>
                <tbody>
        `;
        currentMovements.forEach(m => {
            reportContent += `
                <tr>
                    <td>${m.tipo.toUpperCase()}</td>
                    <td>${m.modelo}</td>
                    <td>${m.cantidad}</td>
                    <td>${m.comentarios || 'Sin comentarios'}</td>
                    <td>${m.timestamp.toLocaleTimeString()}</td>
                </tr>
            `;
        });
        reportContent += '</tbody></table>';
    } else {
        reportContent += '<div class="alert alert-info">No hay movimientos registrados.</div>';
    }
    
    reportContent += `
            </div>
        </body>
        </html>
    `;
    
    reportWindow.document.write(reportContent);
    reportWindow.document.close();
    reportWindow.print();
}
    // Validar archivo PDF
function validatePDF(inputId) {
    const fileInput = document.getElementById(inputId);
    const file = fileInput.files[0];
    
    if (file) {
        // Verificar que sea PDF
        if (file.type !== 'application/pdf') {
            alert('‚ö†Ô∏è Solo se permiten archivos PDF.');
            fileInput.value = '';
            return false;
        }
        
        // Verificar tama√±o (5MB m√°ximo)
        const maxSize = 5 * 1024 * 1024; // 5MB en bytes
        if (file.size > maxSize) {
            alert('‚ö†Ô∏è El archivo es demasiado grande. M√°ximo permitido: 5MB.');
            fileInput.value = '';
            return false;
        }
        
        // Mostrar confirmaci√≥n
        const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
        console.log(`‚úÖ Archivo v√°lido: ${file.name} (${sizeInMB}MB)`);
        return true;
    }
    return true;
}

// Convertir archivo a Base64 para almacenamiento
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Funci√≥n auxiliar para obtener archivo de evidencia
async function getEvidenceFile(inputId) {
    const fileInput = document.getElementById(inputId);
    const file = fileInput.files[0];
    
    if (file && validatePDF(inputId)) {
        try {
            const base64 = await fileToBase64(file);
            return {
                nombre: file.name,
                tama√±o: file.size,
                fecha: new Date().toISOString(),
                contenido: base64
            };
        } catch (error) {
            console.error('Error al procesar archivo:', error);
            alert('‚ùå Error al procesar el archivo. Intenta de nuevo.');
            return null;
        }
    }
    return null;
}
    // Variables globales para gesti√≥n de archivos
let currentFiles = {};
let fileHistories = {};

// Manejar selecci√≥n de archivo
async function handleFileSelection(inputId) {
    const fileInput = document.getElementById(inputId);
    const file = fileInput.files[0];
    const statusDiv = document.getElementById(inputId + '-status');
    const actionsDiv = document.getElementById(inputId + '-actions');
    
    if (file && validatePDF(inputId)) {
        try {
            // Mostrar estado de carga
            statusDiv.innerHTML = '<span class="file-info">‚è≥ Procesando archivo...</span>';
            
            const fileData = await fileToBase64(file);
            const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
            
            // Crear objeto de archivo con metadatos
            const fileObject = {
                nombre: file.name,
                tama√±o: file.size,
                fechaSubida: new Date().toISOString(),
                contenido: fileData,
                version: getNextVersion(inputId)
            };
            
            // Guardar en historial
            saveFileToHistory(inputId, fileObject);
            
            // Guardar archivo actual
            currentFiles[inputId] = fileObject;
            
            // Actualizar interfaz
            statusDiv.innerHTML = `<span class="file-success">‚úÖ ${file.name} (${sizeInMB}MB) - v${fileObject.version}</span>`;
            actionsDiv.style.display = 'block';
            
        } catch (error) {
            console.error('Error al procesar archivo:', error);
            statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Error al procesar archivo</span>';
            fileInput.value = '';
        }
    } else if (file) {
        statusDiv.innerHTML = '<span style="color: #dc3545;">‚ùå Archivo inv√°lido</span>';
        fileInput.value = '';
    }
}

// Obtener siguiente versi√≥n
function getNextVersion(inputId) {
    if (!fileHistories[inputId]) {
        fileHistories[inputId] = [];
    }
    return fileHistories[inputId].length + 1;
}

// Guardar archivo en historial
function saveFileToHistory(inputId, fileObject) {
    if (!fileHistories[inputId]) {
        fileHistories[inputId] = [];
    }
    
    fileHistories[inputId].push({
        ...fileObject,
        accion: fileHistories[inputId].length === 0 ? 'Carga inicial' : 'Reemplazo',
        fechaAccion: new Date().toISOString()
    });
}

// Reemplazar archivo
function replaceFile(inputId) {
    if (confirm('¬øEst√°s seguro de que quieres reemplazar el archivo actual?')) {
        const fileInput = document.getElementById(inputId);
        fileInput.click();
    }
}

// Eliminar archivo
function removeFile(inputId) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar el archivo actual?')) {
        const fileInput = document.getElementById(inputId);
        const statusDiv = document.getElementById(inputId + '-status');
        const actionsDiv = document.getElementById(inputId + '-actions');
        
        // Guardar eliminaci√≥n en historial
        if (currentFiles[inputId]) {
            if (!fileHistories[inputId]) {
                fileHistories[inputId] = [];
            }
            
            fileHistories[inputId].push({
                nombre: currentFiles[inputId].nombre,
                accion: 'Eliminaci√≥n',
                fechaAccion: new Date().toISOString(),
                eliminadoPor: 'Usuario'
            });
        }
        
        // Limpiar archivo actual
        currentFiles[inputId] = null;
        fileInput.value = '';
        
        // Resetear interfaz
        statusDiv.innerHTML = '<span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>';
        actionsDiv.style.display = 'none';
        
        alert('‚úÖ Archivo eliminado correctamente.');
    }
}

// Ver historial de archivos
function viewFileHistory(inputId) {
    const history = fileHistories[inputId] || [];
    
    if (history.length === 0) {
        alert('üìã No hay historial de archivos para este campo.');
        return;
    }
    
    let modalHtml = `
        <div class="file-history-modal" id="historyModal">
            <div class="file-history-content">
                <button class="file-history-close" onclick="closeFileHistory()">√ó</button>
                <h3>üìã Historial de Archivos</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="border: 1px solid #ddd; padding: 8px;">Versi√≥n</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Archivo</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Acci√≥n</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Fecha</th>
                            <th style="border: 1px solid #ddd; padding: 8px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    history.forEach((item, index) => {
        const isDeleted = item.accion === 'Eliminaci√≥n';
        const rowStyle = isDeleted ? 'background: #f8d7da;' : '';
        const fecha = new Date(item.fechaAccion).toLocaleString();
        const tama√±o = item.tama√±o ? `(${(item.tama√±o / 1024 / 1024).toFixed(2)}MB)` : '';
        
        modalHtml += `
            <tr style="${rowStyle}">
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">v${item.version || index + 1}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${item.nombre} ${tama√±o}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">
                    ${item.accion === 'Carga inicial' ? 'üìÅ' : item.accion === 'Reemplazo' ? 'üîÑ' : 'üóëÔ∏è'} 
                    ${item.accion}
                </td>
                <td style="border: 1px solid #ddd; padding: 8px; font-size: 0.9em;">${fecha}</td>
                <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">
                    ${!isDeleted && item.contenido ? 
                        `<button onclick="downloadFile('${inputId}', ${index})" class="btn btn-sm" style="background: #007bff; color: white; border: none; padding: 3px 8px; border-radius: 3px;">üì• Descargar</button>` : 
                        '‚Äî'
                    }
                </td>
            </tr>
        `;
    });
    
    modalHtml += `
                    </tbody>
                </table>
                <div style="text-align: right; margin-top: 15px;">
                    <button onclick="closeFileHistory()" class="btn" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px;">Cerrar</button>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Cerrar modal de historial
function closeFileHistory() {
    const modal = document.getElementById('historyModal');
    if (modal) {
        modal.remove();
    }
}

// Descargar archivo del historial
function downloadFile(inputId, historyIndex) {
    const history = fileHistories[inputId];
    if (history && history[historyIndex] && history[historyIndex].contenido) {
        const fileData = history[historyIndex];
        
        // Crear enlace de descarga
        const link = document.createElement('a');
        link.href = fileData.contenido;
        link.download = fileData.nombre;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert(`üì• Descargando ${fileData.nombre}`);
    } else {
        alert('‚ùå No se puede descargar el archivo. Datos no disponibles.');
    }
}

// Obtener archivo actual (actualizada)
async function getEvidenceFile(inputId) {
    return currentFiles[inputId] || null;
}

// Limpiar archivos al resetear formulario
function clearFormFiles(formId) {
    const form = document.getElementById(formId);
    const inputs = form.querySelectorAll('input[type="file"]');
    
    inputs.forEach(input => {
        const inputId = input.id;
        currentFiles[inputId] = null;
        
        const statusDiv = document.getElementById(inputId + '-status');
        const actionsDiv = document.getElementById(inputId + '-actions');
        
        if (statusDiv) {
            statusDiv.innerHTML = '<span class="file-placeholder">üìé Haz clic para seleccionar PDF (m√°x. 5MB)</span>';
        }
        if (actionsDiv) {
            actionsDiv.style.display = 'none';
        }
    });
}
async function showEvidenceInfo(reportId) {
    const reporte = productionReports.find(r => r.id == reportId) || 
                   movementReports.find(m => m.id == reportId);
    
    if (reporte && reporte.evidencia) {
    let evidencia = reporte.evidencia;
    
    // Cargar evidencia por separado si es necesario
    if (evidencia.hasEvidence && evidencia.evidenceId) {
        try {
            const evidenciaData = await loadFromFirebase(`evidencia_${evidencia.evidenceId}`);
            if (evidenciaData) {
                evidencia = JSON.parse(evidenciaData);
            }
        } catch (error) {
            console.error('Error cargando evidencia:', error);
            alert('‚ùå Error cargando evidencia');
            return;
        }
    }
    
    if (evidencia.contenido) {
        
        if (confirm(`üìÑ Evidencia Adjunta:\n\n‚Ä¢ Archivo: ${evidencia.nombre}\n‚Ä¢ Tama√±o: ${sizeInMB}MB\n‚Ä¢ Subido: ${fecha}\n‚Ä¢ Versi√≥n: v${evidencia.version || 1}\n\n¬øDeseas descargar el archivo?`)) {
            const link = document.createElement('a');
            link.href = evidencia.contenido;
            link.download = evidencia.nombre;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    } else {
        alert('‚ùå No hay evidencia disponible para este reporte.');
    }
}
}
// Variables para la c√°mara
let qrScanner = null;
let currentCamera = 'environment'; // 'environment' = c√°mara trasera, 'user' = frontal

// Inicializar c√°mara
async function startCamera() {
    // L√≠nea temporal para debug
    if (typeof QrScanner === 'undefined') {
        alert('‚ùå La librer√≠a QR Scanner no se carg√≥ correctamente');
        return;
    }
    try {
        const videoElement = document.getElementById('camera-video');
        const containerElement = document.getElementById('camera-container');
        const statusElement = document.getElementById('camera-status');
        
        // Mostrar contenedor
        containerElement.style.display = 'block';
        statusElement.textContent = 'üì∑ Iniciando c√°mara...';
        
        // Crear scanner
        qrScanner = new QrScanner(
            videoElement,
            result => handleQRScan(result.data),
            {
                returnDetailedScanResult: true,
                highlightScanRegion: true,
                highlightCodeOutline: true,
                preferredCamera: currentCamera
            }
        );
        
        // Iniciar scanner
        await qrScanner.start();
        
        // Actualizar interfaz
        document.getElementById('start-camera-btn').style.display = 'none';
        document.getElementById('stop-camera-btn').style.display = 'inline-block';
        document.getElementById('switch-camera-btn').style.display = 'inline-block';
        statusElement.textContent = 'üì∑ C√°mara activa - Posiciona el c√≥digo QR en el recuadro';
        
    } catch (error) {
        console.error('Error al iniciar c√°mara:', error);
        alert('‚ùå Error al acceder a la c√°mara.\n\nVerifica que:\n‚Ä¢ Hayas dado permisos de c√°mara\n‚Ä¢ Est√©s usando HTTPS\n‚Ä¢ Tu dispositivo tenga c√°mara disponible');
        document.getElementById('camera-container').style.display = 'none';
    }
}

// Detener c√°mara
function stopCamera() {
    if (qrScanner) {
        qrScanner.stop();
        qrScanner.destroy();
        qrScanner = null;
    }
    
    // Actualizar interfaz
    document.getElementById('camera-container').style.display = 'none';
    document.getElementById('start-camera-btn').style.display = 'inline-block';
    document.getElementById('stop-camera-btn').style.display = 'none';
    document.getElementById('switch-camera-btn').style.display = 'none';
}

// Cambiar entre c√°mara frontal y trasera
async function switchCamera() {
    if (!qrScanner) return;
    
    try {
        currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
        await qrScanner.setCamera(currentCamera);
        
        const statusElement = document.getElementById('camera-status');
        statusElement.textContent = `üì∑ C√°mara ${currentCamera === 'environment' ? 'trasera' : 'frontal'} activa`;
        
    } catch (error) {
        console.error('Error al cambiar c√°mara:', error);
        alert('‚ùå No se pudo cambiar de c√°mara. Es posible que tu dispositivo solo tenga una c√°mara disponible.');
    }
}

// Manejar c√≥digo QR escaneado
function handleQRScan(qrData) {
    if (qrData && qrData.trim().length > 0) {
        // Colocar c√≥digo en el textarea
        document.getElementById('qr-input').value = qrData.trim();
        
        // Analizar c√≥digo autom√°ticamente
        analyzeQRCode();
        
        // Mostrar feedback visual
        const statusElement = document.getElementById('camera-status');
        statusElement.style.background = '#d4edda';
        statusElement.style.color = '#155724';
        statusElement.textContent = '‚úÖ ¬°C√≥digo QR detectado!';
        
        // Detener c√°mara autom√°ticamente despu√©s de 2 segundos
        setTimeout(() => {
            stopCamera();
        }, 2000);
        
        // Enfocar en el bot√≥n de procesar
        setTimeout(() => {
            document.querySelector('button[onclick="processQRCode()"]').focus();
        }, 2500);
    }
}

// Verificar disponibilidad de c√°mara al cargar
async function checkCameraAvailability() {
    try {
        const hasCamera = await QrScanner.hasCamera();
        if (!hasCamera) {
            document.getElementById('start-camera-btn').style.display = 'none';
            document.querySelector('.camera-controls').innerHTML = 
                '<div style="color: #6c757d; font-style: italic;">üìµ No se detect√≥ c√°mara en este dispositivo</div>';
        }
    } catch (error) {
        console.error('Error verificando c√°mara:', error);
    }
}
// Funciones de navegaci√≥n entre modos
function showScannerMode() {
    document.getElementById('scanner-mode').style.display = 'block';
    document.getElementById('generator-mode').style.display = 'none';
    document.getElementById('qr-result').style.display = 'none';
    
    // Actualizar botones
    document.getElementById('mode-scanner').classList.add('selected');
    document.getElementById('mode-generator').classList.remove('selected');
    
    // Detener c√°mara del generador si est√° activa
    stopGeneratorCamera();
}

function showGeneratorMode() {
    document.getElementById('scanner-mode').style.display = 'none';
    document.getElementById('generator-mode').style.display = 'block';
    document.getElementById('qr-result').style.display = 'none';
    
    // Actualizar botones
    document.getElementById('mode-generator').classList.add('selected');
    document.getElementById('mode-scanner').classList.remove('selected');
    
    // Detener c√°mara del scanner si est√° activa
    stopCamera();
}

// C√°mara para el generador
async function startGeneratorCamera() {
    try {
        const videoElement = document.getElementById('gen-camera-video');
        const containerElement = document.getElementById('gen-camera-container');
        const statusElement = document.getElementById('gen-camera-status');
        
        containerElement.style.display = 'block';
        statusElement.textContent = 'üì∑ Iniciando c√°mara para c√≥digos individuales...';
        
        generatorScanner = new QrScanner(
            videoElement,
            result => handleGeneratorScan(result.data),
            {
                returnDetailedScanResult: true,
                highlightScanRegion: true,
                highlightCodeOutline: true,
                preferredCamera: 'environment'
            }
        );
        
        await generatorScanner.start();
        
        document.getElementById('gen-start-camera-btn').style.display = 'none';
        document.getElementById('gen-stop-camera-btn').style.display = 'inline-block';
        statusElement.textContent = 'üì∑ Escanea c√≥digos individuales - Se agregar√°n autom√°ticamente';
        
    } catch (error) {
        console.error('Error al iniciar c√°mara del generador:', error);
        alert('‚ùå Error al acceder a la c√°mara.\n\nVerifica los permisos de c√°mara.');
        document.getElementById('gen-camera-container').style.display = 'none';
    }
}

function stopGeneratorCamera() {
    if (generatorScanner) {
        generatorScanner.stop();
        generatorScanner.destroy();
        generatorScanner = null;
    }
    
    document.getElementById('gen-camera-container').style.display = 'none';
    document.getElementById('gen-start-camera-btn').style.display = 'inline-block';
    document.getElementById('gen-stop-camera-btn').style.display = 'none';
}

// Manejar c√≥digo escaneado en el generador
function handleGeneratorScan(qrData) {
    if (qrData && qrData.trim().length > 0) {
        const code = qrData.trim();
        
        // Verificar si es un c√≥digo individual v√°lido (no tarima)
        if (code.includes('|')) {
            showTemporaryMessage('‚ö†Ô∏è Este es un c√≥digo de tarima, no individual', 'warning');
            return;
        }
        
        // Agregar c√≥digo a la lista
        addCodeToList(code);
	// üÜï AGREGAR ESTAS L√çNEAS:
        // Scroll adicional para c√°mara (m√°s tiempo para que se vea el efecto)
        setTimeout(() => {
            const listDiv = document.getElementById('codes-validation-list');
            if (listDiv) {
                listDiv.scrollTo({
                    top: listDiv.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }, 300);
        
        // Feedback visual
        const statusElement = document.getElementById('gen-camera-status');
        statusElement.style.background = '#d4edda';
        statusElement.style.color = '#155724';
        statusElement.textContent = '‚úÖ C√≥digo agregado: ' + code.substring(0, 10) + '...';
        
        // Resetear status despu√©s de 2 segundos
        setTimeout(() => {
            if (generatorScanner) {
                statusElement.style.background = '#e3f2fd';
                statusElement.style.color = '#0c5460';
                statusElement.textContent = 'üì∑ Escanea c√≥digos individuales - Se agregar√°n autom√°ticamente';
            }
        }, 2000);
    }
}

// Agregar c√≥digo a la lista
function addCodeToList(code) {
    const cleanCode = code.trim();
    if (!cleanCode) return;
    
    console.log('Intentando agregar c√≥digo:', cleanCode); // DEBUG
    
    // Verificar si ya existe
    const exists = generatedCodes.some(item => item.code === cleanCode);
    if (exists) {
        duplicateAttempts++;
        console.log('Duplicado detectado. Total duplicados:', duplicateAttempts); // DEBUG
        showTemporaryMessage('‚ö†Ô∏è C√≥digo duplicado omitido: ' + cleanCode, 'warning');
        updateValidationInfo(); // CR√çTICO: Actualizar info inmediatamente
        return;
    }
    
    // Validar formato del c√≥digo
    const isValid = (cleanCode.length === 13 || cleanCode.length === 17);
    const type = cleanCode.length === 13 ? 'UPR' : cleanCode.length === 17 ? 'LWR' : 'UNKNOWN';
    
    // Agregar a la lista
    generatedCodes.push({
        code: cleanCode,
        type: type,
        valid: isValid,
        timestamp: new Date()
    });
    
    console.log('C√≥digo agregado. Total c√≥digos:', generatedCodes.length); // DEBUG
    
    // Actualizar TODOS los elementos
    updateCodesTextarea();
    updateCodesValidationList();
    updateValidationInfo(); // CR√çTICO: Actualizar siempre
    updateGenerateButton();
	    // üÜï AGREGAR ESTAS L√çNEAS:
    // Scroll suave hacia el √∫ltimo elemento agregado
    setTimeout(() => {
        const listDiv = document.getElementById('codes-validation-list');
        if (listDiv) {
            listDiv.scrollTo({
                top: listDiv.scrollHeight,
                behavior: 'smooth'
            });
        }
    }, 200);
}
// Actualizar textarea con c√≥digos
function updateCodesTextarea() {
    const textarea = document.getElementById('gen-codigos');
    textarea.value = generatedCodes.map(item => item.code).join('\n');
}

// Actualizar lista visual de validaci√≥n
function updateCodesValidationList() {
    const listDiv = document.getElementById('codes-validation-list');
    
    if (generatedCodes.length === 0) {
        listDiv.innerHTML = '<p style="color: #6c757d; font-style: italic;">Los c√≥digos aparecer√°n aqu√≠ conforme los agregues...</p>';
        return;
    }
    
    let html = '<div class="codes-list">';
    generatedCodes.forEach((item, index) => {
        const className = item.valid ? 'code-valid' : 'code-invalid';
        const icon = item.valid ? '‚úÖ' : '‚ùå';
        const typeLabel = item.type !== 'UNKNOWN' ? `[${item.type}]` : '[INV√ÅLIDO]';
        
        html += `
            <div class="code-item ${className}">
                <span>${icon} ${typeLabel} ${item.code}</span>
                <button onclick="removeCode(${index})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
            </div>
        `;
    });
    html += '</div>';
    
    listDiv.innerHTML = html;
 // üÜï AGREGAR ESTAS L√çNEAS AL FINAL:
    // Scroll autom√°tico hacia abajo
    setTimeout(() => {
        if (listDiv && listDiv.scrollHeight > listDiv.clientHeight) {
            listDiv.scrollTop = listDiv.scrollHeight;
        }
    }, 150);
}

// Actualizar informaci√≥n de validaci√≥n
function updateValidationInfo() {
    console.log('updateValidationInfo llamada. duplicateAttempts:', duplicateAttempts); // DEBUG
    
    const infoDiv = document.getElementById('gen-validation-info');
    const countSpan = document.getElementById('codes-count');
    const duplicatesSpan = document.getElementById('duplicates-count');
    const invalidSpan = document.getElementById('invalid-count');
    
    if (!infoDiv || !countSpan || !duplicatesSpan || !invalidSpan) {
        console.log('Elementos de validaci√≥n no encontrados'); // DEBUG
        return;
    }
    
    const totalCodes = generatedCodes.length;
    const invalidCodes = generatedCodes.filter(item => !item.valid).length;
    
    console.log('Stats:', { totalCodes, duplicateAttempts, invalidCodes }); // DEBUG
    
    if (totalCodes > 0 || duplicateAttempts > 0) {
        infoDiv.style.display = 'block';
        countSpan.textContent = totalCodes;
        duplicatesSpan.textContent = duplicateAttempts;
        invalidSpan.textContent = invalidCodes;
        
        // Mostrar mensaje si hay duplicados
        if (duplicateAttempts > 0) {
            console.log('Mostrando mensaje de duplicados'); // DEBUG
            showTemporaryMessage(`‚ö†Ô∏è Se encontraron ${duplicateAttempts} c√≥digos duplicados`, 'warning');
        }
    } else {
        infoDiv.style.display = 'none';
    }
}
// Pegar c√≥digos desde portapapeles
async function pasteCodesFromClipboard() {
    try {
        const text = await navigator.clipboard.readText();
        const lines = text.split('\n').filter(line => line.trim().length > 0);
        
        let addedCount = 0;
        let duplicatesInThisPaste = 0;
        
        lines.forEach(line => {
            const code = line.trim();
            if (code) {
                const existsBefore = generatedCodes.some(item => item.code === code);
                if (!existsBefore) {
                    // Validar formato del c√≥digo
                    const isValid = (code.length === 13 || code.length === 17);
                    const type = code.length === 13 ? 'UPR' : code.length === 17 ? 'LWR' : 'UNKNOWN';
                    
                    // Agregar directamente sin llamar addCodeToList para evitar mensajes m√∫ltiples
                    generatedCodes.push({
                        code: code,
                        type: type,
                        valid: isValid,
                        timestamp: new Date()
                    });
                    addedCount++;
                } else {
                    duplicatesInThisPaste++;
                    duplicateAttempts++; // Incrementar contador global
                    console.log('Duplicado en paste:', code);
                }
            }
        });
        
        // Actualizar TODO una sola vez al final
        updateCodesTextarea();
        updateCodesValidationList();
        updateValidationInfo(); // CR√çTICO: Actualizar contadores
        updateGenerateButton();
       
if (addedCount > 0) {
    showTemporaryMessage(`‚úÖ ${addedCount} c√≥digos agregados desde portapapeles`, 'success');
}

if (duplicateAttempts > 0) {
    showTemporaryMessage(`‚ö†Ô∏è Se omitieron ${duplicateAttempts} c√≥digos duplicados`, 'warning');
}

if (addedCount === 0 && duplicateAttempts === 0) {
    showTemporaryMessage('‚ÑπÔ∏è No se encontraron c√≥digos v√°lidos para agregar', 'info');
}
        
    } catch (error) {
        console.error('Error al leer portapapeles:', error);
        
        // M√©todo alternativo: pedir al usuario que pegue manualmente
        const codes = prompt('Pega los c√≥digos aqu√≠ (uno por l√≠nea):');
        if (codes) {
            const lines = codes.split('\n').filter(line => line.trim().length > 0);
            lines.forEach(line => addCodeToList(line.trim()));
            showTemporaryMessage(`‚úÖ C√≥digos procesados manualmente`, 'success');
        }
    }
}

// Limpiar todos los c√≥digos
function clearAllCodes() {
    if (generatedCodes.length === 0) {
        showTemporaryMessage('‚ÑπÔ∏è No hay c√≥digos para limpiar', 'info');
        return;
    }
    
    if (confirm(`¬øEliminar todos los ${generatedCodes.length} c√≥digos de la lista?`)) {
        generatedCodes = [];
        duplicateAttempts = 0;
        updateCodesTextarea();
        updateCodesValidationList();
        updateValidationInfo();
        updateGenerateButton();
        showTemporaryMessage('üóëÔ∏è Todos los c√≥digos eliminados', 'info');
    }
}

// Generar c√≥digo QR de tarima
function generatePalletQR() {
    console.log('üîç generatePalletQR iniciada'); // üÜï AGREGAR
	
    const zona = document.getElementById('gen-zona').value.trim();
    const tipo = document.getElementById('gen-tipo').value;
    const validCodes = generatedCodes.filter(item => item.valid);
	
    console.log('üìä Datos:', { zona, tipo, validCodes: validCodes.length }); // üÜï AGREGAR
    
    if (!zona || !tipo || validCodes.length === 0) {
        alert('‚ö†Ô∏è Completa todos los campos:\n‚Ä¢ Zona/ID de tarima\n‚Ä¢ Tipo de material\n‚Ä¢ Al menos un c√≥digo v√°lido');
        return;
    }
    
    // Crear texto del QR en formato: zona|tipo|codigo1|codigo2|...
    const codesText = validCodes.map(item => item.code).join('|');
    const qrText = `${zona}|${tipo}|${codesText}`;
    
    // Mostrar resultado
    showQRResult(zona, tipo, validCodes, qrText);
    
    // Agregar al historial
    palletHistory.push({
        id: generatePalletId(),
        zona: zona,
        tipo: tipo,
        codes: validCodes.map(item => item.code),
        qrText: qrText,
        timestamp: new Date(),
        codesCount: validCodes.length
    });
    
 // Solo limpiar c√≥digos, mantener zona y tipo para posibles regeneraciones
generatedCodes = [];
duplicateAttempts = 0;
document.getElementById('gen-codigos').value = '';
updateCodesValidationList();
updateValidationInfo();
// NO llamar updateGenerateButton() aqu√≠ para mantener el bot√≥n habilitado
}
// Mostrar resultado del QR generado
function showQRResult(zona, tipo, codes, qrText) {
    console.log('üéØ showQRResult iniciada con:', { zona, tipo, codesLength: codes.length, qrTextLength: qrText.length }); // üÜï AGREGAR
    
    const resultDiv = document.getElementById('qr-result');
    const infoDiv = document.getElementById('qr-info');
    const displayDiv = document.getElementById('qr-display');
    const textArea = document.getElementById('qr-text');
    
    console.log('Elementos encontrados:', { resultDiv, infoDiv, displayDiv, textArea }); // DEBUG
    
    // Informaci√≥n de la tarima
    infoDiv.innerHTML = `
        <p><strong>üè≠ Zona/ID:</strong> ${zona}</p>
        <p><strong>üì¶ Tipo:</strong> ${tipo}</p>
        <p><strong>üìä Total c√≥digos:</strong> ${codes.length}</p>
        <p><strong>üî∫ UPR:</strong> ${codes.filter(c => c.type === 'UPR').length}</p>
        <p><strong>üîª LWR:</strong> ${codes.filter(c => c.type === 'LWR').length}</p>
        <p><strong>üìÖ Generado:</strong> ${new Date().toLocaleString()}</p>
    `;
    
    // Generar imagen QR usando una API p√∫blica
    const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrText)}&size=300x300&format=png&ecc=M`;
    
    displayDiv.innerHTML = `
        <div class="qr-display-container">
            <img src="${qrImageUrl}" alt="C√≥digo QR de Tarima" style="max-width: 300px; height: auto;" id="qr-image">
        </div>
    `;
    
    // Texto del QR
    textArea.value = qrText;
    
    // MOSTRAR RESULTADO - L√çNEA CR√çTICA
    resultDiv.style.display = 'block';
    resultDiv.style.visibility = 'visible';
    resultDiv.style.opacity = '1';
    resultDiv.style.position = 'relative';
    resultDiv.style.zIndex = '10';
    console.log('QR result div mostrado:', resultDiv.style.display); // DEBUG
    
    // Hacer scroll hacia el resultado
    setTimeout(() => {
        resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        console.log('Scroll ejecutado'); // DEBUG
    }, 300);
    
    // Guardar datos para descarga
    window.currentQRData = {
        zona: zona,
        tipo: tipo,
        codes: codes,
        qrText: qrText,
        imageUrl: qrImageUrl
    };
    
    showTemporaryMessage('‚úÖ C√≥digo QR de tarima generado exitosamente', 'success');
}
// Descargar imagen QR
async function downloadQRImage() {
    if (!window.currentQRData) {
        alert('‚ùå No hay c√≥digo QR para descargar');
        return;
    }
    
    try {
        const response = await fetch(window.currentQRData.imageUrl);
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `QR_${window.currentQRData.zona}_${window.currentQRData.tipo}_${new Date().toISOString().split('T')[0]}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showTemporaryMessage('üì• Imagen QR descargada exitosamente', 'success');
        
    } catch (error) {
        console.error('Error al descargar imagen:', error);
        alert('‚ùå Error al descargar la imagen. Intenta hacer clic derecho en la imagen y "Guardar como..."');
    }
}

// Copiar texto del QR
async function copyQRText() {
    if (!window.currentQRData) {
        alert('‚ùå No hay c√≥digo QR para copiar');
        return;
    }
    
    try {
        await navigator.clipboard.writeText(window.currentQRData.qrText);
        showTemporaryMessage('üìã Texto del QR copiado al portapapeles', 'success');
    } catch (error) {
        // M√©todo alternativo
        const textArea = document.getElementById('qr-text');
        textArea.select();
        document.execCommand('copy');
        showTemporaryMessage('üìã Texto copiado (m√©todo alternativo)', 'success');
    }
}

// Imprimir QR
function printQR() {
    if (!window.currentQRData) {
        alert('‚ùå No hay c√≥digo QR para imprimir');
        return;
    }
    
    const printWindow = window.open('', '_blank');
    const data = window.currentQRData;
    
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>C√≥digo QR - Tarima ${data.zona}</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
                .header { margin-bottom: 20px; }
                .qr-container { margin: 20px 0; }
                .info { text-align: left; margin: 20px auto; max-width: 400px; }
                .codes-list { font-family: monospace; font-size: 12px; text-align: left; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üè≠ C√ìDIGO QR - TARIMA</h1>
                <h2>Zona: ${data.zona} | Tipo: ${data.tipo}</h2>
            </div>
            
            <div class="qr-container">
                <img src="${data.imageUrl}" alt="C√≥digo QR" style="max-width: 300px;">
            </div>
            
            <div class="info">
                <p><strong>üìÖ Fecha:</strong> ${new Date().toLocaleString()}</p>
                <p><strong>üìä Total c√≥digos:</strong> ${data.codes.length}</p>
                <p><strong>üî∫ UPR:</strong> ${data.codes.filter(c => c.type === 'UPR').length}</p>
                <p><strong>üîª LWR:</strong> ${data.codes.filter(c => c.type === 'LWR').length}</p>
            </div>
            
            <div class="codes-list">
                <h3>üìã C√≥digos incluidos:</h3>
                ${data.codes.map((c, i) => `<p>${i + 1}. [${c.type}] ${c.code}</p>`).join('')}
            </div>
            
            <p style="margin-top: 30px; font-size: 12px; color: #666;">
                Generado por Sistema de Control de Almac√©n - Fundici√≥n v1.3
            </p>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    
    // Peque√±o delay para asegurar que la imagen se cargue antes de imprimir
    setTimeout(() => {
        printWindow.print();
    }, 1000);
    
    showTemporaryMessage('üñ®Ô∏è Enviando a imprimir...', 'info');
}

// Limpiar formulario del generador
function clearGeneratorForm() {
    document.getElementById('gen-zona').value = '';
    document.getElementById('gen-tipo').value = '';
    document.getElementById('gen-codigos').value = '';
    generatedCodes = [];
    duplicateAttempts = 0;
    updateCodesValidationList();
    updateValidationInfo();
    updateGenerateButton();
    
    // Ocultar resultado si est√° visible
    // document.getElementById('qr-result').style.display = 'none'; // 
    // document.getElementById('generator-mode').style.display = 'block'; //
}

// Funci√≥n para mostrar mensajes temporales
function showTemporaryMessage(message, type = 'info') {
    const resultDiv = document.getElementById('process-result');
    
    const alertClass = type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert' : 
                     'alert-info';
    
    resultDiv.innerHTML = `<div class="${alertClass}">${message}</div>`;
    
    setTimeout(() => {
        resultDiv.innerHTML = '';
    }, 4000);
}
       // Mostrar modo scanner por defecto
    showScannerMode();
       // Actualizar estado del bot√≥n generar
function updateGenerateButton() {
    const button = document.getElementById('generate-qr-btn');
    if (!button) {
        console.log('Bot√≥n generate-qr-btn no encontrado'); // DEBUG
        return;
    }
    
    const zona = document.getElementById('gen-zona').value.trim();
    const tipo = document.getElementById('gen-tipo').value;
    const validCodes = generatedCodes.filter(item => item.valid).length;
    
    console.log('updateGenerateButton - zona:', zona, 'tipo:', tipo, 'validCodes:', validCodes); // DEBUG
    
    if (zona && tipo && validCodes > 0) {
        button.disabled = false;
        button.textContent = `üè∑Ô∏è Generar QR de Tarima (${validCodes} c√≥digos)`;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
        console.log('Bot√≥n habilitado'); // DEBUG
    } else {
        button.disabled = true;
        button.textContent = 'üè∑Ô∏è Generar C√≥digo QR de Tarima';
        button.style.opacity = '0.6';
        button.style.cursor = 'not-allowed';
        console.log('Bot√≥n deshabilitado - falta:', !zona ? 'zona' : !tipo ? 'tipo' : 'c√≥digos v√°lidos'); // DEBUG
    }
}
       // Actualizar textarea con c√≥digos
function updateCodesTextarea() {
    const textarea = document.getElementById('gen-codigos');
    if (textarea) {
        textarea.value = generatedCodes.map(item => item.code).join('\n');
    }
}
       // Actualizar lista visual de validaci√≥n
function updateCodesValidationList() {
    const listDiv = document.getElementById('codes-validation-list');
    if (!listDiv) return;
    
    if (generatedCodes.length === 0) {
        listDiv.innerHTML = '<p style="color: #6c757d; font-style: italic;">Los c√≥digos aparecer√°n aqu√≠ conforme los agregues...</p>';
        return;
    }
    
    let html = '<div class="codes-list">';
    generatedCodes.forEach((item, index) => {
        const className = item.valid ? 'code-valid' : 'code-invalid';
        const icon = item.valid ? '‚úÖ' : '‚ùå';
        const typeLabel = item.type !== 'UNKNOWN' ? `[${item.type}]` : '[INV√ÅLIDO]';
        
        html += `
            <div class="code-item ${className}">
                <span>${icon} ${typeLabel} ${item.code}</span>
                <button onclick="removeCode(${index})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
            </div>
        `;
    });
    html += '</div>';
    
    listDiv.innerHTML = html;
// Scroll autom√°tico hacia el √∫ltimo c√≥digo agregado
setTimeout(() => {
    const listDiv = document.getElementById('codes-validation-list');
    if (listDiv && listDiv.scrollHeight > listDiv.clientHeight) {
        listDiv.scrollTop = listDiv.scrollHeight;
    }
}, 100);
}
       // Funci√≥n para remover c√≥digos del generador
function removeCode(index) {
    if (confirm('¬øEliminar este c√≥digo de la lista?')) {
        generatedCodes.splice(index, 1);
        updateCodesTextarea();
        updateCodesValidationList();
        updateValidationInfo();
        updateGenerateButton();
        showTemporaryMessage('üóëÔ∏è C√≥digo eliminado', 'info');
    }
}
// Integraci√≥n con inventario existente
async function updateInventoryFromScrap(scrapData) {
// Actualizar el inventario cuando se registre scrap adicional
    const data = await loadFromFirebase('scannedData');
    const existingInventory = JSON.parse(data || '[]');
    
    scrapData.shots.forEach(shot => {
        const scrapEntry = {
            id: `SCRAP-${shot.number}`,
            modelo: scrapData.numeroProducto,
            estado: 'scrap',
            tipo: 'SCRAP_ADICIONAL',
            folio: scrapData.folio,
            fecha: scrapData.fechaOperacion,
            motivo: shot.reason
        };
        existingInventory.push(scrapEntry);
    });
    
    await saveToFirebase('scannedData', JSON.stringify(existingInventory));
    updateInventoryDisplay();
}
function showSubTab(subTabName) {
    // Solo afectar elementos dentro de scrap-retention
    const container = document.getElementById('scrap-retention');
    if (!container) return;
    
    // Ocultar todas las sub-pesta√±as
    const subTabs = container.querySelectorAll('.sub-tab-content'); // ‚¨ÖÔ∏è CAMBIO AQU√ç
    subTabs.forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active'); // Remover clase active
    });
    
    // Remover active de todos los botones
    const subButtons = container.querySelectorAll('.sub-nav-tab');
    subButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar la sub-pesta√±a seleccionada
    const targetTab = document.getElementById(subTabName);
    if (targetTab) {
        targetTab.style.display = 'block';
        targetTab.classList.add('active'); // Agregar clase active
    }
// Refrescar lista cuando se muestra gestionar hojas
if (subTabName === 'manage-sheets') {
    setTimeout(() => {
        refreshSheetsList();
    }, 100);
}
    // Activar el bot√≥n correspondiente
    if (event && event.target) {
        event.target.classList.add('active');
    }
}
// REEMPLAZAR la funci√≥n startScrapCamera() completa:
async function startScrapCamera() {
    console.log('üîç Verificando QrScanner...', typeof QrScanner);
    
    if (typeof QrScanner === 'undefined') {
        alert('‚ùå La librer√≠a QR Scanner no se carg√≥ correctamente.\n\nPor favor recarga la p√°gina.');
        return;
    }
    
    try {
        const videoElement = document.getElementById('scrap-camera-video');
        const containerElement = document.getElementById('scrap-camera-container');
        const statusElement = document.getElementById('scrap-camera-status');
        
        // ‚úÖ VERIFICACI√ìN MEJORADA de elementos
        if (!videoElement) {
            console.error('‚ùå Elemento scrap-camera-video no encontrado');
            alert('‚ùå Error: Elemento de video no encontrado');
            return;
        }
        if (!containerElement) {
            console.error('‚ùå Elemento scrap-camera-container no encontrado');
            alert('‚ùå Error: Contenedor de c√°mara no encontrado');
            return;
        }
        if (!statusElement) {
            console.error('‚ùå Elemento scrap-camera-status no encontrado');
            alert('‚ùå Error: Elemento de estado no encontrado');
            return;
        }
        
        // Verificar si ya hay una c√°mara activa
        if (scrapScanner) {
            console.log('‚ö†Ô∏è C√°mara ya activa, deteni√©ndola primero...');
            stopScrapCamera();
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // Verificar disponibilidad de c√°mara
        const hasCamera = await QrScanner.hasCamera();
        if (!hasCamera) {
            alert('‚ùå No se detect√≥ ninguna c√°mara en tu dispositivo.\n\nPuedes usar entrada manual escribiendo el c√≥digo QR.');
            return;
        }
        
        // Mostrar estado de carga
        statusElement.textContent = 'üì∑ Solicitando permisos de c√°mara...';
        statusElement.style.background = '#fff3cd';
        statusElement.style.color = '#856404';
        
        // Crear scanner
        scrapScanner = new QrScanner(
            videoElement,
            result => handleScrapQRScan(result.data),
            {
                returnDetailedScanResult: true,
                highlightScanRegion: true,
                highlightCodeOutline: true,
                preferredCamera: 'environment',
                maxScansPerSecond: 2
            }
        );
        
        // Iniciar scanner
        statusElement.textContent = 'üì∑ Iniciando c√°mara...';
        await scrapScanner.start();
        
        // ‚úÖ √âXITO - Actualizar elementos que S√ç existen
        statusElement.textContent = 'üì∑ C√°mara activa - Escanea el c√≥digo QR del shot';
        statusElement.style.background = '#d4edda';
        statusElement.style.color = '#155724';
        
        console.log('‚úÖ C√°mara de scrap iniciada correctamente');
        
    } catch (error) {
        console.error('‚ùå Error detallado de c√°mara:', error);
        
        // Limpiar scanner en caso de error
        if (scrapScanner) {
            try {
                scrapScanner.destroy();
            } catch (e) {
                console.error('Error al limpiar scanner:', e);
            }
            scrapScanner = null;
        }
        
        // Mostrar error espec√≠fico
        let errorMessage = '‚ùå Error al acceder a la c√°mara.\n\n';
        
        if (error.name === 'NotAllowedError' || error.message.includes('Permission')) {
            errorMessage += 'PERMISOS DENEGADOS:\n‚Ä¢ Haz clic en el icono de c√°mara en la barra del navegador\n‚Ä¢ Selecciona "Permitir" para el acceso a la c√°mara\n‚Ä¢ Recarga la p√°gina si es necesario';
        } else if (error.name === 'NotFoundError') {
            errorMessage += 'C√ÅMARA NO ENCONTRADA:\n‚Ä¢ Verifica que tu dispositivo tenga c√°mara\n‚Ä¢ Aseg√∫rate de que no est√© siendo usada por otra aplicaci√≥n';
        } else if (error.name === 'NotSupportedError') {
            errorMessage += 'NO COMPATIBLE:\n‚Ä¢ Usa un navegador m√°s reciente\n‚Ä¢ Aseg√∫rate de estar en HTTPS';
        } else {
            errorMessage += `ERROR T√âCNICO:\n‚Ä¢ ${error.message}\n‚Ä¢ Intenta recargar la p√°gina`;
        }
        
        errorMessage += '\n\nüí° ALTERNATIVA: Usa entrada manual escribiendo el c√≥digo QR.';
        alert(errorMessage);
        
        // Resetear estado visual si hay error
        const statusElement = document.getElementById('scrap-camera-status');
        if (statusElement) {
            statusElement.textContent = '‚ùå Error al iniciar c√°mara';
            statusElement.style.background = '#f8d7da';
            statusElement.style.color = '#721c24';
        }
    }
}
// Detener c√°mara de scrap
function stopScrapCamera() {
    if (scrapScanner) {
        try {
            scrapScanner.stop();
            scrapScanner.destroy();
            scrapScanner = null;
            console.log('‚úÖ C√°mara de scrap detenida');
        } catch (error) {
            console.error('Error al detener c√°mara:', error);
        }
    }
    
    // Resetear estado visual
    const statusElement = document.getElementById('scrap-camera-status');
    if (statusElement) {
        statusElement.textContent = 'üì∑ C√°mara detenida';
        statusElement.style.background = '#e2e3e5';
        statusElement.style.color = '#495057';
    }
}

function handleScrapQRScan(qrData) {
    if (qrData && qrData.trim().length > 0) {
        const code = qrData.trim();
        
        const codeData = extractCodeData(code);
        
        if (codeData) {
            // Solo llenar el n√∫mero de shot
            document.getElementById('shot-number').value = codeData.disparo;
            
            // Mostrar feedback visual
            const statusElement = document.getElementById('scrap-camera-status');
            statusElement.style.background = '#d4edda';
            statusElement.style.color = '#155724';
            statusElement.textContent = '‚úÖ Shot detectado: ' + codeData.disparo;
            
            setTimeout(() => {
                stopScrapCamera();
            }, 2000);
            
            setTimeout(() => {
                document.getElementById('scrap-reason').focus();
            }, 2100);
        } else {
            alert('‚ùå C√≥digo QR no v√°lido para shot');
        }
    }
}
// Toggle entre entrada manual y c√°mara
function toggleScrapCameraMode() {
    cameraMode = !cameraMode;
    
    if (cameraMode) {
        document.getElementById('camera-mode-text').textContent = '‚úèÔ∏è Entrada Manual';
        document.getElementById('scrap-camera-section').style.display = 'block';
        document.getElementById('manual-entry-section').style.display = 'none';
        startScrapCamera();
    } else {
        document.getElementById('camera-mode-text').textContent = 'üì∑ Activar C√°mara';
        document.getElementById('scrap-camera-section').style.display = 'none';
        document.getElementById('manual-entry-section').style.display = 'block';
        stopScrapCamera();
    }
}

// Actualizar la funci√≥n addShot() para incluir verificaci√≥n de duplicados
async function addShot() {
    const shotCode = document.getElementById('shot-number').value.toUpperCase().trim();
    const moldeNumber = document.getElementById('molde-producto').value;
    const scrapReason = document.getElementById('scrap-reason').value;
    const otherReason = document.getElementById('other-reason').value;
    const almacenOrigen = document.getElementById('almacen-origen').value;
    
    // Validaciones b√°sicas
    if (!shotCode || !moldeNumber || !scrapReason || !almacenOrigen) {
        alert('‚ö†Ô∏è Por favor completa todos los campos requeridos\n\nAseg√∫rate de haber seleccionado:\n‚Ä¢ N√∫mero de producto\n‚Ä¢ Molde\n‚Ä¢ C√≥digo QR completo\n‚Ä¢ Motivo del scrap\n‚Ä¢ Almac√©n origen');
        return;
    }
    
    if (scrapReason === 'OTRO' && !otherReason) {
        alert('‚ö†Ô∏è Por favor especifica el motivo del scrap');
        return;
    }
    
    // ‚¨ÖÔ∏è **L√çNEA FALTANTE**: Definir fullCode
    let fullCode = shotCode;
    
    // Extraer datos del c√≥digo para validaci√≥n
    const codeData = extractCodeData(fullCode);
    if (codeData) {
    // **VALIDACI√ìN DE MODELO**: Verificar que coincida con el seleccionado
    const selectedProduct = document.getElementById('numero-producto').value;
    const selectedMold = document.getElementById('molde-producto').value;
    
    // Extraer el modelo base del producto seleccionado (ej: "PX13-10-382" -> "P5" o similar)
    let expectedModelCode = '';
    if (selectedProduct.includes('PX13-10-382')) expectedModelCode = 'PX'; 
    else if (selectedProduct.includes('PEDD-10-382-A')) expectedModelCode = 'PE';
    else if (selectedProduct.includes('P54G-10-382')) expectedModelCode = 'P5';
    else if (selectedProduct.includes('PX13-10-301')) expectedModelCode = 'PX';
    else if (selectedProduct.includes('PEDD-10-301-A')) expectedModelCode = 'PE';
    else if (selectedProduct.includes('P54G-10-301-A')) expectedModelCode = 'P5';
    
    // **VALIDACI√ìN DE TIPO**: UPR vs LWR
    const isSelectedUPR = selectedProduct.includes('301');
    const isSelectedLWR = selectedProduct.includes('382');
    const isCodeUPR = codeData.type === 'UPR';
    const isCodeLWR = codeData.type === 'LWR';
    
    if ((isSelectedUPR && !isCodeUPR) || (isSelectedLWR && !isCodeLWR)) {
        alert(`‚ùå TIPO DE PRODUCTO INCORRECTO\n\nEl c√≥digo ingresado es ${codeData.type} pero el producto seleccionado es ${isSelectedUPR ? 'UPR' : 'LWR'}.\n\nC√≥digo: ${fullCode}\nProducto seleccionado: ${selectedProduct}\n\nPor favor:\n1. Verifica el c√≥digo QR, O\n2. Cambia el producto seleccionado`);
        return;
    }
    
    // **VALIDACI√ìN DE MOLDE**: Verificar que coincida exactamente
    if (codeData.molde !== selectedMold) {
        alert(`‚ùå MOLDE INCORRECTO\n\nEl c√≥digo QR pertenece al molde "${codeData.molde}" pero tienes seleccionado el molde "${selectedMold}".\n\nC√≥digo: ${fullCode}\nMolde del c√≥digo: ${codeData.molde}\nMolde seleccionado: ${selectedMold}\n\nPor favor:\n1. Verifica el c√≥digo QR, O\n2. Cambia el molde seleccionado`);
        return;
    }
    
    // **VALIDACI√ìN DE M√ÅQUINA** (opcional, pero √∫til)
    const expectedMachines = {
        'PX13-10-382': [30, 31],     // LWR
        'PEDD-10-382-A': [30, 31],   // LWR  
        'P54G-10-382': [30, 31],     // LWR
        'PX13-10-301': [32, 33, 34], // UPR
        'PEDD-10-301-A': [32, 33, 34], // UPR
        'P54G-10-301-A': [32, 33, 34]  // UPR
    };
    
    const allowedMachines = expectedMachines[selectedProduct];
    if (allowedMachines && !allowedMachines.includes(codeData.maquina)) {
        const confirmProceed = confirm(`‚ö†Ô∏è M√ÅQUINA INUSUAL\n\nEl c√≥digo QR es de la m√°quina ${codeData.maquina}, pero para ${selectedProduct} normalmente se usan las m√°quinas: ${allowedMachines.join(', ')}.\n\nC√≥digo: ${fullCode}\nM√°quina del c√≥digo: ${codeData.maquina}\nM√°quinas esperadas: ${allowedMachines.join(', ')}\n\n¬øContinuar de todos modos?`);
        
        if (!confirmProceed) {
            return;
        }
    }
    
    console.log('‚úÖ Validaciones de encabezado pasadas:', {
        codigo: fullCode,
        tipo: codeData.type,
        molde: codeData.molde,
        maquina: codeData.maquina,
        productoSeleccionado: selectedProduct,
        moldeSeleccionado: selectedMold
    });
}
    // **VALIDACI√ìN PRINCIPAL**: Buscar en la base de datos
    console.log('üîç Buscando en inventario:', fullCode, 'Inventario size:', inventory.length);
    
    const existingItem = inventory.find(item => {
        // Buscar por c√≥digo completo o por shot number si tiene codeData
        return item.code === fullCode || 
               (item.codeData && codeData && item.codeData.disparo === codeData.disparo && item.codeData.molde === moldeNumber);
    });
    
    if (!existingItem) {
        const shotDisplay = codeData ? codeData.disparo : shotCode;
        alert(`‚ùå SHOT NO ENCONTRADO EN BASE DE DATOS\n\nEl c√≥digo ${shotDisplay} con molde ${moldeNumber} no est√° registrado en el inventario.\n\nVerifica:\n‚Ä¢ C√≥digo QR correcto\n‚Ä¢ Molde correcto\n‚Ä¢ Que la pieza est√© registrada en el sistema`);
        return;
    }
    
    // **VALIDACI√ìN DE ALMAC√âN**: Verificar que est√© en el almac√©n correcto
    // Mapear correctamente los nombres de almacenes
const almacenMapping = {
    'ALMACEN_FUNDICION': 'fundidos',
    'ALMACEN_ACABADO': 'acabados', 
    'ALMACEN_RETENCION': 'retenciones'
};
const expectedWarehouse = almacenMapping[almacenOrigen] || almacenOrigen.toLowerCase().replace('almacen_', '');
    const actualWarehouse = existingItem.warehouse;
    
    // ‚¨ÖÔ∏è **DEFINIR warehouseNames AQU√ç**
    const warehouseNames = {
        'fundidos': 'üî• Fundici√≥n',
        'acabados': '‚úÖ Acabado',
        'scrap': '‚ôªÔ∏è Scrap',
        'retenciones': '‚è∏Ô∏è Retenciones',
        'envios': 'üì¶ Env√≠os',
        'pruebas': 'üß™ Pruebas'
    };
    
    if (actualWarehouse !== expectedWarehouse) {
        const shotDisplay = codeData ? codeData.disparo : shotCode;
        alert(`‚ùå ALMAC√âN INCORRECTO\n\nEl c√≥digo ${shotDisplay} NO est√° en el almac√©n seleccionado.\n\nüìç Almac√©n actual: ${warehouseNames[actualWarehouse] || actualWarehouse}\nüéØ Almac√©n seleccionado: ${warehouseNames[expectedWarehouse] || almacenOrigen}\n\nPor favor:\n1. Corrije el almac√©n origen, O\n2. Verifica la ubicaci√≥n real de la pieza`);
        return;
    }
    
    // **VALIDACI√ìN DE CANTIDAD**: Verificar que tenga cantidad disponible
    if (existingItem.quantity <= 0) {
        const shotDisplay = codeData ? codeData.disparo : shotCode;
        alert(`‚ùå SHOT SIN INVENTARIO\n\nEl c√≥digo ${shotDisplay} est√° registrado pero con cantidad 0.\n\nNo se puede procesar como scrap porque ya fue descontado del inventario.`);
        return;
    }
    
    // Verificar duplicados en la lista actual
    const shotNumber = codeData ? codeData.disparo : shotCode; // ‚¨ÖÔ∏è **DEFINIR shotNumber AQU√ç**
    const isDuplicate = scannedShots.some(shot => 
        shot.shotNumber === shotNumber && shot.moldeNumber === moldeNumber
    );
    
    if (isDuplicate) {
        alert('‚ö†Ô∏è Este shot ya fue registrado en la lista actual');
        return;
    }
    
    // ‚úÖ **TODAS LAS VALIDACIONES PASARON** - Agregar shot
    const newShot = {
        shotNumber: shotNumber,
        moldeNumber: moldeNumber,
        fullCode: fullCode,
        scrapReason: scrapReason === 'OTRO' ? otherReason : scrapReason,
        almacenOrigen: almacenOrigen,
        existingInventory: {
            id: existingItem.id,
            currentQuantity: existingItem.quantity,
            partNumber: existingItem.partNumber,
            warehouse: existingItem.warehouse
        },
        timestamp: new Date().toLocaleString('es-MX'),
        id: Date.now(),
        validated: true
    };
    
    scannedShots.push(newShot);
    
    // Actualizar la visualizaci√≥n
    updateShotsDisplay();
    
    // Limpiar solo el campo de shot number (mantener molde y raz√≥n)
    document.getElementById('shot-number').value = '';
    if (scrapReason === 'OTRO') {
        document.getElementById('other-reason').value = '';
    }
    
    // Mostrar mensaje de √©xito con informaci√≥n de validaci√≥n
    const display = document.getElementById('current-shots-display');
    const successMsg = document.createElement('div');
    successMsg.className = 'alert alert-success';
    successMsg.innerHTML = `
        ‚úÖ <strong>Shot validado y agregado</strong><br>
        üì¶ C√≥digo: ${fullCode}<br>
        üè™ Almac√©n confirmado: ${warehouseNames[actualWarehouse] || actualWarehouse}<br>
        üìä Cantidad disponible: ${existingItem.quantity}
    `;
    display.insertBefore(successMsg, display.firstChild);
    
    setTimeout(() => {
        successMsg.remove();
    }, 5000);
    
    console.log('‚úÖ Shot agregado con validaci√≥n completa:', newShot);
// üî• DESCONTAR AUTOM√ÅTICAMENTE DEL INVENTARIO
try {
    await descontarDelInventario(existingItem, newShot);
    console.log('‚úÖ Inventario actualizado despu√©s del scrap');
} catch (error) {
    console.error('‚ùå Error actualizando inventario:', error);
}
}
// Funci√≥n para detectar tipo de modelo y ajustar l√≠mites
function updateShotInputLimits() {
    const numeroProducto = document.getElementById('numero-producto').value;
    const shotInput = document.getElementById('shot-number');
    
    if (!shotInput) return;
    
    // Determinar si es UPR o LWR bas√°ndose en el n√∫mero de producto
    let isUPR = false;
    let isLWR = false;
    
    if (numeroProducto) {
        // Los c√≥digos que contienen "301" son UPR, los que contienen "382" son LWR
        if (numeroProducto.includes('301')) {
            isUPR = true;
        } else if (numeroProducto.includes('382')) {
            isLWR = true;
        }
    }
    
    // Actualizar l√≠mites y placeholder seg√∫n el tipo
    if (isUPR) {
        shotInput.maxLength = 13;
        shotInput.placeholder = "Ej: P5QF4181O1PX2 (UPR - m√°x. 13 caracteres)";
        shotInput.style.borderColor = "#007bff"; // Azul para UPR
    } else if (isLWR) {
        shotInput.maxLength = 17;
        shotInput.placeholder = "Ej: 25E153003154276P5 (LWR - m√°x. 17 caracteres)";
        shotInput.style.borderColor = "#28a745"; // Verde para LWR
    } else {
        // Sin modelo seleccionado
        shotInput.maxLength = 17; // M√°ximo por defecto
        shotInput.placeholder = "Primero selecciona un producto - Ej: P5QF4181O1PX2 (UPR) o 25E153003154276P5 (LWR)";
        shotInput.style.borderColor = "#ced4da"; // Gris por defecto
    }
    
    console.log(`üîß L√≠mites actualizados: ${isUPR ? 'UPR (13)' : isLWR ? 'LWR (17)' : 'Sin modelo'}`);
}

// Funci√≥n para validar en tiempo real mientras el usuario escribe
function validateShotInput() {
    const shotInput = document.getElementById('shot-number');
    const numeroProducto = document.getElementById('numero-producto').value;
    
    if (!shotInput || !numeroProducto) return;
    
    const currentValue = shotInput.value.toUpperCase(); // Convertir a may√∫sculas
    shotInput.value = currentValue; // Aplicar may√∫sculas
    
    // Determinar tipo esperado
    const isUPRProduct = numeroProducto.includes('301');
    const isLWRProduct = numeroProducto.includes('382');
    
    // Validar longitud en tiempo real
    if (isUPRProduct && currentValue.length > 13) {
        shotInput.style.borderColor = "#dc3545"; // Rojo si excede
        shotInput.title = "‚ùå Demasiados caracteres para UPR (m√°x. 13)";
    } else if (isLWRProduct && currentValue.length > 17) {
        shotInput.style.borderColor = "#dc3545"; // Rojo si excede
        shotInput.title = "‚ùå Demasiados caracteres para LWR (m√°x. 17)";
    } else if (currentValue.length >= 10) {
        // Validar formato b√°sico si tiene suficientes caracteres
        const isValidLength = (isUPRProduct && currentValue.length === 13) || 
                             (isLWRProduct && currentValue.length === 17);
        
        if (isValidLength) {
            shotInput.style.borderColor = "#28a745"; // Verde si es correcto
            shotInput.title = "‚úÖ Longitud correcta";
        } else {
            shotInput.style.borderColor = "#ffc107"; // Amarillo si est√° incompleto
            shotInput.title = `‚ö†Ô∏è Longitud esperada: ${isUPRProduct ? '13' : '17'} caracteres`;
        }
    } else {
        // Restablecer color normal si est√° escribiendo
        shotInput.style.borderColor = isUPRProduct ? "#007bff" : "#28a745";
        shotInput.title = "";
    }
}
// Funci√≥n para actualizar la visualizaci√≥n de shots
function updateShotsDisplay() {
    const display = document.getElementById('current-shots-display');
    const totalElement = document.getElementById('total-shots');
    
    if (scannedShots.length === 0) {
        display.innerHTML = '<div class="alert alert-info">üîç Los shots escaneados aparecer√°n aqu√≠</div>';
        totalElement.textContent = '0';
        return;
    }
    
    totalElement.textContent = scannedShots.length;
    
    let html = '<div class="shots-grid">';
    scannedShots.forEach(shot => {
        html += `
            <div class="shot-item">
                <div class="shot-header">
                    <strong>Shot #${shot.shotNumber}</strong>
                    <button class="btn btn-sm btn-danger" onclick="removeShot(${shot.id})">‚ùå</button>
                </div>
                <div class="shot-details">
                    <p>üîß Molde: ${shot.moldeNumber}</p>
                    <p>üìù Motivo: ${shot.scrapReason}</p>
                    <p>üïí ${shot.timestamp}</p>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    display.innerHTML = html;
}

// Funci√≥n para remover un shot
function removeShot(shotId) {
    if (confirm('¬øEst√°s seguro de eliminar este shot?')) {
        scannedShots = scannedShots.filter(shot => shot.id !== shotId);
        updateShotsDisplay();
    }
}
// üîÑ FUNCI√ìN checkInventoryShots ACTUALIZADA
async function checkInventoryShots(shotsList) {
    const inventoryShots = [];
    const notInInventory = [];
    
    // Obtener el inventario actual desde Firebase
    const inventoryData = await getFromFirebase('inventory') || [];
    const currentInventory = firebaseObjectToArray(inventoryData);
    
    shotsList.forEach(shot => {
        const inventoryItem = currentInventory.find(item => 
            item.shotNumber === shot.shotNumber && 
            item.location !== 'DESCONTADO'
        );
        
        if (inventoryItem) {
            inventoryShots.push({
                ...shot,
                almacenActual: inventoryItem.location,
                inventoryId: inventoryItem.id
            });
        } else {
            notInInventory.push(shot);
        }
    });
    
    return { inventoryShots, notInInventory };
}


// üîÑ FUNCI√ìN saveScrapSheet CORREGIDA
async function saveScrapSheet() {  // ‚¨ÖÔ∏è AGREGAR async aqu√≠
    const folio = document.getElementById('folio').value;
    const fechaOperacion = document.getElementById('fecha-operacion').value;
    const sectorTrabajo = document.getElementById('sector-trabajo').value;
    const numeroProducto = document.getElementById('numero-producto').value;
    const nombreProducto = document.getElementById('nombre-producto').value;
    const moldeProducto = document.getElementById('molde-producto').value;
    const creadoPor = document.getElementById('creado-por').value;
    const almacenOrigen = document.getElementById('almacen-origen').value;
    const observaciones = document.getElementById('observaciones').value;

    // Validaciones
    if (!fechaOperacion || !sectorTrabajo || !numeroProducto || !moldeProducto || !creadoPor || !almacenOrigen) {
        alert('‚ö†Ô∏è Por favor completa todos los campos obligatorios');
        return;
    }

    if (!scannedShots || scannedShots.length === 0) {
        alert('‚ö†Ô∏è Debe agregar al menos un shot');
        return;
    }

    // Verificar shots en inventario - AGREGAR await aqu√≠ ‚¨ÖÔ∏è
    const { inventoryShots, notInInventory } = await checkInventoryShots(scannedShots);

    // Preparar datos de la hoja
    const scrapSheet = {
        folio: folio,
        fechaOperacion: fechaOperacion,
        fechaCreacion: new Date().toISOString(),
        sectorTrabajo: sectorTrabajo,
        numeroProducto: numeroProducto,
        nombreProducto: nombreProducto,
        moldeProducto: moldeProducto,
        creadoPor: creadoPor,
        almacenOrigen: almacenOrigen,
        shots: scannedShots.map(shot => ({
            ...shot,
            almacenProveniente: inventoryShots.find(is => is.shotNumber === shot.shotNumber)?.almacenActual || almacenOrigen
        })),
        observaciones: observaciones,
        estado: 'ABIERTA',
        evidencia: null,
        inventoryShots: inventoryShots.length,
        newShots: notInInventory.length,
        id: Date.now()
    };

    // Descontar del inventario si hay shots existentes
    if (inventoryShots.length > 0) {
        updateInventoryForScrap(inventoryShots);
    }

    scrapSheets.push(scrapSheet);
    
    // üî• GUARDAR EN FIREBASE
    await saveToFirebase('scrapSheets', JSON.stringify(arrayToFirebaseObject(scrapSheets)));
    
    // Incrementar contador y guardar
    folioCounter++;
    await saveToFirebase('folioCounter', folioCounter.toString());

    alert(`‚úÖ Hoja de scrap guardada correctamente\n\n` +
          `üìã Folio: ${folio}\n` +
          `üì¶ Shots del inventario: ${inventoryShots.length}\n` +
          `üÜï Shots nuevos: ${notInInventory.length}\n` +
          `üìä Total shots: ${scannedShots.length}\n\n` +
          `Puedes gestionarla desde la pesta√±a "Gestionar Hojas"`);
	
updateAllDisplays();
clearScrapForm();
generateNewFolio();
refreshSheetsList();
}
// üîÑ FUNCI√ìN updateInventoryForScrap ACTUALIZADA (versi√≥n completa)
async function updateInventoryForScrap(inventoryShots) {
    // Obtener inventario actual
    const inventoryData = await getFromFirebase('inventory') || [];
    let currentInventory = firebaseObjectToArray(inventoryData);
    
    inventoryShots.forEach(shot => {
        const index = currentInventory.findIndex(item => item.id === shot.inventoryId);
        if (index !== -1) {
            currentInventory[index].location = 'SCRAP_ADICIONAL';
            currentInventory[index].lastUpdate = new Date().toISOString();
            currentInventory[index].scrapReason = shot.scrapReason;
        }
    });
    
    // Guardar inventario actualizado
    await saveToFirebaseHelper('inventory', arrayToFirebaseObject(currentInventory));
    
    // Actualizar la variable global tambi√©n
    inventory = currentInventory;
}
// Funci√≥n para imprimir hoja
function printScrapSheet() {
    const folio = document.getElementById('folio').value || 'BORRADOR';
    const fechaOperacion = document.getElementById('fecha-operacion').value || new Date().toISOString().split('T')[0];
    const numeroProducto = document.getElementById('numero-producto').value || 'N/A';
    const nombreProducto = document.getElementById('nombre-producto').value || 'N/A';
    const moldeProducto = document.getElementById('molde-producto').value || 'N/A';
    const creadoPor = document.getElementById('creado-por').value || 'N/A';
    const sectorTrabajo = document.getElementById('sector-trabajo').value || 'N/A';
    const almacenOrigen = document.getElementById('almacen-origen').value || 'N/A';
    const observaciones = document.getElementById('observaciones').value || 'Sin observaciones';
    
    // Generar contenido HTML para imprimir
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Hoja de Scrap - ${folio}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 15px; line-height: 1.3; font-size: 14px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
                .department-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 10px 0; font-size: 12px; }
                .signatures { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0; }
                .signature-box { border: 1px solid #333; padding: 8px; text-align: center; min-height: 50px; }
                .section { margin: 10px 0; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 8px 0; }
                .info-item { font-size: 12px; }
                .shots-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
                .shots-table th, .shots-table td { border: 1px solid #333; padding: 6px; text-align: left; }
                .shots-table th { background: #f0f0f0; font-weight: bold; }
                .folio-box { border: 2px solid #333; padding: 8px; text-align: center; margin-bottom: 10px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 style="margin: 0; font-size: 18px;">REPORTE DIARIO DE SCRAP ADICIONAL</h1>
                <div class="department-info">
                    <div><strong>Departamento:</strong> Fundici√≥n 1</div>
                    <div><strong>Secci√≥n:</strong> Fundici√≥n 1.3</div>
                </div>
            </div>
            
            <div class="folio-box">
                <strong>FOLIO: ${folio}</strong>
            </div>
            
            <div class="signatures">
                <div class="signature-box">
                    <strong>ELABORACI√ìN</strong><br><br>
                    <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 5px;">
                        Nombre y Firma
                    </div>
                </div>
                <div class="signature-box">
                    <strong>REVISI√ìN</strong><br><br>
                    <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 5px;">
                        Nombre y Firma
                    </div>
                </div>
                <div class="signature-box">
                    <strong>APROBACI√ìN</strong><br><br>
                    <div style="border-top: 1px solid #333; margin-top: 20px; padding-top: 5px;">
                        Nombre y Firma
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h3 style="margin: 10px 0 8px 0; font-size: 14px;">INFORMACI√ìN GENERAL</h3>
                <div class="info-grid">
                    <div class="info-item"><strong>Fecha:</strong> ${fechaOperacion}</div>
                    <div class="info-item"><strong>Sector:</strong> ${sectorTrabajo}</div>
                    <div class="info-item"><strong>Creado por:</strong> ${creadoPor}</div>
                    <div class="info-item"><strong>Producto:</strong> ${numeroProducto}</div>
                    <div class="info-item"><strong>Molde:</strong> ${moldeProducto}</div>
                    <div class="info-item"><strong>Almac√©n:</strong> ${almacenOrigen}</div>
                </div>
                <div class="info-item" style="margin-top: 8px;"><strong>Nombre:</strong> ${nombreProducto}</div>
            </div>
            
            <div class="section">
                <h3 style="margin: 10px 0 8px 0; font-size: 14px;">SHOTS REGISTRADOS (${scannedShots.length})</h3>
                <table class="shots-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">Shot #</th>
                            <th style="width: 15%;">Molde</th>
                            <th style="width: 50%;">Motivo del Scrap</th>
                            <th style="width: 20%;">Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scannedShots.map(shot => `
                            <tr>
                                <td>${shot.shotNumber}</td>
                                <td>${shot.moldeNumber}</td>
                                <td>${shot.scrapReason}</td>
                                <td>${shot.timestamp}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h3 style="margin: 10px 0 8px 0; font-size: 14px;">OBSERVACIONES</h3>
                <div style="border: 1px solid #333; padding: 8px; min-height: 40px; font-size: 12px;">
                    ${observaciones}
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center; font-size: 10px; color: #666;">
                <p>Generado: ${new Date().toLocaleString()}</p>
                <p>Sistema de Control de Almac√©n - Fundici√≥n v1.3</p>
            </div>
        </body>
        </html>
    `;
    
    // Crear ventana de impresi√≥n
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}
// Funci√≥n para cerrar hoja (modal)
function openCloseSheetModal(sheetId) {
    const sheets = getFromLocalStorage('scrapSheets') || [];
    const sheet = sheets.find(s => s.id === sheetId);
    
    if (!sheet) return;
    
    document.getElementById('modal-folio').value = sheet.folio;
    document.getElementById('close-sheet-modal').style.display = 'flex';
}

// Funci√≥n para confirmar cierre
function confirmCloseSheet() {
    const folio = document.getElementById('modal-folio').value;
    const firmaSupervisor = document.getElementById('firma-supervisor').value;
    const firmaGerente = document.getElementById('firma-gerente').value;
    const comentarios = document.getElementById('comentarios-cierre').value;
    
    if (!firmaSupervisor || !firmaGerente) {
        alert('‚ö†Ô∏è Se requieren ambas firmas para cerrar la hoja');
        return;
    }
    
    // Actualizar estado de la hoja
    let sheets = getFromLocalStorage('scrapSheets') || [];
    const sheetIndex = sheets.findIndex(s => s.folio === folio);
    
    if (sheetIndex !== -1) {
        sheets[sheetIndex].estado = 'CERRADA';
        sheets[sheetIndex].fechaCierre = new Date().toISOString();
        sheets[sheetIndex].firmaSupervisor = firmaSupervisor;
        sheets[sheetIndex].firmaGerente = firmaGerente;
        sheets[sheetIndex].comentariosCierre = comentarios;
        
        saveToLocalStorage('scrapSheets', sheets);
        
        alert('‚úÖ Hoja cerrada correctamente');
        closeModal();
        refreshSheetsList();
    }
}
function openManageStateModal(folio) {
    const sheet = scrapSheets.find(s => s.folio === folio);
    if (!sheet) return;
    
    document.getElementById('modal-folio-manage').value = sheet.folio;
    document.getElementById('modal-current-state').value = getEstadoText(sheet.estado);
    document.getElementById('modal-new-state').value = '';
    document.getElementById('modal-comentarios').value = '';
    
    // Limpiar campos de evidencia y firmas
    clearModalFields();
    
    // Mostrar modal
    document.getElementById('manage-state-modal').style.display = 'flex';
    
    // Event listener para cambio de estado
    document.getElementById('modal-new-state').onchange = handleStateChange;
}

function handleStateChange() {
    const newState = document.getElementById('modal-new-state').value;
    const evidenceSection = document.getElementById('evidence-upload-section');
    const signaturesSection = document.getElementById('signatures-section');
    
    // Ocultar todas las secciones por defecto
    evidenceSection.style.display = 'none';
    signaturesSection.style.display = 'none';
    
    if (newState === 'PENDIENTE_FIRMA' || newState === 'CERRADA') {
        evidenceSection.style.display = 'block';
    }
    
    if (newState === 'CERRADA') {
        signaturesSection.style.display = 'block';
    }
}

function getEstadoText(estado) {
    const texts = {
        'ABIERTA': 'Abierta',
        'EN_PROCESO': 'En Proceso',
        'PENDIENTE_FIRMA': 'Pendiente de Firma',
        'CERRADA': 'Cerrada'
    };
    return texts[estado] || 'Desconocido';
}

function clearModalFields() {
    document.getElementById('modal-evidencia-file').value = '';
    document.getElementById('modal-file-status').innerHTML = '<span class="file-placeholder">üìé Haz clic para seleccionar archivo PDF</span>';
    document.getElementById('modal-firma-supervisor').value = '';
    document.getElementById('modal-firma-gerente').value = '';
    document.getElementById('evidence-upload-section').style.display = 'none';
    document.getElementById('signatures-section').style.display = 'none';
}
function handleModalEvidenceUpload() {
    const file = document.getElementById('modal-evidencia-file').files[0];
    const fileStatus = document.getElementById('modal-file-status');
    
    if (file) {
        if (file.type !== 'application/pdf') {
            alert('‚ö†Ô∏è Solo se permiten archivos PDF');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            alert('‚ö†Ô∏è El archivo no puede ser mayor a 5MB');
            return;
        }
        
        const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
        fileStatus.innerHTML = `<span style="color: green;">‚úÖ ${file.name} (${sizeInMB} MB)</span>`;
    }
}

// üîÑ FUNCI√ìN confirmStateChange ACTUALIZADA
async function confirmStateChange() {
    const folio = document.getElementById('modal-folio-manage').value;
    const newState = document.getElementById('modal-new-state').value;
    const comentarios = document.getElementById('modal-comentarios').value;
    
    if (!newState) {
        alert('‚ö†Ô∏è Selecciona un nuevo estado');
        return;
    }
    
    // Validaciones seg√∫n el estado
    if (newState === 'PENDIENTE_FIRMA' || newState === 'CERRADA') {
        const evidenceFile = document.getElementById('modal-evidencia-file').files[0];
        if (!evidenceFile) {
            alert('‚ö†Ô∏è Debe subir la hoja firmada en PDF para este estado');
            return;
        }
    }
    
    if (newState === 'CERRADA') {
        const supervisor = document.getElementById('modal-firma-supervisor').value;
        const gerente = document.getElementById('modal-firma-gerente').value;
        
        if (!supervisor || !gerente) {
            alert('‚ö†Ô∏è Se requieren ambas firmas para cerrar la hoja');
            return;
        }
    }
    
    // Encontrar y actualizar la hoja
    const sheetIndex = scrapSheets.findIndex(s => s.folio === folio);
    if (sheetIndex === -1) return;
    
    // Preparar datos de evidencia si existe
    let evidenciaData = null;
    const evidenceFile = document.getElementById('modal-evidencia-file').files[0];
    if (evidenceFile) {
        try {
            const base64 = await fileToBase64(evidenceFile);
            evidenciaData = {
                nombre: evidenceFile.name,
                tama√±o: evidenceFile.size,
                fecha: new Date().toISOString(),
                contenido: base64
            };
        } catch (error) {
            alert('‚ùå Error al procesar el archivo');
            return;
        }
    }
    
    // Actualizar la hoja
    scrapSheets[sheetIndex].estado = newState;
    scrapSheets[sheetIndex].fechaUltimaActualizacion = new Date().toISOString();
    scrapSheets[sheetIndex].comentariosEstado = comentarios;
    
    if (evidenciaData) {
        scrapSheets[sheetIndex].evidencia = evidenciaData;
    }
    
    if (newState === 'CERRADA') {
        scrapSheets[sheetIndex].firmaSupervisor = document.getElementById('modal-firma-supervisor').value;
        scrapSheets[sheetIndex].firmaGerente = document.getElementById('modal-firma-gerente').value;
        scrapSheets[sheetIndex].fechaCierre = new Date().toISOString();
    }
    
    // üî• GUARDAR EN FIREBASE
    await saveToFirebase('scrapSheets', JSON.stringify(arrayToFirebaseObject(scrapSheets)));
    
    alert(`‚úÖ Estado actualizado a: ${getEstadoText(newState)}`);
    
    closeManageModal();
    refreshSheetsList();
}
function closeManageModal() {
    document.getElementById('manage-state-modal').style.display = 'none';
}

function viewEvidence(folio) {
    const sheet = scrapSheets.find(s => s.folio === folio);
    if (!sheet || !sheet.evidencia) {
        alert('‚ùå No hay evidencia disponible para esta hoja');
        return;
    }
    
    const evidencia = sheet.evidencia;
    const sizeInMB = (evidencia.tama√±o / 1024 / 1024).toFixed(2);
    const fecha = new Date(evidencia.fecha).toLocaleString();
    
    if (confirm(`üìÑ Evidencia de ${folio}:\n\n‚Ä¢ Archivo: ${evidencia.nombre}\n‚Ä¢ Tama√±o: ${sizeInMB}MB\n‚Ä¢ Subido: ${fecha}\n\n¬øDeseas descargar el archivo?`)) {
        const link = document.createElement('a');
        link.href = evidencia.contenido;
        link.download = evidencia.nombre;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
// Inicializar sistema de retenciones
function initializeRetencionSystem() {
    generateNewRetencionFolio();
    refreshRetencionList();
    
    // Event listener para cambio de motivo
    document.getElementById('retencion-motivo').addEventListener('change', function() {
        const otroMotivoDiv = document.getElementById('retencion-otro-motivo');
        if (this.value === 'OTRO') {
            otroMotivoDiv.style.display = 'block';
        } else {
            otroMotivoDiv.style.display = 'none';
        }
    });
}

// üîÑ FUNCI√ìN generateNewRetencionFolio ACTUALIZADA
async function generateNewRetencionFolio() {
    const currentDate = new Date();
    const year = currentDate.getFullYear().toString().slice(-2);
    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
    const day = String(currentDate.getDate()).padStart(2, '0');
    
    // Asegurar que tenemos el contador m√°s reciente
    const currentCounter = await loadFromFirebase('retencionCounter');
    if (currentCounter) {
        retencionCounter = parseInt(currentCounter);
    }
    
    const folio = `RET-${year}${month}${day}-${String(retencionCounter).padStart(4, '0')}`;
    document.getElementById('retencion-folio').value = folio;
}
function updateRetencionProductInfo() {
    const producto = document.getElementById('retencion-producto');
    const moldeSelect = document.getElementById('retencion-molde');
    
    if (!producto || !moldeSelect) {
        console.warn('‚ö†Ô∏è Elementos de producto/molde no encontrados');
        return;
    }
    
    const productoValue = producto.value;
    
    // Limpiar opciones existentes
    moldeSelect.innerHTML = '<option value="">Seleccionar molde...</option>';
    
    if (productoValue) {
        const productoKey = productoValue + '-FUN';
        const moldes = MODEL_MOLDS[productoKey] || [];
        
        moldes.forEach(molde => {
            const option = document.createElement('option');
            option.value = molde;
            option.textContent = molde;
            moldeSelect.appendChild(option);
        });
        
        if (moldes.length === 0) {
            moldeSelect.innerHTML += '<option value="">No hay moldes disponibles para este producto</option>';
        }
    } else {
        moldeSelect.innerHTML = '<option value="">Primero selecciona un producto...</option>';
    }
}
async function validateRetencion() {
    const fechaProduccion = document.getElementById('retencion-fecha-produccion').value;
    const producto = document.getElementById('retencion-producto').value;
    const molde = document.getElementById('retencion-molde').value;
    
    if (!fechaProduccion || !producto || !molde) {
        alert('‚ö†Ô∏è Por favor completa todos los campos obligatorios');
        return;
    }
    
    if (retencionValidatedCodes.length === 0) {
        alert('‚ö†Ô∏è Debes agregar al menos un c√≥digo QR v√°lido');
        return;
    }
    
    document.getElementById('create-retencion-btn').disabled = false;
    
    const resultDiv = document.getElementById('retencion-validation-result');
    resultDiv.innerHTML = `
        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px;">
            <h4 style="color: #155724; margin: 0;">‚úÖ Validaci√≥n Exitosa</h4>
            <p style="margin: 5px 0 0 0;">${retencionValidatedCodes.length} c√≥digos QR validados y listos para retenci√≥n</p>
        </div>
    `;
}
// üîÑ FUNCI√ìN createRetencion ACTUALIZADA
async function createRetencion() {
    const folio = document.getElementById('retencion-folio').value;
    const fechaProduccion = document.getElementById('retencion-fecha-produccion').value;
    const producto = document.getElementById('retencion-producto').value;
    const molde = document.getElementById('retencion-molde').value;
    const totalCodes = retencionValidatedCodes.length;
    const motivo = document.getElementById('retencion-motivo').value;
    const motivoOtro = document.getElementById('retencion-motivo-otro').value;
    const observaciones = document.getElementById('retencion-observaciones').value;
    const creadoPor = document.getElementById('retencion-creado-por').value;
    
    // Validaciones finales
    if (!creadoPor) {
        alert('‚ö†Ô∏è Por favor ingresa el nombre del responsable');
        return;
    }
    
    if (!motivo) {
        alert('‚ö†Ô∏è Por favor selecciona el motivo de la retenci√≥n');
        return;
    }
    
    if (motivo === 'OTRO' && !motivoOtro) {
        alert('‚ö†Ô∏è Por favor especifica el motivo cuando selecciones "Otro"');
        return;
    }
    
    if (validatedShots.length === 0) {
        alert('‚ö†Ô∏è Primero debes validar los shots');
        return;
    }
    if (retencionValidatedCodes.length === 0) {
        alert('‚ö†Ô∏è Primero debes agregar y validar c√≥digos QR');
        return;
    }
    
    // Crear objeto de retenci√≥n
    const retencion = {
        folio: folio,
        fechaCreacion: new Date().toISOString(),
        fechaProduccion: fechaProduccion,
        producto: producto,
        molde: molde,
        totalShots: retencionValidatedCodes.length,
        motivo: motivo === 'OTRO' ? motivoOtro : motivo,
        observaciones: observaciones,
        creadoPor: creadoPor,
        estado: 'ACTIVA',
        codigosQR: [...retencionValidatedCodes], // ‚Üê CAMBIO PRINCIPAL
        historial: [{
            fecha: new Date().toISOString(),
            accion: 'CREACION',
            responsable: creadoPor,
            comentario: 'Retenci√≥n creada con c√≥digos QR individuales'
        }]
    };
    
    // Guardar retenci√≥n
    retenciones.push(retencion);
    
    // üî• GUARDAR EN FIREBASE
    await saveToFirebase('retenciones', JSON.stringify(arrayToFirebaseObject(retenciones)));
    
    // Incrementar contador
    retencionCounter++;
    await saveToFirebase('retencionCounter', retencionCounter.toString());
    
    alert(`‚úÖ Retenci√≥n ${folio} creada exitosamente\n\n‚Ä¢ ${validatedShots.length} piezas retenidas\n‚Ä¢ Estado: Activa\n\nLas piezas han sido marcadas como "En Retenci√≥n" temporalmente.`);
    
    // Limpiar formulario y actualizar
    clearRetencionForm();
    generateNewRetencionFolio();
    refreshRetencionList();
    retencionValidatedCodes = [];
    updateRetencionCodesDisplay();
}
// üîÑ FUNCI√ìN refreshRetencionList ACTUALIZADA
async function refreshRetencionList() {
    // Cargar datos m√°s recientes desde Firebase
    const retencionesData = await loadFromFirebase('retenciones');
    if (retencionesData) {
        retenciones = firebaseObjectToArray(JSON.parse(retencionesData));
    }
    
    const tbody = document.getElementById('retenciones-table-body');
    
    if (retenciones.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">‚è∏Ô∏è No hay retenciones registradas</td></tr>';
        return;
    }
    
    tbody.innerHTML = retenciones.map(retencion => {
        const estadoBadge = getRetencionEstadoBadge(retencion.estado);
        const motivoTexto = getMotivoTexto(retencion.motivo);
        
        return `
            <tr>
                <td><strong>${retencion.folio}</strong></td>
                <td>${retencion.fechaProduccion}</td>
                <td>${retencion.producto}</td>
                <td>${retencion.molde}</td>
                <td>${retencion.shotInicial} - ${retencion.shotFinal}</td>
                <td style="text-align: center;">${retencion.totalShots}</td>
                <td>${motivoTexto}</td>
                <td>${estadoBadge}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewRetencionDetails('${retencion.folio}')">üëÅÔ∏è Ver</button>
                    ${retencion.estado === 'ACTIVA' ? 
                        `<button class="btn btn-success btn-sm" onclick="resolveRetencion('${retencion.folio}')">‚úÖ Resolver</button>` : 
                        ''}
                </td>
            </tr>
        `;
    }).join('');
}
function getRetencionEstadoBadge(estado) {
    const badges = {
        'ACTIVA': '<span style="background: #ffc107; color: black; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚è∏Ô∏è Activa</span>',
        'RESUELTA': '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚úÖ Resuelta</span>',
        'CANCELADA': '<span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">‚ùå Cancelada</span>'
    };
    return badges[estado] || badges['ACTIVA'];
}

function getMotivoTexto(motivo) {
    const motivos = {
        'INSPECCION_CALIDAD': 'Inspecci√≥n de Calidad',
        'DEFECTO_SOSPECHOSO': 'Defecto Sospechoso',
        'REVISION_PROCESO': 'Revisi√≥n de Proceso',
        'AUDITORIA_INTERNA': 'Auditor√≠a Interna',
        'RECLAMO_CLIENTE': 'Reclamo de Cliente'
    };
    return motivos[motivo] || motivo;
}

function clearRetencionForm() {
    // Elementos b√°sicos del formulario
    const elements = {
        'retencion-fecha-produccion': '',
        'retencion-creado-por': '',
        'retencion-producto': '',
        'retencion-shot-code': '', // ‚Üê NUEVO elemento
        'retencion-motivo': '',
        'retencion-motivo-otro': '',
        'retencion-observaciones': ''
    };
    
    // Limpiar campos que existen
    Object.keys(elements).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.value = elements[id];
        } else {
            console.warn(`‚ö†Ô∏è Elemento no encontrado: ${id}`);
        }
    });
    
    // Limpiar molde (select especial)
    const moldeSelect = document.getElementById('retencion-molde');
    if (moldeSelect) {
        moldeSelect.innerHTML = '<option value="">Primero selecciona un producto...</option>';
    }
    
    // Ocultar campo "otro motivo"
    const otroMotivoDiv = document.getElementById('retencion-otro-motivo');
    if (otroMotivoDiv) {
        otroMotivoDiv.style.display = 'none';
    }
    
    // Limpiar resultado de validaci√≥n
    const validationResult = document.getElementById('retencion-validation-result');
    if (validationResult) {
        validationResult.innerHTML = '';
    }
    
    // Deshabilitar bot√≥n de crear
    const createBtn = document.getElementById('create-retencion-btn');
    if (createBtn) {
        createBtn.disabled = true;
    }
    
    // Limpiar c√≥digos QR
    retencionValidatedCodes = [];
    updateRetencionCodesDisplay();
    
    // Detener c√°mara si est√° activa
    if (retencionScanner) {
        stopRetencionCamera();
        retencionCameraMode = false;
        const cameraText = document.getElementById('retencion-camera-mode-text');
        const cameraSection = document.getElementById('retencion-camera-section');
        const manualSection = document.getElementById('retencion-manual-entry-section');
        
        if (cameraText) cameraText.textContent = 'üì∑ Activar C√°mara';
        if (cameraSection) cameraSection.style.display = 'none';
        if (manualSection) manualSection.style.display = 'block';
    }
}
function viewRetencionDetails(folio) {
    const retencion = retenciones.find(r => r.folio === folio);
    if (!retencion) return;
    
    const fechaCreacion = new Date(retencion.fechaCreacion).toLocaleString();
    const motivoTexto = getMotivoTexto(retencion.motivo);
    
    // Crear breakdown por almac√©n
    const almacenBreakdown = {};
    retencion.shots.forEach(shot => {
        if (!almacenBreakdown[shot.almacen]) {
            almacenBreakdown[shot.almacen] = 0;
        }
        almacenBreakdown[shot.almacen]++;
    });
    
    let almacenInfo = '';
    Object.entries(almacenBreakdown).forEach(([almacen, cantidad]) => {
        almacenInfo += `‚Ä¢ ${almacen}: ${cantidad} piezas\n`;
    });
    
    // Crear historial
    let historialTexto = '';
    retencion.historial.forEach(entrada => {
        const fecha = new Date(entrada.fecha).toLocaleString();
        historialTexto += `‚Ä¢ ${fecha} - ${entrada.accion} por ${entrada.responsable}\n  ${entrada.comentario}\n\n`;
    });
    
    const mensaje = `üìã DETALLES DE RETENCI√ìN: ${folio}
    
üìÖ Fecha de Creaci√≥n: ${fechaCreacion}
üìÖ Fecha de Producci√≥n: ${retencion.fechaProduccion}
üè≠ Producto: ${retencion.producto}
üîß Molde: ${retencion.molde}
üéØ Rango de Shots: ${retencion.shotInicial} - ${retencion.shotFinal}
üì¶ Total de Piezas: ${retencion.totalShots}
‚ö†Ô∏è Motivo: ${motivoTexto}
üë§ Creado por: ${retencion.creadoPor}
üìä Estado: ${retencion.estado}

üì¶ DISTRIBUCI√ìN POR ALMAC√âN:
${almacenInfo}

üìù OBSERVACIONES:
${retencion.observaciones || 'Sin observaciones'}

üìú HISTORIAL:
${historialTexto}`;
    
    alert(mensaje);
}
function resolveRetencion(folio) {
    const retencion = retenciones.find(r => r.folio === folio);
    if (!retencion) return;
    
    if (retencion.estado !== 'ACTIVA') {
        alert('‚ùå Solo se pueden resolver retenciones activas');
        return;
    }
    
    // Crear modal de resoluci√≥n
    const modalHTML = `
        <div id="resolve-retencion-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
            <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90%; overflow-y: auto;">
                <h3>‚úÖ Resolver Retenci√≥n: ${folio}</h3>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <strong>üì¶ Informaci√≥n de la Retenci√≥n:</strong><br>
                    ‚Ä¢ Producto: ${retencion.producto}<br>
                    ‚Ä¢ Molde: ${retencion.molde}<br>
                    ‚Ä¢ Shots: ${retencion.shotInicial} - ${retencion.shotFinal}<br>
                    ‚Ä¢ Total Piezas: ${retencion.totalShots}<br>
                    ‚Ä¢ Motivo: ${getMotivoTexto(retencion.motivo)}
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label><strong>üìã Acci√≥n a Realizar:</strong></label>
                    <select id="resolve-action" onchange="handleResolveActionChange()" style="width: 100%; padding: 8px; margin-top: 5px;">
                        <option value="">Seleccionar acci√≥n...</option>
                        <option value="LIBERAR">‚úÖ Liberar Piezas (Conformes)</option>
                        <option value="SCRAP">üóëÔ∏è Enviar a Scrap (No Conformes)</option>
                        <option value="REPROCESO">üîÑ Enviar a Reproceso</option>
                        <option value="DEVOLVER_CLIENTE">üì¶ Devolver a Cliente</option>
                        <option value="CANCELAR">‚ùå Cancelar Retenci√≥n</option>
                    </select>
                </div>
                
                <div id="resolve-details" style="margin-bottom: 20px;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label><strong>üë§ Responsable de la Resoluci√≥n:</strong></label>
                    <input type="text" id="resolve-responsable" placeholder="Nombre del responsable" style="width: 100%; padding: 8px; margin-top: 5px;" required>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label><strong>üìù Comentarios de Resoluci√≥n:</strong></label>
                    <textarea id="resolve-comentarios" rows="4" placeholder="Describe el resultado de la investigaci√≥n y la acci√≥n tomada..." style="width: 100%; padding: 8px; margin-top: 5px;" required></textarea>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="handleConfirmResolveRetencion('${folio}')" class="btn btn-success">‚úÖ Confirmar Resoluci√≥n</button>
                    <button onclick="closeResolveModal()" class="btn btn-secondary" style="margin-left: 10px;">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function handleResolveActionChange() {
    const action = document.getElementById('resolve-action').value;
    const detailsDiv = document.getElementById('resolve-details');
    
    detailsDiv.innerHTML = '';
    
    switch (action) {
        case 'LIBERAR':
            detailsDiv.innerHTML = `
                <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                    <strong>‚úÖ Liberar Piezas</strong><br>
                    Las piezas ser√°n marcadas como conformes y regresar√°n a su estado original en el almac√©n.
                </div>
            `;
            break;
            
        case 'SCRAP':
            detailsDiv.innerHTML = `
                <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                    <strong>üóëÔ∏è Enviar a Scrap</strong><br>
                    Las piezas ser√°n marcadas como no conformes y enviadas al √°rea de scrap.
                    <div style="margin-top: 10px;">
                        <label>üìã Defecto Encontrado:</label>
                        <select id="resolve-defecto" style="width: 100%; padding: 5px; margin-top: 5px;">
                            <option value="">Seleccionar defecto...</option>
                            <option value="DIMENSIONAL">üìè Defecto Dimensional</option>
                            <option value="VISUAL">üëÅÔ∏è Defecto Visual</option>
                            <option value="MATERIAL">üß± Defecto de Material</option>
                            <option value="PROCESO">‚öôÔ∏è Defecto de Proceso</option>
                            <option value="OTRO">üìù Otro</option>
                        </select>
                    </div>
                </div>
            `;
            break;
            
        case 'REPROCESO':
            detailsDiv.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 5px;">
                    <strong>üîÑ Enviar a Reproceso</strong><br>
                    Las piezas ser√°n enviadas al √°rea de reproceso para correcci√≥n.
                    <div style="margin-top: 10px;">
                        <label>üîß Tipo de Reproceso:</label>
                        <select id="resolve-reproceso" style="width: 100%; padding: 5px; margin-top: 5px;">
                            <option value="">Seleccionar tipo...</option>
                            <option value="MAQUINADO">üîß Maquinado Adicional</option>
                            <option value="PULIDO">‚ú® Pulido/Acabado</option>
                            <option value="SOLDADURA">üî• Soldadura/Reparaci√≥n</option>
                            <option value="OTRO">üìù Otro</option>
                        </select>
                    </div>
                </div>
            `;
            break;
            
        case 'DEVOLVER_CLIENTE':
            detailsDiv.innerHTML = `
                <div style="background: #cce7ff; padding: 15px; border-radius: 5px;">
                    <strong>üì¶ Devolver a Cliente</strong><br>
                    Las piezas ser√°n devueltas al cliente para su disposici√≥n.
                    <div style="margin-top: 10px;">
                        <label>üìã Motivo de Devoluci√≥n:</label>
                        <input type="text" id="resolve-devolucion" placeholder="Especificar motivo..." style="width: 100%; padding: 5px; margin-top: 5px;">
                    </div>
                </div>
            `;
            break;
            
        case 'CANCELAR':
            detailsDiv.innerHTML = `
                <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                    <strong>‚ùå Cancelar Retenci√≥n</strong><br>
                    La retenci√≥n ser√° cancelada y las piezas regresar√°n a su estado original.
                    <div style="margin-top: 10px;">
                        <label>üìã Motivo de Cancelaci√≥n:</label>
                        <input type="text" id="resolve-cancelacion" placeholder="¬øPor qu√© se cancela la retenci√≥n?" style="width: 100%; padding: 5px; margin-top: 5px;">
                    </div>
                </div>
            `;
            break;
    }
}
// üîÑ FUNCI√ìN confirmResolveRetencion ACTUALIZADA
async function confirmResolveRetencion(folio) {
    const action = document.getElementById('resolve-action').value;
    const responsable = document.getElementById('resolve-responsable').value;
    const comentarios = document.getElementById('resolve-comentarios').value;
    
    if (!action) {
        alert('‚ö†Ô∏è Selecciona una acci√≥n a realizar');
        return;
    }
    
    if (!responsable) {
        alert('‚ö†Ô∏è Ingresa el nombre del responsable');
        return;
    }
    
    if (!comentarios) {
        alert('‚ö†Ô∏è Ingresa comentarios sobre la resoluci√≥n');
        return;
    }
    
    // Validaciones espec√≠ficas por acci√≥n
    let accionDetalle = '';
    switch (action) {
        case 'SCRAP':
            const defecto = document.getElementById('resolve-defecto').value;
            if (!defecto) {
                alert('‚ö†Ô∏è Selecciona el tipo de defecto encontrado');
                return;
            }
            accionDetalle = `Defecto: ${defecto}`;
            break;
            
        case 'REPROCESO':
            const reproceso = document.getElementById('resolve-reproceso').value;
            if (!reproceso) {
                alert('‚ö†Ô∏è Selecciona el tipo de reproceso');
                return;
            }
            accionDetalle = `Tipo: ${reproceso}`;
            break;
            
        case 'DEVOLVER_CLIENTE':
            const devolucion = document.getElementById('resolve-devolucion').value;
            if (!devolucion) {
                alert('‚ö†Ô∏è Especifica el motivo de devoluci√≥n');
                return;
            }
            accionDetalle = `Motivo: ${devolucion}`;
            break;
            
        case 'CANCELAR':
            const cancelacion = document.getElementById('resolve-cancelacion').value;
            if (!cancelacion) {
                alert('‚ö†Ô∏è Especifica el motivo de cancelaci√≥n');
                return;
            }
            accionDetalle = `Motivo: ${cancelacion}`;
            break;
    }
    
    // Encontrar y actualizar la retenci√≥n
    const retencionIndex = retenciones.findIndex(r => r.folio === folio);
    if (retencionIndex === -1) return;
    
    const retencion = retenciones[retencionIndex];
    
    // Actualizar estado
    const nuevoEstado = action === 'CANCELAR' ? 'CANCELADA' : 'RESUELTA';
    retenciones[retencionIndex].estado = nuevoEstado;
    retenciones[retencionIndex].fechaResolucion = new Date().toISOString();
    retenciones[retencionIndex].accionTomada = action;
    retenciones[retencionIndex].accionDetalle = accionDetalle;
    retenciones[retencionIndex].resueltoePor = responsable;
    retenciones[retencionIndex].comentariosResolucion = comentarios;
    
    // Agregar al historial
    retenciones[retencionIndex].historial.push({
        fecha: new Date().toISOString(),
        accion: 'RESOLUCION',
        responsable: responsable,
        comentario: `${getActionText(action)}. ${comentarios}${accionDetalle ? '. ' + accionDetalle : ''}`
    });
    
    // üî• GUARDAR EN FIREBASE
    await saveToFirebase('retenciones', JSON.stringify(arrayToFirebaseObject(retenciones)));
    
    // Crear hoja de scrap autom√°ticamente si corresponde
    if (action === 'SCRAP') {
        await createScrapFromRetencion(retencion, responsable);
    }
    
    alert(`‚úÖ Retenci√≥n ${folio} resuelta exitosamente\n\nAcci√≥n: ${getActionText(action)}\nPiezas procesadas: ${retencion.totalShots}`);
    
    closeResolveModal();
    refreshRetencionList();
}
// Agrega esta funci√≥n despu√©s de las funciones de retenci√≥n existentes
async function liberateFromRetencion(retencionFolio, targetWarehouse, reason) {
    try {
        // Encontrar elementos en retenci√≥n
        const itemsInRetencion = inventory.filter(item => item.retencionFolio === retencionFolio);
        const palletsInRetencion = pallets.filter(pallet => pallet.retencionFolio === retencionFolio);
        
        // Actualizar estado de items
        itemsInRetencion.forEach(item => {
            item.warehouse = targetWarehouse;
            item.state = getStateFromWarehouse(targetWarehouse);
            item.retencionFolio = null;
            item.lastMovement = new Date();
            item.liberationReason = reason;
        });
        
        // Actualizar estado de tarimas
        palletsInRetencion.forEach(pallet => {
            pallet.warehouse = targetWarehouse;
            pallet.state = targetWarehouse;
            pallet.retencionFolio = null;
            pallet.liberationDate = new Date().toISOString();
            pallet.liberationReason = reason;
        });
        
        // Guardar cambios
        await saveToFirebase('inventory', JSON.stringify(arrayToFirebaseObject(inventory)));
        await saveToFirebase('pallets', JSON.stringify(arrayToFirebaseObject(pallets)));
        
        console.log(`‚úÖ ${itemsInRetencion.length} items y ${palletsInRetencion.length} tarimas liberadas de retenci√≥n`);
        updateAllDisplays();
        
    } catch (error) {
        console.error('Error liberando de retenci√≥n:', error);
        throw error;
    }
}

function getActionText(action) {
    const actions = {
        'LIBERAR': 'Piezas liberadas (conformes)',
        'SCRAP': 'Piezas enviadas a scrap',
        'REPROCESO': 'Piezas enviadas a reproceso',
        'DEVOLVER_CLIENTE': 'Piezas devueltas a cliente',
        'CANCELAR': 'Retenci√≥n cancelada'
    };
    return actions[action] || action;
}

function closeResolveModal() {
    const modal = document.getElementById('resolve-retencion-modal');
    if (modal) {
        modal.remove();
    }
}
// üîÑ FUNCI√ìN createScrapFromRetencion ACTUALIZADA
async function createScrapFromRetencion(retencion, responsable) {
    const currentDate = new Date();
    const folio = `SCR-${currentDate.getFullYear().toString().slice(-2)}${String(currentDate.getMonth() + 1).padStart(2, '0')}${String(currentDate.getDate()).padStart(2, '0')}-${String(folioCounter).padStart(4, '0')}`;
    
    // Convertir shots de retenci√≥n a formato de scrap
    const scrapShots = retencion.shots.map(shot => ({
        shot: shot.shot,
        codigo: shot.codigo,
        motivo: 'Resultado de Retenci√≥n ' + retencion.folio,
        almacenOrigen: shot.almacen
    }));
    
    const scrapSheet = {
        folio: folio,
        fechaOperacion: retencion.fechaProduccion,
        fechaCreacion: new Date().toLocaleString(),
        sectorTrabajo: 'Control de Calidad',
        numeroProducto: retencion.producto,
        nombreProducto: getProductName(retencion.producto),
        moldeProducto: retencion.molde,
        creadoPor: responsable,
        almacenOrigen: 'Multiple (Ver shots individuales)',
        shots: scrapShots,
        observaciones: `Generado autom√°ticamente desde retenci√≥n ${retencion.folio}. Motivo original: ${getMotivoTexto(retencion.motivo)}`,
        estado: 'ABIERTA',
        evidencia: null,
        origenRetencion: retencion.folio
    };
    
    scrapSheets.push(scrapSheet);
    
    // üî• GUARDAR EN FIREBASE
    await saveToFirebase('scrapSheets', JSON.stringify(arrayToFirebaseObject(scrapSheets)));
    
    folioCounter++;
    await saveToFirebase('folioCounter', folioCounter.toString());
    
    alert(`üìã Hoja de scrap ${folio} creada autom√°ticamente\n\nPuedes gestionarla desde la pesta√±a "Gestionar Hojas"`);
}
// üîÑ FUNCI√ìN loadUsers ACTUALIZADA
async function loadUsers() {
    try {
        const usersData = await loadFromFirebase('usuarios');
        console.log('üì• Datos de usuarios cargados:', usersData); // DEBUG
        
        if (usersData) {
            // Si es un string JSON, parsearlo
            if (typeof usersData === 'string') {
                usuarios = firebaseObjectToArray(JSON.parse(usersData));
            } 
            // Si es un objeto, convertirlo a array
            else if (typeof usersData === 'object' && usersData !== null) {
                usuarios = firebaseObjectToArray(usersData);
            }
            // Si ya es un array, usarlo directamente
            else if (Array.isArray(usersData)) {
                usuarios = usersData;
            }
            else {
                usuarios = [];
            }
        } else {
            usuarios = [];
        }
        
        console.log(`‚úÖ Usuarios cargados: ${usuarios.length}`, usuarios); // DEBUG
        
        // Asegurar que usuarios sea siempre un array
        if (!Array.isArray(usuarios)) {
            console.warn('‚ö†Ô∏è usuarios no es array, convirtiendo...');
            usuarios = [];
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando usuarios:', error);
        usuarios = []; // Fallback seguro
    }
}

// Inicializar con datos de Firebase
async function initUserSystem() {
    console.log('üë• Iniciando sistema de usuarios...');
    
    // Inicializar usuarios como array vac√≠o
    usuarios = [];
    
    // Cargar usuarios ANTES de verificar sesi√≥n
    await loadUsers();
    
    // Crear usuario admin por defecto si no existe
    if (usuarios.length === 0) {
        await createDefaultAdmin();
    }
    
    // AHORA verificar si hay sesi√≥n activa
    checkActiveSession();
    
    console.log('‚úÖ Sistema de usuarios inicializado');
}
// üîÑ FUNCI√ìN saveUsers ACTUALIZADA
async function saveUsers() {
    try {
        // Asegurar que usuarios sea un array antes de guardar
        if (!Array.isArray(usuarios)) {
            console.error('‚ùå usuarios no es un array:', usuarios);
            usuarios = [];
        }
        
        const dataToSave = arrayToFirebaseObject(usuarios);
        await saveToFirebase('usuarios', JSON.stringify(dataToSave));
        console.log('‚úÖ Usuarios guardados en Firebase:', usuarios.length);
    } catch (error) {
        console.error('‚ùå Error guardando usuarios:', error);
        throw error;
    }
}
// Crear admin por defecto
async function createDefaultAdmin() {
    // Asegurar que usuarios sea un array
    if (!Array.isArray(usuarios)) {
        usuarios = [];
    }
    
    // Verificar si ya existe el admin
    const existingAdmin = usuarios.find(u => u.username === 'Edgar.Mejia');
    if (existingAdmin) {
        console.log('üëë Admin ya existe');
        return;
    }
    
    const defaultAdmin = {
        id: 'admin-001',
        username: 'Edgar.Mejia',
        password: 'Admin2025!',
        nombre: 'Edgar Isa√≠as',
        apellido: 'S√°nchez Mej√≠a',
        email: 'sanchezei@halmex.com.mx',
        rol: ROLES.ADMIN,
        fechaCreacion: new Date().toISOString(),
        activo: true,
        ultimoAcceso: null
    };
    
    usuarios.push(defaultAdmin);
    await saveUsers();
    
    console.log('üëë Usuario admin creado');
}
function checkActiveSession() {
    try {
        const savedSession = localStorage.getItem('currentSession');
        if (savedSession) {
            const session = JSON.parse(savedSession);
            
            // Asegurar que usuarios sea un array antes de buscar
            if (!Array.isArray(usuarios)) {
                console.log('üë• Usuarios no es array, cargando...');
                showLoginScreen();
                return;
            }
            
            const user = usuarios.find(u => u.id === session.userId);
            
            if (user && user.activo) {
                currentUser = user;
                isLoggedIn = true;
                console.log('‚úÖ Sesi√≥n restaurada para:', user.nombre);
                showMainApp();
                return;
            } else {
                console.log('‚ö†Ô∏è Usuario no encontrado o inactivo');
            }
        } else {
            console.log('üìù No hay sesi√≥n guardada');
        }
        
        showLoginScreen();
    } catch (error) {
        console.error('‚ùå Error verificando sesi√≥n:', error);
        showLoginScreen();
    }
}
// Mostrar pantalla de login
function showLoginScreen() {
    // Ocultar contenido principal si existe
    const container = document.querySelector('.container');
    if (container) {
        container.style.display = 'none';
    }
    
    // Remover barra de usuario si existe
    const userBar = document.getElementById('user-bar');
    if (userBar) {
        userBar.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', `
        <div id="login-container" style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; font-family: Arial, sans-serif; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;">
            <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="color: #333; margin: 0; font-size: 28px;">üè≠ Control de Almac√©n</h1>
                    <p style="color: #666; margin: 10px 0 0 0;">Sistema de Gesti√≥n</p>
                </div>
                
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; color: #333; font-weight: bold;">üë§ Usuario:</label>
                        <input type="text" id="login-username" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;" placeholder="Ingresa tu usuario">
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <label style="display: block; margin-bottom: 5px; color: #333; font-weight: bold;">üîê Contrase√±a:</label>
                        <input type="password" id="login-password" required style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;" placeholder="Ingresa tu contrase√±a">
                    </div>
                    
                    <button type="submit" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
                        üöÄ Iniciar Sesi√≥n
                    </button>
                </form>
                
                <div id="login-error" style="margin-top: 20px; padding: 10px; background: #ffebee; color: #c62828; border-radius: 5px; display: none; text-align: center;">
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 5px; font-size: 14px; text-align: center;">
                    <strong>üîê Sistema Seguro</strong><br>
                    <small>Contacta al administrador para obtener acceso</small>
                </div>
            </div>
        </div>
    `);
}
async function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    
    // DEBUG: Verificar estado de usuarios
    console.log('üîç DEBUG Login - usuarios:', usuarios);
    console.log('üîç DEBUG Login - es array?', Array.isArray(usuarios));
    console.log('üîç DEBUG Login - longitud:', usuarios?.length);
    
    // Asegurar que usuarios sea un array
    if (!Array.isArray(usuarios)) {
        console.error('‚ùå usuarios no es array en login:', usuarios);
        usuarios = [];
        await loadUsers(); // Intentar recargar
    }
    
    // Buscar usuario
    const user = usuarios.find(u => u.username === username && u.activo);
    
    if (!user) {
        showLoginError('‚ùå Usuario no encontrado o inactivo');
        return;
    }
    
    // Verificar contrase√±a (en producci√≥n usar hash)
    if (user.password !== password) {
        showLoginError('‚ùå Contrase√±a incorrecta');
        return;
    }
    
    // Login exitoso
    currentUser = user;
    isLoggedIn = true;
    
    // Actualizar √∫ltimo acceso
    user.ultimoAcceso = new Date().toISOString();
    await saveUsers();
    
    // Guardar sesi√≥n
    const session = {
        userId: user.id,
        loginTime: new Date().toISOString()
    };
    localStorage.setItem('currentSession', JSON.stringify(session));
    
    // Mostrar aplicaci√≥n principal
    showMainApp();
}

// Mostrar error de login
function showLoginError(message) {
    const errorDiv = document.getElementById('login-error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

// Mostrar aplicaci√≥n principal
function showMainApp() {
    // Ocultar pantalla de login si existe
    const loginContainer = document.getElementById('login-container');
    if (loginContainer) {
        loginContainer.remove();
    }
    
    // Crear barra superior con info del usuario
    const userBar = `
        <div id="user-bar" style="background: #333; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000;">
            <div>
                <strong>üè≠ Control de Almac√©n</strong> - Fundici√≥n 1.3
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span>üë§ ${currentUser.nombre} ${currentUser.apellido} (${ROLE_NAMES[currentUser.rol]})</span>
                ${hasPermission('usuarios') ? '<button onclick="showUsersModal()" style="background: #4caf50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">üë• Usuarios</button>' : ''}
                <button onclick="logout()" style="background: #f44336; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                      üö™ Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    `;
    
    // Insertar barra de usuario al inicio del body
    document.body.insertAdjacentHTML('afterbegin', userBar);
    
    // Asegurar que el contenido principal sea visible
    const container = document.querySelector('.container');
    if (container) {
        container.style.display = 'block';
        container.style.visibility = 'visible';
    }
    
    // Aplicar permisos a la aplicaci√≥n existente
    applyPermissions();
    // 4. Inicializar sistemas espec√≠ficos solo si el usuario est√° logueado
        console.log('üîç DEBUG showMainApp - currentUser:', currentUser, 'isLoggedIn:', isLoggedIn);
        if (currentUser) {
            console.log('‚öôÔ∏è Inicializando sistemas espec√≠ficos...');
            
            // Inicializar sistema de scrap
            generateNewFolio();
            setTodayDate();
            refreshSheetsList();
            
            // Inicializar sistema de retenciones
            initializeRetencionSystem();
            generateNewRetencionFolio();
            refreshRetencionList();
            
// EVENT LISTENERS PRINCIPALES
// Event listeners para pesta√±as
document.querySelectorAll('.nav-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        console.log('üñ±Ô∏è Click en pesta√±a:', tabName); // DEBUG
        showTab(tabName);
	    // üîÑ CORREGIR: Forzar actualizaci√≥n de pesta√±as problem√°ticas
        if (tabName === 'theoretical') {
        setTimeout(() => {
        document.getElementById('theoretical').style.display = 'block';
        document.getElementById('theoretical').style.visibility = 'visible';
    }, 100);
        } else if (tabName === 'scrap-retention') {
        setTimeout(() => {
        document.getElementById('scrap-retention').style.display = 'block';
        document.getElementById('scrap-retention').style.visibility = 'visible';
        showSubTab('new-scrap');
    }, 100);
}
        
        // üî• INICIALIZAR DATOS ESPEC√çFICOS POR PESTA√ëA
        if (tabName === 'production') {
            // Cargar y mostrar tabla de reportes cuando se accede a producci√≥n
            setTimeout(() => {
                console.log('üìä Inicializando tabla de reportes de producci√≥n...');
                refreshProductionReports();
            }, 500);
        } else if (tabName === 'dashboard') {
            // Actualizar gr√°ficos del dashboard
            setTimeout(() => {
                console.log('üìà Actualizando gr√°ficos del dashboard...');
                initializeDashboardCharts();
            }, 300);
        } else if (tabName === 'scrap-retention') {
            // Asegurar que se muestre la primera sub-pesta√±a
            setTimeout(() => {
                showSubTab('new-scrap');
                refreshSheetsList();
            }, 100);
        } else if (tabName === 'pallets') {
            // Actualizar tabla de gesti√≥n de inventario
            setTimeout(() => {
                updatePalletsTable();
                if (document.getElementById('individual-management')?.classList.contains('active')) {
                    filterIndividualItems();
                }
            }, 100);
        } else if (tabName === 'inventory') {
            // Actualizar inventario detallado
            setTimeout(() => {
                updateDetailedInventory();
            }, 100);
        }
    });
});
            
            // Event listeners para QR
            const qrInput = document.getElementById('qr-input');
            if (qrInput) {
                qrInput.addEventListener('input', analyzeQRCode);
                qrInput.addEventListener('paste', function(e) {
                    setTimeout(function() {
                        const content = e.target.value.trim();
                        if (content && (content.includes('|') || content.length >= 13)) {
                            analyzeQRCode();
                        }
                    }, 100);
                });
            }
            
            // Event listeners para selecci√≥n de almac√©n
            const inventoryTypeSelect = document.getElementById('inventory-type');
            if (inventoryTypeSelect) {
                inventoryTypeSelect.addEventListener('change', updateFormSections);
            }
            
            const warehouseSelector = document.getElementById('warehouse-selector');
            if (warehouseSelector) {
                warehouseSelector.addEventListener('click', function(e) {
                    if (e.target.classList.contains('warehouse-btn')) {
                        this.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                            btn.classList.remove('selected');
                        });
                        e.target.classList.add('selected');
                        selectedWarehouse = e.target.dataset.warehouse;
                    }
                });
            }
            
            const movementSelector = document.getElementById('movement-selector');
            if (movementSelector) {
                movementSelector.addEventListener('click', function(e) {
                    if (e.target.classList.contains('warehouse-btn')) {
                        this.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                            btn.classList.remove('selected');
                        });
                        e.target.classList.add('selected');
                        selectedMovement = e.target.dataset.movement;
                    }
                });
            }
            
            // Event listeners para retenciones
            const retencionMotivo = document.getElementById('retencion-motivo');
            if (retencionMotivo) {
                retencionMotivo.addEventListener('change', function() {
                    const otroMotivoDiv = document.getElementById('retencion-otro-motivo');
                    if (otroMotivoDiv) {
                        if (this.value === 'OTRO') {
                            otroMotivoDiv.style.display = 'block';
                        } else {
                            otroMotivoDiv.style.display = 'none';
                        }
                    }
                });
            }
            
            // Event listeners para scrap
            const scrapReasonSelect = document.getElementById('scrap-reason');
            if (scrapReasonSelect) {
                scrapReasonSelect.addEventListener('change', function() {
                    const otherContainer = document.getElementById('other-reason-container');
                    if (otherContainer) {
                        if (this.value === 'OTRO') {
                            otherContainer.style.display = 'block';
                        } else {
                            otherContainer.style.display = 'none';
                            const otherReasonInput = document.getElementById('other-reason');
                            if (otherReasonInput) {
                                otherReasonInput.value = '';
                            }
                        }
                    }
                });
            }
            
            // EVENT LISTENERS PARA EL GENERADOR
            // Event listener para cambios en el textarea de c√≥digos
            const codigosTextarea = document.getElementById('gen-codigos');
            if (codigosTextarea) {
                codigosTextarea.addEventListener('input', function() {
                    console.log('Textarea cambi√≥, procesando c√≥digos...'); // DEBUG
                    
                    // Obtener l√≠neas del textarea
                    const lines = this.value.split('\n').filter(line => line.trim().length > 0);
                    console.log('L√≠neas encontradas:', lines); // DEBUG
                    
                    // Resetear arrays y contadores
                    const oldGeneratedCodes = [...generatedCodes]; // Backup
                    generatedCodes = [];
                    duplicateAttempts = 0;
                    
                    // Procesar cada l√≠nea
                    const seenCodes = new Set();
                    
                    lines.forEach((line, index) => {
                        const code = line.trim();
                        if (code) {
                            console.log(`Procesando l√≠nea ${index + 1}: ${code}`); // DEBUG
                            
                            if (seenCodes.has(code)) {
                                // Es duplicado dentro del mismo textarea
                                duplicateAttempts++;
                                console.log(`Duplicado detectado en textarea: ${code}`); // DEBUG
                            } else {
                                // Es √∫nico, agregar
                                seenCodes.add(code);
                                
                                const isValid = (code.length === 13 || code.length === 17);
                                const type = code.length === 13 ? 'UPR' : code.length === 17 ? 'LWR' : 'UNKNOWN';
                                
                                generatedCodes.push({
                                    code: code,
                                    type: type,
                                    valid: isValid,
                                    timestamp: new Date()
                                });
                            }
                        }
                    });
                    
                    console.log('C√≥digos finales:', generatedCodes); // DEBUG
                    console.log('Duplicados detectados:', duplicateAttempts); // DEBUG
                    
                    // Actualizar interfaz
                    updateCodesValidationList();
                    updateValidationInfo();
                    updateGenerateButton();
                });
            }
            
            // Event listeners para campos del formulario generador
            const zonaInput = document.getElementById('gen-zona');
            if (zonaInput) {
                zonaInput.addEventListener('input', function() {
                    console.log('Zona cambi√≥ a:', this.value); // DEBUG
                    updateGenerateButton();
                });
            }
            
            const tipoSelect = document.getElementById('gen-tipo');
            if (tipoSelect) {
                tipoSelect.addEventListener('change', function() {
                    console.log('Tipo cambi√≥ a:', this.value); // DEBUG
                    updateGenerateButton();
                });
            }
		// Event listener para cambio de producto (actualizar l√≠mites del shot input)
const numeroProductoSelect = document.getElementById('numero-producto');
if (numeroProductoSelect) {
    numeroProductoSelect.addEventListener('change', function() {
        updateProductInfo(); // Funci√≥n existente
        updateShotInputLimits(); // Nueva funci√≥n
    });
}

// Event listener para validar input de shot en tiempo real
const shotInput = document.getElementById('shot-number');
if (shotInput) {
    shotInput.addEventListener('input', validateShotInput);
    shotInput.addEventListener('paste', function() {
        // Validar despu√©s de pegar
        setTimeout(validateShotInput, 100);
    });
}
            // 5. Verificar disponibilidad de c√°mara
            console.log('üì∑ Verificando c√°mara...');
            checkCameraAvailability();
            
            // 6. Inicializar modo del generador
            showScannerMode();
            
            // 7. Cargar datos de muestra si es necesario (solo para desarrollo)
            if (inventory.length === 0) {
                console.log('üì¶ Cargando datos de muestra...');
                // loadSampleData(); // Se dehabilita temporalmente.
            }
            
            // 8. Actualizar todas las visualizaciones
            console.log('üîÑ Actualizando displays...');
            updateAllDisplays();
    }
    
    // Inicializar la aplicaci√≥n si no se ha hecho
    if (typeof updateAllDisplays === 'function') {
        updateAllDisplays();
    }
}
// Cerrar sesi√≥n
function logout() {
    if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        currentUser = null;
        isLoggedIn = false;
        localStorage.removeItem('currentSession');
        showLoginScreen();
    }
}

// Verificar permisos
function hasPermission(permission) {
    if (!currentUser) return false;
    return PERMISSIONS[currentUser.rol].includes(permission);
}
function applyPermissions() {
    // Mapeo de pesta√±as a permisos
    const tabPermissions = {
        'dashboard': 'dashboard',
        'scanner': 'scanner', 
        'inventory': 'inventory',
        'pallets': 'pallets',
        'production': 'production',
        'theoretical': 'theoretical',
        'scrap-retention': 'scrap-retention'
    };
    
    // Ocultar pesta√±as seg√∫n permisos del rol
    document.querySelectorAll('.nav-tab').forEach(tab => {
        const tabName = tab.getAttribute('data-tab');
        const permission = tabPermissions[tabName];
        
        // Verificar si el rol tiene permiso para esta pesta√±a
        if (permission && !PERMISSIONS[currentUser.rol].includes(permission)) {
            tab.style.display = 'none';
        }
    });
    
    // Mostrar primera pesta√±a disponible si dashboard no est√° disponible
    if (!PERMISSIONS[currentUser.rol].includes('dashboard')) {
        const firstAvailableTab = document.querySelector('.nav-tab:not([style*="display: none"])');
        if (firstAvailableTab) {
            firstAvailableTab.click();
        }
    }
}
function loadUsersSection() {
    const usersContent = document.getElementById('usuarios-content');
    if (!usersContent) return;
    
    usersContent.innerHTML = `
        <div class="users-section">
            <!-- Bot√≥n para crear nuevo usuario -->
            <div style="margin-bottom: 20px;">
                <button onclick="showCreateUserForm()" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    ‚ûï Crear Nuevo Usuario
                </button>
            </div>
            
            <!-- Lista de usuarios -->
            <div id="users-list">
                <h3>üìã Usuarios del Sistema</h3>
                <div id="users-table">
                    ${generateUsersTable()}
                </div>
            </div>
            
            <!-- Formulario para crear/editar usuario (oculto inicialmente) -->
            <div id="user-form-container" style="display: none;">
                <h3 id="form-title">‚ûï Crear Nuevo Usuario</h3>
                <form id="user-form" onsubmit="handleUserSubmit(event)">
                    <input type="hidden" id="user-id">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>üë§ Nombre:</label>
                            <input type="text" id="user-nombre" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label>üë§ Apellido:</label>
                            <input type="text" id="user-apellido" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>üîë Usuario:</label>
                            <input type="text" id="user-username" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label>üìß Email:</label>
                            <input type="email" id="user-email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>üîê Contrase√±a:</label>
                            <input type="password" id="user-password" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label>üé≠ Rol:</label>
                            <select id="user-rol" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Seleccionar rol...</option>
                                <option value="ADMIN">üëë Administrador</option>
                                <option value="SUPERVISOR">üë∑ Supervisor</option>
                                <option value="OPERADOR">üìã Operador</option>
                                <option value="CONSULTA">üëÅÔ∏è Consulta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label>
                            <input type="checkbox" id="user-activo" checked> ‚úÖ Usuario activo
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            üíæ Guardar Usuario
                        </button>
                        <button type="button" onclick="cancelUserForm()" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
}
function generateUsersTable() {
    if (usuarios.length === 0) {
        return '<p>No hay usuarios en el sistema.</p>';
    }
    
    let html = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr style="background: #f5f5f5;">
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">üë§ Usuario</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">üìß Email</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">üé≠ Rol</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">üìÖ √öltimo Acceso</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">‚úÖ Estado</th>
                    <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">‚öôÔ∏è Acciones</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    usuarios.forEach(user => {
        html += `
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <strong>${user.nombre} ${user.apellido}</strong><br>
                    <small>@${user.username}</small>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">${user.email}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">${ROLE_NAMES[user.rol]}</td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    ${user.ultimoAcceso ? new Date(user.ultimoAcceso).toLocaleString() : 'Nunca'}
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <span style="color: ${user.activo ? 'green' : 'red'};">
                        ${user.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}
                    </span>
                </td>
                <td style="padding: 10px; border: 1px solid #ddd;">
                    <button onclick="editUser('${user.id}')" style="background: #2196f3; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">
                        ‚úèÔ∏è Editar
                    </button>
                    ${user.id === currentUser.id ? '' : `
                        <button onclick="toggleUserStatus('${user.id}')" style="background: ${user.activo ? '#f44336' : '#4caf50'}; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">
                            ${user.activo ? '‚ùå Desactivar' : '‚úÖ Activar'}
                        </button>
                    `}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    return html;
}

function showCreateUserForm() {
    document.getElementById('user-form-container').style.display = 'block';
    document.getElementById('form-title').textContent = '‚ûï Crear Nuevo Usuario';
    document.getElementById('user-form').reset();
    document.getElementById('user-id').value = '';
    document.getElementById('user-activo').checked = true;
}

function cancelUserForm() {
    document.getElementById('user-form-container').style.display = 'none';
}

// üîÑ FUNCI√ìN handleUserSubmit ACTUALIZADA
// üîÑ FUNCI√ìN handleUserSubmit DIRECTA (sin wrappers)
async function handleUserSubmit(event) {
    event.preventDefault();
    
    console.log('üìù Enviando formulario de usuario...'); // DEBUG
    
    try {
        const userId = document.getElementById('user-id').value;
        const isEditing = !!userId;
        
        const userData = {
            id: userId || 'user-' + Date.now(),
            username: document.getElementById('user-username').value,
            password: document.getElementById('user-password').value,
            nombre: document.getElementById('user-nombre').value,
            apellido: document.getElementById('user-apellido').value,
            email: document.getElementById('user-email').value,
            rol: document.getElementById('user-rol').value,
            activo: document.getElementById('user-activo').checked,
            fechaCreacion: isEditing ? usuarios.find(u => u.id === userId).fechaCreacion : new Date().toISOString(),
            ultimoAcceso: isEditing ? usuarios.find(u => u.id === userId).ultimoAcceso : null
        };
        
        console.log('üìä Datos del usuario:', userData); // DEBUG
        
        // Verificar si el username ya existe
        const existingUser = usuarios.find(u => u.username === userData.username && u.id !== userData.id);
        if (existingUser) {
            alert('‚ùå El nombre de usuario ya existe. Por favor, elige otro.');
            return;
        }
        
        if (isEditing) {
            // Actualizar usuario existente
            const index = usuarios.findIndex(u => u.id === userId);
            usuarios[index] = userData;
        } else {
            // Crear nuevo usuario
            usuarios.push(userData);
        }
        
        console.log('üíæ Guardando usuarios...'); // DEBUG
        
        // Guardar en Firebase
        await saveUsers();
        
        console.log('‚úÖ Usuario guardado exitosamente'); // DEBUG
        
        // Cerrar formulario
        cancelUserFormInModal();
        
        // Actualizar la tabla
        const usersTable = document.getElementById('users-table');
        if (usersTable) {
            usersTable.innerHTML = generateUsersTable();
        }
        
        alert(isEditing ? '‚úÖ Usuario actualizado correctamente' : '‚úÖ Usuario creado correctamente');
        
    } catch (error) {
        console.error('‚ùå Error en handleUserSubmit:', error);
        alert('‚ùå Error guardando usuario: ' + error.message);
    }
}
function editUser(userId) {
    console.log('‚úèÔ∏è Editando usuario:', userId); // DEBUG
    
    const user = usuarios.find(u => u.id === userId);
    if (!user) return;
    
    showCreateUserFormInModal();
    
    // Llenar formulario
    document.getElementById('user-id').value = user.id;
    document.getElementById('user-username').value = user.username;
    document.getElementById('user-password').value = user.password;
    document.getElementById('user-nombre').value = user.nombre;
    document.getElementById('user-apellido').value = user.apellido;
    document.getElementById('user-email').value = user.email;
    document.getElementById('user-rol').value = user.rol;
    document.getElementById('user-activo').checked = user.activo;
    
    document.getElementById('form-title').textContent = '‚úèÔ∏è Editar Usuario';
}

// üîÑ FUNCI√ìN toggleUserStatus ACTUALIZADA
async function toggleUserStatus(userId) {
    console.log('üîÑ Cambiando estado usuario:', userId); // DEBUG
    
    try {
        const user = usuarios.find(u => u.id === userId);
        if (!user) return;
        
        const action = user.activo ? 'desactivar' : 'activar';
        if (confirm(`¬øEst√°s seguro de que quieres ${action} al usuario ${user.nombre} ${user.apellido}?`)) {
            user.activo = !user.activo;
            
            await saveUsers();
            
            // Actualizar tabla
            const usersTable = document.getElementById('users-table');
            if (usersTable) {
                usersTable.innerHTML = generateUsersTable();
            }
            
            alert(`‚úÖ Usuario ${user.activo ? 'activado' : 'desactivado'} correctamente`);
        }
    } catch (error) {
        console.error('‚ùå Error toggle status:', error);
        alert('‚ùå Error: ' + error.message);
    }
}
// Mostrar modal de gesti√≥n de usuarios
function showUsersModal() {
    const modalHTML = `
        <div id="users-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;">
            <div style="background: white; padding: 30px; border-radius: 10px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üë• Gesti√≥n de Usuarios</h3>
                    <button onclick="closeUsersModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button onclick="showCreateUserFormInModal()" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                        ‚ûï Crear Nuevo Usuario
                    </button>
                </div>
                
                <div id="users-list">
                    <h4>üìã Usuarios del Sistema</h4>
                    <div id="users-table">
                        ${generateUsersTable()}
                    </div>
                </div>
                
                <div id="user-form-container" style="display: none; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
                    <h4 id="form-title">‚ûï Crear Nuevo Usuario</h4>
                    <form id="user-form" onsubmit="handleUserSubmit(event)">
                        <input type="hidden" id="user-id">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label>üë§ Nombre:</label>
                                <input type="text" id="user-nombre" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>üë§ Apellido:</label>
                                <input type="text" id="user-apellido" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label>üîë Usuario:</label>
                                <input type="text" id="user-username" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>üìß Email:</label>
                                <input type="email" id="user-email" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label>üîê Contrase√±a:</label>
                                <input type="password" id="user-password" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label>üé≠ Rol:</label>
                                <select id="user-rol" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Seleccionar rol...</option>
                                    <option value="ADMIN">üëë Administrador</option>
                                    <option value="SUPERVISOR">üë∑ Supervisor</option>
                                    <option value="OPERADOR">üìã Operador</option>
                                    <option value="CONSULTA">üëÅÔ∏è Consulta</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label>
                                <input type="checkbox" id="user-activo" checked> ‚úÖ Usuario activo
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                                üíæ Guardar Usuario
                            </button>
                            <button type="button" onclick="cancelUserFormInModal()" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
function showCreateUserFormInModal() {
    console.log('üìù Mostrando formulario de usuario'); // DEBUG
    
    const formContainer = document.getElementById('user-form-container');
    const formTitle = document.getElementById('form-title');
    const form = document.getElementById('user-form');
    
    if (formContainer && formTitle && form) {
        formContainer.style.display = 'block';
        formTitle.textContent = '‚ûï Crear Nuevo Usuario';
        form.reset();
        document.getElementById('user-id').value = '';
        document.getElementById('user-activo').checked = true;
        console.log('‚úÖ Formulario mostrado'); // DEBUG
    } else {
        console.error('‚ùå No se encontraron elementos del formulario'); // DEBUG
    }
}

function cancelUserFormInModal() {
    const formContainer = document.getElementById('user-form-container');
    if (formContainer) {
        formContainer.style.display = 'none';
    }
}

function closeUsersModal() {
    const modal = document.getElementById('users-modal');
    if (modal) {
        modal.remove();
    }
}
// Funci√≥n para enviar email de bienvenida
function sendWelcomeEmail(userData) {
    console.log('üìß Email enviado a:', userData.email);
    showEmailNotification(userData.email);
}

// Mostrar notificaci√≥n de email enviado
function showEmailNotification(email) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 80px; right: 20px; background: #4caf50; color: white;
        padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 3000; max-width: 300px;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">üìß</span>
            <div>
                <strong>Email enviado</strong><br>
                <small>Notificaci√≥n enviada a ${email}</small>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 5000);
}
// Funci√≥n para limpiar datos corruptos (ejecutar una vez si hay problemas)
function resetUserSystem() {
    localStorage.removeItem('usuarios');
    localStorage.removeItem('currentSession');
    location.reload();
}
// üîÑ WRAPPER para handleLogout (para mantener compatibilidad con HTML)
function handleLogout() {
    logout();
}
// üîÑ FUNCI√ìN DE INICIALIZACI√ìN ACTUALIZADA
async function initializeAppData() {
    try {
        console.log('üîÑ Cargando datos desde Firebase...');
        
        // Cargar todos los datos principales
        const inventoryData = await loadFromFirebase('inventory');
        inventory = inventoryData ? firebaseObjectToArray(JSON.parse(inventoryData)) : [];
        
        const movementsData = await loadFromFirebase('movements');
        movements = movementsData ? firebaseObjectToArray(JSON.parse(movementsData)) : [];
        
        const palletsData = await loadFromFirebase('pallets');
        pallets = palletsData ? firebaseObjectToArray(JSON.parse(palletsData)) : [];
        
        const physicalVerificationData = await loadFromFirebase('physicalVerification');
        physicalVerification = physicalVerificationData ? JSON.parse(physicalVerificationData) : {};
        
        const productionReportsData = await loadProductionReportsSimple();('productionReports');
        productionReports = productionReportsData ? firebaseObjectToArray(JSON.parse(productionReportsData)) : [];
        
        const movementReportsData = await loadFromFirebase('movementReports');
        movementReports = movementReportsData ? firebaseObjectToArray(JSON.parse(movementReportsData)) : [];
        
        // Cargar datos de scrap y retenciones
        const scrapSheetsData = await loadFromFirebase('scrapSheets');
        scrapSheets = scrapSheetsData ? firebaseObjectToArray(JSON.parse(scrapSheetsData)) : [];
        
        const retencionesData = await loadFromFirebase('retenciones');
        retenciones = retencionesData ? firebaseObjectToArray(JSON.parse(retencionesData)) : [];
        
        // Cargar contadores
        const folioCounterData = await loadFromFirebase('folioCounter');
        folioCounter = folioCounterData ? parseInt(folioCounterData) : 1;
        
        const retencionCounterData = await loadFromFirebase('retencionCounter');
        retencionCounter = retencionCounterData ? parseInt(retencionCounterData) : 1;
        
        const palletCounterData = await loadFromFirebase('palletCounter');
        if (palletCounterData) {
            palletCounter = parseInt(palletCounterData);
        }
        
        console.log('‚úÖ Todos los datos cargados desde Firebase');
        console.log(`üìä Inventario: ${inventory.length} items`);
        console.log(`üì¶ Tarimas: ${pallets.length} items`);
        console.log(`üìã Hojas Scrap: ${scrapSheets.length} items`);
        
    } catch (error) {
        console.error('‚ùå Error cargando datos iniciales:', error);
        // Usar valores por defecto en caso de error
        inventory = [];
        movements = [];
        pallets = [];
        physicalVerification = {};
        productionReports = [];
        movementReports = [];
        scrapSheets = [];
        retenciones = [];
        folioCounter = 1;
        retencionCounter = 1;
    }
}
// Funci√≥n helper para manejar llamadas async desde botones
async function handleAsyncCall(asyncFunction) {
    try {
        await asyncFunction();
    } catch (error) {
        console.error('Error en operaci√≥n async:', error);
        alert('‚ùå Error: ' + error.message);
    }
}
// Funci√≥n helper para manejar formularios async
async function handleAsyncForm(event, asyncFunction) {
    event.preventDefault();
    try {
        await asyncFunction(event);
    } catch (error) {
        console.error('Error en formulario async:', error);
        alert('‚ùå Error: ' + error.message);
    }
}
// üîÑ FUNCIONES AUXILIARES PARA REEMPLAZAR getFromLocalStorage/saveToLocalStorage
async function getFromFirebase(key) {
    try {
        const data = await loadFromFirebase(key);
        if (data) {
            return JSON.parse(data);
        }
        return null;
    } catch (error) {
        console.error(`Error obteniendo ${key}:`, error);
        return null;
    }
}
function clearScannedShots() {
    if (scannedShots.length === 0) {
        alert('‚ÑπÔ∏è No hay shots para limpiar');
        return;
    }
    
    if (confirm(`¬øEst√°s seguro de limpiar todos los ${scannedShots.length} shots registrados?`)) {
        scannedShots = [];
        updateShotsDisplay();
        alert('üóëÔ∏è Lista limpiada correctamente');
    }
}
function clearScrapForm() {
    document.getElementById('fecha-operacion').value = '';
    document.getElementById('sector-trabajo').value = '';
    document.getElementById('numero-producto').value = '';
    document.getElementById('nombre-producto').value = '';
    document.getElementById('molde-producto').innerHTML = '<option value="">Primero selecciona un producto...</option>';
    document.getElementById('creado-por').value = '';
    document.getElementById('almacen-origen').value = '';
    document.getElementById('shot-number').value = '';
    document.getElementById('scrap-reason').value = '';
    document.getElementById('other-reason').value = '';
    document.getElementById('observaciones').value = '';
    document.getElementById('other-reason-container').style.display = 'none';
    
    scannedShots = [];
    updateShotsDisplay();
    setTodayDate();
    generateNewFolio();
}
async function deleteSheet(folio) {
    if (currentUser.rol !== 'ADMIN') {
        alert('‚ùå Solo los administradores pueden eliminar hojas');
        return;
    }
    
    const sheet = scrapSheets.find(s => s.folio === folio);
    if (!sheet) return;
    
    const confirmDelete = confirm(`üóëÔ∏è ELIMINAR HOJA DE SCRAP\n\n¬øEst√°s SEGURO de eliminar la hoja ${folio}?\n\n‚ö†Ô∏è Esta acci√≥n NO se puede deshacer.\n‚ö†Ô∏è El folio ser√° restaurado autom√°ticamente.\n\n‚úÖ Aceptar = Eliminar\n‚ùå Cancelar = Mantener`);
    
    if (confirmDelete) {
        // Eliminar hoja del array
        const index = scrapSheets.findIndex(s => s.folio === folio);
        scrapSheets.splice(index, 1);
        
        // Restaurar contador de folio si es la √∫ltima hoja creada
        const allFolios = scrapSheets.map(s => s.folio).sort();
        const lastFolio = allFolios[allFolios.length - 1];
        
        if (!lastFolio || folio > lastFolio) {
            folioCounter--;
            await saveToFirebase('folioCounter', folioCounter.toString());
        }
        
        // Guardar cambios
        await saveToFirebase('scrapSheets', JSON.stringify(arrayToFirebaseObject(scrapSheets)));
        
        alert(`‚úÖ Hoja ${folio} eliminada correctamente.\nüìä Folio restaurado.`);
        refreshSheetsList();
    }
}
// üîÑ FUNCI√ìN WRAPPER FALTANTE - Agregar antes de la funci√≥n descontarDelInventario
async function handleConfirmResolveRetencion(folio) {
    try {
        await confirmResolveRetencion(folio);
    } catch (error) {
        console.error('‚ùå Error resolviendo retenci√≥n:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// üîÑ FUNCI√ìN WRAPPER FALTANTE PARA START NEW SHIFT
async function handleStartNewShiftVerification() {
    try {
        await startNewShiftVerification();
    } catch (error) {
        console.error('‚ùå Error iniciando nuevo turno:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// üîÑ FUNCI√ìN WRAPPER FALTANTE PARA PRODUCTION REPORTS
async function handleSaveProductionReport(tipo) {
    try {
        await saveProductionReport(tipo);
    } catch (error) {
        console.error('‚ùå Error guardando reporte:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// üîÑ FUNCI√ìN WRAPPER FALTANTE PARA MOVEMENT REPORTS
async function handleSaveMovementReport() {
    try {
        await saveMovementReport();
    } catch (error) {
        console.error('‚ùå Error guardando movimiento:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// üîÑ FUNCI√ìN WRAPPER FALTANTE PARA CREATE RETENCION
async function handldeCreateRetencion() { // ‚Üê NOTA: Tienes un typo aqu√≠, deber√≠a ser "handleCreateRetencion"
    try {
        await createRetencion();
    } catch (error) {
        console.error('‚ùå Error creando retenci√≥n:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// üîÑ FUNCI√ìN WRAPPER FALTANTE PARA CONFIRM STATE CHANGE  
async function handleConfirmStateChange() {
    try {
        await confirmStateChange();
    } catch (error) {
        console.error('‚ùå Error cambiando estado:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

async function handleCreateRetencion() {
    try {
        await createRetencion();
    } catch (error) {
        console.error('‚ùå Error creando retenci√≥n:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// üîÑ ASEGURAR QUE LA √öLTIMA FUNCI√ìN EST√â CORRECTAMENTE CERRADA
async function descontarDelInventario(existingItem, shotData) {
    console.log('üîΩ Descontando del inventario:', existingItem.code);
    
    // Encontrar el item en el inventario
    const itemIndex = inventory.findIndex(item => item.code === existingItem.code);
    
    if (itemIndex !== -1) {
        // Reducir cantidad
        inventory[itemIndex].quantity = Math.max(0, inventory[itemIndex].quantity - 1);
        
        // Si cantidad llega a 0, mover a scrap
        if (inventory[itemIndex].quantity === 0) {
            inventory[itemIndex].warehouse = 'scrap';
            inventory[itemIndex].state = 'SCRAP';
            inventory[itemIndex].lastMovement = new Date();
        }
        
        // Registrar movimiento
        movements.push({
            id: Date.now() + Math.random(),
            code: existingItem.code,
            partNumber: existingItem.partNumber,
            type: 'scrap_adicional',
            warehouse: 'scrap',
            quantity: 1,
            date: new Date(),
            reason: shotData.scrapReason,
            palletId: null
        });
        
        // üî• GUARDAR EN FIREBASE
        await saveToFirebase('inventory', JSON.stringify(arrayToFirebaseObject(inventory)));
        await saveToFirebase('movements', JSON.stringify(arrayToFirebaseObject(movements)));
        
        // üîÑ ACTUALIZAR DISPLAYS INMEDIATAMENTE
        updateAllDisplays();
        
        console.log(`‚úÖ Item ${existingItem.code} descontado. Nueva cantidad: ${inventory[itemIndex].quantity}`);
    }
} // ‚Üê ASEGURAR QUE ESTA LLAVE EST√â AQU√ç
// üîÑ FUNCI√ìN PARA PRE-LLENAR FORMULARIO DE SCRAP
function prefillScrapForm(analysis) {
    try {
        // Pre-llenar c√≥digo QR
        document.getElementById('shot-number').value = analysis.code;
        
        if (analysis.isValid && !analysis.isPallet) {
            const codeData = extractCodeData(analysis.code);
            
            if (codeData) {
                // Detectar y seleccionar producto basado en el c√≥digo
                const productSelect = document.getElementById('numero-producto');
                let detectedProduct = '';
                
                if (codeData.type === 'UPR') {
                    // Para c√≥digos UPR, usar el modelo extra√≠do
                    if (codeData.modelo === 'PX') detectedProduct = 'PX13-10-301';
                    else if (codeData.modelo === 'PE') detectedProduct = 'PEDD-10-301-A';
                    else if (codeData.modelo === 'P5') detectedProduct = 'P54G-10-301-A';
                } else if (codeData.type === 'LWR') {
                    // Para c√≥digos LWR, usar el modelo extra√≠do
                    if (codeData.modelo === 'PX') detectedProduct = 'PX13-10-382';
                    else if (codeData.modelo === 'PE') detectedProduct = 'PEDD-10-382-A';
                    else if (codeData.modelo === 'P5') detectedProduct = 'P54G-10-382';
                }
                
                if (detectedProduct) {
                    productSelect.value = detectedProduct;
                    updateProductInfo(); // Actualizar nombre y moldes
                    
                    // Pre-seleccionar molde si est√° disponible
                    setTimeout(() => {
                        const moldeSelect = document.getElementById('molde-producto');
                        if (moldeSelect && codeData.molde) {
                            moldeSelect.value = codeData.molde;
                        }
                    }, 100);
                }
                
                // Determinar almac√©n origen basado en el inventario actual
                const existingItem = inventory.find(item => item.code === analysis.code && item.quantity > 0);
                if (existingItem) {
                    const almacenSelect = document.getElementById('almacen-origen');
                    if (existingItem.warehouse === 'fundidos') {
                        almacenSelect.value = 'ALMACEN_FUNDICION';
                    } else if (existingItem.warehouse === 'acabados') {
                        almacenSelect.value = 'ALMACEN_ACABADO';
                    }
                }
            }
        }
        
        // Pre-llenar fecha de hoy
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha-operacion').value = today;
        
        // Pre-seleccionar sector basado en el tipo
        if (analysis.type === 'UPR') {
            document.getElementById('sector-trabajo').value = 'FUNDICION';
        } else if (analysis.type === 'LWR') {
            document.getElementById('sector-trabajo').value = 'FUNDICION';
        }
        
        alert('‚úÖ Formulario de scrap pre-llenado\n\nCompleta los campos faltantes:\n‚Ä¢ Motivo del scrap\n‚Ä¢ Creado por\n‚Ä¢ Observaciones');
        
    } catch (error) {
        console.error('Error pre-llenando formulario de scrap:', error);
        // Solo pre-llenar el c√≥digo en caso de error
        document.getElementById('shot-number').value = analysis.code;
    }
}

// üîÑ FUNCI√ìN PARA PRE-LLENAR FORMULARIO DE RETENCI√ìN
function prefillRetencionForm(analysis) {
    try {
        if (analysis.isValid && !analysis.isPallet) {
            const codeData = extractCodeData(analysis.code);
            
            if (codeData) {
                // Pre-llenar fecha de producci√≥n (hoy)
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('retencion-fecha-produccion').value = today;
                
                // Detectar y seleccionar producto
                const productSelect = document.getElementById('retencion-producto');
                let detectedProduct = '';
                
                if (codeData.type === 'UPR') {
                    if (codeData.modelo === 'PX') detectedProduct = 'PX13-10-301';
                    else if (codeData.modelo === 'PE') detectedProduct = 'PEDD-10-301-A';
                    else if (codeData.modelo === 'P5') detectedProduct = 'P54G-10-301-A';
                } else if (codeData.type === 'LWR') {
                    if (codeData.modelo === 'PX') detectedProduct = 'PX13-10-382';
                    else if (codeData.modelo === 'PE') detectedProduct = 'PEDD-10-382-A';
                    else if (codeData.modelo === 'P5') detectedProduct = 'P54G-10-382';
                }
                
                if (detectedProduct) {
                    productSelect.value = detectedProduct;
                    updateRetencionProductInfo(); // Actualizar moldes
                    
                    // Pre-seleccionar molde
                    setTimeout(() => {
                        const moldeSelect = document.getElementById('retencion-molde');
                        if (moldeSelect && codeData.molde) {
                            moldeSelect.value = codeData.molde;
                        }
                    }, 100);
                }
                
                // Sugerir rango de shots basado en el c√≥digo escaneado
                if (codeData.disparo) {
                    const shotNumber = parseInt(codeData.disparo);
                    document.getElementById('retencion-shot-inicial').value = Math.max(1, shotNumber - 10);
                    document.getElementById('retencion-shot-final').value = shotNumber + 10;
                }
            }
        }
        
        alert('‚úÖ Formulario de retenci√≥n pre-llenado\n\nCompleta los campos faltantes:\n‚Ä¢ Ajusta el rango de shots\n‚Ä¢ Motivo de la retenci√≥n\n‚Ä¢ Responsable\n‚Ä¢ Observaciones');
        
    } catch (error) {
        console.error('Error pre-llenando formulario de retenci√≥n:', error);
        alert('‚ö†Ô∏è Error al pre-llenar formulario, pero puedes completarlo manualmente');
    }
}
// ============ FUNCIONES PARA RETENCIONES CON C√ìDIGOS QR ============

// Toggle c√°mara para retenciones
function toggleRetencionCameraMode() {
    retencionCameraMode = !retencionCameraMode;
    
    if (retencionCameraMode) {
        document.getElementById('retencion-camera-mode-text').textContent = '‚úèÔ∏è Entrada Manual';
        document.getElementById('retencion-camera-section').style.display = 'block';
        document.getElementById('retencion-manual-entry-section').style.display = 'none';
        startRetencionCamera();
    } else {
        document.getElementById('retencion-camera-mode-text').textContent = 'üì∑ Activar C√°mara';
        document.getElementById('retencion-camera-section').style.display = 'none';
        document.getElementById('retencion-manual-entry-section').style.display = 'block';
        stopRetencionCamera();
    }
}

// Iniciar c√°mara para retenciones
async function startRetencionCamera() {
    if (typeof QrScanner === 'undefined') {
        alert('‚ùå La librer√≠a QR Scanner no se carg√≥ correctamente');
        return;
    }
    
    try {
        const videoElement = document.getElementById('retencion-camera-video');
        const statusElement = document.getElementById('retencion-camera-status');
        
        if (retencionScanner) {
            stopRetencionCamera();
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        statusElement.textContent = 'üì∑ Iniciando c√°mara...';
        
        retencionScanner = new QrScanner(
            videoElement,
            result => handleRetencionQRScan(result.data),
            {
                returnDetailedScanResult: true,
                highlightScanRegion: true,
                highlightCodeOutline: true,
                preferredCamera: 'environment',
                maxScansPerSecond: 2
            }
        );
        
        await retencionScanner.start();
        statusElement.textContent = 'üì∑ C√°mara activa - Escanea c√≥digos QR';
        statusElement.style.background = '#d4edda';
        statusElement.style.color = '#155724';
        
    } catch (error) {
        console.error('Error c√°mara retenci√≥n:', error);
        alert('‚ùå Error al acceder a la c√°mara');
    }
}

// Detener c√°mara para retenciones
function stopRetencionCamera() {
    if (retencionScanner) {
        try {
            retencionScanner.stop();
            retencionScanner.destroy();
            retencionScanner = null;
        } catch (error) {
            console.error('Error deteniendo c√°mara:', error);
        }
    }
}

// Manejar QR escaneado en retenciones
function handleRetencionQRScan(qrData) {
    if (qrData && qrData.trim().length > 0) {
        const code = qrData.trim();
        document.getElementById('retencion-shot-code').value = code;
        
        // Feedback visual
        const statusElement = document.getElementById('retencion-camera-status');
        statusElement.style.background = '#d4edda';
        statusElement.style.color = '#155724';
        statusElement.textContent = '‚úÖ C√≥digo detectado: ' + code.substring(0, 10) + '...';
        
        setTimeout(() => {
            if (retencionScanner) {
                statusElement.style.background = '#e3f2fd';
                statusElement.style.color = '#0c5460';
                statusElement.textContent = 'üì∑ C√°mara activa - Escanea c√≥digos QR';
            }
        }, 2000);
    }
}

// Agregar c√≥digo a retenci√≥n (adaptado de addShot)
async function addCodeToRetencion() {
    const codeInput = document.getElementById('retencion-shot-code');
    const code = codeInput.value.toUpperCase().trim();
    const producto = document.getElementById('retencion-producto').value;
    const molde = document.getElementById('retencion-molde').value;
    
    // Validaciones b√°sicas
    if (!code) {
        alert('‚ö†Ô∏è Ingresa un c√≥digo QR');
        return;
    }
    
    if (!producto || !molde) {
        alert('‚ö†Ô∏è Primero selecciona producto y molde');
        return;
    }
    
    // Validar formato del c√≥digo
    const codeData = extractCodeData(code);
    if (!codeData) {
        alert('‚ùå C√≥digo QR no v√°lido');
        return;
    }
    
    // VALIDACI√ìN DE MODELO (igual que en scrap)
    const selectedProduct = producto;
    const selectedMold = molde;
    
    const isSelectedUPR = selectedProduct.includes('301');
    const isSelectedLWR = selectedProduct.includes('382');
    const isCodeUPR = codeData.type === 'UPR';
    const isCodeLWR = codeData.type === 'LWR';
    
    if ((isSelectedUPR && !isCodeUPR) || (isSelectedLWR && !isCodeLWR)) {
        alert(`‚ùå TIPO INCORRECTO\n\nC√≥digo: ${codeData.type}\nProducto: ${isSelectedUPR ? 'UPR' : 'LWR'}\n\nVerifica el c√≥digo o cambia el producto.`);
        return;
    }
    
    // VALIDACI√ìN DE MOLDE
    if (codeData.molde !== selectedMold) {
        alert(`‚ùå MOLDE INCORRECTO\n\nC√≥digo molde: ${codeData.molde}\nMolde seleccionado: ${selectedMold}`);
        return;
    }
    
    // VALIDACI√ìN EN INVENTARIO (igual que en scrap)
    const existingItem = inventory.find(item => 
        item.code === code || 
        (item.codeData && codeData && item.codeData.disparo === codeData.disparo && item.codeData.molde === molde)
    );
    
    if (!existingItem) {
        alert(`‚ùå C√ìDIGO NO ENCONTRADO\n\nEl c√≥digo ${code} no est√° registrado en el inventario.`);
        return;
    }
    
    if (existingItem.quantity <= 0) {
        alert(`‚ùå SIN INVENTARIO\n\nEl c√≥digo ${code} tiene cantidad 0.`);
        return;
    }
    
    // Verificar duplicados
    const isDuplicate = retencionValidatedCodes.some(item => item.code === code);
    if (isDuplicate) {
        alert('‚ö†Ô∏è Este c√≥digo ya est√° en la lista');
        return;
    }
    
    // Agregar c√≥digo validado
    const validatedCode = {
        code: code,
        codeData: codeData,
        existingInventory: {
            id: existingItem.id,
            currentQuantity: existingItem.quantity,
            partNumber: existingItem.partNumber,
            warehouse: existingItem.warehouse
        },
        timestamp: new Date().toLocaleString('es-MX'),
        id: Date.now()
    };
    
    retencionValidatedCodes.push(validatedCode);
    updateRetencionCodesDisplay();
    
    // Limpiar input
    codeInput.value = '';
    
    // Mostrar √©xito
    alert(`‚úÖ C√≥digo validado: ${code}\nAlmac√©n: ${existingItem.warehouse}\nCantidad: ${existingItem.quantity}`);
}

// Actualizar visualizaci√≥n de c√≥digos de retenci√≥n
function updateRetencionCodesDisplay() {
    const display = document.getElementById('retencion-codes-display');
    const totalElement = document.getElementById('retencion-total-codes');
    
    if (retencionValidatedCodes.length === 0) {
        display.innerHTML = '<div class="alert alert-info">üîç Los c√≥digos validados aparecer√°n aqu√≠</div>';
        totalElement.textContent = '0';
        return;
    }
    
    totalElement.textContent = retencionValidatedCodes.length;
    
    let html = '<div class="codes-list">';
    retencionValidatedCodes.forEach(item => {
        html += `
            <div class="code-item code-valid">
                <span>‚úÖ [${item.codeData.type}] ${item.code} - Almac√©n: ${item.existingInventory.warehouse}</span>
                <button onclick="removeRetencionCode(${item.id})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 16px;">üóëÔ∏è</button>
            </div>
        `;
    });
    html += '</div>';
    
    display.innerHTML = html;
}

// Remover c√≥digo de retenci√≥n
function removeRetencionCode(codeId) {
    if (confirm('¬øEliminar este c√≥digo de la lista?')) {
        retencionValidatedCodes = retencionValidatedCodes.filter(item => item.id !== codeId);
        updateRetencionCodesDisplay();
    }
}

// Limpiar c√≥digos de retenci√≥n
function clearRetencionCodes() {
    if (retencionValidatedCodes.length === 0) {
        alert('‚ÑπÔ∏è No hay c√≥digos para limpiar');
        return;
    }
    
    if (confirm(`¬øEliminar todos los ${retencionValidatedCodes.length} c√≥digos validados?`)) {
        retencionValidatedCodes = [];
        updateRetencionCodesDisplay();
        alert('üóëÔ∏è Lista limpiada');
    }
}
// Funci√≥n para cambiar entre sub-pesta√±as de gesti√≥n de inventario
function showInventorySubTab(subTabName) {
    // Ocultar todas las sub-pesta√±as
    document.querySelectorAll('#pallets .sub-tab-content').forEach(tab => {
        tab.style.display = 'none';
        tab.classList.remove('active');
    });
    
    // Remover active de todos los botones
    document.querySelectorAll('#pallets .sub-nav-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar la sub-pesta√±a seleccionada
    const targetTab = document.getElementById(subTabName);
    if (targetTab) {
        targetTab.style.display = 'block';
        targetTab.classList.add('active');
    }
    
    // Activar el bot√≥n correspondiente
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Cargar datos seg√∫n la pesta√±a
    if (subTabName === 'individual-management') {
        loadIndividualCodesTable();
    }
}

// Funci√≥n para cargar tabla de c√≥digos individuales
function loadIndividualCodesTable() {
    filterIndividualItems();
}

// Funci√≥n para filtrar elementos individuales
function filterIndividualItems() {
    const searchCode = document.getElementById('search-individual-code').value.toLowerCase();
    const filterType = document.getElementById('filter-individual-type').value;
    const filterWarehouse = document.getElementById('filter-individual-warehouse').value;
    const filterState = document.getElementById('filter-individual-state').value;
    
    let filteredInventory = inventory.filter(item => item.quantity > 0);
    
    // Aplicar filtros
    if (searchCode) {
        filteredInventory = filteredInventory.filter(item => 
            item.code.toLowerCase().includes(searchCode)
        );
    }
    if (filterType) {
        filteredInventory = filteredInventory.filter(item => item.type === filterType);
    }
    if (filterWarehouse) {
        filteredInventory = filteredInventory.filter(item => item.warehouse === filterWarehouse);
    }
    if (filterState) {
        filteredInventory = filteredInventory.filter(item => item.state === filterState);
    }
    
    // Actualizar contador
    document.getElementById('individual-results-count').textContent = `${filteredInventory.length} elementos encontrados`;
    
    // Generar tabla
    const tbody = document.getElementById('individual-codes-tbody');
    if (filteredInventory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">üîç No se encontraron c√≥digos con los filtros aplicados</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredInventory.map(item => `
        <tr>
            <td style="font-family: monospace; font-size: 0.9em;">${item.code}</td>
            <td><span class="code-badge" style="background: ${item.type === 'UPR' ? '#007bff' : '#28a745'};">${item.type}</span></td>
            <td>${item.partNumber}</td>
            <td><span class="code-badge" style="background: ${getStateColor(item.state)};">${item.state}</span></td>
            <td>${getWarehouseName(item.warehouse)}</td>
            <td style="text-align: center; font-weight: bold;">${item.quantity}</td>
            <td style="font-size: 0.8em;">${formatLastMovement(item.lastMovement)}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="moveIndividualCode('${item.code}')">üì¶ Mover</button>
                <button class="btn btn-info btn-sm" onclick="viewIndividualDetails('${item.code}')">üëÅÔ∏è Ver</button>
            </td>
        </tr>
    `).join('');
}

// Funci√≥n para limpiar filtros
function clearIndividualFilters() {
    document.getElementById('search-individual-code').value = '';
    document.getElementById('filter-individual-type').value = '';
    document.getElementById('filter-individual-warehouse').value = '';
    document.getElementById('filter-individual-state').value = '';
    filterIndividualItems();
}

// Funci√≥n para obtener color del estado
function getStateColor(state) {
    const colors = {
        'FUNDIDOS': '#e74c3c',
        'ACABADOS': '#27ae60',
        'SCRAP': '#95a5a6',
        'RETENIDO': '#f39c12',
        'ENVIADO': '#3498db',
        'EN_PRUEBAS': '#9b59b6'
    };
    return colors[state] || '#6c757d';
}

// Reemplaza la funci√≥n moveIndividualCode() completa
function moveIndividualCode(code) {
    const item = inventory.find(i => i.code === code);
    if (!item) return;
    
    // üÜï APLICAR MISMAS REGLAS QUE TARIMAS
    const allowedMoves = {
        'fundidos': ['acabados', 'retenciones', 'pruebas', 'scrap'],
        'acabados': ['envios', 'retenciones', 'pruebas', 'scrap'],
        'scrap': [],
        'retenciones': ['fundidos', 'acabados', 'scrap'],
        'envios': [],
        'pruebas': ['fundidos', 'acabados', 'scrap']
    };
    
    const currentState = item.warehouse;
    const availableMoves = allowedMoves[currentState] || [];
    
    if (availableMoves.length === 0) {
        alert(`‚ùå MOVIMIENTO NO PERMITIDO\n\nLos c√≥digos en estado "${getWarehouseName(currentState)}" no pueden moverse.`);
        return;
    }
    
    // Generar opciones filtradas
    const warehouseOptions = {
        'fundidos': '<div class="warehouse-btn" data-warehouse="fundidos">üî• FUNDIDOS</div>',
        'acabados': '<div class="warehouse-btn" data-warehouse="acabados">‚úÖ ACABADOS</div>',
        'scrap': '<div class="warehouse-btn" data-warehouse="scrap">‚ôªÔ∏è SCRAP</div>',
        'retenciones': '<div class="warehouse-btn" data-warehouse="retenciones">‚è∏Ô∏è RETENCIONES</div>',
        'envios': '<div class="warehouse-btn" data-warehouse="envios">üì¶ ENV√çOS</div>',
        'pruebas': '<div class="warehouse-btn" data-warehouse="pruebas">üß™ PRUEBAS</div>'
    };
    
    let optionsHTML = '';
    availableMoves.forEach(move => {
        optionsHTML += warehouseOptions[move];
    });
    
    const modalHtml = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;" id="moveIndividualModal">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                <h3>üì¶ Mover C√≥digo Individual</h3>
                <p><strong>C√≥digo:</strong> ${code}</p>
                <p><strong>Estado actual:</strong> ${getWarehouseName(item.warehouse)}</p>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">Selecciona el almac√©n destino:</label>
                    <div class="warehouse-selector" id="move-individual-selector">
                        ${optionsHTML}
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 25px;">
                    <button class="btn btn-success" onclick="confirmIndividualMove('${code}')" id="confirmIndividualMoveBtn" disabled>‚úÖ Confirmar Movimiento</button>
                    <button class="btn btn-danger" onclick="closeIndividualMoveModal()" style="margin-left: 10px;">‚ùå Cancelar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Event listener para selector
    document.getElementById('move-individual-selector').addEventListener('click', function(e) {
        if (e.target.classList.contains('warehouse-btn')) {
            this.querySelectorAll('.warehouse-btn').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            document.getElementById('confirmIndividualMoveBtn').disabled = false;
            window.selectedMoveWarehouse = e.target.dataset.warehouse;
        }
    });
}
// Reemplaza la funci√≥n confirmIndividualMove() completa
async function confirmIndividualMove(code) {
    if (!window.selectedMoveWarehouse) return;
    
    const item = inventory.find(i => i.code === code);
    const newWarehouse = window.selectedMoveWarehouse;
    
    // üÜï AUTOMATIZACI√ìN DE FLUJOS PARA C√ìDIGOS INDIVIDUALES
    if (newWarehouse === 'retenciones') {
        const confirmRetencion = confirm(`‚è∏Ô∏è CREAR RETENCI√ìN AUTOM√ÅTICA\n\nSe crear√° autom√°ticamente una retenci√≥n para este c√≥digo.\n\n¬øContinuar?`);
        
        if (confirmRetencion) {
            await createAutomaticIndividualRetencion(item);
            closeIndividualMoveModal();
            return;
        } else {
            return;
        }
    }
    
    if (newWarehouse === 'pruebas') {
        const confirmPruebas = confirm(`üß™ ENVIAR A PRUEBAS\n\nEste c√≥digo ser√° enviado a pruebas.\n\n¬øContinuar?`);
        
        if (!confirmPruebas) return;
    }
    
    // Continuar con movimiento normal
    item.warehouse = newWarehouse;
    item.state = getStateFromWarehouse(newWarehouse);
    item.lastMovement = new Date();
    
    await saveToFirebase('inventory', JSON.stringify(arrayToFirebaseObject(inventory)));
    
    alert('‚úÖ C√≥digo ' + code + ' movido a ' + getWarehouseName(newWarehouse));
    closeIndividualMoveModal();
    filterIndividualItems();
    updateAllDisplays();
}

// Funciones auxiliares para modales
function closeIndividualMoveModal() {
    const modal = document.getElementById('moveIndividualModal');
    if (modal) modal.remove();
    window.selectedMoveWarehouse = null;
}

function viewIndividualDetails(code) {
    const item = inventory.find(i => i.code === code);
    if (!item) return;
    
    const details = `üìã DETALLES DEL C√ìDIGO: ${code}
    
üè∑Ô∏è C√≥digo QR: ${item.code}
üì¶ Tipo: ${item.type}
üè≠ Part Number: ${item.partNumber}
üìä Estado: ${item.state}
üè™ Almac√©n: ${getWarehouseName(item.warehouse)}
üìä Cantidad: ${item.quantity}
üìÖ √öltimo Movimiento: ${formatLastMovement(item.lastMovement)}
üì¶ ID Tarima: ${item.palletId || 'No asignada'}
üîÑ Turno: ${item.shift || 'N/A'}`;
    
    alert(details);
}
// Variables para los gr√°ficos
let statusChart = null;
let warehouseChart = null;
let productionChart = null;

// Inicializar gr√°ficos del dashboard
function initializeDashboardCharts() {
    setTimeout(() => {
        createStatusByModelChart();
        createWarehouseDistributionChart();
        createDailyProductionChart();
        updateQualityMetrics();
        updateRecentActivity();
    }, 1000);
}

// Reemplaza la funci√≥n createStatusByModelChart() completa
function createStatusByModelChart() {
    const ctx = document.getElementById('statusByModelChart');
    if (!ctx) return;

    // Procesar datos por n√∫mero de parte y fecha
    const dailyData = {};
    const partNumbers = new Set();

    // Agrupar movimientos por fecha y n√∫mero de parte
    movements.forEach(movement => {
        const date = new Date(movement.date).toISOString().split('T')[0];
        const partNumber = movement.partNumber || 'DESCONOCIDO';
        
        if (!dailyData[date]) {
            dailyData[date] = {};
        }
        if (!dailyData[date][partNumber]) {
            dailyData[date][partNumber] = { fundidos: 0, acabados: 0, scrap: 0, retenciones: 0 };
        }
        
        partNumbers.add(partNumber);
        
        // Sumar o restar seg√∫n el almac√©n de destino
        if (movement.warehouse === 'fundidos') dailyData[date][partNumber].fundidos += movement.quantity;
        else if (movement.warehouse === 'acabados') dailyData[date][partNumber].acabados += movement.quantity;
        else if (movement.warehouse === 'scrap') dailyData[date][partNumber].scrap += movement.quantity;
        else if (movement.warehouse === 'retenciones') dailyData[date][partNumber].retenciones += movement.quantity;
    });

    // Obtener √∫ltimos 7 d√≠as
    const dates = Object.keys(dailyData).sort().slice(-7);
    const partNumbersArray = Array.from(partNumbers);

    if (statusChart) statusChart.destroy();
    
    statusChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: dates.map(date => new Date(date).toLocaleDateString()),
            datasets: partNumbersArray.map((partNumber, index) => {
                const colors = ['#e74c3c', '#27ae60', '#3498db', '#f39c12', '#9b59b6', '#1abc9c'];
                return {
                    label: partNumber,
                    data: dates.map(date => {
                        const dayData = dailyData[date] && dailyData[date][partNumber];
                        return dayData ? (dayData.fundidos + dayData.acabados + dayData.scrap + dayData.retenciones) : 0;
                    }),
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length],
                    borderWidth: 2
                };
            })
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2.5, // M√°s ancho horizontalmente
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#ecf0f1'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}
// Gr√°fico de distribuci√≥n de almacenes
// Reemplaza la funci√≥n createWarehouseDistributionChart() completa
function createWarehouseDistributionChart() {
    const ctx = document.getElementById('warehouseDistributionChart');
    if (!ctx) return;

    const partNumberData = {};

    inventory.forEach(item => {
        if (item.quantity > 0) {
            const partNumber = item.partNumber || 'DESCONOCIDO';
            if (!partNumberData[partNumber]) {
                partNumberData[partNumber] = 0;
            }
            partNumberData[partNumber] += item.quantity;
        }
    });

    const partNumbers = Object.keys(partNumberData);
    const quantities = Object.values(partNumberData);
    const colors = ['#e74c3c', '#27ae60', '#3498db', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#95a5a6'];

    if (warehouseChart) warehouseChart.destroy();

    warehouseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: partNumbers,
            datasets: [{
                data: quantities,
                backgroundColor: colors.slice(0, partNumbers.length),
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2.5, // M√°s ancho horizontalmente
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            }
        }
    });
}

// Gr√°fico de producci√≥n diaria
function createDailyProductionChart() {
    const ctx = document.getElementById('dailyProductionChart');
    if (!ctx) return;

    // Procesar datos de producci√≥n por fecha
    const productionByDate = {};
    
    productionReports.forEach(report => {
        const date = report.fecha;
        if (!productionByDate[date]) {
            productionByDate[date] = { total: 0, buenas: 0, ng: 0 };
        }
        productionByDate[date].total += report.cantidadTotal;
        productionByDate[date].buenas += report.piezasBuenas;
        productionByDate[date].ng += report.cantidadNG;
    });

    const dates = Object.keys(productionByDate).sort().slice(-7); // √öltimos 7 d√≠as
    
    if (productionChart) productionChart.destroy();

    productionChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates.map(date => new Date(date).toLocaleDateString()),
            datasets: [
                {
                    label: 'üìä Total Producido',
                    data: dates.map(date => productionByDate[date].total),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '‚úÖ Piezas Buenas',
                    data: dates.map(date => productionByDate[date].buenas),
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: '‚ùå No Good',
                    data: dates.map(date => productionByDate[date].ng),
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: '#ecf0f1'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Reemplaza la funci√≥n updateQualityMetrics() completa
function updateQualityMetrics() {
    const machineFilter = document.getElementById('quality-machine-filter')?.value;
    const dateFilter = document.getElementById('quality-date-filter')?.value;
    
    let filteredReports = productionReports;
    
    // Aplicar filtros
    if (machineFilter) {
        filteredReports = filteredReports.filter(report => 
            report.maquina && report.maquina.toString() === machineFilter
        );
    }
    
    if (dateFilter) {
        filteredReports = filteredReports.filter(report => 
            report.fecha === dateFilter
        );
    }
    
    const totalProduction = filteredReports.reduce((sum, report) => sum + report.cantidadTotal, 0);
    const totalGood = filteredReports.reduce((sum, report) => sum + report.piezasBuenas, 0);
    const totalNG = filteredReports.reduce((sum, report) => sum + report.cantidadNG, 0);
    
    const efficiency = totalProduction > 0 ? Math.round((totalGood / totalProduction) * 100) : 0;
    const defects = totalProduction > 0 ? Math.round((totalNG / totalProduction) * 100) : 0;
    
    // Actualizar c√≠rculos de calidad
    const efficiencyElement = document.getElementById('quality-efficiency');
    const defectsElement = document.getElementById('quality-defects');
    
    if (efficiencyElement) {
        document.getElementById('efficiency-percentage').textContent = efficiency + '%';
        efficiencyElement.className = 'quality-circle ' + 
            (efficiency >= 95 ? 'excellent' : efficiency >= 85 ? 'good' : 'poor');
    }
    
    if (defectsElement) {
        document.getElementById('defects-percentage').textContent = defects + '%';
        defectsElement.className = 'quality-circle ' + 
            (defects <= 5 ? 'excellent' : defects <= 15 ? 'good' : 'poor');
    }
}
// Actualizar actividad reciente
function updateRecentActivity() {
    const recentActivity = document.getElementById('recent-activity');
    if (!recentActivity) return;
    
    const recentMovements = movements.slice(-5).reverse();
    
    let activityHTML = '';
    recentMovements.forEach(movement => {
        const timeAgo = getTimeAgo(movement.date);
        const icon = movement.type === 'transferencia' ? 'üîÑ' : 
                    movement.warehouse === 'scrap' ? '‚ôªÔ∏è' : 
                    movement.warehouse === 'envios' ? 'üì¶' : 'üìã';
        
        activityHTML += `
            <div class="activity-item">
                <span class="activity-icon">${icon}</span>
                <span class="activity-text">${movement.partNumber} ‚Üí ${getWarehouseName(movement.warehouse)}</span>
                <span class="activity-time">${timeAgo}</span>
            </div>
        `;
    });
    
    if (activityHTML === '') {
        activityHTML = '<div class="activity-item"><span class="activity-icon">üí§</span><span class="activity-text">No hay actividad reciente</span><span class="activity-time">-</span></div>';
    }
    
    recentActivity.innerHTML = activityHTML;
}

// Funci√≥n auxiliar para extraer modelo del part number
function extractModelFromPartNumber(partNumber) {
    if (partNumber.includes('UPR')) return 'UPR';
    if (partNumber.includes('LWR')) return 'LWR';
    if (partNumber.includes('382')) return 'LWR-382';
    if (partNumber.includes('301')) return 'UPR-301';
    return 'OTRO';
}

// Funci√≥n auxiliar para tiempo transcurrido
function getTimeAgo(date) {
    const now = new Date();
    const then = new Date(date);
    const diffMs = now - then;
    const diffMins = Math.floor(diffMs / 60000);
    
    if (diffMins < 1) return 'Ahora';
    if (diffMins < 60) return `${diffMins}m`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h`;
    return `${Math.floor(diffMins / 1440)}d`;
}

// Funci√≥n para refrescar dashboard
function refreshDashboard() {
    updateDashboard();
    initializeDashboardCharts();
    alert('‚úÖ Dashboard actualizado');
}

// Actualizar funci√≥n updateDashboard existente
function updateDashboard() {
    const fundidos = inventory.filter(i => i.state === 'FUNDIDOS' && i.quantity > 0).length;
    const acabados = inventory.filter(i => i.state === 'ACABADOS' && i.quantity > 0).length;
    const upr = inventory.filter(i => i.type === 'UPR' && i.quantity > 0).length;
    const lwr = inventory.filter(i => i.type === 'LWR' && i.quantity > 0).length;
    const totalPallets = pallets.length;
    const verificationCount = Object.keys(physicalVerification).length;
    
    document.getElementById('total-fundidos').textContent = fundidos;
    document.getElementById('total-acabados').textContent = acabados;
    document.getElementById('total-upr').textContent = upr;
    document.getElementById('total-lwr').textContent = lwr;
    document.getElementById('total-pallets').textContent = totalPallets;
    document.getElementById('verification-count').textContent = verificationCount;
    
    // Inicializar gr√°ficos si no existen
    if (!statusChart) {
        initializeDashboardCharts();
    }
}
// Variables para gesti√≥n de reportes
let filteredProductionReports = [];

// Refrescar lista de reportes - VERSI√ìN CORREGIDA
async function refreshProductionReports() {
    try {
        // üî• CARGAR CON FUNCI√ìN SIMPLE
        await loadProductionReportsSimple();
        
        // ‚úÖ SOLO FILTRAR SI ESTAMOS EN LA PESTA√ëA CORRECTA
        const productionTab = document.getElementById('production');
        if (productionTab && productionTab.classList.contains('active')) {
            filterProductionReports();
        }
        
        console.log(`‚úÖ ${productionReports.length} reportes cargados y sincronizados`);
    } catch (error) {
        console.error('‚ùå Error cargando reportes:', error);
        console.log('‚ö†Ô∏è Error cargando reportes, pero continuando...');
    }
}
// Filtrar reportes de producci√≥n (Versi√≥n 1.1 - CORREGIDA)
function filterProductionReports() {
    // ‚úÖ VERIFICAR QUE LOS ELEMENTOS EXISTAN ANTES DE ACCEDER A ELLOS
    const dateFromElement = document.getElementById('filter-date-from');
    const dateToElement = document.getElementById('filter-date-to');
    const processElement = document.getElementById('filter-process');
    const machineElement = document.getElementById('filter-machine');
    
    // Si los elementos no existen, salir de la funci√≥n
    if (!dateFromElement || !dateToElement || !processElement) {
        console.log('‚ö†Ô∏è Elementos de filtro no disponibles, omitiendo filtrado');
        return;
    }
    
    const dateFrom = dateFromElement.value;
    const dateTo = dateToElement.value;
    const process = processElement.value;
    const machine = machineElement ? machineElement.value : '';
    
    filteredProductionReports = productionReports.filter(report => {
        // üîÑ CORREGIR: Usar fecha directa sin conversi√≥n UTC
        const reportDate = report.fecha; // Ya est√° en formato YYYY-MM-DD
        
        // Filtro por fecha desde (inclusive)
        if (dateFrom && reportDate < dateFrom) return false;
        
        // Filtro por fecha hasta (inclusive)
        if (dateTo && reportDate > dateTo) return false;
        
        // Filtro por proceso
        if (process && report.tipo !== process) return false;
        
        // Filtro por m√°quina
        if (machine && report.maquina && report.maquina.toString() !== machine) return false;
        
        return true;
    });
    
    // Ordenar por fecha descendente
    filteredProductionReports.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    // Actualizar tabla
    updateProductionReportsTable();
    
    // Actualizar contador si el elemento existe
    const reportsCountElement = document.getElementById('reports-count');
    if (reportsCountElement) {
        reportsCountElement.textContent = `${filteredProductionReports.length} reportes encontrados`;
    }
}
// Actualizar tabla de reportes - VERSI√ìN CORREGIDA
function updateProductionReportsTable() {
    // ‚úÖ VERIFICAR QUE EL ELEMENTO TBODY EXISTA
    const tbody = document.getElementById('production-reports-tbody');
    
    if (!tbody) {
        console.log('‚ö†Ô∏è Elemento production-reports-tbody no encontrado, omitiendo actualizaci√≥n de tabla');
        return;
    }
    
    if (filteredProductionReports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px;">üìã No hay reportes que coincidan con los filtros</td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredProductionReports.map(report => {
        const efficiency = report.cantidadTotal > 0 ? Math.round((report.piezasBuenas / report.cantidadTotal) * 100) : 0;
        const efficiencyColor = efficiency >= 95 ? '#27ae60' : efficiency >= 85 ? '#f39c12' : '#e74c3c';
        
        const evidenceIcon = report.evidencia ? 
            `<button onclick="viewReportEvidence(${report.id})" class="btn btn-sm" style="background: #28a745; color: white;">üìÑ</button>` : 
            '<span style="color: #6c757d;">Sin evidencia</span>';
        
        const canManage = currentUser && (currentUser.rol === 'ADMIN' || currentUser.rol === 'SUPERVISOR');
        const actionsHTML = canManage ? `
            <button onclick="editProductionReport(${report.id})" class="btn btn-warning btn-sm">‚úèÔ∏è Editar</button>
            <button onclick="deleteProductionReport(${report.id})" class="btn btn-danger btn-sm" style="margin-left: 5px;">üóëÔ∏è Eliminar</button>
        ` : '<span style="color: #6c757d;">Sin permisos</span>';
        
        return `
            <tr>
                <td>${report.fecha}</td>
                <td><span class="code-badge" style="background: ${report.tipo === 'fundicion' ? '#e74c3c' : '#27ae60'};">${report.tipo.toUpperCase()}</span></td>
                <td>${report.maquina || 'N/A'}</td>
                <td style="font-size: 0.8em;">${report.modelo}</td>
                <td>${report.molde || 'N/A'}</td>
                <td style="text-align: center;">${report.cantidadTotal}</td>
                <td style="text-align: center; color: #e74c3c;">${report.cantidadNG}</td>
                <td style="text-align: center; color: #27ae60; font-weight: bold;">${report.piezasBuenas}</td>
                <td style="text-align: center; color: ${efficiencyColor}; font-weight: bold;">${efficiency}%</td>
                <td style="text-align: center;">${evidenceIcon}</td>
                <td>${actionsHTML}</td>
            </tr>
        `;
    }).join('');
}

// Limpiar filtros
function clearProductionFilters() {
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';
    document.getElementById('filter-process').value = '';
    document.getElementById('filter-machine').value = '';
    filterProductionReports();
}

// Editar reporte de producci√≥n
function editProductionReport(reportId) {
    const report = productionReports.find(r => r.id === reportId);
    if (!report) return;
    
    // Llenar formulario de edici√≥n
    document.getElementById('edit-report-id').value = report.id;
    document.getElementById('edit-fecha').value = report.fecha;
    document.getElementById('edit-turno').value = report.turno;
    document.getElementById('edit-maquina').value = report.maquina || 'N/A';
    document.getElementById('edit-modelo').value = report.modelo;
    document.getElementById('edit-total').value = report.cantidadTotal;
    document.getElementById('edit-ng').value = report.cantidadNG;
    document.getElementById('edit-buenas').value = report.piezasBuenas;
    
    // Mostrar modal
    document.getElementById('edit-report-modal').style.display = 'flex';
}

// Calcular piezas buenas en edici√≥n
function calculateEditGoodParts() {
    const total = parseInt(document.getElementById('edit-total').value) || 0;
    const ng = parseInt(document.getElementById('edit-ng').value) || 0;
    const buenas = Math.max(0, total - ng);
    
    document.getElementById('edit-buenas').value = buenas;
}

// Guardar reporte editado - VERSI√ìN CORREGIDA CON FIREBASE
async function saveEditedReport() {
    try {
        const reportId = parseInt(document.getElementById('edit-report-id').value);
        const reportIndex = productionReports.findIndex(r => r.id === reportId);
        
        if (reportIndex === -1) {
            alert('‚ùå Reporte no encontrado');
            return;
        }
        
        console.log('‚úèÔ∏è Editando reporte:', reportId);
        
        // Actualizar datos
        productionReports[reportIndex].fecha = document.getElementById('edit-fecha').value;
        productionReports[reportIndex].turno = document.getElementById('edit-turno').value;
        productionReports[reportIndex].cantidadTotal = parseInt(document.getElementById('edit-total').value);
        productionReports[reportIndex].cantidadNG = parseInt(document.getElementById('edit-ng').value);
        productionReports[reportIndex].piezasBuenas = parseInt(document.getElementById('edit-buenas').value);
        productionReports[reportIndex].lastModified = new Date().toISOString();
        productionReports[reportIndex].modifiedBy = currentUser.nombre;
        
        // üî• GUARDAR EN FIREBASE CON FUNCI√ìN SIMPLE
        await saveProductionReportsSimple();
        
        alert('‚úÖ Reporte actualizado correctamente');
        closeEditModal();
        filterProductionReports();
        updateProductionSummary();
        
        console.log('‚úÖ Reporte editado exitosamente');
        
    } catch (error) {
        console.error('‚ùå Error guardando reporte:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// Eliminar reporte - VERSI√ìN CORREGIDA CON FIREBASE
async function deleteProductionReport(reportId) {
    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar este reporte?\n\nEsta acci√≥n no se puede deshacer.')) {
        return;
    }
    
    try {
        console.log('üóëÔ∏è Eliminando reporte:', reportId);
        
        const reportIndex = productionReports.findIndex(r => r.id === reportId);
        if (reportIndex === -1) {
            alert('‚ùå Reporte no encontrado');
            return;
        }
        
        // Eliminar evidencia de Firebase si existe
        const report = productionReports[reportIndex];
        if (report.evidencia) {
            try {
                await deleteFromFirebase(`evidencia_${reportId}`);
                console.log('üóëÔ∏è Evidencia eliminada de Firebase');
            } catch (evidenceError) {
                console.warn('‚ö†Ô∏è No se pudo eliminar evidencia:', evidenceError);
            }
        }
        
        // Eliminar del array local
        productionReports.splice(reportIndex, 1);
        
        // üî• GUARDAR EN FIREBASE CON FUNCI√ìN SIMPLE
        await saveProductionReportsSimple();
        
        alert('‚úÖ Reporte eliminado correctamente');
        filterProductionReports();
        updateProductionSummary();
        
        console.log('‚úÖ Reporte eliminado exitosamente');
        
    } catch (error) {
        console.error('‚ùå Error eliminando reporte:', error);
        alert('‚ùå Error eliminando reporte: ' + error.message);
    }
}
// Ver evidencia de reporte
function viewReportEvidence(reportId) {
    const report = productionReports.find(r => r.id === reportId);
    if (!report || !report.evidencia) {
        alert('‚ùå No hay evidencia disponible para este reporte');
        return;
    }
    
    const evidencia = report.evidencia;
    const sizeInMB = (evidencia.tama√±o / 1024 / 1024).toFixed(2);
    const fecha = new Date(evidencia.fecha).toLocaleString();
    
    if (confirm(`üìÑ Evidencia del Reporte:\n\n‚Ä¢ Archivo: ${evidencia.nombre}\n‚Ä¢ Tama√±o: ${sizeInMB}MB\n‚Ä¢ Subido: ${fecha}\n\n¬øDeseas descargar el archivo?`)) {
        const link = document.createElement('a');
        link.href = evidencia.contenido;
        link.download = evidencia.nombre;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Cerrar modal de edici√≥n
function closeEditModal() {
    document.getElementById('edit-report-modal').style.display = 'none';
}

// ============ SOLUCI√ìN AL ERROR DE FIREBASE ============

// Funci√≥n optimizada para guardar reportes de producci√≥n
async function saveProductionReportsOptimized() {
    try {
        // üßπ LIMPIEZA AUTOM√ÅTICA - mantener solo √∫ltimos 100 reportes
        if (productionReports.length > 100) {
            productionReports = productionReports
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 100);
            console.log('üßπ Reportes limitados a 100 m√°s recientes');
        }
        
        // Dividir reportes en chunks muy peque√±os debido a PDFs
        const chunkSize = 3; // Solo 3 reportes por chunk
        const chunks = [];
        
        for (let i = 0; i < productionReports.length; i += chunkSize) {
            chunks.push(productionReports.slice(i, i + chunkSize));
        }
        
        // Guardar chunks por separado
        for (let i = 0; i < chunks.length; i++) {
            const chunkData = arrayToFirebaseObject(chunks[i]);
            await saveToFirebase(`productionReports_chunk_${i}`, JSON.stringify(chunkData));
        }
        
        // Guardar metadata sobre los chunks
        await saveToFirebase('productionReports_meta', JSON.stringify({
            totalChunks: chunks.length,
            totalReports: productionReports.length,
            lastUpdate: new Date().toISOString()
        }));
        
        console.log(`‚úÖ Reportes guardados en ${chunks.length} chunks`);
        
    } catch (error) {
        console.error('‚ùå Error guardando reportes optimizado:', error);
        // Fallback: guardar solo los √∫ltimos 5 reportes sin evidencia
        try {
            const recentReports = productionReports.slice(-5).map(report => ({
                ...report,
                evidencia: null // Remover evidencia para reducir tama√±o
            }));
            await saveToFirebase('productionReports_recent', JSON.stringify(arrayToFirebaseObject(recentReports)));
            console.log('‚ö†Ô∏è Guardados solo los √∫ltimos 5 reportes sin evidencia como respaldo');
        } catch (fallbackError) {
            console.error('‚ùå Error en respaldo:', fallbackError);
            throw new Error('No se pudieron guardar los reportes. Datos demasiado grandes.');
        }
    }
}

// Funci√≥n optimizada para cargar reportes de producci√≥n
async function loadProductionReportsOptimized() {
    try {
        console.log('üìä Cargando reportes de producci√≥n...');
        
        // Intentar cargar metadata
        const metaData = await loadFromFirebase('productionReports_meta');
        
        if (metaData) {
            const meta = JSON.parse(metaData);
            console.log(`üìã Encontrados ${meta.totalChunks} chunks con ${meta.totalReports} reportes`);
            
            // Cargar todos los chunks
            const allReports = [];
            for (let i = 0; i < meta.totalChunks; i++) {
                const chunkData = await loadFromFirebase(`productionReports_chunk_${i}`);
                if (chunkData) {
                    const chunk = firebaseObjectToArray(JSON.parse(chunkData));
                    allReports.push(...chunk);
                }
            }
            
            productionReports = allReports;
            console.log(`‚úÖ ${productionReports.length} reportes cargados desde chunks`);
            
        } else {
            // Fallback: cargar de la forma antigua
            console.log('‚ö†Ô∏è No se encontr√≥ metadata, intentando carga tradicional...');
            const reportsData = await loadFromFirebase('productionReports');
            if (reportsData) {
                productionReports = firebaseObjectToArray(JSON.parse(reportsData));
                console.log(`‚úÖ ${productionReports.length} reportes cargados (modo compatibilidad)`);
            } else {
                productionReports = [];
                console.log('üì≠ No hay reportes de producci√≥n');
            }
        }
        
    } catch (error) {
        console.error('‚ùå Error cargando reportes:', error);
        productionReports = [];
    }
}
// Funci√≥n para generar reporte
function generateReport() {
    try {
        // Crear datos del reporte
        const reportData = {
            fecha: new Date().toLocaleString(),
            inventario: {
                total: inventory.filter(i => i.quantity > 0).length,
                fundidos: inventory.filter(i => i.warehouse === 'fundidos' && i.quantity > 0).length,
                acabados: inventory.filter(i => i.warehouse === 'acabados' && i.quantity > 0).length,
                scrap: inventory.filter(i => i.warehouse === 'scrap' && i.quantity > 0).length
            },
            tarimas: pallets.length,
            movimientos: movements.length,
            reportesProduccion: productionReports.length,
            verificacionesFisicas: Object.keys(physicalVerification).length
        };
        
        // Crear contenido HTML del reporte
        const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Reporte General - ${new Date().toLocaleDateString()}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .header { text-align: center; border-bottom: 2px solid #333; padding: 20px; }
                    .section { margin: 20px 0; }
                    .stat { display: inline-block; margin: 10px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>üè≠ REPORTE GENERAL DEL SISTEMA</h1>
                    <p>Generado: ${reportData.fecha}</p>
                </div>
                
                <div class="section">
                    <h2>üìä RESUMEN DE INVENTARIO</h2>
                    <div class="stat"><strong>Total Items:</strong> ${reportData.inventario.total}</div>
                    <div class="stat"><strong>üî• Fundidos:</strong> ${reportData.inventario.fundidos}</div>
                    <div class="stat"><strong>‚úÖ Acabados:</strong> ${reportData.inventario.acabados}</div>
                    <div class="stat"><strong>‚ôªÔ∏è Scrap:</strong> ${reportData.inventario.scrap}</div>
                </div>
                
                <div class="section">
                    <h2>üì¶ ESTAD√çSTICAS GENERALES</h2>
                    <div class="stat"><strong>Tarimas:</strong> ${reportData.tarimas}</div>
                    <div class="stat"><strong>Movimientos:</strong> ${reportData.movimientos}</div>
                    <div class="stat"><strong>Reportes Producci√≥n:</strong> ${reportData.reportesProduccion}</div>
                    <div class="stat"><strong>Verificaciones F√≠sicas:</strong> ${reportData.verificacionesFisicas}</div>
                </div>
            </body>
            </html>
        `;
        
        // Crear y descargar el reporte
        const blob = new Blob([reportHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Reporte-General-${new Date().toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('üìä Reporte generado y descargado exitosamente');
        
    } catch (error) {
        console.error('Error generando reporte:', error);
        alert('‚ùå Error generando reporte: ' + error.message);
    }
}

// Funci√≥n para exportar datos - ACTUALIZADA Y FUNCIONAL
function exportData() {
    try {
        const data = {
            metadata: {
                fechaExportacion: new Date().toISOString(),
                version: "1.3",
                totalInventario: inventory.length,
                totalMovimientos: movements.length,
                totalTarimas: pallets.length
            },
            inventory: inventory,
            movements: movements,
            pallets: pallets,
            physicalVerification: physicalVerification,
            productionReports: productionReports.map(report => ({
                ...report,
                evidencia: report.evidencia ? { hasEvidence: true } : null // Excluir evidencia pesada
            })),
            scrapSheets: scrapSheets.map(sheet => ({
                ...sheet,
                evidencia: sheet.evidencia ? { hasEvidence: true } : null // Excluir evidencia pesada
            })),
            retenciones: retenciones
        };
        
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `almacen-completo-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('üìä Datos exportados exitosamente\n\nArchivo JSON con toda la informaci√≥n del sistema descargado.');
        
    } catch (error) {
        console.error('Error exportando datos:', error);
        alert('‚ùå Error exportando datos: ' + error.message);
    }
}
// üÜï FUNCI√ìN PARA CREAR RETENCI√ìN AUTOM√ÅTICA DE TARIMA
async function createAutomaticRetencion(pallet) {
    try {
        // Generar folio autom√°tico
        const currentDate = new Date();
        const year = currentDate.getFullYear().toString().slice(-2);
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        
        const currentCounter = await loadFromFirebase('retencionCounter') || 1;
        const newCounter = parseInt(currentCounter) + 1;
        
        const folio = `RET-${year}${month}${day}-${String(newCounter).padStart(4, '0')}`;
        
        // Crear retenci√≥n con c√≥digos de la tarima
        const retencion = {
            folio: folio,
            fechaCreacion: new Date().toISOString(),
            fechaProduccion: new Date().toISOString().split('T')[0],
            tipoOrigen: 'TARIMA_AUTOMATICA',
            palletId: pallet.systemId,
            codigosQR: pallet.codes || [],
            totalShots: pallet.codes ? pallet.codes.length : pallet.codesCount,
            motivo: 'INSPECCION_AUTOMATICA',
            observaciones: `Retenci√≥n autom√°tica creada desde movimiento de tarima ${pallet.systemId}`,
            creadoPor: currentUser.nombre,
            estado: 'ACTIVA',
            historial: [{
                fecha: new Date().toISOString(),
                accion: 'CREACION_AUTOMATICA',
                responsable: currentUser.nombre,
                comentario: 'Retenci√≥n creada autom√°ticamente desde gesti√≥n de inventario'
            }]
        };
        
        // Guardar retenci√≥n
        retenciones.push(retencion);
        await saveToFirebase('retenciones', JSON.stringify(arrayToFirebaseObject(retenciones)));
        await saveToFirebase('retencionCounter', newCounter.toString());
        
        // Actualizar estado de la tarima
        pallet.warehouse = 'retenciones';
        pallet.state = 'retenciones';
        pallet.retencionFolio = folio;
        
        // Actualizar inventario
        inventory.forEach(item => {
            if (item.palletId === pallet.systemId) {
                item.warehouse = 'retenciones';
                item.state = 'RETENIDO';
                item.retencionFolio = folio;
                item.lastMovement = new Date();
            }
        });
        
        await saveToFirebase('pallets', JSON.stringify(arrayToFirebaseObject(pallets)));
        await saveToFirebase('inventory', JSON.stringify(arrayToFirebaseObject(inventory)));
        
        alert(`‚úÖ RETENCI√ìN CREADA AUTOM√ÅTICAMENTE\n\nFolio: ${folio}\nTarima: ${pallet.systemId}\nC√≥digos: ${retencion.totalShots}\n\nPuedes gestionar la retenci√≥n desde la pesta√±a "Retenci√≥n y Scrap"`);
        
        // Opcional: abrir pesta√±a de retenciones
        const openTab = confirm('¬øDeseas abrir la pesta√±a de retenciones para revisar?');
        if (openTab) {
            showTab('scrap-retention');
            showSubTab('retenciones');
        }
        
        updateAllDisplays();
        
    } catch (error) {
        console.error('Error creando retenci√≥n autom√°tica:', error);
        alert('‚ùå Error creando retenci√≥n autom√°tica: ' + error.message);
    }
}

// üÜï FUNCI√ìN PARA CREAR RETENCI√ìN AUTOM√ÅTICA DE C√ìDIGO INDIVIDUAL
async function createAutomaticIndividualRetencion(item) {
    try {
        // Similar a la anterior pero para c√≥digo individual
        const currentDate = new Date();
        const year = currentDate.getFullYear().toString().slice(-2);
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        
        const currentCounter = await loadFromFirebase('retencionCounter') || 1;
        const newCounter = parseInt(currentCounter) + 1;
        
        const folio = `RET-${year}${month}${day}-${String(newCounter).padStart(4, '0')}`;
        
        const retencion = {
            folio: folio,
            fechaCreacion: new Date().toISOString(),
            fechaProduccion: new Date().toISOString().split('T')[0],
            tipoOrigen: 'CODIGO_INDIVIDUAL_AUTOMATICO',
            codigosQR: [item.code],
            totalShots: 1,
            motivo: 'INSPECCION_AUTOMATICA',
            observaciones: `Retenci√≥n autom√°tica creada para c√≥digo individual ${item.code}`,
            creadoPor: currentUser.nombre,
            estado: 'ACTIVA',
            historial: [{
                fecha: new Date().toISOString(),
                accion: 'CREACION_AUTOMATICA',
                responsable: currentUser.nombre,
                comentario: 'Retenci√≥n individual creada autom√°ticamente'
            }]
        };
        
        retenciones.push(retencion);
        await saveToFirebase('retenciones', JSON.stringify(arrayToFirebaseObject(retenciones)));
        await saveToFirebase('retencionCounter', newCounter.toString());
        
        // Actualizar item
        item.warehouse = 'retenciones';
        item.state = 'RETENIDO';
        item.retencionFolio = folio;
        item.lastMovement = new Date();
        
        await saveToFirebase('inventory', JSON.stringify(arrayToFirebaseObject(inventory)));
        
        alert(`‚úÖ RETENCI√ìN INDIVIDUAL CREADA\n\nFolio: ${folio}\nC√≥digo: ${item.code}`);
        updateAllDisplays();
        
    } catch (error) {
        console.error('Error creando retenci√≥n individual:', error);
        alert('‚ùå Error: ' + error.message);
    }
}

// üÜï FUNCI√ìN PARA CREAR HOJA DE SEGUIMIENTO DE PRUEBAS
async function createAutomaticTestSheet(pallet) {
    try {
        // Crear hoja similar a scrap pero para pruebas
        const folio = `PRUEBA-${new Date().getFullYear().toString().slice(-2)}${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(folioCounter).padStart(4, '0')}`;
        
        const testSheet = {
            folio: folio,
            tipo: 'PRUEBAS',
            fechaOperacion: new Date().toISOString().split('T')[0],
            fechaCreacion: new Date().toISOString(),
            palletId: pallet.systemId,
            codigosQR: pallet.codes || [],
            totalCodigos: pallet.codes ? pallet.codes.length : pallet.codesCount,
            motivo: 'ENVIO_AUTOMATICO_PRUEBAS',
            observaciones: `Hoja autom√°tica para seguimiento de pruebas de tarima ${pallet.systemId}`,
            creadoPor: currentUser.nombre,
            estado: 'EN_PRUEBAS'
        };
        
        // Nota: Esto requerir√≠a una nueva estructura para hojas de pruebas
        // Por simplicidad, puedes usar scrapSheets o crear una nueva variable testSheets
        
        alert(`üìã HOJA DE SEGUIMIENTO CREADA\n\nFolio: ${folio}\nTipo: Pruebas\nTarima: ${pallet.systemId}`);
        
    } catch (error) {
        console.error('Error creando hoja de pruebas:', error);
    }
}

// üÜï FUNCI√ìN HELPER PARA MAPEAR WAREHOUSE A STATE
function getStateFromWarehouse(warehouse) {
    const mapping = {
        'fundidos': 'FUNDIDOS',
        'acabados': 'ACABADOS',
        'scrap': 'SCRAP',
        'retenciones': 'RETENIDO',
        'envios': 'ENVIADO',
        'pruebas': 'EN_PRUEBAS'
    };
    return mapping[warehouse] || 'DESCONOCIDO';
}
</script>
</body>
</html>
