<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Almacén - Fundición</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 18px 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: white;
            border-bottom: 4px solid #e74c3c;
            color: #e74c3c;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
        }

        #qr-input {
            background: #f8f9fa;
            border: 3px solid #28a745;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            line-height: 1.4;
        }

        #qr-input:focus {
            outline: none;
            border-color: #20c997;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.3);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 8px 5px;
            text-transform: uppercase;
        }

        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-danger { background: #e74c3c; color: white; }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-left: 6px solid #3498db;
            margin: 20px 0;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 25px 0;
        }

        .stats-card {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .stats-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .alert {
            padding: 20px;
            margin: 15px 0;
            border-radius: 12px;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .warehouse-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .warehouse-btn {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .warehouse-btn.selected {
            border-color: #e74c3c;
            background: #e74c3c;
            color: white;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .inventory-table th, .inventory-table td {
            padding: 18px 15px;
            text-align: left;
            border-bottom: 1px solid #f1f3f4;
        }

        .inventory-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            font-weight: bold;
        }

        .code-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
            margin: 2px;
            display: inline-block;
        }

        .pallet-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .pallet-code {
            font-size: 12px;
            padding: 2px 5px;
            margin: 1px;
            background: #e9ecef;
            border-radius: 3px;
            display: inline-block;
        }

        .pallet-info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .pallet-id {
            font-size: 1.2em;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .scanner-hint {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #856404;
        }

        .auto-detect {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .existing-code {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .existing-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .existing-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .duplicate-warning {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #721c24;
        }

        .model-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
        }

        .model-header {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
        }

        .state-subsection {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
        }

        .state-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .movement-list {
            font-size: 0.9em;
            color: #6c757d;
            margin: 5px 0;
        }

        .collapsible-content {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏭 Sistema de Almacén</h1>
            <p>Control de Inventario - Fundición y Acabados</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">📊 Dashboard</button>
            <button class="nav-tab" data-tab="scanner">📱 Escáner QR</button>
            <button class="nav-tab" data-tab="inventory">📋 Inventario</button>
            <button class="nav-tab" data-tab="pallets">📦 Tarimas</button>
            <button class="nav-tab" data-tab="production">🏭 Producción</button>
            <button class="nav-tab" data-tab="theoretical">📊 Teórico vs Físico</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>📊 Dashboard de Almacén</h2>
            
            <div class="grid">
                <div class="card stats-card">
                    <div class="stats-number" id="total-fundidos">0</div>
                    <h3>🔥 FUNDIDOS</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-acabados">0</div>
                    <h3>✅ ACABADOS</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-upr">0</div>
                    <h3>🔺 UPR</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-lwr">0</div>
                    <h3>🔻 LWR</h3>
                </div>
                <div class="card stats-card">
                    <div class="stats-number" id="total-pallets">0</div>
                    <h3>📦 TARIMAS</h3>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-primary" onclick="exportData()">📊 Exportar Datos</button>
            </div>
        </div>

        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content">
            <h2>📱 Procesamiento de Códigos QR</h2>
            
            <div class="card">
                <h3>Procesar Código QR</h3>
                
                <div class="scanner-hint">
                    💡 <strong>Para Scanner Físico:</strong> Posiciona el scanner sobre este campo de texto y escanea. 
                    El código se capturará automáticamente.
                </div>
                
                <div class="form-group">
                    <label>Código QR (Tarima o Individual):</label>
                    <textarea id="qr-input" rows="4" placeholder="Pega aquí el código QR completo o usa el scanner físico..." autofocus></textarea>
                    <div id="qr-analysis"></div>
                </div>
                
                <div class="form-group">
                    <label>Tipo de Inventario:</label>
                    <select id="inventory-type">
                        <option value="movimiento">📦 Movimiento Normal</option>
                        <option value="inicial">🎯 Inventario Inicial</option>
                        <option value="turno">⏰ Inventario por Turno</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Turno:</label>
                    <select id="shift">
                        <option value="1">Primer Turno (07:00 am - 07:00 pm)</option>
                        <option value="2">Segundo Turno (07:00 pm - 07:00 am)</option>
                    </select>
                </div>
                
                <div class="form-group" id="individual-state-section" style="display: none;">
                    <label>Estado del Material (Pieza Individual):</label>
                    <select id="individual-state">
                        <option value="fundidos">🔥 Fundido</option>
                        <option value="acabados">✅ Acabado</option>
                    </select>
                </div>
                
                <div class="form-group" id="movement-destination-section" style="display: none;">
                    <label>Destino del Movimiento:</label>
                    <div class="warehouse-selector" id="movement-selector">
                        <div class="warehouse-btn" data-movement="envios">📦 ENVÍOS</div>
                        <div class="warehouse-btn" data-movement="retenciones">⏸️ RETENCIONES</div>
                        <div class="warehouse-btn" data-movement="scrap">♻️ SCRAP</div>
                        <div class="warehouse-btn" data-movement="pruebas">🧪 PRUEBAS</div>
                    </div>
                </div>
                
                <div class="form-group" id="warehouse-override-section" style="display: none;">
                    <label>Forzar Almacén (Tarima sin estado detectado):</label>
                    <div class="warehouse-selector" id="warehouse-selector">
                        <div class="warehouse-btn" data-warehouse="fundidos">🔥 FUNDIDOS</div>
                        <div class="warehouse-btn" data-warehouse="acabados">✅ ACABADOS</div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="processQRCode()">✅ Procesar Código QR</button>
                <button class="btn btn-info" onclick="clearForm()">🔄 Limpiar</button>
            </div>

            <div id="process-result"></div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>📋 Inventario Detallado</h2>
            
            <div class="card">
                <h3>📊 Inventario por Modelo y Estado</h3>
                <div id="detailed-inventory"></div>
            </div>
            
            <div class="card">
                <h3>📊 Resumen por Número de Parte</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Número de Parte</th>
                            <th>Fundidos</th>
                            <th>Acabados</th>
                            <th>Envíos</th>
                            <th>Retenciones</th>
                            <th>Scrap</th>
                            <th>Pruebas</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="grouped-inventory-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Pallets Tab -->
        <div id="pallets" class="tab-content">
            <h2>📦 Gestión de Tarimas</h2>
            
            <div class="card">
                <h3>📋 Registro de Tarimas</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>ID Tarima</th>
                            <th>ID Original</th>
                            <th>Estado</th>
                            <th>Tipo</th>
                            <th>Piezas</th>
                            <th>Almacén</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="pallets-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- Production Tab -->
        <div id="production" class="tab-content">
            <h2>🏭 Control de Producción</h2>
            
            <div class="card">
                <h3>🔥 Reporte de Fundición</h3>
                <p>Funcionalidad completa en desarrollo...</p>
                <button class="btn btn-success" onclick="alert('Reporte guardado')">🔥 Guardar Reporte</button>
            </div>

            <div class="card">
                <h3>✅ Reporte de Acabado</h3>
                <p>Funcionalidad completa en desarrollo...</p>
                <button class="btn btn-success" onclick="alert('Reporte guardado')">✅ Guardar Reporte</button>
            </div>
        </div>

        <!-- Theoretical vs Physical Tab -->
        <div id="theoretical" class="tab-content">
            <h2>📊 Inventario Teórico vs Físico</h2>
            
            <div class="card">
                <h3>⚙️ Configuración Base</h3>
                <p>Configura el inventario inicial y producción para calcular el teórico.</p>
                <button class="btn btn-info" onclick="alert('Función en desarrollo')">🧮 Calcular Teórico</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let inventory = [];
        let movements = [];
        let pallets = [];
        let selectedWarehouse = '';
        let selectedMovement = '';
        let palletCounter = 1;

        const STATE_MAPPING = {
            'FUNDIDO': 'fundidos',
            'FUNDIDOS': 'fundidos',
            'ACABADO': 'acabados',
            'ACABADOS': 'acabados',
            'FINISHED': 'acabados',
            'CAST': 'fundidos'
        };

        // Función para extraer información del código
        function extractCodeInfo(code) {
            if (code.length === 13) {
                // UPR: P6102448O2P52
                const lote = code.substring(0, 3);
                const numeroDisparo = code.substring(3, 8);
                const maquinaRaw = parseInt(code.substring(8, 10));
                const maquina = maquinaRaw + 30;
                const modelo = code.substring(10, 12);
                const molde = code.substring(12, 13);
                
                return {
                    type: 'UPR',
                    lote: lote,
                    numeroDisparo: numeroDisparo,
                    maquina: maquina,
                    modelo: modelo,
                    molde: molde,
                    partNumber: 'UPR-' + modelo,
                    displayInfo: 'UPR-' + modelo + ' | L:' + lote + ' | M:' + maquina + ' | Mo:' + molde
                };
            } else if (code.length === 17) {
                // LWR: 25E153003154276P5
                const lote = code.substring(0, 5);
                const maquina = parseInt(code.substring(5, 7));
                const molde = code.substring(7, 9);
                const numeroDisparo = code.substring(9, 15);
                const modelo = code.substring(15, 17);
                
                return {
                    type: 'LWR',
                    lote: lote,
                    numeroDisparo: numeroDisparo,
                    maquina: maquina,
                    modelo: modelo,
                    molde: molde,
                    partNumber: 'LWR-' + modelo,
                    displayInfo: 'LWR-' + modelo + ' | L:' + lote + ' | M:' + maquina + ' | Mo:' + molde
                };
            }
            
            return null;
        }

        // Función para cambiar pestañas
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
        }

        function generatePalletId() {
            return 'PAL-' + String(palletCounter++).padStart(4, '0');
        }

        function checkExistingCodes(codes) {
            const existingCodes = [];
            const newCodes = [];
            
            codes.forEach(code => {
                const existing = inventory.find(item => item.code === code && item.quantity > 0);
                if (existing) {
                    existingCodes.push({ code: code, data: existing });
                } else {
                    newCodes.push(code);
                }
            });
            
            return { existingCodes, newCodes };
        }

        function getWarehouseName(warehouse) {
            const names = {
                'fundidos': '🔥 FUNDIDOS',
                'acabados': '✅ ACABADOS',
                'scrap': '♻️ SCRAP',
                'retenciones': '⏸️ RETENCIONES',
                'envios': '📦 ENVÍOS',
                'pruebas': '🧪 PRUEBAS'
            };
            return names[warehouse] || warehouse.toUpperCase();
        }

        function updateFormSections() {
            const inventoryType = document.getElementById('inventory-type').value;
            const movementSection = document.getElementById('movement-destination-section');
            
            if (inventoryType === 'movimiento') {
                movementSection.style.display = 'block';
            } else {
                movementSection.style.display = 'none';
                document.querySelectorAll('#movement-selector .warehouse-btn').forEach(btn => 
                    btn.classList.remove('selected'));
                selectedMovement = '';
            }
        }

        function analyzeQRCode() {
            const input = document.getElementById('qr-input').value.trim();
            const analysisDiv = document.getElementById('qr-analysis');
            
            document.getElementById('warehouse-override-section').style.display = 'none';
            document.getElementById('individual-state-section').style.display = 'none';
            
            if (!input) {
                analysisDiv.innerHTML = '';
                return;
            }
            
            const analysis = parseQRCode(input);
            
            if (analysis.isPallet) {
                const codeCheck = checkExistingCodes(analysis.codes);
                
                if (!analysis.detectedState) {
                    document.getElementById('warehouse-override-section').style.display = 'block';
                }
                
                analysisDiv.innerHTML = '<div class="alert alert-info"><strong>🎯 TARIMA DETECTADA</strong><br>' +
                    '<span class="code-badge" style="background: #17a2b8;">ID: ' + analysis.palletId + '</span>' +
                    '<span class="code-badge" style="background: #28a745;">' + analysis.type + '</span>' +
                    '<span class="code-badge" style="background: #6c757d;">' + analysis.codes.length + ' piezas</span>' +
                    '<span class="code-badge" style="background: #17a2b8;">' + codeCheck.newCodes.length + ' nuevas</span></div>';
                
            } else if (analysis.isValid) {
                document.getElementById('individual-state-section').style.display = 'block';
                
                analysisDiv.innerHTML = '<div class="alert alert-success"><strong>✅ CÓDIGO NUEVO</strong><br>' +
                    '<span class="code-badge" style="background: #28a745;">' + analysis.type + '</span>' +
                    '<span class="code-badge" style="background: #6c757d;">' + analysis.code + '</span></div>';
                
            } else {
                analysisDiv.innerHTML = '<div class="alert" style="background: #f8d7da; color: #721c24;">' +
                    '❌ <strong>Código no válido</strong></div>';
            }
            
            updateFormSections();
        }

        function parseQRCode(input) {
            if (input.includes('|')) {
                const parts = input.split('|');
                if (parts.length >= 3) {
                    const palletId = parts[0];
                    const state = parts[1];
                    const codes = parts.slice(2).filter(code => code.trim().length > 0);
                    
                    let type = 'UNKNOWN';
                    if (codes.length > 0) {
                        const firstCodeInfo = extractCodeInfo(codes[0]);
                        type = firstCodeInfo ? firstCodeInfo.type : 'UNKNOWN';
                    }
                    
                    let detectedState = null;
                    const stateUpper = state.toUpperCase();
                    for (const key in STATE_MAPPING) {
                        if (stateUpper.includes(key)) {
                            detectedState = STATE_MAPPING[key];
                            break;
                        }
                    }
                    
                    return {
                        isPallet: true,
                        isValid: true,
                        palletId: palletId,
                        type: type,
                        state: state,
                        detectedState: detectedState,
                        codes: codes
                    };
                }
            } else {
                const cleanCode = input.trim();
                const codeInfo = extractCodeInfo(cleanCode);
                if (codeInfo) {
                    return {
                        isPallet: false,
                        isValid: true,
                        code: cleanCode,
                        type: codeInfo.type,
                        codeInfo: codeInfo
                    };
                }
            }
            
            return { isPallet: false, isValid: false };
        }

        function processQRCode() {
            const input = document.getElementById('qr-input').value.trim();
            const inventoryType = document.getElementById('inventory-type').value;
            const shift = document.getElementById('shift').value;
            const resultDiv = document.getElementById('process-result');
            
            if (!input) {
                alert('Por favor escanea o pega un código QR');
                return;
            }
            
            const analysis = parseQRCode(input);
            if (!analysis.isValid) {
                alert('Código QR no válido');
                return;
            }
            
            let targetWarehouse = '';
            
            if (analysis.isPallet) {
                const codeCheck = checkExistingCodes(analysis.codes);
                
                if (inventoryType === 'movimiento') {
                    if (!selectedMovement) {
                        alert('Por favor selecciona el destino del movimiento');
                        return;
                    }
                    targetWarehouse = selectedMovement;
                } else {
                    if (analysis.detectedState) {
                        targetWarehouse = analysis.detectedState;
                    } else {
                        if (!selectedWarehouse) {
                            alert('Por favor selecciona Fundidos o Acabados manualmente');
                            return;
                        }
                        targetWarehouse = selectedWarehouse;
                    }
                }
                
                if (codeCheck.newCodes.length === 0) {
                    alert('⚠️ Todos los códigos ya existen en el sistema');
                    return;
                }
                
                const palletSystemId = generatePalletId();
                
                const palletRecord = {
                    systemId: palletSystemId,
                    originalId: analysis.palletId,
                    state: targetWarehouse,
                    type: analysis.type,
                    codesCount: codeCheck.newCodes.length,
                    warehouse: targetWarehouse,
                    codes: codeCheck.newCodes,
                    createdDate: new Date()
                };
                
                pallets.push(palletRecord);
                
                codeCheck.newCodes.forEach(code => {
                    processIndividualCode(code, analysis.type, inventoryType, shift, targetWarehouse, palletSystemId);
                });
                
                resultDiv.innerHTML = '<div class="alert alert-success">✅ <strong>Tarima procesada</strong><br>' +
                    '🆔 ID Sistema: <strong>' + palletSystemId + '</strong><br>' +
                    '📦 ID Original: ' + analysis.palletId + '<br>' +
                    '📊 ' + codeCheck.newCodes.length + ' piezas NUEVAS ' + analysis.type + '<br>' +
                    '🏪 Destino: ' + getWarehouseName(targetWarehouse) + '</div>';
                
            } else {
                // Piezas individuales
                const individualState = document.getElementById('individual-state').value;
                
                if (inventoryType === 'movimiento') {
                    if (!selectedMovement) {
                        alert('Por favor selecciona el destino del movimiento');
                        return;
                    }
                    targetWarehouse = selectedMovement;
                } else {
                    targetWarehouse = individualState;
                }
                
                processIndividualCode(analysis.code, analysis.type, inventoryType, shift, targetWarehouse);
                
                resultDiv.innerHTML = '<div class="alert alert-success">✅ <strong>Código procesado</strong><br>' +
                    '📦 ' + analysis.code + '<br>' +
                    '🏪 Registrado en: ' + getWarehouseName(targetWarehouse) + '</div>';
            }
            
            clearForm();
            updateAllDisplays();
            
            setTimeout(function() {
                resultDiv.innerHTML = '';
            }, 6000);
        }

        function clearForm() {
            document.getElementById('qr-input').value = '';
            document.getElementById('qr-analysis').innerHTML = '';
            
            document.getElementById('warehouse-override-section').style.display = 'none';
            document.getElementById('individual-state-section').style.display = 'none';
            document.getElementById('movement-destination-section').style.display = 'none';
            
            document.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            selectedWarehouse = '';
            selectedMovement = '';
            
            document.getElementById('qr-input').focus();
        }

        function processIndividualCode(code, type, movementType, shift, warehouse, palletId) {
            palletId = palletId || null;
            const codeInfo = extractCodeInfo(code);
            if (!codeInfo) {
                console.error('No se pudo extraer información del código:', code);
                return;
            }
            
            const partNumber = codeInfo.partNumber;
            
            let item = inventory.find(function(i) {
                return i.code === code;
            });
            
            if (!item) {
                item = {
                    code: code,
                    partNumber: partNumber,
                    type: codeInfo.type,
                    state: warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS',
                    warehouse: warehouse,
                    quantity: 0,
                    lastMovement: new Date(),
                    shift: shift,
                    palletId: palletId,
                    lote: codeInfo.lote,
                    numeroDisparo: codeInfo.numeroDisparo,
                    maquina: codeInfo.maquina,
                    modelo: codeInfo.modelo,
                    molde: codeInfo.molde,
                    displayInfo: codeInfo.displayInfo
                };
                inventory.push(item);
            }
            
            if (movementType === 'movimiento') {
                item.warehouse = warehouse;
                item.state = warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
                item.lastMovement = new Date();
                item.palletId = palletId;
            } else {
                item.quantity += 1;
                item.warehouse = warehouse;
                item.state = warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
                item.lastMovement = new Date();
                item.palletId = palletId;
            }
            
            movements.push({
                id: Date.now() + Math.random(),
                code: code,
                partNumber: partNumber,
                type: movementType,
                warehouse: warehouse,
                quantity: 1,
                date: new Date(),
                shift: shift,
                palletId: palletId,
                lote: codeInfo.lote,
                maquina: codeInfo.maquina,
                modelo: codeInfo.modelo,
                molde: codeInfo.molde
            });
        }

        function movePallet(palletId) {
            const newWarehouse = prompt('Almacén destino (fundidos/acabados/scrap/retenciones/envios/pruebas):');
            
            if (newWarehouse && ['fundidos', 'acabados', 'scrap', 'retenciones', 'envios', 'pruebas'].includes(newWarehouse.toLowerCase())) {
                const warehouse = newWarehouse.toLowerCase();
                const pallet = pallets.find(function(p) {
                    return p.systemId === palletId;
                });
                
                if (pallet) {
                    pallet.warehouse = warehouse;
                    
                    inventory.forEach(function(item) {
                        if (item.palletId === palletId) {
                            item.warehouse = warehouse;
                            item.state = warehouse === 'fundidos' ? 'FUNDIDOS' : 'ACABADOS';
                            item.lastMovement = new Date();
                        }
                    });
                    
                    alert('✅ Tarima ' + palletId + ' movida a ' + getWarehouseName(warehouse));
                    updateAllDisplays();
                }
            } else if (newWarehouse !== null) {
                alert('Almacén no válido');
            }
        }

        function viewPalletDetails(palletId) {
            const pallet = pallets.find(function(p) {
                return p.systemId === palletId;
            });
            if (!pallet) {
                alert('Tarima no encontrada');
                return;
            }

            const codes = pallet.codes.length > 10 ? 
                pallet.codes.slice(0, 10).join('\n') + '\n... y ' + (pallet.codes.length - 10) + ' más' :
                pallet.codes.join('\n');

            alert('📦 DETALLES DE TARIMA\n\n🆔 ID: ' + pallet.systemId + '\n📋 Original: ' + pallet.originalId + '\n🔧 Tipo: ' + pallet.type + '\n📦 Piezas: ' + pallet.codesCount + '\n🏪 Almacén: ' + getWarehouseName(pallet.warehouse) + '\n\n📋 CÓDIGOS:\n' + codes);
        }

        function exportData() {
            const data = {
                inventory: inventory,
                movements: movements,
                pallets: pallets,
                exportDate: new Date()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'almacen-completo-' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadSampleData() {
            const samples = [
                { code: 'P6102448O2P52', type: 'UPR' },
                { code: '25E153003154276P5', type: 'LWR' },
                { code: 'P6205362O3P54', type: 'UPR' },
                { code: '25F164004265387P7', type: 'LWR' }
            ];
            
            samples.forEach(function(sample) {
                const codeInfo = extractCodeInfo(sample.code);
                if (codeInfo) {
                    inventory.push({
                        code: sample.code,
                        partNumber: codeInfo.partNumber,
                        type: sample.type,
                        state: 'ACABADOS',
                        warehouse: 'acabados',
                        quantity: Math.floor(Math.random() * 15) + 5,
                        lastMovement: new Date(),
                        shift: '1',
                        palletId: null,
                        lote: codeInfo.lote,
                        numeroDisparo: codeInfo.numeroDisparo,
                        maquina: codeInfo.maquina,
                        modelo: codeInfo.modelo,
                        molde: codeInfo.molde,
                        displayInfo: codeInfo.displayInfo
                    });
                }
            });

            const samplePallet = {
                systemId: generatePalletId(),
                originalId: 'TARM001',
                state: 'acabados',
                type: 'UPR',
                codesCount: 3,
                warehouse: 'acabados',
                codes: ['P6102448O2P52', 'P6205362O3P54', 'P6308476O4P56'],
                createdDate: new Date()
            };
            pallets.push(samplePallet);
        }

        function updateAllDisplays() {
            updateDashboard();
            updateGroupedInventory();
            updateDetailedInventory();
            updatePalletsTable();
        }

        function updateDashboard() {
            const fundidos = inventory.filter(function(i) {
                return i.state === 'FUNDIDOS' && i.quantity > 0;
            }).length;
            const acabados = inventory.filter(function(i) {
                return i.state === 'ACABADOS' && i.quantity > 0;
            }).length;
            const upr = inventory.filter(function(i) {
                return i.type === 'UPR' && i.quantity > 0;
            }).length;
            const lwr = inventory.filter(function(i) {
                return i.type === 'LWR' && i.quantity > 0;
            }).length;
            const totalPallets = pallets.length;
            
            document.getElementById('total-fundidos').textContent = fundidos;
            document.getElementById('total-acabados').textContent = acabados;
            document.getElementById('total-upr').textContent = upr;
            document.getElementById('total-lwr').textContent = lwr;
            document.getElementById('total-pallets').textContent = totalPallets;
        }

        function updateGroupedInventory() {
            const tbody = document.getElementById('grouped-inventory-tbody');
            tbody.innerHTML = '';
            
            const grouped = {};
            
            inventory.forEach(function(item) {
                if (item.quantity > 0) {
                    if (!grouped[item.partNumber]) {
                        grouped[item.partNumber] = { 
                            fundidos: 0, acabados: 0, envios: 0, 
                            retenciones: 0, scrap: 0, pruebas: 0 
                        };
                    }
                    
                    if (item.warehouse === 'fundidos') {
                        grouped[item.partNumber].fundidos += item.quantity;
                    } else if (item.warehouse === 'acabados') {
                        grouped[item.partNumber].acabados += item.quantity;
                    } else if (item.warehouse === 'envios') {
                        grouped[item.partNumber].envios += item.quantity;
                    } else if (item.warehouse === 'retenciones') {
                        grouped[item.partNumber].retenciones += item.quantity;
                    } else if (item.warehouse === 'scrap') {
                        grouped[item.partNumber].scrap += item.quantity;
                    } else if (item.warehouse === 'pruebas') {
                        grouped[item.partNumber].pruebas += item.quantity;
                    }
                }
            });
            
            Object.keys(grouped).forEach(function(partNumber) {
                const data = grouped[partNumber];
                const total = data.fundidos + data.acabados + data.envios + data.retenciones + data.scrap + data.pruebas;
                
                const row = document.createElement('tr');
                row.innerHTML = '<td><strong>' + partNumber + '</strong></td>' +
                    '<td style="text-align: center;">🔥 ' + data.fundidos + '</td>' +
                    '<td style="text-align: center;">✅ ' + data.acabados + '</td>' +
                    '<td style="text-align: center;">📦 ' + data.envios + '</td>' +
                    '<td style="text-align: center;">⏸️ ' + data.retenciones + '</td>' +
                    '<td style="text-align: center;">♻️ ' + data.scrap + '</td>' +
                    '<td style="text-align: center;">🧪 ' + data.pruebas + '</td>' +
                    '<td style="text-align: center; font-weight: bold;">' + total + '</td>';
                tbody.appendChild(row);
            });
        }

        function updateDetailedInventory() {
            const detailedDiv = document.getElementById('detailed-inventory');
            
            // Filtros
            const filtersHTML = '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">' +
                '<h4>🔍 Filtros de Inventario</h4>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">' +
                '<div><label><strong>Tipo:</strong></label>' +
                '<select id="filter-type" onchange="updateDetailedInventory()">' +
                '<option value="all">Todos</option><option value="UPR">UPR</option><option value="LWR">LWR</option>' +
                '</select></div>' +
                '<div><label><strong>Modelo:</strong></label>' +
                '<select id="filter-modelo" onchange="updateDetailedInventory()"><option value="all">Todos</option></select></div>' +
                '<div><label><strong>Lote:</strong></label>' +
                '<select id="filter-lote" onchange="updateDetailedInventory()"><option value="all">Todos</option></select></div>' +
                '<div><label><strong>Molde:</strong></label>' +
                '<select id="filter-molde" onchange="updateDetailedInventory()"><option value="all">Todos</option></select></div>' +
                '</div></div>';
            
            // Obtener valores de filtros
            const typeFilter = document.getElementById('filter-type') ? document.getElementById('filter-type').value : 'all';
            const modeloFilter = document.getElementById('filter-modelo') ? document.getElementById('filter-modelo').value : 'all';
            const loteFilter = document.getElementById('filter-lote') ? document.getElementById('filter-lote').value : 'all';
            const moldeFilter = document.getElementById('filter-molde') ? document.getElementById('filter-molde').value : 'all';
            
            // Filtrar inventario
            let filteredInventory = inventory.filter(function(item) {
                if (item.quantity === 0) return false;
                if (typeFilter !== 'all' && item.type !== typeFilter) return false;
                if (modeloFilter !== 'all' && item.modelo !== modeloFilter) return false;
                if (loteFilter !== 'all' && item.lote !== loteFilter) return false;
                if (moldeFilter !== 'all' && item.molde !== moldeFilter) return false;
                return true;
            });
            
            // Agrupar por tipo y modelo
            const grouped = {};
            filteredInventory.forEach(function(item) {
                const key = item.type + '-' + item.modelo;
                if (!grouped[key]) {
                    grouped[key] = {
                        type: item.type,
                        modelo: item.modelo,
                        items: []
                    };
                }
                grouped[key].items.push(item);
            });
            
            let html = filtersHTML;
            
            // Generar secciones por tipo/modelo
            Object.keys(grouped).forEach(function(key) {
                const group = grouped[key];
                const totalItems = group.items.reduce(function(sum, item) {
                    return sum + item.quantity;
                }, 0);
                
                html += '<div class="model-section">' +
                    '<div class="model-header" onclick="toggleSection(\'' + key + '\')">' +
                    '<span id="toggle-' + key + '">🔽</span> ' + group.type + '-' + group.modelo + 
                    ' <span style="float: right;">Total: ' + totalItems + ' piezas</span>' +
                    '</div>' +
                    '<div id="section-' + key + '" class="collapsible-content">' +
                    generateDetailedPartSection(group.items) +
                    '</div></div>';
            });
            
            if (Object.keys(grouped).length === 0) {
                html += '<div class="alert alert-info">No hay inventario que coincida con los filtros seleccionados.</div>';
            }
            
            detailedDiv.innerHTML = html;
            
            // Actualizar opciones de filtros
            updateFilterOptions();
        }

        function toggleSection(sectionKey) {
            const content = document.getElementById('section-' + sectionKey);
            const toggle = document.getElementById('toggle-' + sectionKey);
            
            if (content && toggle) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = '🔽';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = '▶️';
                }
            }
        }

        function updateFilterOptions() {
            // Obtener valores únicos para los filtros
            const modelos = [];
            const lotes = [];
            const moldes = [];
            
            inventory.forEach(function(item) {
                if (item.quantity > 0) {
                    if (item.modelo && modelos.indexOf(item.modelo) === -1) {
                        modelos.push(item.modelo);
                    }
                    if (item.lote && lotes.indexOf(item.lote) === -1) {
                        lotes.push(item.lote);
                    }
                    if (item.molde && moldes.indexOf(item.molde) === -1) {
                        moldes.push(item.molde);
                    }
                }
            });
            
            modelos.sort();
            lotes.sort();
            moldes.sort();
            
            // Actualizar select de modelos
            const modeloSelect = document.getElementById('filter-modelo');
            if (modeloSelect) {
                const currentValue = modeloSelect.value;
                let modeloOptions = '<option value="all">Todos</option>';
                modelos.forEach(function(m) {
                    modeloOptions += '<option value="' + m + '"' + (m === currentValue ? ' selected' : '') + '>' + m + '</option>';
                });
                modeloSelect.innerHTML = modeloOptions;
            }
            
            // Actualizar select de lotes
            const loteSelect = document.getElementById('filter-lote');
            if (loteSelect) {
                const currentValue = loteSelect.value;
                let loteOptions = '<option value="all">Todos</option>';
                lotes.forEach(function(l) {
                    loteOptions += '<option value="' + l + '"' + (l === currentValue ? ' selected' : '') + '>' + l + '</option>';
                });
                loteSelect.innerHTML = loteOptions;
            }
            
            // Actualizar select de moldes
            const moldeSelect = document.getElementById('filter-molde');
            if (moldeSelect) {
                const currentValue = moldeSelect.value;
                let moldeOptions = '<option value="all">Todos</option>';
                moldes.forEach(function(m) {
                    moldeOptions += '<option value="' + m + '"' + (m === currentValue ? ' selected' : '') + '>' + m + '</option>';
                });
                moldeSelect.innerHTML = moldeOptions;
            }
        }

        function generateDetailedPartSection(items) {
            const warehouses = ['fundidos', 'acabados', 'envios', 'retenciones', 'scrap', 'pruebas'];
            const warehouseNames = {
                'fundidos': '🔥 FUNDIDOS',
                'acabados': '✅ ACABADOS',
                'envios': '📦 ENVÍOS',
                'retenciones': '⏸️ RETENCIONES',
                'scrap': '♻️ SCRAP',
                'pruebas': '🧪 PRUEBAS'
            };
            
            let html = '';
            
            warehouses.forEach(function(warehouse) {
                const warehouseItems = items.filter(function(item) {
                    return item.warehouse === warehouse;
                });
                const totalQuantity = warehouseItems.reduce(function(sum, item) {
                    return sum + item.quantity;
                }, 0);
                
                if (totalQuantity > 0) {
                    html += '<div class="state-subsection">';
                    html += '<div class="state-header">' + warehouseNames[warehouse] + ' (' + totalQuantity + ' piezas)</div>';
                    
                    // Agrupar por lote y molde
                    const subgroups = {};
                    warehouseItems.forEach(function(item) {
                        const key = 'L:' + item.lote + '-Mo:' + item.molde + '-Mq:' + item.maquina;
                        if (!subgroups[key]) {
                            subgroups[key] = [];
                        }
                        subgroups[key].push(item);
                    });
                    
                    Object.keys(subgroups).forEach(function(key) {
                        const subgroup = subgroups[key];
                        const subgroupTotal = subgroup.reduce(function(sum, item) {
                            return sum + item.quantity;
                        }, 0);
                        
                        const codes = subgroup.map(function(item) {
                            return item.code;
                        }).join(', ');
                        
                        html += '<div class="movement-list">' +
                            '<strong>' + key + '</strong> - ' + subgroupTotal + ' piezas' +
                            '<br><small>Códigos: ' + codes + '</small>' +
                            '</div>';
                    });
                    
                    html += '</div>';
                }
            });
            
            return html;
        }

        function updatePalletsTable() {
            const tbody = document.getElementById('pallets-tbody');
            tbody.innerHTML = '';
            
            pallets.forEach(function(pallet) {
                const row = document.createElement('tr');
                row.innerHTML = '<td><strong>' + pallet.systemId + '</strong></td>' +
                    '<td>' + pallet.originalId + '</td>' +
                    '<td><span class="code-badge" style="background: ' + (pallet.state === 'fundidos' ? '#e74c3c' : '#27ae60') + ';">' + pallet.state.toUpperCase() + '</span></td>' +
                    '<td><span class="code-badge" style="background: #17a2b8;">' + pallet.type + '</span></td>' +
                    '<td style="text-align: center;">' + pallet.codesCount + '</td>' +
                    '<td>' + getWarehouseName(pallet.warehouse) + '</td>' +
                    '<td>' + pallet.createdDate.toLocaleDateString() + '</td>' +
                    '<td>' +
                    '<button class="btn btn-warning" style="padding: 5px 10px; font-size: 12px;" onclick="movePallet(\'' + pallet.systemId + '\')">📦 Mover</button>' +
                    '<button class="btn btn-info" style="padding: 5px 10px; font-size: 12px;" onclick="viewPalletDetails(\'' + pallet.systemId + '\')">👁️ Ver</button>' +
                    '</td>';
                tbody.appendChild(row);
            });
        }

        // Configurar event listeners cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Event listeners para pestañas
            document.querySelectorAll('.nav-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });
            
            // Event listeners
            document.getElementById('qr-input').addEventListener('input', analyzeQRCode);
            document.getElementById('inventory-type').addEventListener('change', updateFormSections);
            
            document.getElementById('qr-input').addEventListener('paste', function(e) {
                setTimeout(function() {
                    const content = e.target.value.trim();
                    if (content && (content.includes('|') || content.length >= 13)) {
                        analyzeQRCode();
                    }
                }, 100);
            });
            
            document.getElementById('warehouse-selector').addEventListener('click', function(e) {
                if (e.target.classList.contains('warehouse-btn')) {
                    this.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                        btn.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    selectedWarehouse = e.target.dataset.warehouse;
                }
            });
            
            document.getElementById('movement-selector').addEventListener('click', function(e) {
                if (e.target.classList.contains('warehouse-btn')) {
                    this.querySelectorAll('.warehouse-btn').forEach(function(btn) {
                        btn.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    selectedMovement = e.target.dataset.movement;
                }
            });
            
            // Inicializar datos y displays
            loadSampleData();
            updateAllDisplays();
        });

    </script>
</body>
</html>
